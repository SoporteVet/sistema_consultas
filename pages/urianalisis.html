<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Plantillas</title>
    <link rel="stylesheet" href="index_lab.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=ABeeZee:ital@0;1&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=League+Spartan:wght@100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
</head>
<body>
<script>
// Autollenado desde parámetros URL para urianálisis
document.addEventListener('DOMContentLoaded', function(){
  try {
    const params = new URLSearchParams(window.location.search);
    const setVal = (id, val) => { const el = document.getElementById(id); if (el && val!=null && val!=='') el.value = val; };
    setVal('mascotaNombre', params.get('mascotaNombre'));
    setVal('propietarioNombre', params.get('propietarioNombre'));
    setVal('propietarioCedula', params.get('propietarioCedula'));
    setVal('propietarioTelefono', params.get('propietarioTelefono'));
    setVal('propietarioEmail', params.get('propietarioEmail'));
    setVal('nombreMedico', params.get('nombreMedico'));
    setVal('mascotaRaza', params.get('mascotaRaza'));
    setVal('mascotaEdad', params.get('mascotaEdad'));
    setVal('mascotaPeso', params.get('mascotaPeso'));
    const especie = params.get('especie');
    const sexo = params.get('mascotaSexo');
    const especieSelector = document.getElementById('especieSelector');
    const sexoSelector = document.getElementById('sexoSelector');
    if (especieSelector && especie) especieSelector.value = especie;
    if (sexoSelector && sexo) sexoSelector.value = capitalize(sexo);
    
    // Verificar el mensaje del médico después del autollenado
    const medico = params.get('nombreMedico');
    if (medico) {
      setTimeout(() => {
        verificarMedico();
      }, 100);
    }
  } catch(e){ console.warn('Autollenado urianálisis falló:', e); }
  function capitalize(s){ if(!s) return s; return s.charAt(0).toUpperCase()+s.slice(1).toLowerCase(); }
});
</script>
    <body>
        <div class="controls">
            <label for="sexoSelector">Selecciona el sexo:</label>
            <select id="sexoSelector" onchange="actualizarSexoEnPlantilla(),actualizarValoresReferencia2()">
                <option value="Seleccionar" selected>-- Seleccionar --</option>
                <option value="Macho">Macho</option>
                <option value="Hembra">Hembra</option>
            </select>
            <label for="especieSelector">Selecciona la especie:</label>
            <select id="especieSelector" onchange="actualizarEspecieEnPlantilla(),actualizarValoresReferencia2()">
                <option value="Seleccionar" selected>-- Seleccionar --</option>
                <option value="Canino">Canino</option>
                <option value="Felino">Felino</option>
                <option value="Lagomorfo">Lagomorfo</option>
                <option value="Cuilo">Cuilo</option>
            </select>
          <label for="plantillaSelector">Selecciona la plantilla:</label>
          <select id="plantillaUrianalisisSelect" onchange="mostrarPlantillaUrianalisis()">
          <option value="11">11 parámetros</option>
          <option value="15">15 parámetros</option>
        </select>
</div>
        </div>
        <div class="container" id="template1" style="display: block;">
        <div class="header">
            <img src="empresa.jpg" alt="Logo de la Empresa" class="small-image">
            <h1>Laboratorio Clínico Veterinario</h1>
        </div>
        <h3 class="subheader">URIANÁLISIS</h3>
            <table>
                <thead>
                    <tr>
                        <th colspan="2">DATOS DE LA MASCOTA</th>
                        <th colspan="2">DATOS DEL PROPIETARIO</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Nombre</td>
                        <td><input type="text" id="mascotaNombre" onkeydown="moverFocoConFlechas(event, 'propietarioNombre', 'propietarioNombre', 'mascotaNombre', 'mascotaRaza')"></td>
                        <td>Nombre</td>
                        <td><input type="text" id="propietarioNombre"  onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaNombre', 'mascotaNombre', 'propietarioCedula')"></td>
                    </tr>
                    <tr>
                        <td>Raza</td>
                        <td><input type="text" id="mascotaRaza" list="razas"  onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaNombre', 'mascotaNombre', 'mascotaSexo')"></td>
                        <datalist id="razas">

                        </datalist>
                        <td>Cédula</td>
                        <td><input type="text" id="propietarioCedula"  onkeydown="moverFocoConFlechas(event, 'propietarioTelefono', 'mascotaRaza', 'propietarioNombre', 'propietarioTelefono')"></td>
                    </tr>
                    <tr>
                        <td>Sexo</td>
                        <td><input type="text" id="sexoEnPlantilla"></td>
                        <td>Teléfono</td>
                        <td><input type="text" id="propietarioTelefono" onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaSexo', 'propietarioCedula', 'propietarioEmail')"></td>
                    </tr>
                    <tr>
                        <td>Especie</td>
                        <td><input type="text" id="especieEnPlantilla"></td>
                        <td>Email</td>
                        <td><input type="text" id="propietarioEmail"  onkeydown="moverFocoConFlechas(event, 'mascotaEspecie', 'mascotaEspecie', 'propietarioTelefono', 'nombreMedico')"></td>
                    </tr>
                    <tr>
                        <td>Edad</td>
                        <td><input type="text" id="mascotaEdad" list="edades"  onkeydown="moverFocoConFlechas(event, 'nombreMedico', 'mascotaEspecie', 'mascotaEspecie', 'mascotaPeso')"></td>
    
                        <datalist id="edades">
                        <option value="1 mes"><option value="2 meses"><option value="3 meses"><option value="4 meses">
                        <option value="5 meses"><option value="6 meses"><option value="7 meses"><option value="8 meses"><option value="9 meses">
                        <option value="10 meses"><option value="11 meses"><option value="12 meses">
                        <option value="1 año"><option value="2 años"><option value="3 años"><option value="4 años">
                        <option value="5 años"><option value="6 años"><option value="7 años"><option value="8 años"><option value="9 años">
                        <option value="10 años"><option value="11 años"><option value="12 años"><option value="13 años"></option><option value="14 años"></option>
                        <option value="15 años"><option value="16 años"><option value="17 años"><option value="18 años"></option>
                        <option value="19 años"><option value="20 años"></option>    
                    </datalist>
                        <td>Médico</td>
                        <td>
                            <input type="text" id="nombreMedico" list="medicos" 
                                onkeydown="moverFocoConFlechas(event, 'propietarioFecha', 'mascotaEdad', 'propietarioEmail', 'propietarioFecha')" 
                                oninput="verificarMedico()">
                        </td>
                        <datalist id="medicos">
                            <option value="N.A">
                            <option value="Dr. Randall Azofeifa">
                            <option value="Dr. Luis Coto">
                            <option value="Dr. Gustavo Gónzalez">
                            <option value="Dra. Daniela Sancho">
                            <option value="Dra. Sofia Carrillo">
                            <option value="Dra. Franciny Nuñez">
                            <option value="Dra. Lourdes Chacón">
                            <option value="Dra. Alejandra León">
                            <option value="Dra. Karla Quesada">
                            <option value="Dra. Kharen Moreno">
                            <option value="Dra. Karina Madrigal">
                            <option value="Dra. Natalia Alvarado">
                        </datalist>
                    </tr>
                    <tr>
                        <script>    
                            function actualizarSexoEnPlantilla() {
                                const sexo = document.getElementById('sexoSelector').value;
                                document.getElementById('sexoEnPlantilla').value = sexo.charAt(0).toUpperCase() + sexo.slice(1);
                            }
                            function actualizarEspecieEnPlantilla() {
                                const especie = document.getElementById('especieSelector').value;
                                document.getElementById('especieEnPlantilla').value = especie;
                            }
                            function verificarMedico() {
                                const medico = document.getElementById('nombreMedico').value;
                                const mensaje = document.getElementById('mensajeMedico');
                                
                                // Verificar si el médico es N.A en cualquier variante o está vacío
                                const isNA = !medico || 
                                           medico.trim() === '' || 
                                           medico.toUpperCase() === 'N.A' || 
                                           medico.toUpperCase() === 'NA' || 
                                           medico.toUpperCase() === 'N.A.';
                                
                                if (isNA) {
                                    mensaje.style.display = 'none';
                                } else {
                                    mensaje.style.display = 'block';
                                }
                            }
                            
                            </script>
                    </tr>
                    <tr>
                        <td>Peso</td>
    <td><input type="text" id="mascotaPeso" list="pesos" onkeydown="moverFocoConFlechas(event, 'propietarioFecha', 'mascotaEdad', 'mascotaEdad', 'mascotaPeso')"></td>
    
        <datalist id="pesos">
            <option value="N.A">N.A</option><option value="0,1 kg">0,1 kg</option><option value="0,2 kg">0,2 kg</option><option value="0,3 kg">0,3 kg</option><option value="0,4 kg">0,4 kg</option>
            <option value="0,5 kg">0,5 kg</option><option value="0,6 kg">0,6 kg</option><option value="0,7 kg">0,7 kg</option><option value="0,8 kg">0,8 kg</option><option value="0,9 kg">0,9 kg</option>
            <option value="1,0 kg">1,0 kg</option><option value="1,1 kg">1,1 kg</option><option value="1,2 kg">1,2 kg</option><option value="1,3 kg">1,3 kg</option><option value="1,4 kg">1,4 kg</option>
            <option value="1,5 kg">1,5 kg</option><option value="1,6 kg">1,6 kg</option><option value="1,7 kg">1,7 kg</option><option value="1,8 kg">1,8 kg</option><option value="1,9 kg">1,9 kg</option>
            <option value="2,0 kg">2,0 kg</option><option value="2,1 kg">2,1 kg</option><option value="2,2 kg">2,2 kg</option><option value="2,3 kg">2,3 kg</option><option value="2,4 kg">2,4 kg</option>
            <option value="2,5 kg">2,5 kg</option><option value="2,6 kg">2,6 kg</option><option value="2,7 kg">2,7 kg</option><option value="2,8 kg">2,8 kg</option><option value="2,9 kg">2,9 kg</option>
            <option value="3,0 kg">3,0 kg</option><option value="3,1 kg">3,1 kg</option><option value="3,2 kg">3,2 kg</option><option value="3,3 kg">3,3 kg</option><option value="3,4 kg">3,4 kg</option>
            <option value="3,5 kg">3,5 kg</option><option value="3,6 kg">3,6 kg</option><option value="3,7 kg">3,7 kg</option><option value="3,8 kg">3,8 kg</option><option value="3,9 kg">3,9 kg</option>
            <option value="4,0 kg">4,0 kg</option><option value="4,1 kg">4,1 kg</option><option value="4,2 kg">4,2 kg</option><option value="4,3 kg">4,3 kg</option><option value="4,4 kg">4,4 kg</option>
            <option value="4,5 kg">4,5 kg</option><option value="4,6 kg">4,6 kg</option><option value="4,7 kg">4,7 kg</option><option value="4,8 kg">4,8 kg</option><option value="4,9 kg">4,9 kg</option>
            <option value="5,0 kg">5,0 kg</option><option value="5,1 kg">5,1 kg</option><option value="5,2 kg">5,2 kg</option><option value="5,3 kg">5,3 kg</option><option value="5,4 kg">5,4 kg</option>
            <option value="5,5 kg">5,5 kg</option><option value="5,6 kg">5,6 kg</option><option value="5,7 kg">5,7 kg</option><option value="5,8 kg">5,8 kg</option><option value="5,9 kg">5,9 kg</option>
            <option value="6,0 kg">6,0 kg</option><option value="6,1 kg">6,1 kg</option><option value="6,2 kg">6,2 kg</option><option value="6,3 kg">6,3 kg</option><option value="6,4 kg">6,4 kg</option>
            <option value="6,5 kg">6,5 kg</option><option value="6,6 kg">6,6 kg</option><option value="6,7 kg">6,7 kg</option><option value="6,8 kg">6,8 kg</option><option value="6,9 kg">6,9 kg</option>
            <option value="7,0 kg">7,0 kg</option><option value="7,1 kg">7,1 kg</option><option value="7,2 kg">7,2 kg</option><option value="7,3 kg">7,3 kg</option><option value="7,4 kg">7,4 kg</option>
            <option value="7,5 kg">7,5 kg</option><option value="7,6 kg">7,6 kg</option><option value="7,7 kg">7,7 kg</option><option value="7,8 kg">7,8 kg</option><option value="7,9 kg">7,9 kg</option>
            <option value="8,0 kg">8,0 kg</option><option value="8,1 kg">8,1 kg</option><option value="8,2 kg">8,2 kg</option><option value="8,3 kg">8,3 kg</option><option value="8,4 kg">8,4 kg</option>
            <option value="8,5 kg">8,5 kg</option><option value="8,6 kg">8,6 kg</option><option value="8,7 kg">8,7 kg</option><option value="8,8 kg">8,8 kg</option><option value="8,9 kg">8,9 kg</option>
            <option value="9,0 kg">9,0 kg</option><option value="9,1 kg">9,1 kg</option><option value="9,2 kg">9,2 kg</option><option value="9,3 kg">9,3 kg</option><option value="9,4 kg">9,4 kg</option>
            <option value="9,5 kg">9,5 kg</option><option value="9,6 kg">9,6 kg</option><option value="9,7 kg">9,7 kg</option><option value="9,8 kg">9,8 kg</option><option value="9,9 kg">9,9 kg</option>
            <option value="10,0 kg">10,0 kg</option><option value="10,1 kg">10,1 kg</option><option value="10,2 kg">10,2 kg</option><option value="10,3 kg">10,3 kg</option><option value="10,4 kg">10,4 kg</option>
            <option value="10,5 kg">10,5 kg</option><option value="10,6 kg">10,6 kg</option><option value="10,7 kg">10,7 kg</option><option value="10,8 kg">10,8 kg</option><option value="10,9 kg">10,9 kg</option>
            <option value="11,0 kg">11,0 kg</option><option value="11,1 kg">11,1 kg</option><option value="11,2 kg">11,2 kg</option><option value="11,3 kg">11,3 kg</option><option value="11,4 kg">11,4 kg</option>
            <option value="11,5 kg">11,5 kg</option><option value="11,6 kg">11,6 kg</option><option value="11,7 kg">11,7 kg</option><option value="11,8 kg">11,8 kg</option><option value="11,9 kg">11,9 kg</option>
            <option value="12,0 kg">12,0 kg</option>
            
        </datalist>
            <td>Fecha</td>
            <td><input type="date" id="propietarioFecha" class="date-input" onkeydown="moverFocoConFlechas(event, 'nombreMedico', 'mascotaPeso', 'nombreMedico', 'propietarioFecha')"></td>
                    </tr>
                    
                    <script>
                  function formatearFecha(input) {
                const fecha = new Date(input.value);
                const dia = String(fecha.getDate()).padStart(2, '0');
                const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                const año = fecha.getFullYear();
                input.value = `${dia}-${mes}-${año}`;
            }
       
            function moverFocoConFlechas(event, derechaId, izquierdaId, arribaId, abajoId) {
                    switch (event.key) {
                        case 'ArrowRight':
                            event.preventDefault();
                            document.getElementById(derechaId).focus();
                            break;
                        case 'ArrowLeft':
                            event.preventDefault();
                            document.getElementById(izquierdaId).focus();
                            break;
                        case 'ArrowUp':
                            event.preventDefault();
                            document.getElementById(arribaId).focus();
                            break;
                        case 'ArrowDown':
                        case 'Enter':
                            event.preventDefault();
                            document.getElementById(abajoId).focus();
                            break;
                    }
                }
                const razasCaninas = [
    "Ainu", "Airedale terrier", "Akita", "Akita Inu", "Alaskan Malamute",
    "American Black and Tan Coonhound", "American Bull Terrier", "American Pit Bull Terrier",
    "American Staffordshire terrier", "American Water Spaniel", "Apso Tibetano", "Barzoi", 
    "Basenji", "Basset Hound", "Beagle", "Bichon Frise", "Bloodhound", "Bobtail", 
    "Border Collie", "Boston Terrier", "Bouvier des Flandres", "Boxer", "Bull terrier", 
    "Bull Terrier Miniatura", "Bulldog Americano", "Bulldog Francés", "Bulldog Inglés", 
    "Bullmastiff", "Cavalier King Charles Spaniel", "Chihuahua", "Chow Chow", 
    "Cocker Spaniel Americano", "Cocker Spaniel Inglés", "Collie", "Collie Escocés", 
    "Dachshund", "Dálmata", "Doberman", "Doberman Pincher", "Dogo Alemán", 
    "Dogo Argentino", "Dogo de Burdeos", "French Poodle", "Galgo Español", 
    "Galgo Inglés-español", "Golden Retriever", "Gran Danés", "Greyhound", 
    "Husky Siberiano", "Jack Russell Terrier", "Labrador Retriever", "Maltés", 
    "Pastor Alemán", "Pequinés", "Pomerania", "Pug", "Rottweiler", "Samoyedo", 
    "San Bernardo", "Schnauzer", 
    "Shih Tzu", "SRD", "Yorkshire Terrier", "Weimaraner", "Fila Brasileiro",
];

const razasFelinas = [
    "Abisinio", "American Bobtail", "Angora Turco", "Azul Ruso", "Balinés", 
    "Bengalí", "Bobtail japonés", "Bombay", "British Shorthair", "Burmés", 
    "Carey", "Común Europeo", "Exótico", "Himalayo", "Javanés", 
    "Oriental", "Persa", "Sagrado de Birmania", "Siamés", "Siberiano", 
    "Silvestre", "SRD"
];
// Reemplazar la función de reemplazo de punto por coma
function reemplazarPuntoPorComa() {
    // Obtener todos los campos numéricos
    const camposNumericos = [
        'Glucosa', 'Colesterol_total', 'amilasa', 'CK', 
        'nitrogeno_ureico', 'creatinina', 'bun_crea', 'fosforo', 'calcio',
        'ALT', 'Fosfatasa_Alcalina', 'billirrubina_total', 'Albumina',
        'proteinas_totales', 'Globulinas', 'alb/glo'
    ];
    
    // Aplicar la funcionalidad a cada campo
    camposNumericos.forEach(id => {
        const campo = document.getElementById(id);
        if (campo) {
            // Usar keydown en lugar de input
            campo.addEventListener('keydown', function(event) {
                // Solo actuar cuando se presiona la tecla punto
                if (event.key === '.') {
                    event.preventDefault(); // Prevenir la acción por defecto
                    
                    // Obtener la posición actual del cursor
                    const cursorPos = this.selectionStart;
                    
                    // Obtener el valor actual e insertar una coma en lugar del punto
                    const valorActual = this.value;
                    const nuevoValor = valorActual.slice(0, cursorPos) + ',' + valorActual.slice(cursorPos);
                    
                    // Establecer el nuevo valor
                    this.value = nuevoValor;
                    
                    // Restaurar la posición del cursor justo después de la coma
                    setTimeout(() => {
                        this.setSelectionRange(cursorPos + 1, cursorPos + 1);
                    }, 0);
                }
            });
            
            // Mover las actualizaciones de color y cálculos al evento blur
            campo.addEventListener('blur', function() {
                actualizarColor(id, 'ref' + id.toLowerCase());
                if (id === 'Albumina' || id === 'proteinas_totales') {
                    calculateValues();
                }
            });
            
            // Eliminar cualquier evento input que pueda interferir
            const oldInputListeners = campo._inputListeners || [];
            oldInputListeners.forEach(listener => {
                campo.removeEventListener('input', listener);
            });
        }
    });
}

// Ejecutar cuando el DOM esté listo
// Asegura que el datalist de razas esté siempre en el DOM y se actualice correctamente
function inicializarDatalistRazas() {
    let datalistRazas = document.getElementById('razas');
    if (!datalistRazas) {
        datalistRazas = document.createElement('datalist');
        datalistRazas.id = 'razas';
        document.body.appendChild(datalistRazas);
    }
    // Asegura que el input apunte al datalist correcto
    const campoRaza = document.getElementById('mascotaRaza');
    if (campoRaza) {
        campoRaza.setAttribute('list', 'razas');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    inicializarDatalistRazas();
    reemplazarPuntoPorComa();
    // ...resto de código existente...
});

// Modificar la función existente
function actualizarEspecieEnPlantilla() {
    const especie = document.getElementById('especieSelector').value;
    document.getElementById('especieEnPlantilla').value = especie;
    // Actualizar las razas disponibles según la especie
    actualizarRazasPorEspecie();
    // Asegura que el datalist esté actualizado y el input apunte a él
    inicializarDatalistRazas();
}
// Función para actualizar el datalist de razas según la especie seleccionada
function actualizarRazasPorEspecie() {
    const especie = document.getElementById('especieSelector').value;
    // Crear el datalist si no existe
    let datalistRazas = document.getElementById('razas');
    if (!datalistRazas) {
        datalistRazas = document.createElement('datalist');
        datalistRazas.id = 'razas';
        document.body.appendChild(datalistRazas);
    } else {
        // Limpiar la lista actual
        datalistRazas.innerHTML = '';
    }
    
    const campoRaza = document.getElementById('mascotaRaza');
    
    // Restablecer el campo de raza si se cambia la especie
    if (campoRaza.value && campoRaza.value !== "SRD") {
        campoRaza.value = '';
    }
    
    // Agregar las razas según la especie seleccionada
    if (especie === "Canino") {
        razasCaninas.forEach(raza => {
            const option = document.createElement('option');
            option.value = raza;
            datalistRazas.appendChild(option);
        });
    } else if (especie === "Felino") {
        razasFelinas.forEach(raza => {
            const option = document.createElement('option');
            option.value = raza;
            datalistRazas.appendChild(option);
        });
    } else if (especie === "Lagomorfo" || especie === "Cuilo") {
        // Para otras especies, agregar solo opciones genéricas
        const option = document.createElement('option');
        option.value = "SRD";
        datalistRazas.appendChild(option);
    }
}

// Ejecutar al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    // Asegurarse de que existe el selector de especies
    const especieSelector = document.getElementById('especieSelector');
    if (especieSelector) {
        // Si ya hay una especie seleccionada al cargar
        if (especieSelector.value !== "Seleccionar") {
            actualizarRazasPorEspecie();
        }
        
        // Agregar un listener adicional para garantizar que se actualicen las razas
        especieSelector.addEventListener('change', actualizarRazasPorEspecie);
    }
    
    // Crear datalist si no existe
    if (!document.getElementById('razas')) {
        const datalist = document.createElement('datalist');
        datalist.id = 'razas';
        document.body.appendChild(datalist);
    }
});

            
                    </script>
                </tbody>
            </table>
<!-- Plantilla de 11 parámetros (original) -->
<div id="urianalisis11" class="urianalisis-plantilla">
<table class="urianalisis-table">
  <tr><th colspan="3">Examen Físico</th></tr>
  <!-- Examen Físico 11 parámetros -->
  <tr><td>Color</td><td><input type="text" id="color" list="colorList" onkeydown="moverFocoUrianalisis(event, 'apariencia')"></td><td></td></tr>
  <tr><td>Apariencia</td><td><input type="text" id="apariencia" list="aparienciaList" onkeydown="moverFocoUrianalisis(event, 'densidad', 'color')"></td><td></td></tr>
<datalist id="aparienciaList">
  <option value="Transparente">
  <option value="Ligeramente turbia">
  <option value="Turbia">
</datalist>
  <tr><td>Densidad</td><td><input type="text" id="densidad" onkeydown="moverFocoUrianalisis(event, 'metodo_recoleccion', 'apariencia')"></td><td>(1.005–1.040)</td></tr>
  <tr><td>Método de recolección</td><td><input type="text" id="metodo_recoleccion" list="metodoRecoleccionList" onkeydown="moverFocoUrianalisis(event, 'ph_urinario', 'densidad')"></td><td></td></tr>
  <datalist id="metodoRecoleccionList">
    <option value="Cistocentesis">
    <option value="Cateterismo">
    <option value="Micción espontánea">
  </datalist>
  <tr><th colspan="3">Examen Químico</th></tr>
  <tr><td>pH urinario</td><td><input type="text" id="ph_urinario" onkeydown="moverFocoUrianalisis(event, 'proteinas')"></td><td>(5.0–7.0)</td></tr>
<tr><td>Proteínas</td><td>
  <input type="text" id="proteinas" list="proteinasList" onkeydown="moverFocoUrianalisis(event, 'cetonas', 'ph_urinario')">
  <datalist id="proteinasList">
    <option value="Negativo">
    <option value="Positivo 1+">
    <option value="Positivo 2+">
    <option value="Positivo 3+">
  </datalist>
</td><td></td></tr>
<tr><td>Cetonas</td><td>
  <input type="text" id="cetonas" list="cetonasList" onkeydown="moverFocoUrianalisis(event, 'nitritos', 'proteinas')">
  <datalist id="cetonasList">
    <option value="Negativo">
    <option value="Positivo 1+">
    <option value="Positivo 2+">
    <option value="Positivo 3+">
  </datalist>
</td><td></td></tr>
<tr><td>Nitritos</td><td>
  <input type="text" id="nitritos" list="nitritosList" onkeydown="moverFocoUrianalisis(event, 'leucocitosQ', 'cetonas')">
  <datalist id="nitritosList">
    <option value="Negativo">
    <option value="Positivo 1+">
    <option value="Positivo 2+">
    <option value="Positivo 3+">
  </datalist>
</td><td></td></tr>
<tr><td>Leucocitos</td><td><input type="text" id="leucocitosQ" onkeydown="moverFocoUrianalisis(event, 'glucosaQ', 'nitritos')"></td><td></td></tr>
<tr><td>Glucosa</td><td>
  <input type="text" id="glucosaQ" list="glucosaQList" onkeydown="moverFocoUrianalisis(event, 'bilirrubina', 'leucocitosQ')">
  <datalist id="glucosaQList">
    <option value="Negativo">
    <option value="Positivo 1+">
    <option value="Positivo 2+">
    <option value="Positivo 3+">
  </datalist>
</td><td></td></tr>
<tr><td>Bilirrubina</td><td>
  <input type="text" id="bilirrubina" list="bilirrubinaList" onkeydown="moverFocoUrianalisis(event, 'urobilinogeno', 'glucosaQ')">
  <datalist id="bilirrubinaList">
    <option value="Negativo">
    <option value="Positivo 1+">
    <option value="Positivo 2+">
    <option value="Positivo 3+">
  </datalist>
</td><td></td></tr>
<tr><td>Urobilinógeno</td><td>
  <input type="text" id="urobilinogeno" list="urobilinogenoList" onkeydown="moverFocoUrianalisis(event, 'eritrocitos_hemoglobina', 'glucosaQ')">
  <datalist id="urobilinogenoList">
    <option value="Negativo">
    <option value="Positivo 1+">
    <option value="Positivo 2+">
    <option value="Positivo 3+">
  </datalist>
</td><td></td></tr>
<tr><td>Eritrocitos/hemoglobina</td><td>
  <input type="text" id="eritrocitos_hemoglobina" onkeydown="moverFocoUrianalisis(event, 'asc', 'urobilinogeno')">
</td><td></td></tr>
<tr><td>ASC</td><td>
  <input type="text" id="asc" list="ascList" onkeydown="moverFocoUrianalisis(event, 'celulas_transicionales', 'eritrocitos_hemoglobina')">
  <datalist id="ascList">
    <option value="Negativo">
    <option value="Positivo 1+">
    <option value="Positivo 2+">
    <option value="Positivo 3+">
  </datalist>
</td><td></td></tr>
<tr><th colspan="3">Examen Microscópico</th></tr>
<tr><td>Células transicionales</td><td>
  <input type="text" id="celulas_transicionales" list="celulasTransicionalesList" onkeydown="moverFocoUrianalisis(event, 'celulas_escamosas', 'asc')">
  <datalist id="celulasTransicionalesList">
    <option value="Escasas">
    <option value="Moderadas">
    <option value="Abundantes">
    <option value="No se observa">
  </datalist>
</td><td></td></tr>
<tr><td>Células escamosas</td><td>
  <input type="text" id="celulas_escamosas" list="celulasEscamosasList" onkeydown="moverFocoUrianalisis(event, 'celulas_renales', 'celulas_transicionales')">
  <datalist id="celulasEscamosasList">
    <option value="Escasas">
    <option value="Moderadas">
    <option value="Abundantes">
    <option value="No se observa">
  </datalist>
</td><td></td></tr>
<tr><td>Células renales</td><td>
  <input type="text" id="celulas_renales" list="celulasRenalesList" onkeydown="moverFocoUrianalisis(event, 'cilindros', 'celulas_escamosas')">
  <datalist id="celulasRenalesList">
    <option value="Escasas">
    <option value="Moderadas">
    <option value="Abundantes">
    <option value="No se observa">
  </datalist>
</td><td></td></tr>
<tr><td>Cilindros</td><td>
  <input type="text" id="cilindros" list="cilindrosList" onkeydown="moverFocoUrianalisis(event, 'eritrocitos', 'celulas_renales')">
  <datalist id="cilindrosList">
    <option value="No se observa">
  </datalist>
</td><td></td></tr>
<tr><td>Eritrocitos</td><td><input type="text" id="eritrocitos" style="width:98%" oninput="agregarXCampoEritrocitos(this)" onkeydown="moverFocoUrianalisis(event, 'leucocitos', 'cilindros')"></td><td></td></tr>
<tr><td>Leucocitos</td><td><input type="text" id="leucocitos" style="width:98%" oninput="agregarXCampoLeucocitos(this)" onkeydown="moverFocoUrianalisis(event, 'bacterias', 'eritrocitos')"></td><td></td></tr>
<tr><td>Bacterias</td><td><input type="text" id="bacterias" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'cristales', 'leucocitos')"></td><td></td></tr>
<tr><td>Cristales</td><td><input type="text" id="cristales" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'filamento_mucoso', 'bacterias')"></td><td></td></tr>
<tr><td>Filamento mucoso</td><td>
  <input type="text" id="filamento_mucoso" list="filamentoMucosoList" onkeydown="moverFocoUrianalisis(event, 'sedimento_amorfo', 'cristales')">
  <datalist id="filamentoMucosoList">
    <option value="No se observa">
    <option value="Escaso">
    <option value="Moderado">
    <option value="Abundante">
  </datalist>
</td><td></td></tr>
<tr><td>Sedimento amorfo</td><td>
  <input type="text" id="sedimento_amorfo" list="sedimentoAmorfoList" onkeydown="moverFocoUrianalisis(event, 'comentario', 'filamento_mucoso')">
  <datalist id="sedimentoAmorfoList">
    <option value="No se observa">
    <option value="Escaso">
    <option value="Moderado">
    <option value="Abundante">
  </datalist>
</td><td></td></tr>
<tr><td>Comentario:</td><td colspan="2"><input type="text" id="comentario" style="width:98%" onkeydown="moverFocoUrianalisis(event, null, 'sedimento_amorfo')"></td></tr>
</table>
<!-- Imagen de análisis para urianálisis 11 parámetros -->
<div class="image-container" style="display: flex; justify-content: center; margin: 20px 0;">
  <div class="image-box  analysis-box" style="text-align: center; margin: 0 10px; max-width: 60%;">
    <h4>Imagen del Análisis</h4>
    <div style="margin-bottom: 10px;">
      <label for="imageUploadUrianalisis11">Seleccionar imagen:</label>
      <input type="file" id="imageUploadUrianalisis11" accept="image/*" onchange="previewImageUrianalisis(event, 'previewUrianalisis11')" style="display: inline-block;">
    </div>
    <div style="margin-top: 10px; min-height: 200px; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center;">
      <img id="previewUrianalisis11" alt="Imagen del Análisis" style="max-width: 100%; max-height: 200px; display: none;">
      <span id="noImageTextUrianalisis11">Sin imagen</span>
    </div>
  </div>
</div>
</div>

<!-- Plantilla de 15 parámetros (nueva, según imagen) -->
<div id="urianalisis15" class="urianalisis-plantilla" style="display:none;">
  <table class="urianalisis-table">
    <tr><th colspan="3">Examen Físico</th></tr>
    <tr><td>Color</td><td colspan="2"><input type="text" id="color15" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'apariencia15')"></td></tr>
    <tr><td>Apariencia</td><td colspan="2"><input type="text" id="apariencia15" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'metodo_recoleccion15', 'color15')"></td></tr>
    <tr><td>Método Recolección de muestra</td><td colspan="2"><input type="text" id="metodo_recoleccion15" list="metodoRecoleccionList15" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'densidad15', 'apariencia15')"></td></tr>
    <datalist id="metodoRecoleccionList15">
      <option value="Cistocentesis">
      <option value="Cateterismo">
      <option value="Micción espontánea">
    </datalist>
    <tr><th colspan="3">Examen Químico</th></tr>
    <tr><td>Densidad</td><td><input type="text" id="densidad15" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'ph_urinario15', 'metodo_recoleccion15')"></td><td>(1.005–1.040)</td></tr>
    <tr><td>pH urinario</td><td><input type="text" id="ph_urinario15" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'proteinas15', 'densidad15')"></td><td>(5.0–7.0)</td></tr>
    <tr><td>Proteínas</td><td colspan="2"><input type="text" id="proteinas15" list="proteinasList15" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'cetonas15', 'ph_urinario15')"></td></tr>
    <datalist id="proteinasList15">
      <option value="Negativo">
      <option value="Positivo 1+">
      <option value="Positivo 2+">
      <option value="Positivo 3+">
    </datalist>
    <tr><td>Cetonas</td><td colspan="2"><input type="text" id="cetonas15" list="cetonasList15" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'nitritos15', 'proteinas15')"></td></tr>
    <datalist id="cetonasList15">
      <option value="Negativo">
      <option value="Positivo 1+">
      <option value="Positivo 2+">
      <option value="Positivo 3+">
    </datalist>
    <tr><td>Nitritos</td><td colspan="2"><input type="text" id="nitritos15" list="nitritosList15" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'leucocitosQ15', 'cetonas15')"></td></tr>
    <datalist id="nitritosList15">
      <option value="Negativo">
      <option value="Positivo 1+">
      <option value="Positivo 2+">
      <option value="Positivo 3+">
    </datalist>
    <tr><td>Leucocitos</td><td colspan="2"><input type="text" id="leucocitosQ15" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'glucosaQ15', 'nitritos15')"></td></tr>
    <tr><td>Glucosa</td><td colspan="2"><input type="text" id="glucosaQ15" list="glucosaQList15" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'bilirrubina15', 'leucocitosQ15')"></td></tr>
    <datalist id="glucosaQList15">
      <option value="Negativo">
      <option value="Positivo 1+">
      <option value="Positivo 2+">
      <option value="Positivo 3+">
    </datalist>
    <tr><td>Bilirrubina</td><td colspan="2"><input type="text" id="bilirrubina15" list="bilirrubinaList15" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'urobilinogeno15', 'glucosaQ15')"></td></tr>
    <datalist id="bilirrubinaList15">
      <option value="Negativo">
      <option value="Positivo 1+">
      <option value="Positivo 2+">
      <option value="Positivo 3+">
    </datalist>
    <tr><td>Urobilinógeno</td><td colspan="2"><input type="text" id="urobilinogeno15" list="urobilinogenoList15" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'eritrocitos_hemoglobina15', 'bilirrubina15')"></td></tr>
    <datalist id="urobilinogenoList15">
      <option value="Negativo">
      <option value="Positivo 1+">
      <option value="Positivo 2+">
      <option value="Positivo 3+">
    </datalist>
    <tr><td>Eritrocitos/hemoglobina</td><td colspan="2"><input type="text" id="eritrocitos_hemoglobina15" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'albumina15', 'urobilinogeno15')"></td></tr>
    <tr><td>Albumina</td><td colspan="2"><input type="text" id="albumina15" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'asc15', 'eritrocitos_hemoglobina15')"></td></tr>
    <tr><td>ASC</td><td colspan="2"><input type="text" id="asc15" list="ascList15" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'creatinina15', 'albumina15')"></td></tr>
    <datalist id="ascList15">
      <option value="Negativo">
      <option value="Positivo 1+">
      <option value="Positivo 2+">
      <option value="Positivo 3+">
    </datalist>
    <tr><td>Creatinina</td><td colspan="2"><input type="text" id="creatinina15" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'calcio15', 'asc15')"></td></tr>
    <tr><td>Calcio</td><td colspan="2"><input type="text" id="calcio15" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'celulas_transicionales15', 'creatinina15')"></td></tr>
    <tr><th colspan="3">Examen Microscópico</th></tr>
    <tr><td>Células transicionales</td><td colspan="2"><input type="text" id="celulas_transicionales15" list="celulasTransicionalesList15" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'celulas_escamosas15', 'calcio15')"></td></tr>
    <datalist id="celulasTransicionalesList15">
      <option value="Escasas">
      <option value="Moderadas">
      <option value="Abundantes">
      <option value="No se observa">
    </datalist>
    <tr><td>Células escamosas</td><td colspan="2"><input type="text" id="celulas_escamosas15" list="celulasEscamosasList15" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'celulas_renales15', 'celulas_transicionales15')"></td></tr>
    <datalist id="celulasEscamosasList15">
      <option value="Escasas">
      <option value="Moderadas">
      <option value="Abundantes">
      <option value="No se observa">
    </datalist>
    <tr><td>Células renales</td><td colspan="2"><input type="text" id="celulas_renales15" list="celulasRenalesList15" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'cilindros15', 'celulas_escamosas15')"></td></tr>
    <datalist id="celulasRenalesList15">
      <option value="Escasas">
      <option value="Moderadas">
      <option value="Abundantes">
      <option value="No se observa">
    </datalist>
    <tr><td>Cilindros</td><td colspan="2"><input type="text" id="cilindros15" list="cilindrosList15" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'eritrocitos15', 'celulas_renales15')"></td></tr>
    <datalist id="cilindrosList15">
      <option value="No se observa">
    </datalist>
    <tr><td>Eritrocitos</td><td colspan="2"><input type="text" id="eritrocitos15" style="width:98%" oninput="agregarXCampoEritrocitos15(this)" onkeydown="moverFocoUrianalisis(event, 'leucocitos15', 'cilindros15')"></td></tr>
    <tr><td>Leucocitos</td><td colspan="2"><input type="text" id="leucocitos15" style="width:98%" oninput="agregarXCampoLeucocitos15(this)" onkeydown="moverFocoUrianalisis(event, 'bacterias15', 'eritrocitos15')"></td></tr>
    <tr><td>Bacterias</td><td colspan="2"><input type="text" id="bacterias15" style="width:98%"></td></tr>
    <tr><td>Cristales</td><td colspan="2"><input type="text" id="cristales15" style="width:98%"></td></tr>
    <tr><td>Filamento mucoso</td><td colspan="2"><input type="text" id="filamento_mucoso15" list="filamentoMucosoList15" style="width:98%"></td></tr>
    <datalist id="filamentoMucosoList15">
      <option value="No se observa">
      <option value="Escaso">
      <option value="Moderado">
      <option value="Abundante">
    </datalist>
    <tr><td>Sedimento amorfo</td><td colspan="2"><input type="text" id="sedimento_amorfo15" list="sedimentoAmorfoList15" style="width:98%" onkeydown="moverFocoUrianalisis(event, 'comentario15', 'filamento_mucoso15')"></td></tr>
    <datalist id="sedimentoAmorfoList15">
      <option value="No se observa">
      <option value="Escaso">
      <option value="Moderado">
      <option value="Abundante">
    </datalist>
    <!-- Tinción gram -->
    <tr id="row_tincion_gram15">
      <td>Tinción gram</td>
      <td colspan="2">
        <input type="text" id="tincion_gram15" list="tincionGramList15" style="width:85%">
      </td>
    </tr>
    <datalist id="tincionGramList15">
      <option value="Bacterias Gram Positivas">
      <option value="Bacterias Gram Negativas">
    </datalist>
    <script>
    function eliminarTincionGram15() {
      var row = document.getElementById('row_tincion_gram15');
      if(row) {
        row.remove();
        console.log('Tinción gram eliminada');
      } else {
        console.error('No se encontró la fila de tinción gram');
      }
    }
    </script>
    <tr><td>Comentario:</td><td colspan="2"><input type="text" id="comentario" style="width:98%"></td></tr>
  </table>
  <!-- Imagen de análisis para urianálisis 15 parámetros -->
<div class="image-container" style="display: flex; justify-content: center; margin: 20px 0;">
  <div class="image-box analysis-box" style="text-align: center; margin: 0 10px; max-width: 60%;">
    <h4>Imagen del Análisis</h4>
    <div style="margin-bottom: 10px;">
      <label for="imageUploadUrianalisis15">Seleccionar imagen:</label>
      <input type="file" id="imageUploadUrianalisis15" accept="image/*" onchange="previewImageUrianalisis(event, 'previewUrianalisis15')" style="display: inline-block;">
    </div>
    <div style="margin-top: 10px; min-height: 200px; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center;">
      <img id="previewUrianalisis15" alt="Imagen del Análisis" style="max-width: 100%; max-height: 200px; display: none;">
      <span id="noImageTextUrianalisis15">Sin imagen</span>
    </div>
  </div>
</div>
</div>

<script>
// Variable global para almacenar la imagen de análisis
let urianalisisImageDataUrl = '';

function previewImageUrianalisis(event, previewId) {
  const file = event.target.files[0];
  const preview11 = document.getElementById('previewUrianalisis11');
  const preview15 = document.getElementById('previewUrianalisis15');
  const noImageText11 = document.getElementById('noImageTextUrianalisis11');
  const noImageText15 = document.getElementById('noImageTextUrianalisis15');
  if (file) {
    const reader = new FileReader();
    reader.onload = function() {
      urianalisisImageDataUrl = reader.result;
      if (preview11) {
        preview11.src = urianalisisImageDataUrl;
        preview11.style.display = 'block';
        if (noImageText11) noImageText11.style.display = 'none';
      }
      if (preview15) {
        preview15.src = urianalisisImageDataUrl;
        preview15.style.display = 'block';
        if (noImageText15) noImageText15.style.display = 'none';
      }
    }
    reader.readAsDataURL(file);
  } else {
    if (preview11) preview11.style.display = 'none';
    if (preview15) preview15.style.display = 'none';
    if (noImageText11) noImageText11.style.display = 'block';
    if (noImageText15) noImageText15.style.display = 'block';
    urianalisisImageDataUrl = '';
  }
}

// Al cambiar de plantilla, mantener la imagen previsualizada
function mostrarPlantillaUrianalisis() {
  var select = document.getElementById('plantillaUrianalisisSelect');
  var plantilla11 = document.getElementById('urianalisis11');
  var plantilla15 = document.getElementById('urianalisis15');
  if (select.value === '11') {
    plantilla11.style.display = '';
    plantilla15.style.display = 'none';
  } else {
    plantilla11.style.display = 'none';
    plantilla15.style.display = '';
  }
  // Refrescar la previsualización de imagen al cambiar de plantilla
  const preview11 = document.getElementById('previewUrianalisis11');
  const preview15 = document.getElementById('previewUrianalisis15');
  const noImageText11 = document.getElementById('noImageTextUrianalisis11');
  const noImageText15 = document.getElementById('noImageTextUrianalisis15');
  if (urianalisisImageDataUrl) {
    if (preview11) {
      preview11.src = urianalisisImageDataUrl;
      preview11.style.display = 'block';
      if (noImageText11) noImageText11.style.display = 'none';
    }
    if (preview15) {
      preview15.src = urianalisisImageDataUrl;
      preview15.style.display = 'block';
      if (noImageText15) noImageText15.style.display = 'none';
    }
  } else {
    if (preview11) preview11.style.display = 'none';
    if (preview15) preview15.style.display = 'none';
    if (noImageText11) noImageText11.style.display = 'block';
    if (noImageText15) noImageText15.style.display = 'block';
  }
}

// Generar PDF con dos páginas: 1) tabla, 2) imagen de análisis y footer
async function generatePDF() {
    const loadingIndicator = document.getElementById('loadingPdf');
    const pdfButton = document.getElementById('pdfButton');
    loadingIndicator.style.display = 'flex';
    pdfButton.disabled = true;
    try {
        const { jsPDF } = window.jspdf;
        // Seleccionar la plantilla activa (11 o 15 parámetros)
        const select = document.getElementById('plantillaUrianalisisSelect');
        const plantilla11 = document.getElementById('urianalisis11');
        const plantilla15 = document.getElementById('urianalisis15');
        const selectedPlantilla = select.value === '15' ? plantilla15 : plantilla11;
        // Clonar el contenedor principal para capturar cabecera, datos y tabla
        const container = document.querySelector('.container');
        const containerClone = container.cloneNode(true);
        // Mostrar solo la plantilla seleccionada en el clon
        containerClone.querySelectorAll('.urianalisis-plantilla').forEach(div => {
            div.style.display = 'none';
        });
        const plantillaClon = containerClone.querySelector(select.value === '15' ? '#urianalisis15' : '#urianalisis11');
        if (plantillaClon) plantillaClon.style.display = 'block';
        // Copiar valores de los inputs (excepto file)
        containerClone.querySelectorAll('input, select, textarea').forEach(function(element) {
            const original = document.getElementById(element.id);
            if (!original) return;
            if (element.tagName === 'INPUT') {
                if (element.type === 'file') return;
                if (element.type === 'checkbox' || element.type === 'radio') {
                    element.checked = original.checked;
                } else {
                    element.value = original.value;
                }
            } else if (element.tagName === 'SELECT' || element.tagName === 'TEXTAREA') {
                element.value = original.value;
            }
        });
        // Ocultar la imagen y el footer en la primera página
        containerClone.querySelectorAll('.image-container, .footer').forEach(el => el.style.display = 'none');
        // Crear contenedor temporal para renderizar
        const tempDiv1 = document.createElement('div');
        tempDiv1.style.width = '800px';
        tempDiv1.style.background = '#fff';
        tempDiv1.appendChild(containerClone);
        document.body.appendChild(tempDiv1);
        const canvas1 = await html2canvas(tempDiv1, {
            scale: 2,
            useCORS: true,
            logging: false,
            allowTaint: true,
            backgroundColor: '#ffffff'
        });
        document.body.removeChild(tempDiv1);
        const imgData1 = canvas1.toDataURL('image/jpeg', 1.0);
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 150;
        const imgHeight = (canvas1.height * imgWidth) / canvas1.width;
        const x = (pdf.internal.pageSize.getWidth() - imgWidth) / 2;
        const y = 5;
        pdf.addImage(imgData1, 'JPEG', x, y, imgWidth, imgHeight);

        // --- SEGUNDA PÁGINA: imagen de análisis y footer ---
        pdf.addPage();
        const tempDiv2 = document.createElement('div');
        tempDiv2.style.width = '800px';
        tempDiv2.style.background = '#fff';
        // Imagen de análisis (solo si existe y es válida)
        if (typeof urianalisisImageDataUrl === 'string' && urianalisisImageDataUrl.startsWith('data:image')) {
            const img = document.createElement('img');
            img.src = urianalisisImageDataUrl;
            img.style.maxWidth = '100%';
            img.style.maxHeight = '400px';
            img.style.display = 'block';
            img.style.margin = '30px auto 20px auto';
            tempDiv2.appendChild(img);
        }
        // Footer
        const footerClone = document.querySelector('.footer')?.cloneNode(true);
        if (footerClone) {
            footerClone.style.marginTop = '40px';
            tempDiv2.appendChild(footerClone);
        }
        document.body.appendChild(tempDiv2);
        const canvas2 = await html2canvas(tempDiv2, {
            scale: 2,
            useCORS: true,
            logging: false,
            allowTaint: true,
            backgroundColor: '#ffffff'
        });
        document.body.removeChild(tempDiv2);
        const imgData2 = canvas2.toDataURL('image/jpeg', 1.0);
        const imgWidth2 = 150;
        const imgHeight2 = (canvas2.height * imgWidth2) / canvas2.width;
        const x2 = (pdf.internal.pageSize.getWidth() - imgWidth2) / 2;
        const y2 = 10;
        pdf.addImage(imgData2, 'JPEG', x2, y2, imgWidth2, imgHeight2);
        // Guardar PDF
        const mascotaNombre = document.getElementById('mascotaNombre').value || 'Sin_nombre';
        const propietarioNombre = document.getElementById('propietarioNombre').value || 'Sin_apellido';
        const propietarioApellido = propietarioNombre.split(' ').length > 1 ? propietarioNombre.split(' ')[1] : propietarioNombre;
        const fileName = `Urianálisis ${mascotaNombre} ${propietarioApellido}.pdf`;
        pdf.save(fileName);
    } catch (error) {
        console.error('Error al generar el PDF:', error);
        alert('Ocurrió un error al generar el PDF: ' + error.message);
    } finally {
        loadingIndicator.style.display = 'none';
        pdfButton.disabled = false;
    }
}
</script>
<script>
function agregarXCampoEritrocitos(input) {
    let valor = input.value.trim();
    // Si ya tiene 'x campo', no hacer nada
    if (valor.endsWith('x campo')) return;
    // Si es número o <1, agregar ' x campo'
    if (/^<?\d+(,\d+)?$/.test(valor) || valor === '<1') {
        input.value = valor + ' x campo';
    }
    // Si el usuario borra todo, dejar vacío
    if (valor === '') {
        input.value = '';
    }
}

function agregarXCampoLeucocitos(input) {
    let valor = input.value.trim();
    if (valor.endsWith('x campo')) return;
    if (/^<?\d+(,\d+)?$/.test(valor) || valor === '<1') {
        input.value = valor + ' x campo';
    }
    if (valor === '') {
        input.value = '';
    }
}
function moverFocoUrianalisis(event, siguienteId, anteriorId) {
    if (event.key === 'Enter' || event.key === 'ArrowDown') {
        if (siguienteId) {
            event.preventDefault();
            const siguiente = document.getElementById(siguienteId);
            if (siguiente) siguiente.focus();
        }
    } else if (event.key === 'ArrowUp') {
        if (anteriorId) {
            event.preventDefault();
            const anterior = document.getElementById(anteriorId);
            if (anterior) anterior.focus();
        }
    }
}
</script>
  <div class="footer">
    <p id="mensajeMedico" style="display: none;">El personal médico cuenta con un plazo de 24 a 48 horas para interpretar el reporte de los resultados.</p>
    <p>Facebook: Veterinaria San Martin de Porres | Teléfono: 4000 - 1365 | Ext: 106</p>
    <p>WhatsApp: 8839 - 2214 | San Rafael Abajo de Desamparados, 50 metros Norte del Mall Zona Centro</p>
    <p>Correo: laboratorio@vetsanmartin.com</p>
</div>
        </div>
    </body>
    <div class="controls">
    <button id="pdfButton" onclick="generatePDF()">Generar PDF</button>
    <button id="menuButton" onclick="window.location.href='index.html'">Volver al Menú</button>
    <button type="button" onclick="eliminarTincionGram15()" title="Eliminar Tinción Gram" style="margin-left: 5px; padding: 5px 10px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">🗑️</button>
    <div id="loadingPdf" class="loading-indicator" style="display:none;">
        <div class="spinner"></div>
        <span>Generando PDF...</span>
    </div>
</div>

<script>
async function generatePDF() {
    const loadingIndicator = document.getElementById('loadingPdf');
    const pdfButton = document.getElementById('pdfButton');
    loadingIndicator.style.display = 'flex';
    pdfButton.disabled = true;
    try {
        const { jsPDF } = window.jspdf;
        // Seleccionar la plantilla activa (11 o 15 parámetros)
        const select = document.getElementById('plantillaUrianalisisSelect');
        const plantilla11 = document.getElementById('urianalisis11');
        const plantilla15 = document.getElementById('urianalisis15');
        const selectedPlantilla = select.value === '15' ? plantilla15 : plantilla11;
        // Clonar el contenedor principal para capturar cabecera, datos y tabla
        const container = document.querySelector('.container');
        const containerClone = container.cloneNode(true);
        // Mostrar solo la plantilla seleccionada en el clon
        containerClone.querySelectorAll('.urianalisis-plantilla').forEach(div => {
            div.style.display = 'none';
        });
        const plantillaClon = containerClone.querySelector(select.value === '15' ? '#urianalisis15' : '#urianalisis11');
        if (plantillaClon) plantillaClon.style.display = 'block';
        // Copiar valores de los inputs (excepto file)
        containerClone.querySelectorAll('input, select, textarea').forEach(function(element) {
            const original = document.getElementById(element.id);
            if (!original) return;
            if (element.tagName === 'INPUT') {
                if (element.type === 'file') return;
                if (element.type === 'checkbox' || element.type === 'radio') {
                    element.checked = original.checked;
                } else {
                    element.value = original.value;
                }
            } else if (element.tagName === 'SELECT' || element.tagName === 'TEXTAREA') {
                element.value = original.value;
            }
        });
        // Ocultar la imagen y el footer en la primera página
        containerClone.querySelectorAll('.image-container, .footer').forEach(el => el.style.display = 'none');
        // Crear contenedor temporal para renderizar
        const tempDiv1 = document.createElement('div');
        tempDiv1.style.width = '800px';
        tempDiv1.style.background = '#fff';
        tempDiv1.appendChild(containerClone);
        document.body.appendChild(tempDiv1);
        const canvas1 = await html2canvas(tempDiv1, {
            scale: 2,
            useCORS: true,
            logging: false,
            allowTaint: true,
            backgroundColor: '#ffffff'
        });
        document.body.removeChild(tempDiv1);
        const imgData1 = canvas1.toDataURL('image/jpeg', 1.0);
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 150;
        const imgHeight = (canvas1.height * imgWidth) / canvas1.width;
        const x = (pdf.internal.pageSize.getWidth() - imgWidth) / 2;
        const y = 5;
        pdf.addImage(imgData1, 'JPEG', x, y, imgWidth, imgHeight);

        // --- SEGUNDA PÁGINA: imagen de análisis y footer ---
        pdf.addPage();
        const tempDiv2 = document.createElement('div');
        tempDiv2.style.width = '800px';
        tempDiv2.style.background = '#fff';
        // Imagen de análisis (solo si existe y es válida)
        if (typeof urianalisisImageDataUrl === 'string' && urianalisisImageDataUrl.startsWith('data:image')) {
          const img = document.createElement('img');
          img.src = urianalisisImageDataUrl;
          img.style.maxWidth = '100%';
          img.style.maxHeight = '400px';
          img.style.display = 'block';
          img.style.margin = '30px auto 20px auto';
          tempDiv2.appendChild(img);
        }
        // Footer
        const footerClone = document.querySelector('.footer')?.cloneNode(true);
        if (footerClone) {
          footerClone.style.marginTop = '40px';
          tempDiv2.appendChild(footerClone);
        }
        document.body.appendChild(tempDiv2);
        const canvas2 = await html2canvas(tempDiv2, {
          scale: 2,
          useCORS: true,
          logging: false,
          allowTaint: true,
          backgroundColor: '#ffffff'
        });
        document.body.removeChild(tempDiv2);
        const imgData2 = canvas2.toDataURL('image/jpeg', 1.0);
        const imgWidth2 = 150;
        const imgHeight2 = (canvas2.height * imgWidth2) / canvas2.width;
        const x2 = (pdf.internal.pageSize.getWidth() - imgWidth2) / 2;
        const y2 = 10;
        pdf.addImage(imgData2, 'JPEG', x2, y2, imgWidth2, imgHeight2);
        // Guardar PDF
        const mascotaNombre = document.getElementById('mascotaNombre').value || 'Sin_nombre';
        const propietarioNombre = document.getElementById('propietarioNombre').value || 'Sin_apellido';
        const propietarioApellido = propietarioNombre.split(' ').length > 1 ? propietarioNombre.split(' ')[1] : propietarioNombre;
        const fileName = `Urianálisis ${mascotaNombre} ${propietarioApellido}.pdf`;
        pdf.save(fileName);
    } catch (error) {
        console.error('Error al generar el PDF:', error);
        alert('Ocurrió un error al generar el PDF: ' + error.message);
    } finally {
        loadingIndicator.style.display = 'none';
        pdfButton.disabled = false;
    }
}
</script>
<script>
function agregarXCampoEritrocitos15(input) {
    let valor = input.value.trim();
    if (valor.endsWith('x campo')) return;
    if (/^<?\d+(,\d+)?$/.test(valor) || valor === '<1') {
        input.value = valor + ' x campo';
    }
    if (valor === '') {
        input.value = '';
    }
}
function agregarXCampoLeucocitos15(input) {
    let valor = input.value.trim();
    if (valor.endsWith('x campo')) return;
    if (/^<?\d+(,\d+)?$/.test(valor) || valor === '<1') {
        input.value = valor + ' x campo';
    }
    if (valor === '') {
        input.value = '';
    }
}
</script>
</html>
