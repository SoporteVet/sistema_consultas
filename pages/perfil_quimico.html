<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Plantillas</title>
    <link rel="stylesheet" href="index_lab.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=ABeeZee:ital@0;1&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=League+Spartan:wght@100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
</head>
<body>
<script>
// Autollenado Perfil Químico
document.addEventListener('DOMContentLoaded', function(){
  try {
    const p = new URLSearchParams(location.search);
    const setVal = (id, v) => { const el = document.getElementById(id); if (el && v) el.value = v; };
    setVal('mascotaNombre', p.get('mascotaNombre'));
    setVal('propietarioNombre', p.get('propietarioNombre'));
    setVal('propietarioCedula', p.get('propietarioCedula'));
    setVal('propietarioTelefono', p.get('propietarioTelefono'));
    setVal('propietarioEmail', p.get('propietarioEmail'));
    setVal('nombreMedico', p.get('nombreMedico'));
    setVal('mascotaRaza', p.get('mascotaRaza'));
    setVal('mascotaEdad', p.get('mascotaEdad'));
    setVal('mascotaPeso', p.get('mascotaPeso'));
    
    // Cambiar el header según el tipo de plantilla
    const template = p.get('template');
    const headerElement = document.getElementById('reportHeader');
    const interferenceSection = document.getElementById('interferenceIndicesSection');
    const lipasaRow = document.getElementById('lipasaRow');
    const funcionamientoRenalTitle = document.getElementById('funcionamientoRenalTitle');
    const funcionamientoHepaticoTitle = document.getElementById('funcionamientoHepaticoTitle');
    const funcionamientoSanguineoTitle = document.getElementById('funcionamientoSanguineoTitle');
    
    if (headerElement) {
      if (template === 'analitos_laboratorio') {
        headerElement.textContent = 'ANALITOS LABORATORIO';
      } else {
        headerElement.textContent = 'PERFIL QUIMICO GENERAL';
      }
    }
    
    // Ocultar sección de Índices de Interferencia para analitos_laboratorio
    if (interferenceSection) {
      if (template === 'analitos_laboratorio') {
        interferenceSection.style.display = 'none';
      } else {
        interferenceSection.style.display = 'block';
      }
    }
    
    // Ocultar títulos de funcionamiento para analitos_laboratorio
    if (funcionamientoRenalTitle) {
      if (template === 'analitos_laboratorio') {
        funcionamientoRenalTitle.style.display = 'none';
      } else {
        funcionamientoRenalTitle.style.display = 'block';
      }
    }
    
    if (funcionamientoHepaticoTitle) {
      if (template === 'analitos_laboratorio') {
        funcionamientoHepaticoTitle.style.display = 'none';
      } else {
        funcionamientoHepaticoTitle.style.display = 'block';
      }
    }
    
    if (funcionamientoSanguineoTitle) {
      if (template === 'analitos_laboratorio') {
        funcionamientoSanguineoTitle.style.display = 'none';
      } else {
        funcionamientoSanguineoTitle.style.display = 'block';
      }
    }
    
    // LIPASA siempre visible - se puede eliminar manualmente si es necesario
    if (lipasaRow) {
      lipasaRow.style.display = 'table-row';
    }
    
    // Recargar la lista de parámetros después de detectar el template
    setTimeout(() => {
      if (typeof cargarListaDeParametros === 'function') {
        cargarListaDeParametros();
      }
    }, 200);
    
    // Verificar el mensaje del médico después del autollenado
    const medico = p.get('nombreMedico');
    if (medico) {
      setTimeout(() => {
        verificarMedico();
      }, 100);
    }
  } catch(e){}
});

// Función adicional para asegurar que el header se cambie
function updateHeaderBasedOnTemplate() {
  const p = new URLSearchParams(location.search);
  const template = p.get('template');
  const headerElement = document.getElementById('reportHeader');
  const interferenceSection = document.getElementById('interferenceIndicesSection');
  const lipasaRow = document.getElementById('lipasaRow');
  const funcionamientoRenalTitle = document.getElementById('funcionamientoRenalTitle');
  const funcionamientoHepaticoTitle = document.getElementById('funcionamientoHepaticoTitle');
  const funcionamientoSanguineoTitle = document.getElementById('funcionamientoSanguineoTitle');
  
  if (headerElement) {
    if (template === 'analitos_laboratorio') {
      headerElement.textContent = 'ANALITOS LABORATORIO';
    } else {
      headerElement.textContent = 'PERFIL QUIMICO GENERAL';
    }
  }
  
  // Ocultar sección de Índices de Interferencia para analitos_laboratorio
  if (interferenceSection) {
    if (template === 'analitos_laboratorio') {
      interferenceSection.style.display = 'none';
    } else {
      interferenceSection.style.display = 'block';
    }
  }
  
  // Ocultar títulos de funcionamiento para analitos_laboratorio
  if (funcionamientoRenalTitle) {
    if (template === 'analitos_laboratorio') {
      funcionamientoRenalTitle.style.display = 'none';
    } else {
      funcionamientoRenalTitle.style.display = 'block';
    }
  }
  
  // Agregar/quitar clase para ocultar encabezados de tablas en modo analitos
  if (template === 'analitos_laboratorio') {
    document.body.classList.add('analitos-mode');
  } else {
    document.body.classList.remove('analitos-mode');
  }
  
  if (funcionamientoHepaticoTitle) {
    if (template === 'analitos_laboratorio') {
      funcionamientoHepaticoTitle.style.display = 'none';
    } else {
      funcionamientoHepaticoTitle.style.display = 'block';
    }
  }
  
  if (funcionamientoSanguineoTitle) {
    if (template === 'analitos_laboratorio') {
      funcionamientoSanguineoTitle.style.display = 'none';
    } else {
      funcionamientoSanguineoTitle.style.display = 'block';
    }
  }
  
  // LIPASA siempre visible - se puede eliminar manualmente si es necesario
  if (lipasaRow) {
    lipasaRow.style.display = 'table-row';
  }
  
  // Recargar la lista de parámetros después de detectar el template
  if (typeof cargarListaDeParametros === 'function') {
    cargarListaDeParametros();
  }
}

// Ejecutar también cuando el DOM esté completamente listo
document.addEventListener('DOMContentLoaded', updateHeaderBasedOnTemplate);

// Ejecutar también después de un pequeño delay por si hay problemas de timing
setTimeout(updateHeaderBasedOnTemplate, 100);

</script>
    <body>
        <div class="controls">
            <label for="sexoSelector">Selecciona el sexo:</label>
            <select id="sexoSelector" onchange="actualizarSexoEnPlantilla(),actualizarValoresReferencia2()">
                <option value="Seleccionar" selected>-- Seleccionar --</option>
                <option value="Macho">Macho</option>
                <option value="Hembra">Hembra</option>
            </select>
            <label for="especieSelector">Selecciona la especie:</label>
            <select id="especieSelector" onchange="actualizarEspecieEnPlantilla(),actualizarValoresReferencia2()">
                <option value="Seleccionar" selected>-- Seleccionar --</option>
                <option value="Canino">Canino</option>
                <option value="Felino">Felino</option>
                <option value="Lagomorfo">Lagomorfo</option>
                <option value="Cuilo">Cuilo</option>
            </select>
            <label for="edadSelector">Selecciona el rango de edad:</label>
            <select id="edadSelector" onchange="actualizarValoresReferencia2()">
                <option value="Seleccionar" selected>-- Seleccionar --</option>
                <option value="De 1 año a 12 años">De 1 año a 12 años</option>
                <option value="De 6 meses a 1 año">De 6 meses a 1 año</option>
                <option value="De 3 meses a 6 meses">De 3 meses a 6 meses</option>
                <option value="De 0 meses a mes y medio">De 0 meses a mes y medio</option>
                <option value="Todas las edades">Todas las edades</option>
            </select>
        </div>
        <div class="container" id="template1" style="display: block;">
        <div class="header">
            <img src="empresa.jpg" alt="Logo de la Empresa" class="small-image">
            <h1>Laboratorio Clínico Veterinario</h1>
        </div>
        <h3 class="subheader" id="reportHeader">PERFIL QUIMICO GENERAL</h3>
            <table>
                <thead>
                    <tr>
                        <th colspan="2">DATOS DE LA MASCOTA</th>
                        <th colspan="2">DATOS DEL PROPIETARIO</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Nombre</td>
                        <td><input type="text" id="mascotaNombre" onkeydown="moverFocoConFlechas(event, 'propietarioNombre', 'propietarioNombre', 'mascotaNombre', 'mascotaRaza')"></td>
                        <td>Nombre</td>
                        <td><input type="text" id="propietarioNombre"  onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaNombre', 'mascotaNombre', 'propietarioCedula')"></td>
                    </tr>
                    <tr>
                        <td>Raza</td>
                        <td><input type="text" id="mascotaRaza" list="razas"  onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaNombre', 'mascotaNombre', 'mascotaSexo')"></td>
                        <datalist id="razas">

                        </datalist>
                        <td>Cédula</td>
                        <td><input type="text" id="propietarioCedula"  onkeydown="moverFocoConFlechas(event, 'propietarioTelefono', 'mascotaRaza', 'propietarioNombre', 'propietarioTelefono')"></td>
                    </tr>
                    <tr>
                        <td>Sexo</td>
                        <td><input type="text" id="sexoEnPlantilla"></td>
                        <td>Teléfono</td>
                        <td><input type="text" id="propietarioTelefono" onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaSexo', 'propietarioCedula', 'propietarioEmail')"></td>
                    </tr>
                    <tr>
                        <td>Especie</td>
                        <td><input type="text" id="especieEnPlantilla"></td>
                        <td>Email</td>
                        <td><input type="text" id="propietarioEmail"  onkeydown="moverFocoConFlechas(event, 'mascotaEspecie', 'mascotaEspecie', 'propietarioTelefono', 'nombreMedico')"></td>
                    </tr>
                    <tr>
                        <td>Edad</td>
                        <td><input type="text" id="mascotaEdad" list="edades"  onkeydown="moverFocoConFlechas(event, 'nombreMedico', 'mascotaEspecie', 'mascotaEspecie', 'mascotaPeso')"></td>
    
                        <datalist id="edades">
                        <option value="1 mes"><option value="2 meses"><option value="3 meses"><option value="4 meses">
                        <option value="5 meses"><option value="6 meses"><option value="7 meses"><option value="8 meses"><option value="9 meses">
                        <option value="10 meses"><option value="11 meses"><option value="12 meses">
                        <option value="1 año"><option value="2 años"><option value="3 años"><option value="4 años">
                        <option value="5 años"><option value="6 años"><option value="7 años"><option value="8 años"><option value="9 años">
                        <option value="10 años"><option value="11 años"><option value="12 años"><option value="13 años"></option><option value="14 años"></option>
                        <option value="15 años"><option value="16 años"><option value="17 años"><option value="18 años"></option>
                        <option value="19 años"><option value="20 años"></option>    
                    </datalist>
                        <td>Médico</td>
                        <td>
                            <input type="text" id="nombreMedico" list="medicos" 
                                onkeydown="moverFocoConFlechas(event, 'propietarioFecha', 'mascotaEdad', 'propietarioEmail', 'propietarioFecha')" 
                                oninput="verificarMedico()">
                        </td>
                        <datalist id="medicos">
                            <option value="N.A">
                            <option value="Dr. Randall Azofeifa">
                            <option value="Dr. Luis Coto">
                            <option value="Dr. Gustavo Gónzalez">
                            <option value="Dra. Daniela Sancho">
                            <option value="Dra. Sofia Carrillo">
                            <option value="Dra. Franciny Nuñez">
                            <option value="Dra. Lourdes Chacón">
                            <option value="Dra. Alejandra León">
                            <option value="Dra. Karla Quesada">
                            <option value="Dra. Kharen Moreno">
                            <option value="Dra. Karina Madrigal">
                            <option value="Dra. Natalia Alvarado">
                        </datalist>
                    </tr>
                    <tr>
                        <script>    
                            function actualizarSexoEnPlantilla() {
                                const sexo = document.getElementById('sexoSelector').value;
                                document.getElementById('sexoEnPlantilla').value = sexo.charAt(0).toUpperCase() + sexo.slice(1);
                            }
                            function actualizarEspecieEnPlantilla() {
                                const especie = document.getElementById('especieSelector').value;
                                document.getElementById('especieEnPlantilla').value = especie;
                            }
                            function verificarMedico() {
                                const medico = document.getElementById('nombreMedico').value;
                                const mensaje = document.getElementById('mensajeMedico');
                                if (medico === 'N.A' || medico === 'NA' || medico === '' || medico === 'N.A.' || medico.toLowerCase() === 'na') {
                                    mensaje.style.display = 'none';
                                } else {
                                    mensaje.style.display = 'block';
                                }
                            }
                            
                            </script>
                    </tr>
                    <tr>
                        <td>Peso</td>
    <td><input type="text" id="mascotaPeso" list="pesos" onkeydown="moverFocoConFlechas(event, 'propietarioFecha', 'mascotaEdad', 'mascotaEdad', 'mascotaPeso')"></td>
    
        <datalist id="pesos">
            <option value="N.A">N.A</option><option value="0,1 kg">0,1 kg</option><option value="0,2 kg">0,2 kg</option><option value="0,3 kg">0,3 kg</option><option value="0,4 kg">0,4 kg</option>
            <option value="0,5 kg">0,5 kg</option><option value="0,6 kg">0,6 kg</option><option value="0,7 kg">0,7 kg</option><option value="0,8 kg">0,8 kg</option><option value="0,9 kg">0,9 kg</option>
            <option value="1,0 kg">1,0 kg</option><option value="1,1 kg">1,1 kg</option><option value="1,2 kg">1,2 kg</option><option value="1,3 kg">1,3 kg</option><option value="1,4 kg">1,4 kg</option>
            <option value="1,5 kg">1,5 kg</option><option value="1,6 kg">1,6 kg</option><option value="1,7 kg">1,7 kg</option><option value="1,8 kg">1,8 kg</option><option value="1,9 kg">1,9 kg</option>
            <option value="2,0 kg">2,0 kg</option><option value="2,1 kg">2,1 kg</option><option value="2,2 kg">2,2 kg</option><option value="2,3 kg">2,3 kg</option><option value="2,4 kg">2,4 kg</option>
            <option value="2,5 kg">2,5 kg</option><option value="2,6 kg">2,6 kg</option><option value="2,7 kg">2,7 kg</option><option value="2,8 kg">2,8 kg</option><option value="2,9 kg">2,9 kg</option>
            <option value="3,0 kg">3,0 kg</option><option value="3,1 kg">3,1 kg</option><option value="3,2 kg">3,2 kg</option><option value="3,3 kg">3,3 kg</option><option value="3,4 kg">3,4 kg</option>
            <option value="3,5 kg">3,5 kg</option><option value="3,6 kg">3,6 kg</option><option value="3,7 kg">3,7 kg</option><option value="3,8 kg">3,8 kg</option><option value="3,9 kg">3,9 kg</option>
            <option value="4,0 kg">4,0 kg</option><option value="4,1 kg">4,1 kg</option><option value="4,2 kg">4,2 kg</option><option value="4,3 kg">4,3 kg</option><option value="4,4 kg">4,4 kg</option>
            <option value="4,5 kg">4,5 kg</option><option value="4,6 kg">4,6 kg</option><option value="4,7 kg">4,7 kg</option><option value="4,8 kg">4,8 kg</option><option value="4,9 kg">4,9 kg</option>
            <option value="5,0 kg">5,0 kg</option><option value="5,1 kg">5,1 kg</option><option value="5,2 kg">5,2 kg</option><option value="5,3 kg">5,3 kg</option><option value="5,4 kg">5,4 kg</option>
            <option value="5,5 kg">5,5 kg</option><option value="5,6 kg">5,6 kg</option><option value="5,7 kg">5,7 kg</option><option value="5,8 kg">5,8 kg</option><option value="5,9 kg">5,9 kg</option>
            <option value="6,0 kg">6,0 kg</option><option value="6,1 kg">6,1 kg</option><option value="6,2 kg">6,2 kg</option><option value="6,3 kg">6,3 kg</option><option value="6,4 kg">6,4 kg</option>
            <option value="6,5 kg">6,5 kg</option><option value="6,6 kg">6,6 kg</option><option value="6,7 kg">6,7 kg</option><option value="6,8 kg">6,8 kg</option><option value="6,9 kg">6,9 kg</option>
            <option value="7,0 kg">7,0 kg</option><option value="7,1 kg">7,1 kg</option><option value="7,2 kg">7,2 kg</option><option value="7,3 kg">7,3 kg</option><option value="7,4 kg">7,4 kg</option>
            <option value="7,5 kg">7,5 kg</option><option value="7,6 kg">7,6 kg</option><option value="7,7 kg">7,7 kg</option><option value="7,8 kg">7,8 kg</option><option value="7,9 kg">7,9 kg</option>
            <option value="8,0 kg">8,0 kg</option><option value="8,1 kg">8,1 kg</option><option value="8,2 kg">8,2 kg</option><option value="8,3 kg">8,3 kg</option><option value="8,4 kg">8,4 kg</option>
            <option value="8,5 kg">8,5 kg</option><option value="8,6 kg">8,6 kg</option><option value="8,7 kg">8,7 kg</option><option value="8,8 kg">8,8 kg</option><option value="8,9 kg">8,9 kg</option>
            <option value="9,0 kg">9,0 kg</option><option value="9,1 kg">9,1 kg</option><option value="9,2 kg">9,2 kg</option><option value="9,3 kg">9,3 kg</option><option value="9,4 kg">9,4 kg</option>
            <option value="9,5 kg">9,5 kg</option><option value="9,6 kg">9,6 kg</option><option value="9,7 kg">9,7 kg</option><option value="9,8 kg">9,8 kg</option><option value="9,9 kg">9,9 kg</option>
            <option value="10,0 kg">10,0 kg</option><option value="10,1 kg">10,1 kg</option><option value="10,2 kg">10,2 kg</option><option value="10,3 kg">10,3 kg</option><option value="10,4 kg">10,4 kg</option>
            <option value="10,5 kg">10,5 kg</option><option value="10,6 kg">10,6 kg</option><option value="10,7 kg">10,7 kg</option><option value="10,8 kg">10,8 kg</option><option value="10,9 kg">10,9 kg</option>
            <option value="11,0 kg">11,0 kg</option><option value="11,1 kg">11,1 kg</option><option value="11,2 kg">11,2 kg</option><option value="11,3 kg">11,3 kg</option><option value="11,4 kg">11,4 kg</option>
            <option value="11,5 kg">11,5 kg</option><option value="11,6 kg">11,6 kg</option><option value="11,7 kg">11,7 kg</option><option value="11,8 kg">11,8 kg</option><option value="11,9 kg">11,9 kg</option>
            <option value="12,0 kg">12,0 kg</option>
            
        </datalist>
            <td>Fecha</td>
            <td><input type="date" id="propietarioFecha" class="date-input" onkeydown="moverFocoConFlechas(event, 'nombreMedico', 'mascotaPeso', 'nombreMedico', 'propietarioFecha')"></td>
                    </tr>
                    
                    <script>
                  function formatearFecha(input) {
                const fecha = new Date(input.value);
                const dia = String(fecha.getDate()).padStart(2, '0');
                const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                const año = fecha.getFullYear();
                input.value = `${dia}-${mes}-${año}`;
            }
       
            function moverFocoConFlechas(event, derechaId, izquierdaId, arribaId, abajoId) {
                    switch (event.key) {
                        case 'ArrowRight':
                            event.preventDefault();
                            document.getElementById(derechaId).focus();
                            break;
                        case 'ArrowLeft':
                            event.preventDefault();
                            document.getElementById(izquierdaId).focus();
                            break;
                        case 'ArrowUp':
                            event.preventDefault();
                            document.getElementById(arribaId).focus();
                            break;
                        case 'ArrowDown':
                        case 'Enter':
                            event.preventDefault();
                            document.getElementById(abajoId).focus();
                            break;
                    }
                }
                const razasCaninas = [
    "Ainu", "Airedale terrier", "Akita", "Akita Inu", "Alaskan Malamute",
    "American Black and Tan Coonhound", "American Bull Terrier", "American Pit Bull Terrier",
    "American Staffordshire terrier", "American Water Spaniel", "Apso Tibetano", "Barzoi", 
    "Basenji", "Basset Hound", "Beagle", "Bichon Frise", "Bloodhound", "Bobtail", 
    "Border Collie", "Boston Terrier", "Bouvier des Flandres", "Boxer", "Bull terrier", 
    "Bull Terrier Miniatura", "Bulldog Americano", "Bulldog Francés", "Bulldog Inglés", 
    "Bullmastiff", "Cavalier King Charles Spaniel", "Chihuahua", "Chow Chow", 
    "Cocker Spaniel Americano", "Cocker Spaniel Inglés", "Collie", "Collie Escocés", 
    "Dachshund", "Dálmata", "Doberman", "Doberman Pincher", "Dogo Alemán", 
    "Dogo Argentino", "Dogo de Burdeos", "French Poodle", "Galgo Español", 
    "Galgo Inglés-español", "Golden Retriever", "Gran Danés", "Greyhound", 
    "Husky Siberiano", "Jack Russell Terrier", "Labrador Retriever", "Maltés", 
    "Pastor Alemán", "Pequinés", "Pomerania", "Pug", "Rottweiler", "Samoyedo", 
    "San Bernardo", "Schnauzer", 
    "Shih Tzu", "SRD", "Yorkshire Terrier", "Weimaraner", "Fila Brasileiro",
];

const razasFelinas = [
    "Abisinio", "American Bobtail", "Angora Turco", "Azul Ruso", "Balinés", 
    "Bengalí", "Bobtail japonés", "Bombay", "British Shorthair", "Burmés", 
    "Carey", "Común Europeo", "Exótico", "Himalayo", "Javanés", 
    "Oriental", "Persa", "Sagrado de Birmania", "Siamés", "Siberiano", 
    "Silvestre", "SRD"
];
// Reemplazar la función de reemplazo de punto por coma
function reemplazarPuntoPorComa() {
    // Obtener todos los campos numéricos
    const camposNumericos = [
        'Glucosa', 'Colesterol_total', 'amilasa', 'CK', 
        'nitrogeno_ureico', 'creatinina', 'bun_crea', 'fosforo', 'calcio',
        'ALT', 'Fosfatasa_Alcalina', 'billirrubina_total', 'Albumina',
        'proteinas_totales', 'Globulinas', 'alb/glo'
    ];
    
    // Aplicar la funcionalidad a cada campo
    camposNumericos.forEach(id => {
        const campo = document.getElementById(id);
        if (campo) {
            // Usar keydown en lugar de input
            campo.addEventListener('keydown', function(event) {
                // Solo actuar cuando se presiona la tecla punto
                if (event.key === '.') {
                    event.preventDefault(); // Prevenir la acción por defecto
                    
                    // Obtener la posición actual del cursor
                    const cursorPos = this.selectionStart;
                    
                    // Obtener el valor actual e insertar una coma en lugar del punto
                    const valorActual = this.value;
                    const nuevoValor = valorActual.slice(0, cursorPos) + ',' + valorActual.slice(cursorPos);
                    
                    // Establecer el nuevo valor
                    this.value = nuevoValor;
                    
                    // Restaurar la posición del cursor justo después de la coma
                    setTimeout(() => {
                        this.setSelectionRange(cursorPos + 1, cursorPos + 1);
                    }, 0);
                }
            });
            
            // Mover las actualizaciones de color y cálculos al evento blur
            campo.addEventListener('blur', function() {
                actualizarColor(id, 'ref' + id.toLowerCase());
                if (id === 'Albumina' || id === 'proteinas_totales') {
                    calculateValues();
                }
            });
            
            // Eliminar cualquier evento input que pueda interferir
            const oldInputListeners = campo._inputListeners || [];
            oldInputListeners.forEach(listener => {
                campo.removeEventListener('input', listener);
            });
        }
    });
}

// Ejecutar cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    reemplazarPuntoPorComa();
});
// Función para actualizar el datalist de razas según la especie seleccionada
function actualizarRazasPorEspecie() {
    const especie = document.getElementById('especieSelector').value;
    // Crear el datalist si no existe
    let datalistRazas = document.getElementById('razas');
    if (!datalistRazas) {
        datalistRazas = document.createElement('datalist');
        datalistRazas.id = 'razas';
        document.body.appendChild(datalistRazas);
    } else {
        // Limpiar la lista actual
        datalistRazas.innerHTML = '';
    }
    
    const campoRaza = document.getElementById('mascotaRaza');
    
    // Restablecer el campo de raza si se cambia la especie
    if (campoRaza.value && campoRaza.value !== "SRD") {
        campoRaza.value = '';
    }
    
    // Agregar las razas según la especie seleccionada
    if (especie === "Canino") {
        razasCaninas.forEach(raza => {
            const option = document.createElement('option');
            option.value = raza;
            datalistRazas.appendChild(option);
        });
    } else if (especie === "Felino") {
        razasFelinas.forEach(raza => {
            const option = document.createElement('option');
            option.value = raza;
            datalistRazas.appendChild(option);
        });
    } else if (especie === "Lagomorfo" || especie === "Cuilo") {
        // Para otras especies, agregar solo opciones genéricas
        const option = document.createElement('option');
        option.value = "SRD";
        datalistRazas.appendChild(option);
    }
}

// Modificar la función existente
function actualizarEspecieEnPlantilla() {
    const especie = document.getElementById('especieSelector').value;
    document.getElementById('especieEnPlantilla').value = especie;
    
    // Actualizar las razas disponibles según la especie
    actualizarRazasPorEspecie();
}

// Ejecutar al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    // Asegurarse de que existe el selector de especies
    const especieSelector = document.getElementById('especieSelector');
    if (especieSelector) {
        // Si ya hay una especie seleccionada al cargar
        if (especieSelector.value !== "Seleccionar") {
            actualizarRazasPorEspecie();
        }
        
        // Agregar un listener adicional para garantizar que se actualicen las razas
        especieSelector.addEventListener('change', actualizarRazasPorEspecie);
    }
    
    // Crear datalist si no existe
    if (!document.getElementById('razas')) {
        const datalist = document.createElement('datalist');
        datalist.id = 'razas';
        document.body.appendChild(datalist);
    }
});

            
                    </script>
                </tbody>
            </table>
    
        <h3 class="titulos">DEPARTAMENTO DE QUIMICA CLINICA</h3>
        <table>
            <thead>
                <tr>
                    <th>PARÁMETRO</th>
                    <th>RESULTADO</th>
                    <th>VALOR DE REFERENCIA</th>
                    <th>UNIDADES</th>
                </tr>
            </thead>
            <tbody>
                <script>
            const valoresReferencia2 = {
                    Canino: {
                        Macho: {
                            "De 1 año a 12 años": {
                                Glucosa: "77 - 126",
                                Colesterol_total: "129 - 331",		
                                Trigliceridos: "36 - 135",
                                Nitrógeno_Ureico:	"7 - 23",
                                Urea: "20 - 50",
                                Creatinina: "0,6 - 1,2",
                                Relación_BUN_Crea:	" 4,2 - 32,8 ",
                                Acido_Urico: "1,0 - 3,0",
                                Calcio: "9,0 - 11,4",
                                Fosforo: "3,3 - 6,4",
                                Magnesio: "1,8 - 3,0",
                                AST: "14 - 42",
                                ALT: "15 - 52",
                                Fosfatasa_Alcalina: "20 - 70",
                                GGT: "1 - 11,5",
                                Bilirrubina_Total: "0,2- 0,8",
                                Albumina: "2,6 - 3,6",
                                Proteínas_Totales: "5,4 - 7,2",
                                Globulinas_Totales: "3,0 - 4,7",
                                Relación_Albumina_Globulina: "0,6 - 1,1 ",
                                Lipasa: "25 - 750",
                            },
                        "De 6 meses a 1 año": {
                                Glucosa: "67 - 101",
                                Colesterol_total: "68 - 128",		
                                Trigliceridos: "19 - 52",
                                Nitrógeno_Ureico:	"14 - 36",
                                Creatinina: "0,4 - 1,2",
                                Relación_BUN_Crea:	" 4,2 - 32,8 ",
                                Acido_Urico: "0,4 - 1,3",
                                Calcio: "8,9 - 10,1",
                                Magnesio: "1,9 - 2,28",
                                Fosforo: "6,2 - 9,1",
                                AST: "10 - 36",
                                ALT: "19 - 72",
                                Fosfatasa_Alcalina: "21 - 95",
                                GGT: "1 - 10",
                                Bilirrubina_Total: "0,2- 0,8",
                                Albumina: "2,4 - 3,6",
                                Proteínas_Totales: "5,3 - 6,9",
                                Globulinas_Totales: "2,6 - 4,7",
                                Relación_Albumina_Globulina: "0,5 - 1,3 ",
                                Lipasa: "25 - 750",
                            },
                            "De 3 meses a 6 meses": {
                                Glucosa: "89 - 133",
                                Colesterol_Total: "115 - 255",
                                Trigliceridos: "45 - 105",
                                Nitrógeno_Ureico: "7 - 19",
                                Urea: "20 - 50",
                                Creatinina: "0,3 - 0,9",
                                Relación_BUN_Crea: "4,2 - 32,8",
                                Acido_Urico: "0,5 - 1,4",
                                Fosforo: "7,2 - 10,1",
                                Calcio: "9,8 - 12,4",
                                Magnesio: "1,8 - 3,0",
                                AST: "14 - 33",
                                ALT: "13 - 30",
                                Fosfatasa_Alcalina: "85 - 199",
                                GGT: "1,0 - 11,5",
                                Bilirrubina_Total: "0,2 - 0,9",
                                Albumina: "2,4 - 3,1",
                                Proteínas_Totales: "4,6 - 5,6",
                                Globulinas_Totales: "3,0 - 4,7",
                                Relación_Albumina_Globulina: "0,6 - 1,1",
                                Lipasa: "25 - 750"
                            },
                            "De 0 meses a mes y medio": {
                                Glucosa: "97 - 150",
                                Colesterol_Total: "113 - 332",
                                Trigliceridos: "42 - 147",
                                Nitrógeno_Ureico: "5,9 - 15,2",
                                Urea: "20 - 50",
                                Creatinina: "0,3 - 0,7",
                                Relación_BUN_Crea: "4,2 - 32,8",
                                Acido_Urico: "0,4 - 1,4",
                                Fosforo: "7,5 - 10,1",
                                Calcio: "9,8 - 12,4",
                                Magnesio: "1,6 - 2,6",
                                AST: "11 - 70",
                                ALT: "10,0 - 28,0",
                                Fosfatasa_Alcalina: "78 - 293",
                                GGT: "0 - 12",
                                Bilirrubina_Total: "0,1 - 0,6",
                                Albumina: "2,3 - 2,6",
                                Proteínas_Totales: "4,0 - 5,2",
                                Globulinas_Totales: "3,0 - 4,1",
                                Relación_Albumina_Globulina: "0,6 - 1,1",
                                Lipasa: "25 - 750"
                            },
                        },
                        Hembra: {
                            "De 1 año a 12 años": {
                                Glucosa: "77 - 126",
                                Colesterol_total: "129 - 331",		
                                Trigliceridos: "36 - 135",
                                Nitrógeno_Ureico:	"7 - 23",
                                Urea: "20 - 50",
                                Creatinina: "0,6 - 1,2",
                                Relación_BUN_Crea:	" 4,2 - 32,8 ",
                                Calcio: "9,0 - 11,4",
                                Acido_Urico: "0,5 - 1,4",
                                Magnesio: "1,8 - 3,0",                       
                                Fosforo: "3,3 - 6,4",
                                AST: "14 - 42",
                                ALT: "15 - 52",
                                Fosfatasa_Alcalina: "20 - 70",
                                GGT: "1 - 11,5",
                                Bilirrubina_Total: "0,2- 0,8",
                                Albumina: "2,6 - 3,6",
                                Proteínas_Totales: "5,4 - 7,2",
                                Globulinas_Totales: "3,0 - 4,7",
                                Relación_Albumina_Globulina: "0,6 - 1,1 ",
                                Lipasa: "25 - 750",
                            },
                            "De 6 meses a 1 año": {
                                Glucosa: "29 - 127",
                                Colesterol_Total: "127 - 247",
                                Trigliceridos: "37 - 94",
                                Nitrógeno_Ureico: "10 - 27",
                                Urea: "20 - 50",
                                Creatinina: "0.7 - 1.4",
                                Relación_BUN_Crea: "4,2 - 32,8",
                                Acido_Urico: "0,4 - 1,6",
                                Fosforo: "4,4 - 9,2",
                                Calcio: "9,4 - 11,7",
                                Magnesio: "1,8 - 3,0",
                                AST: "15 - 40",
                                ALT: "16 - 49",
                                Fosfatasa_Alcalina: "29 - 97",
                                GGT: "1 - 11,5",
                                Bilirrubina_Total: "0,2 - 1,1",
                                Albumina: "2,7 - 3,6",
                                Proteínas_Totales: "5,1 - 6,9",
                                Globulinas_Totales: "3,0 - 4,7",
                                Relación_Albumina_Globulina: "0,6 - 1,1",
                                Lipasa: "25 - 750",
                            },
                            "De 3 meses a 6 meses": {
                                Glucosa: "82 - 130",
                                Colesterol_Total: "105 - 241",
                                Trigliceridos: "43 - 126",
                                Nitrógeno_Ureico: "7 - 19",
                                Urea: "20 - 50",
                                Creatinina: "0,4 - 0,9",
                                Relación_BUN_Crea: "4,2 - 32,8",
                                Acido_Urico: "0,3 - 0,9",
                                Fosforo: "7,5 - 10,0",
                                Calcio: "10,1 - 12,3",
                                Magnesio: "1,8 - 3,0",
                                AST: "13 - 32",
                                ALT: "9 - 27",
                                Fosfatasa_Alcalina: "77 - 180",
                                GGT: "1 - 11,5",
                                Bilirrubina_Total: "0,2 - 0,9",
                                Albumina: "2,4 - 3,1",
                                Proteínas_Totales: "4,6 - 5,8",
                                Globulinas_Totales: "3,0 - 4,7",
                                Relación_Albumina_Globulina: "0,6 - 1,1",
                                Lipasa: "25 - 750"
                            },
                            "De 0 meses a mes y medio": {
                                Glucosa: "108 - 151",
                                Colesterol_Total: "110 - 273",
                                Trigliceridos: "43 - 121",
                                Nitrógeno_Ureico: "6,2 - 15,2",
                                Urea: "20 - 50",
                                Creatinina: "0,3 - 0,8",
                                Relación_BUN_Crea: "4,2 - 32,8",
                                Acido_Urico: "0,3 - 1,3",
                                Fosforo: "7,5 - 10,7",
                                Calcio: "9,9 - 12,0",
                                Magnesio: "1,8 - 3,0",
                                AST: "11 - 35",
                                ALT: "9 - 30",
                                Fosfatasa_Alcalina: "85 - 273",
                                GGT: "1 - 11,5",
                                Bilirrubina_Total: "0,1 - 0,6",
                                Albumina: "2,2 - 2,9",
                                Proteínas_Totales: "4,0 - 5,1",
                                Globulinas_Totales: "3,0 - 4,7",
                                Relación_Albumina_Globulina: "0,6 - 1,1",
                                Lipasa: "25 - 750"
                            },
                        }
                    },
                    Felino: {
                        Macho: {
                            "De 1 año a 12 años": {
                                Glucosa: "65 - 111",
                                Colesterol_Total: "76 - 146",
                                Trigliceridos: "20 - 60",
                                Nitrógeno_Ureico: "20 - 42",
                                Urea: "30 - 60",
                                Creatinina: "0,5 - 1,8",
                                Acido_Urico: "0,3 - 0,9",
                                Relación_BUN_Crea: "4,2 - 32,8",
                                Fosforo: "4,1 - 6,4",
                                Calcio: "8,3 - 10,4",
                                Magnesio: "1,9 - 2,28",
                                AST: "10 - 29",
                                ALT: "20 - 67",
                                Fosfatasa_Alcalina: "13 - 47",
                                GGT: "1 - 10",
                                Bilirrubina_Total: "0,2 - 0,7",
                                Albumina: "2,8 - 3,7",
                                Proteínas_Totales: "5,8 - 7,6",
                                Globulinas_Totales: "2,6 - 4,5",
                                Relación_Albumina_Globulina: "0,5 - 1,3",
                                Lipasa: "25 - 375",     
                            },
                            "De 6 meses a 1 año": {
                                Glucosa: "67 - 101",
                                Colesterol_Total: "68 - 128",
                                Trigliceridos: "19 - 52",
                                Nitrógeno_Ureico: "14 - 36",
                                Urea: "30 - 60",
                                Creatinina: "0,4 - 1,2",
                                Relación_BUN_Crea: "4,2 - 32,8",
                                Acido_Urico: "0,4 - 1,3",
                                Fosforo: "6,2 - 9,1",
                                Calcio: "8,9 - 10,1",
                                Magnesio: "1,9 - 2,28",
                                AST: "10 - 36",
                                ALT: "19 - 72",
                                Fosfatasa_Alcalina: "21 - 95",
                                GGT: "1 - 10",
                                Bilirrubina_Total: "0,2 - 0,8",
                                Albumina: "2,4 - 3,6",
                                Proteínas_Totales: "5,3 - 6,9",
                                Globulinas_Totales: "2,6 - 4,5",
                                Relación_Albumina_Globulina: "0,5 - 1,3",
                                Lipasa: "25 - 375"
                            },
                            "De 3 meses a 6 meses": {
                                Glucosa: "61 - 102",
                                Colesterol_Total: "66 - 132",
                                Trigliceridos: "15 - 47",
                                Nitrógeno_Ureico: "19 - 34",
                                Urea: "30 - 60",
                                Creatinina: "0,4 - 0,9",
                                Relación_BUN_Crea: "4,2 - 32,8",
                                Acido_Urico: "0,4 - 1,1",
                                Fosforo: "7,1 - 9,5",
                                Calcio: "9,1 - 10,9",
                                Magnesio: "1,9 - 2,28",
                                AST: "9 - 34",
                                ALT: "18 - 55",
                                Fosfatasa_Alcalina: "43 - 124",
                                GGT: "1 - 10",
                                Bilirrubina_Total: "0,2 - 0,8",
                                Albumina: "2,7 - 3,6",
                                Proteínas_Totales: "5,4 - 6,6",
                                Globulinas_Totales: "2,6 - 4,5",
                                Relación_Albumina_Globulina: "0,5 - 1,3",
                                Lipasa: "25 - 375"
                            },
                        },
                        Hembra: {
                            "De 1 año a 12 años": {
                                Glucosa: "65 - 112",
                                Colesterol_Total: "51 - 112",
                                Trigliceridos: "13 - 74",
                                Nitrógeno_Ureico: "19 - 30",
                                Urea: "30 - 60",
                                Creatinina: "0,6 - 1,7",
                                Relación_BUN_Crea: "4,2 - 32,8",
                                Acido_Urico: "0,5 - 1,4",
                                Fosforo: "3,2 - 6,6",
                                Calcio: "7,8 - 9,2",
                                Magnesio: "1,9 - 2,28",
                                AST: "10 - 29",
                                ALT: "22 - 79",
                                Fosfatasa_Alcalina: "12 - 55",
                                GGT: "1 - 10",
                                Bilirrubina_Total: "0,3 - 1,1",
                                Albumina: "2,4 - 3,0",
                                Proteínas_Totales: "5,6 - 7,7",
                                Globulinas_Totales: "2,6 - 4,5",
                                Relación_Albumina_Globulina: "0,5 - 1,3",
                                Lipasa: "25 - 375"
                            },
                            "De 6 meses a 1 año": {
                                Glucosa: "67 - 102",
                                Colesterol_Total: "56 - 114",
                                Trigliceridos: "15 - 43",
                                Nitrógeno_Ureico: "19 - 37",
                                Urea: "30 - 60",
                                Creatinina: "0,3 - 1,2",
                                Relación_BUN_Crea: "4,2 - 32,8",
                                Acido_Urico: "0,3 - 1,3",
                                Fosforo: "4,9 - 8,3",
                                Calcio: "8,5 - 10,3",
                                Magnesio: "1,9 - 2,28",
                                AST: "11 - 33",
                                ALT: "25 - 77",
                                Fosfatasa_Alcalina: "22 - 100",
                                GGT: "1 - 10",
                                Bilirrubina_Total: "0,2 - 0,9",
                                Albumina: "2,5 - 3,6",
                                Proteínas_Totales: "5,4 - 7,2",
                                Globulinas_Totales: "2,6 - 4,5",
                                Relación_Albumina_Globulina: "0,5 - 1,3",
                                Lipasa: "25 - 375"
                        },
                        "De 3 meses a 6 meses": {
                            Glucosa: "59 - 99",
                            Colesterol_Total: "63 - 113",
                            Trigliceridos: "16 - 49",
                            Nitrógeno_Ureico: "19 - 33",
                            Urea: "30 - 60",
                            Creatinina: "0,4 - 0,9",
                            Relación_BUN_Crea: "4,2 - 32,8",
                            Acido_Urico: "0,4 - 1,2",
                            Fosforo: "6,9 - 9,5",
                            Calcio: "8,9 - 10,9",
                            Magnesio: "1,9 - 2,28",
                            AST: "10 - 27",
                            ALT: "19 - 58",
                            Fosfatasa_Alcalina: "39 - 114",
                            GGT: "1 - 10",
                            Bilirrubina_Total: "0,1 - 0,6",
                            Albumina: "2,5 - 3,5",
                            Proteínas_Totales: "5,4 - 6,8",
                            Globulinas_Totales: "2,6 - 4,5",
                            Relación_Albumina_Globulina: "0,5 - 1,3",
                            Lipasa: "25 - 375"
                            },
                        }
                    },
                    Lagomorfo: {
                        Macho: {
                            "Todas las edades": {
                                Glucosa: "60,0 - 125,0",
                                Colesterol_Total: "20,0 - 43,0",
                                Amilasa: "",
                                CK: "",
                                Nitrógeno_Ureico: "9,0 - 32,0",
                                Creatinina: "0,6 - 2,2",
                                Relación_BUN_Crea: "",
                                Fosforo: "",
                                Calcio: "7,8 - 10,5",
                                ALT: "10,0 - 25,0",
                                Fosfatasa_Alcalina: "",
                                Bilirrubina_Total: "0,3 - 0,9",
                                Albumina: "2,1 - 3,9",
                                Proteínas_Totales: "4,6 - 6,2",
                                Globulinas_Totales: "1,7 - 2,6",
                                Relación_Albumina_Globulina: "",
                            },
                        },
                        Hembra: {
                            "Todas las edades": {
                                Glucosa: "77 - 126",
                                Colesterol_total: "129 - 331",		
                                Amilasa: "400 - 2500",
                                CK: "32 - 157",
                                Nitrógeno_Ureico:	"7 - 23",
                                Creatinina: "0,6 - 1,2",
                                Relación_BUN_Crea:	" 4,2 - 32,8 ",
                                Calcio: "9,0 - 11,4",
                                Fosforo: "14,2 - 18,9",
                                ALT: "3,3 - 6,4",
                                Fosfatasa_Alcalina: "15 - 52",
                                Bilirrubina_Total: "0,2- 0,8",
                                Albumina: "2,6 - 3,6",
                                Proteínas_Totales: "2,6 - 3,6",
                                Globulinas_Totales: "3,0 - 4,7",
                                Relación_Albumina_Globulina: "0,6 - 1,1 ",
                            },
                            },
                        },
                    Cuilo: {
                        Macho: {
                            "Todas las edades": {
                                Glucosa: "60 - 125",
                                Colesterol_Total: "20 - 43",
                                Amilasa: "",
                                CK: "",
                                Nitrógeno_Ureico: "9,0 - 32,0",
                                Creatinina: "0,6 - 2,2",
                                Relación_BUN_Crea: "",
                                Fosforo: "0 - 5,3",
                                Calcio: "7,8 - 10,5",
                                ALT: "10,0 - 25,0",
                                Fosfatasa_Alcalina: "",
                                Bilirrubina_Total: "0,3 - 0,9",
                                Albumina: "2,1 - 3,9",
                                Proteínas_Totales: "4,6 - 6,2",
                                Globulinas_Totales: "1,7 - 2,6",
                                Relación_Albumina_Globulina: ""
                            },
                        },
                        Hembra: {
                            "Todas las edades": {
                                Glucosa: "60 - 125",
                                Colesterol_Total: "20 - 43",
                                Amilasa: "",
                                CK: "",
                                Nitrógeno_Ureico: "9,0 - 32,0",
                                Creatinina: "0,6 - 2,2",
                                Relación_BUN_Crea: "",
                                Fosforo: "0 - 5,3",
                                Calcio: "7,8 - 10,5",
                                ALT: "10,0 - 25,0",
                                Fosfatasa_Alcalina: "",
                                Bilirrubina_Total: "0,3 - 0,9",
                                Albumina: "2,1 - 3,9",
                                Proteínas_Totales: "4,6 - 6,2",
                                Globulinas_Totales: "1,7 - 2,6",
                                Relación_Albumina_Globulina: ""
                            },
                            },
                        },
                    };
    </script>
                    <script>
   function actualizarValoresReferencia2() {
    const especie = document.getElementById('especieSelector').value;
    const sexo = document.getElementById('sexoSelector').value;
    const edad = document.getElementById('edadSelector').value;

    if (especie !== "Seleccionar" && sexo !== "Seleccionar" && edad !== "Seleccionar") {
        const refValores = valoresReferencia2[especie][sexo][edad];
        document.getElementById('refglucosa').innerText = refValores.Glucosa || '';
        document.getElementById('refcolesterolT').innerText = refValores.Colesterol_total || refValores.Colesterol_Total || '';
        document.getElementById('refTrigliceridos').innerText = refValores.Trigliceridos || '';
        document.getElementById('refnitrogeno_ureico').innerText = refValores.Nitrógeno_Ureico || '';
        document.getElementById('refurea').innerText = refValores.Urea || '';
        document.getElementById('refcreatinina').innerText = refValores.Creatinina || '';
        document.getElementById('refbun_crea').innerText = refValores.Relación_BUN_Crea || '';
        document.getElementById('refacido_urico').innerText = refValores.Acido_Urico || '';
        document.getElementById('reffosforo').innerText = refValores.Fosforo || '';
        document.getElementById('refcalcio').innerText = refValores.Calcio || '';
        document.getElementById('refmagnesio').innerText = refValores.Magnesio || '';
        document.getElementById('refAST').innerText = refValores.AST || '';
        document.getElementById('refALT').innerText = refValores.ALT || '';
        document.getElementById('refFosfatasa_Alcalina').innerText = refValores.Fosfatasa_Alcalina || '';
        document.getElementById('refGGT').innerText = refValores.GGT || '';
        document.getElementById('refbillirrubina').innerText = refValores.Bilirrubina_Total || '';
        document.getElementById('refalbumina').innerText = refValores.Albumina || '';
        document.getElementById('refproteinas_totales').innerText = refValores.Proteínas_Totales || '';
        document.getElementById('refglobulinas').innerText = refValores.Globulinas_Totales || '';
        document.getElementById('refalb_glo').innerText = refValores.Relación_Albumina_Globulina || '';
        document.getElementById('reflipasa').innerText = refValores.Lipasa || '';
    } else {
        document.getElementById('refglucosa').innerText = "";
        document.getElementById('refcolesterolT').innerText = "";
        document.getElementById('refTrigliceridos').innerText = "";
        document.getElementById('refnitrogeno_ureico').innerText = "";
        document.getElementById('refurea').innerText = "";
        document.getElementById('refcreatinina').innerText = "";
        document.getElementById('refbun_crea').innerText = "";
        document.getElementById('refacido_urico').innerText = "";
        document.getElementById('reffosforo').innerText = "";
        document.getElementById('refcalcio').innerText = "";
        document.getElementById('refmagnesio').innerText = "";
        document.getElementById('refAST').innerText = "";
        document.getElementById('refALT').innerText = "";
        document.getElementById('refFosfatasa_Alcalina').innerText = "";
        document.getElementById('refGGT').innerText = "";
        document.getElementById('refbillirrubina').innerText = "";
        document.getElementById('refalbumina').innerText = "";
        document.getElementById('refproteinas_totales').innerText = "";
        document.getElementById('refglobulinas').innerText = "";
        document.getElementById('refalb_glo').innerText = "";
        document.getElementById('reflipasa').innerText = "";
    }
}

// Agregar la función formatearDecimal si aún no existe
function formatearDecimal(id) {
    const input = document.getElementById(id);
    if (!input || input.value === '') return;
    
    // Eliminar flechas y obtener valor numérico
    const valorTexto = input.value.replace(/\s*[↑↓]$/, '').replace(',', '.');
    const valor = parseFloat(valorTexto);
    
    if (isNaN(valor)) return;
    
    // Determinar el número de decimales según el campo
    let decimales = 1; // Por defecto, un decimal
    
    // Algunos campos podrían requerir diferente cantidad de decimales
    if (['billirrubina_total', 'creatinina', 'Albumina'].includes(id)) {
        decimales = 1; // 1 decimal para estos campos
    } else if (['fosforo', 'calcio', 'potasio'].includes(id)) {
        decimales = 1; // 1 decimal para estos campos
    } else if (['ALT', 'Fosfatasa_Alcalina', 'amilasa', 'nitrogeno_ureico', 'urea', 'lipasa'].includes(id)) {
        decimales = 0; // Sin decimales para estos campos (enteros)
    }
    
    // Formatear con el número de decimales apropiado
    const valorFormateado = valor.toFixed(decimales).replace('.', ',');
    input.value = valorFormateado;
    
    // Actualizar color después del formateo
    const refId = 'ref' + id.toLowerCase();
    actualizarColor(id, refId);
}

// Reemplazar la función actualizarColor con esta versión simplificada
// Reemplazar la función actualizarColor existente con esta versión mejorada
function actualizarColor(inputId, refId) {
    const inputElement = document.getElementById(inputId);
    const refElement = document.getElementById(refId);
    
    if (!inputElement || !refElement || !refElement.textContent) {
        return;
    }
    
    // Obtener el valor del input y convertirlo a número
    let valorTexto = inputElement.value.trim();
    
    // Eliminar cualquier flecha existente
    valorTexto = valorTexto.replace(/\s*[↑↓]$/, '');
    
    if (!valorTexto) {
        inputElement.style.color = 'black';
        return;
    }
    
    const valor = parseFloat(valorTexto.replace(',', '.'));
    if (isNaN(valor)) return;
    
    // Extraer el rango de referencia
    const rangoTexto = refElement.textContent;
    const coincidencia = rangoTexto.match(/([\d,.]+)\s*-\s*([\d,.]+)/);
    
    if (coincidencia) {
        const min = parseFloat(coincidencia[1].replace(',', '.'));
        const max = parseFloat(coincidencia[2].replace(',', '.'));
        
        // Aplicar color según el valor
        if (valor < min) {
            inputElement.style.color = '#0096d2'; // Azul/celeste para valores bajos
            
            // Solo agregar flecha si es evento blur o enter, no durante la escritura
            if (event && (event.type === 'blur' || (event.type === 'keydown' && event.key === 'Enter'))) {
                inputElement.value = valorTexto + ' ↓';
            }
        } else if (valor > max) {
            inputElement.style.color = 'red'; // Rojo para valores altos
            
            if (event && (event.type === 'blur' || (event.type === 'keydown' && event.key === 'Enter'))) {
                inputElement.value = valorTexto + ' ↑';
            }
        } else {
            inputElement.style.color = 'black'; // Negro para valores normales
            inputElement.value = valorTexto; // Sin flechas
        }
    }
}

// Modificar los listeners para pasar el evento a la función actualizarColor
document.addEventListener('DOMContentLoaded', function() {
    const parametros = [
        { campo: 'Glucosa', ref: 'refglucosa' },
        { campo: 'Colesterol_total', ref: 'refcolesterolT' },
        { campo: 'Trigliceridos', ref: 'refTrigliceridos' },
        { campo: 'nitrogeno_ureico', ref: 'refnitrogeno_ureico' },
        { campo: 'urea', ref: 'refurea' },
        { campo: 'creatinina', ref: 'refcreatinina' },
        { campo: 'bun_crea', ref: 'refbun_crea' },
        { campo: 'acido_urico', ref: 'refacido_urico' },
        { campo: 'fosforo', ref: 'reffosforo' },
        { campo: 'calcio', ref: 'refcalcio' },
        { campo: 'magnesio', ref: 'refmagnesio' },
        { campo: 'AST', ref: 'refAST' },
        { campo: 'ALT', ref: 'refALT' },
        { campo: 'Fosfatasa_Alcalina', ref: 'refFosfatasa_Alcalina' },
        { campo: 'GGT', ref: 'refGGT' },
        { campo: 'billirrubina_total', ref: 'refbillirrubina' },
        { campo: 'Albumina', ref: 'refalbumina' },
        { campo: 'proteinas_totales', ref: 'refproteinas_totales' },
        { campo: 'Globulinas', ref: 'refglobulinas' },
        { campo: 'alb/glo', ref: 'refalb_glo' },
        { campo: 'lipasa', ref: 'reflipasa' }

    ];
    
    parametros.forEach(param => {
        const input = document.getElementById(param.campo);
        if (input) {
            // No actualizar el color durante la escritura, solo al perder el foco
            input.removeEventListener('input', function() {
                actualizarColor(param.campo, param.ref);
            });
            
            // Actualizar solo al perder el foco o presionar Enter
            input.addEventListener('blur', function(event) {
                actualizarColor(param.campo, param.ref, event);
            });
            
            input.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    actualizarColor(param.campo, param.ref, event);
                }
            });
        }
    });
});
    </script>
    </script>
            </script>
            <tr>
                <td>GLUCOSA</td>
                <td>
                    <input type="text" id="Glucosa" list="rangoglucosa" onkeydown="moverFoco(event, 'Glucosa')">
                    <datalist id="rangoglucosa"></datalist>
                </td>
                <td id="refglucosa">77 - 126</td>
                <td>mg/dl</td>
                </script>
                </tr>
                <tr>
                    <td>COLESTEROL TOTAL</td>
                    <td>
                        <input type="text" id="Colesterol_total" list="rangocolesterolT" onkeydown="moverFoco(event, 'Colesterol_total')">  
                 <datalist id="rangocolesterolT"></datalist>
                    </td>
                <td id="refcolesterolT">129 - 331</td>
                <td>mg/dl</td>  
                </tr>
                <tr>
                    <tr>
                        <td>TRIGLICÉRIDOS</td>
                        <td>
                            <input type="text" id="Trigliceridos" list="rangoTrigliceridos" onkeydown="moverFoco(event, 'Trigliceridos')">  
                            <datalist id="rangoTrigliceridos"></datalist>
                        </td>
                        <td id="refTrigliceridos">23 - 75</td>
                        <td>mg/dl</td>  
                    </tr>
                </tr>
                <tr>
            </tbody>
        </table>
    
        <h3 class="titulos" id="funcionamientoRenalTitle">FUNCIONAMIENTO RENAL</h3>
        <table>
            <thead>
                <tr>
                    <th>PARÁMETRO</th>
                    <th>RESULTADO</th>
                    <th>VALOR DE REFERENCIA</th>
                    <th>UNIDADES</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>NITROGENO UREICO</td>
                    <td>
                        <input type="text" id="nitrogeno_ureico" list="rangonitrogeno_ureico" onblur="formatearDecimal('nitrogeno_ureico')" onkeydown="moverFoco(event, 'nitrogeno_ureico')">
                        <datalist id="rangonitrogeno_ureico"></datalist>
                    </td>
                    <td id="refnitrogeno_ureico">7 - 23</td>
                    <td>mg/dl</td>
                </tr>
                <tr>
                    <td>UREA</td>
                    <td>
                        <input type="text" id="urea" list="rangourea" onblur="formatearDecimal('urea')" onkeydown="moverFoco(event, 'urea')">
                        <datalist id="rangourea"></datalist>
                    </td>
                    <td id="refurea">15 - 48</td>
                    <td>mg/dl</td>
                </tr>
                <tr>
                    <td>CREATININA</td>
                    <td>
                        <input type="text" id="creatinina" list="rangocreatinina" onblur="formatearDecimal('creatinina')" onkeydown="moverFoco(event, 'creatinina')">
                        <datalist id="rangocreatinina"></datalist>
                    </td>
                    <td id="refcreatinina">0,6 - 1,2</td>
                    <td>mg/dl</td>
                </tr>
                <tr>
                    <td>RELACIÓN BUN/CREA</td>
                    <td>
                        <input type="text" id="bun_crea" list="rangobun_crea" onblur="formatearDecimal('bun_crea')" onkeydown="moverFoco(event, 'bun_crea')">
                        <datalist id="rangobun_crea"></datalist>
                    </td>
                    <td id="refbun_crea"> 4,2 - 32,8 </td>
                    <td>mg/dl</td>
                </tr>
                <tr>
                    <td>ÁCIDO ÚRICO</td>
                    <td>
                        <input type="text" id="acido_urico" list="rangoacido_urico" onblur="formatearDecimal('acido_urico')" onkeydown="moverFoco(event, 'acido_urico')">
                        <datalist id="rangoacido_urico"></datalist>
                    </td>
                    <td id="refacido_urico">0.0 - 0.5</td>
                    <td>mg/dl</td>
                </tr>
                <tr>
                    <td>FOSFORO</td>
                    <td>
                        <input type="text" id="fosforo" list="rangofosforo" onblur="formatearDecimal('fosforo')" onkeydown="moverFoco(event, 'fosforo')">
                        <datalist id="rangofosforo"></datalist>
                    </td>
                    <td id="reffosforo">3,3 - 6,4</td>
                    <td>mg/dl</td>
                </tr>
                <tr>
                    <td>CALCIO</td>
                    <td>
                        <input type="text" id="calcio" list="rangocalcio" onblur="formatearDecimal('calcio')" onkeydown="moverFoco(event, 'calcio')">
                        <datalist id="rangocalcio"></datalist>
                    </td>
                    <td id="refcalcio">9,0 - 11,4</td>
                    <td>mg/dl</td>
                </tr>
                <tr>
                    <td>MAGNESIO</td>
                    <td>
                        <input type="text" id="magnesio" list="rangomagnesio" onblur="formatearDecimal('magnesio')" onkeydown="moverFoco(event, 'magnesio')">
                        <datalist id="rangomagnesio"></datalist>
                    </td>
                    <td id="refmagnesio">1.8 - 2.4</td>
                    <td>mg/dl</td>
                </tr>
            </tbody>
        </table>
    
        <h3 class="titulos" id="funcionamientoHepaticoTitle">FUNCIONAMIENTO HÉPATICO</h3>
        <table>
            <thead>
                <tr>
                    <th>PARÁMETRO</th>
                    <th>RESULTADO</th>
                    <th>VALOR DE REFERENCIA</th>
                    <th>UNIDADES</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>AST</td>
                    <td>
                        <input type="text" id="AST" list="rangoAST" onblur="formatearDecimal('AST')" onkeydown="moverFoco(event, 'AST')">
                        <datalist id="rangoAST"></datalist>
                    </td>
                    <td id="refAST">15 - 66</td>
                    <td>U/L</td>
                </tr>
                <tr>
                    <td>ALT</td>
                    <td>
                        <input type="text" id="ALT" list="rangoALT" onblur="formatearDecimal('ALT')" onkeydown="moverFoco(event, 'ALT')">
                        <datalist id="rangoALT"></datalist>
                    </td>
                    <td id="refALT">15 - 52</td>
                    <td>U/L</td>
                </tr>
                <tr>
                    <td>FOSFATASA ALCALINA</td>
                    <td>
                        <input type="text" id="Fosfatasa_Alcalina" list="rangoFosfatasa_Alcalina" onblur="formatearDecimal('Fosfatasa_Alcalina')" onkeydown="moverFoco(event, 'Fosfatasa_Alcalina')">
                        <datalist id="rangoFosfatasa_Alcalina"></datalist>
                    </td>
                    <td id="refFosfatasa_Alcalina">20 - 70</td>
                    <td>U/L</td>
                </tr>
                <tr>
                    <td>GGT</td>
                    <td>
                        <input type="text" id="GGT" list="rangoGGT" onblur="formatearDecimal('GGT')" onkeydown="moverFoco(event, 'GGT')">
                        <datalist id="rangoGGT"></datalist>
                    </td>
                    <td id="refGGT">0 - 6</td>
                    <td>U/L</td>
                </tr>
                <tr>
                    <td>BILLIRRUBINA TOTAL</td>
                    <td>
                        <input type="text" id="billirrubina_total" list="rangobillirrubina" onblur="formatearDecimal('billirrubina_total')" onkeydown="moverFoco(event, 'billirrubina_total')">
                        <datalist id="rangobillirrubina"></datalist>
                    </td>
                    <td id="refbillirrubina">0,2 - 0,8</td>
                    <td>mg/dl</td>
                </tr>
            </tbody>
        </table>
    
        <h3 class="titulos" id="funcionamientoSanguineoTitle">FUNCIONAMIENTO SANGUINEO</h3>
        <table>
            <thead>
                <tr>
                    <th>PARÁMETRO</th>
                    <th>RESULTADO</th>
                    <th>VALOR DE REFERENCIA</th>
                    <th>UNIDADES</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>ALBUMINA</td>
                    <td>
                        <input type="text" id="Albumina" list="rangoalbumina" onblur="formatearDecimal('Albumina')" onkeydown="moverFoco(event, 'Albumina')">
                        <datalist id="rangoalbumina"></datalist>
                    </td>
                    <td id="refalbumina">2,6 - 3,6</td>
                    <td>g/dl</td>
                    <script type="module">
                        import {  recuentoalbumina  } from './numeros.js';
            document.getElementById('Albumina').addEventListener('input', calculateValues);
            document.getElementById('proteinas_totales').addEventListener('input', calculateValues);
                    </script>
                </tr>
                    <td>PROTEINAS TOTALES</td>
                    <td>
                        <input type="text" id="proteinas_totales" list="rangoproteinas" onblur="formatearDecimal('proteinas_totales')" onkeydown="moverFoco(event, 'proteinas_totales')">
                        <datalist id="rangoproteinas"></datalist>
                    </td>
                    <td id="refproteinas_totales">5,4 - 7,2</td>
                    <td>g/dl</td>
                </tr>
                <tr>
                    <td>GLOBULINAS TOTALES</td>
                    <td>
                        <input type="text" id="Globulinas" list="rangoglubolinas" onblur="formatearDecimal('Globulinas')" onkeydown="moverFoco(event, 'Globulinas')">
                        <datalist id="rangoglobulinas"></datalist>
                    </td>
                    <td id="refglobulinas">3,0 - 4,7</td>
                    <td>g/dl</td>
                </tr>
                <tr>
                    <td>RELACIÓN ALBUMINA/GLOBULINAS</td>
                    <td>
                        <input type="text" id="alb/glo" list="rangoalb/glo" onblur="formatearDecimal('alb/glo')" onkeydown="moverFoco(event, 'alb/glo')">
                        <datalist id="rangoalb/glo"></datalist>
                    </td>
                    <td id="refalb_glo">0,6 - 1,1</td>
                    <td></td>
                </tr>
                <tr id="lipasaRow">
                    <td>LIPASA PANCREATICA</td>
                    <td>
                        <input type="text" id="lipasa" list="rangolipasa" onblur="formatearDecimal('lipasa')" onkeydown="moverFoco(event, 'lipasa')">
                        <datalist id="rangolipasa"></datalist>
                    </td>
                    <td id="reflipasa">Seleccionar especie</td>
                    <td>U/L</td>
                </tr>
                <script>
function calculateValues() {
    const albumina = parseFloat(document.getElementById('Albumina').value.replace(',', '.')) || 0;
    const proteinasTotales = parseFloat(document.getElementById('proteinas_totales').value.replace(',', '.')) || 0;
    
    const globulinasTotales = proteinasTotales - albumina;
    
    let relacionAlbGlo = 0;
    if (globulinasTotales > 0) {
        relacionAlbGlo = albumina / globulinasTotales;
    }
    
    document.getElementById('Globulinas').value = globulinasTotales.toFixed(1).replace('.', ',');
    document.getElementById('alb/glo').value = relacionAlbGlo.toFixed(1).replace('.', ',');
    
    actualizarColor('Globulinas', 'refglobulinas');
    actualizarColor('alb/glo', 'refalb_glo'); // Corregido: usar el ID exacto que aparece en el HTML
}


// Asegurarse que los event listeners estén correctamente asignados
document.addEventListener('DOMContentLoaded', function() {
    // Asignar event listeners para los campos de interés
    const albuminaInput = document.getElementById('Albumina');
       const proteinasInput = document.getElementById('proteinas_totales');
    
    if (albuminaInput) {
        albuminaInput.addEventListener('input', calculateValues);
        albuminaInput.addEventListener('blur', calculateValues);
    }
    
    if (proteinasInput) {
        proteinasInput.addEventListener('input', calculateValues);
        proteinasInput.addEventListener('blur', calculateValues);
    }
    
    // También calcular los valores iniciales si ya hay datos
    calculateValues();
});
            </script>
            </tbody>
        </table>
    
        <div id="interferenceIndicesSection">
            <h3 class="titulos">INDICES DE INTERFERENCIA</h3>
            <table>
                <tbody>
                    <tr>
                        <td>SUERO HEMOLITICO</td>
                        <td>
                            <input type="text" id="suero_hemolitico2" list="opcionesInterferencia" style="width:140px;">
                        </td>
                    </tr>
                    <tr>
                        <td>SUERO LIPEMICO</td>
                        <td>
                            <input type="text" id="suero_lipemico2" list="opcionesInterferencia" style="width:140px;">
                        </td>
                    </tr>
                    <tr>
                        <td>SUERO ICTERICO</td>
                        <td>
                            <input type="text" id="suero_icterico2" list="opcionesInterferencia" style="width:140px;">
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <datalist id="opcionesInterferencia">
    <option value="No se observa">
    <option value="Se observa">
</datalist>
<div class="footer">
            <p id="mensajeMedico" style="display: none;">El personal médico cuenta con un plazo de 24 a 48 horas para interpretar el reporte de los resultados.</p>
            <p>Facebook: Veterinaria San Martin de Porres | Teléfono: 4000 - 1365 | Ext: 106</p>
            <p>WhatsApp: 8839 - 2214 | San Rafael Abajo de Desamparados, 50 metros Norte del Mall Zona Centro</p>
            <p>Correo: laboratorio@vetsanmartin.com</p>
        </div>
    </div>
    <div class="controls">
        <button id="pdfButton" onclick="generatePDF()">Generar PDF</button>
        <button id="menuButton" onclick="window.location.href='index.html'">Volver al Menú</button>
        <div id="loadingPdf" class="loading-indicator">
            <div class="spinner"></div>
            <span>Generando PDF...</span>
        </div>
    </div>
    <div class="parameter-selector-panel">
        <h3>Eliminar parámetros</h3>
        <div class="selector-container">
            <select id="parameterSelector" class="parameter-dropdown">
                <option value="" selected disabled>-- Seleccionar parámetro --</option>
            </select>
            <button onclick="eliminarParametroSeleccionado()" class="remove-param-btn">Eliminar</button>
        </div>
    </div>

    <script>
function moverFoco(event, siguienteId) {
    if (event.key === 'Enter') {
        event.preventDefault();
        
        // Lista completa de campos en orden de navegación
        const camposParametros = [
            'Glucosa', 
            'Colesterol_total',
            'Trigliceridos',
            'nitrogeno_ureico',
            'urea',
            'creatinina', 
            'bun_crea',
            'acido_urico',
            'fosforo', 
            'calcio',
            'magnesio',
            'AST',
            'ALT', 
            'Fosfatasa_Alcalina',
            'GGT',
            'billirrubina_total', 
            'Albumina', 
            'proteinas_totales', 
            'Globulinas', 
            'alb/glo',
            'lipasa'

        ];
        
        // Encontrar el índice del campo actual
        const indiceActual = camposParametros.indexOf(event.target.id);
        
        if (indiceActual !== -1 && indiceActual < camposParametros.length - 1) {
            // Mover al siguiente campo en la secuencia
            const siguienteId = camposParametros[indiceActual + 1];
            document.getElementById(siguienteId).focus();
        } else {
            // Si no está en la lista o es el último, usar el siguienteId proporcionado
            document.getElementById(siguienteId).focus();
}
    } else if (event.key === 'ArrowUp') {
        event.preventDefault();
        
        // Los mismos campos para navegación hacia arriba
        const camposParametros = [
            'Glucosa', 
            'Colesterol_total',
            'Trigliceridos',
            'nitrogeno_ureico',
            'urea',
            'creatinina', 
            'bun_crea',
            'acido_urico',
            'fosforo', 
            'calcio',
            'magnesio',
            'AST',
            'ALT', 
            'Fosfatasa_Alcalina',
            'GGT',
            'billirrubina_total', 
            'Albumina', 
            'proteinas_totales', 
            'Globulinas', 
            'alb/glo',
            'lipasa'

        ];
        
        // Encontrar el índice del campo actual
        const indiceActual = camposParametros.indexOf(event.target.id);
        
        if (indiceActual > 0) {
            // Mover al campo anterior
            const anteriorId = camposParametros[indiceActual - 1];
            document.getElementById(anteriorId).focus();
        }
    }
}
document.addEventListener('DOMContentLoaded', () => {
    // No cargar inmediatamente, esperar a que se detecte el template
});
// Función mejorada de redondeo que maneja correctamente los IDs de referencia
function redondearAEntero(id) {
    const input = document.getElementById(id);
    if (!input || input.value === '') return;
    
    // Eliminar flechas y obtener valor numérico
    const valorTexto = input.value.replace(/\s*[↑↓]$/, '').replace(',', '.');
    const valor = parseFloat(valorTexto);
    
    if (isNaN(valor)) return;
    
    // Si tiene decimales, redondear a entero
    if (!Number.isInteger(valor)) {
        input.value = Math.round(valor);
    }
    
    // Usar IDs de referencia específicos para cada campo
    let refId;
    switch(id) {
        case 'Colesterol_total':
            refId = 'refcolesterolT';
            break;
        case 'Trigliceridos':
            refId = 'refTrigliceridos';
            break;
        case 'Glucosa':
            refId = 'refglucosa';
            break;
        case 'amilasa':
            refId = 'refamilasa';
            break;
        case 'AST':
            refId = 'refAST';
            break;
        case 'ALT':
            refId = 'refALT';
            break;
        case 'Fosfatasa_Alcalina':
            refId = 'refFosfatasa_Alcalina';
            break;
        case 'urea':
            refId = 'refurea';
            break;
        case 'nitrogeno_ureico':
            refId = 'refnitrogeno_ureico';
            break;
        case 'GGT':
            refId = 'refGGT';
            break;
        case 'sodio':
            refId = 'refsodio';
            break;
        case 'cloro':
            refId = 'refcloro';
            break;
        case 'Na_K':
            refId = 'refNa_K';
            break;
        default:
            refId = 'ref' + id.toLowerCase();
    }
    
    // Aplicar color y flechas después del redondeo
    const evento = new Event('blur');
    actualizarColor(id, refId, evento);
}

// Asignar esta función a los campos que necesitan redondeo
document.addEventListener('DOMContentLoaded', function() {
    // Campos que deben redondearse a enteros
    const camposEnteros = ['Glucosa', 'Colesterol_total', 'Trigliceridos', 'ALT', 'Fosfatasa_Alcalina', 'urea', 'AST', 'nitrogeno_ureico', 'sodio', 'cloro', 'Na_K', 'GGT'];
    
    camposEnteros.forEach(id => {
        const campo = document.getElementById(id);
        if (campo) {
            // Remover listeners existentes para evitar conflictos
            const nuevoInput = campo.cloneNode(true);
            campo.parentNode.replaceChild(nuevoInput, campo);
            
            // Agregar el nuevo listener
            nuevoInput.addEventListener('blur', function() {
                redondearAEntero(id);
            });
            
            // Mantener navegación con teclas
            if (campo.hasAttribute('onkeydown')) {
                const keydownValue = campo.getAttribute('onkeydown');
                nuevoInput.setAttribute('onkeydown', keydownValue);
            }
        }
    });
});
// Función para redondear a un decimal (para fósforo y calcio)
function redondearAUnDecimal(id) {
    const input = document.getElementById(id);
    if (!input || input.value === '') return;
    
    // Eliminar flechas y obtener valor numérico
    const valorTexto = input.value.replace(/\s*[↑↓]$/, '').replace(',', '.');
    const valor = parseFloat(valorTexto);
    
    if (isNaN(valor)) return;
    
    // Redondear a un decimal
    const valorRedondeado = Math.round(valor * 10) / 10;
    
    // Convertir a formato con coma decimal (español)
    input.value = valorRedondeado.toFixed(1).replace('.', ',');
    
    // Aplicar color y flechas después del redondeo
    const evento = new Event('blur');
    actualizarColor(id, 'ref' + id.toLowerCase(), evento);
}

// Asignar esta función a los campos fósforo y calcio
document.addEventListener('DOMContentLoaded', function() {
    // Campos que deben redondearse a un decimal
    const camposUnDecimal = ['fosforo', 'calcio', 'acido_urico', 'creatinina'];
    
    camposUnDecimal.forEach(id => {
        const campo = document.getElementById(id);
        if (campo) {
            // Remover listeners existentes para evitar conflictos
            const nuevoInput = campo.cloneNode(true);
            campo.parentNode.replaceChild(nuevoInput, campo);
            
            // Agregar el nuevo listener
            nuevoInput.addEventListener('blur', function() {
                redondearAUnDecimal(id);
            });
            
            // Mantener navegación con teclas
            if (campo.hasAttribute('onkeydown')) {
                const keydownValue = campo.getAttribute('onkeydown');
                nuevoInput.setAttribute('onkeydown', keydownValue);
            }
        }
    });
});
function cargarListaDeParametros() {
    const selector = document.getElementById('parameterSelector');
    if (!selector) {
        return;
    }
    
    selector.innerHTML = '<option value="" selected disabled>-- Seleccionar parámetro --</option>';
    
    // Lista de parámetros específicos que queremos mostrar
    const parametrosEspecificos = [
    "GLUCOSA", "COLESTEROL TOTAL", "TRIGLICÉRIDOS", "CK",
    "NITROGENO UREICO", "UREA", "CREATININA", "RELACIÓN BUN/CREA", "ÁCIDO ÚRICO", "FOSFORO", "CALCIO", "MAGNESIO",
    "AST", "ALT", "FOSFATASA ALCALINA", "GGT", "BILLIRRUBINA TOTAL",
    "ALBUMINA", "PROTEINAS TOTALES", "GLOBULINAS TOTALES", "RELACIÓN ALBUMINA/GLOBULINAS", "LIPASA PANCREATICA"
];
    
    const tablas = document.querySelectorAll('#template1 table');
    
    tablas.forEach((tabla, tablaIndex) => {
        const filas = tabla.querySelectorAll('tbody tr');
        
        filas.forEach((fila, filaIndex) => {
            if (!fila.cells || fila.cells.length === 0) return;
            
            // Obtener el nombre del parámetro (primera celda)
            const paramName = fila.cells[0]?.textContent.trim();
            
            // Solo agregar los parámetros específicos que queremos
            if (parametrosEspecificos.includes(paramName)) {
                // Crear un ID único para la fila
                const filaId = `fila-${tablaIndex}-${filaIndex}`;
                fila.id = filaId;
                
                // Añadir opción al selector
                const option = document.createElement('option');
                option.value = filaId;
                option.textContent = paramName;
                selector.appendChild(option);
            }
        });
    });
}

function eliminarParametroSeleccionado() {
    const selector = document.getElementById('parameterSelector');
    const filaId = selector.value;

    if (!filaId) {
        alert('Por favor, selecciona un parámetro para eliminar.');
        return;
    }

    const fila = document.getElementById(filaId);
    if (fila) {
        fila.remove();

        // Actualizar el selector después de eliminar
        cargarListaDeParametros();

        // Verificar si el campo eliminado tiene eventos asociados y eliminarlos
        const input = fila.querySelector('input');
        if (input) {
            const inputClone = input.cloneNode(true); // Clonar el nodo para eliminar eventos
            input.parentNode.replaceChild(inputClone, input); // Reemplazar el nodo original
        }
    }
}
    function actualizarSexoEnPlantilla() {
        const sexo = document.getElementById('sexoSelector').value;
        document.getElementById('sexoEnPlantilla').value = sexo.charAt(0).toUpperCase() + sexo.slice(1);
    }
    function actualizarEspecieEnPlantilla() {
        const especie = document.getElementById('especieSelector').value;
        document.getElementById('especieEnPlantilla').value = especie;
    }
    function verificarMedico2() {
        const medico = document.getElementById('nombreMedico').value;
        const mensaje = document.getElementById('mensajeMedico');
        if (medico === 'N.A' || medico === '') {
            mensaje.style.display = 'none';
        } else {
            mensaje.style.display = 'block';
        }
    }
    </script>
        <script>
            function toggleTemplate() {
                const templates = document.querySelectorAll('.container');
                const selectedTemplate = document.getElementById(document.getElementById('templateSelector').value);
                templates.forEach(template => template.style.display = 'none');
                if (selectedTemplate) selectedTemplate.style.display = 'block';
            }
    
            function actualizarSexoEnPlantilla() {
                const sexo = document.getElementById('sexoSelector').value;
                document.querySelectorAll('.container').forEach(template => {
                    const input = template.querySelector('#sexoEnPlantilla, #sexoEnPlantilla2');
                    if (input) input.value = sexo;
                });
            }
    
            function actualizarEspecieEnPlantilla() {
                const especie = document.getElementById('especieSelector').value;
                document.querySelectorAll('.container').forEach(template => {
                    const input = template.querySelector('#especieEnPlantilla, #especieEnPlantilla2');
                    if (input) input.value = especie;
                });
            }
    
            function actualizarValoresReferencia() {
                const especie = document.getElementById('especieSelector').value;
                const sexo = document.getElementById('sexoSelector').value;
                const edad = document.getElementById('edadSelector').value;
                // Lógica para actualizar los valores de referencia en todas las plantillas
            }

            
    
    </script>
    <script>
document.addEventListener('DOMContentLoaded', function() {
    // Configurar el historial de análisis
    setupHistorial();
    
    // Añadir evento para guardar los datos al generar el PDF
    const pdfButton = document.getElementById('pdfButton');
    if (pdfButton) {
        const originalHandler = pdfButton.onclick;
        pdfButton.onclick = async function() {
            // Guardar los datos antes de generar el PDF
            guardarAnalisisActual();
            
            // Llamar al manejador original
            if (originalHandler) {
                return originalHandler.apply(this, arguments);
            }
        };
    }
});

// Función para configurar el selector de historial
function setupHistorial() {
    // Crear el selector de historial
    const controlsDiv = document.querySelector('.controls');
    
    if (controlsDiv) {
        // Crear el contenedor para el historial
        const historialContainer = document.createElement('div');
        historialContainer.className = 'historial-container';
        historialContainer.style.marginTop = '10px';
        
        // Crear etiqueta
        const label = document.createElement('label');
        label.htmlFor = 'historialSelector';
        label.textContent = 'Historial de análisis:';
        label.style.marginRight = '10px';
        
        // Crear selector
        const select = document.createElement('select');
        select.id = 'historialSelector';
        select.style.padding = '5px';
        select.style.marginRight = '10px';
        
        // Opción por defecto
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '-- Seleccionar análisis anterior --';
        defaultOption.selected = true;
        select.appendChild(defaultOption);
        
        // Cargar opciones del historial
        cargarOpcionesHistorial(select);
        
        // Evento de cambio
        select.addEventListener('change', function() {
            if (this.value) {
                cargarAnalisisDesdeHistorial(this.value);
            }
        });
        
        // Agregar botón para borrar historial
        const borrarHistorialBtn = document.createElement('button');
        borrarHistorialBtn.textContent = 'Borrar Historial';
        borrarHistorialBtn.style.marginLeft = '10px';
        borrarHistorialBtn.onclick = function() {
            if (confirm('¿Estás seguro de que quieres borrar todo el historial de análisis?')) {
                localStorage.removeItem('panelQuimicoHistorial');
                cargarOpcionesHistorial(select);
                alert('Historial borrado correctamente');
            }
        };
        
        // Agregar elementos al DOM
        historialContainer.appendChild(label);
        historialContainer.appendChild(select);
        historialContainer.appendChild(borrarHistorialBtn);
        
        // Agregar después de los selectores existentes
        controlsDiv.appendChild(historialContainer);
    }
}

// Función para cargar las opciones del historial
function cargarOpcionesHistorial(selectElement) {
    // Limpiar opciones existentes excepto la primera
    while (selectElement.options.length > 1) {
        selectElement.remove(1);
    }
    
    // Obtener historial del localStorage
    const historial = JSON.parse(localStorage.getItem('panelQuimicoHistorial') || '[]');
    
    // Agregar cada análisis como opción
    historial.forEach((analisis, index) => {
        const option = document.createElement('option');
        option.value = index;
        
        // Crear descripción con nombre, fecha y hora
        const fecha = new Date(analisis.timestamp);
        const fechaStr = fecha.toLocaleDateString();
        const horaStr = fecha.toLocaleTimeString();
        
        option.textContent = `${analisis.mascotaNombre} - ${analisis.propietarioNombre} (${fechaStr} ${horaStr})`;
        
        selectElement.appendChild(option);
    });
}

// Función para guardar el análisis actual
function guardarAnalisisActual() {
    // Recopilación de todos los datos del formulario
    const formData = {
        // Datos de la mascota y propietario
        mascotaNombre: document.getElementById('mascotaNombre')?.value || '',
        mascotaRaza: document.getElementById('mascotaRaza')?.value || '',
        mascotaEspecie: document.getElementById('especieEnPlantilla')?.value || '',
        mascotaSexo: document.getElementById('sexoEnPlantilla')?.value || '',
        mascotaEdad: document.getElementById('mascotaEdad')?.value || '',
        mascotaPeso: document.getElementById('mascotaPeso')?.value || '',

        propietarioNombre: document.getElementById('propietarioNombre')?.value || '',
        propietarioCedula: document.getElementById('propietarioCedula')?.value || '',
        propietarioTelefono: document.getElementById('propietarioTelefono')?.value || '',
        propietarioEmail: document.getElementById('propietarioEmail')?.value || '',
        propietarioFecha: document.getElementById('propietarioFecha')?.value || '',
        nombreMedico: document.getElementById('nombreMedico')?.value || '',

        // Datos de química clínica
        Glucosa: document.getElementById('Glucosa')?.value || '',
        Colesterol_total: document.getElementById('Colesterol_total')?.value || '',
        Trigliceridos: document.getElementById('Trigliceridos')?.value || '',

        // Datos de funcionamiento renal
        nitrogeno_ureico: document.getElementById('nitrogeno_ureico')?.value || '',
        creatinina: document.getElementById('creatinina')?.value || '',
        urea: document.getElementById('urea')?.value || '',
        acido_urico: document.getElementById('acido_urico')?.value || '',
        bun_crea: document.getElementById('bun_crea')?.value || '',
        fosforo: document.getElementById('fosforo')?.value || '',
        calcio: document.getElementById('calcio')?.value || '',
        magnesio: document.getElementById('magnesio')?.value || '',

        // Datos de funcionamiento hepático
        AST: document.getElementById('AST')?.value || '',
        ALT: document.getElementById('ALT')?.value || '',
        Fosfatasa_Alcalina: document.getElementById('Fosfatasa_Alcalina')?.value || '',
        GGT: document.getElementById('GGT')?.value || '',
        billirrubina_total: document.getElementById('billirrubina_total')?.value || '',

        // Datos de funcionamiento sanguíneo
        Albumina: document.getElementById('Albumina')?.value || '',
        proteinas_totales: document.getElementById('proteinas_totales')?.value || '',
        Globulinas: document.getElementById('Globulinas')?.value || '',
        alb_glo: document.getElementById('alb/glo')?.value || '',
        lipasa: document.getElementById('lipasa')?.value || '',

        // Índices de interferencia
        suero_hemolitico: document.getElementById('suero_hemolitico2')?.value || 'No se observa',
        suero_lipemico: document.getElementById('suero_lipemico2')?.value || 'No se observa',
        suero_icterico: document.getElementById('suero_icterico2')?.value || 'No se observa',

        // Selectores principales
        especieSelector: document.getElementById('especieSelector')?.value || '',
        sexoSelector: document.getElementById('sexoSelector')?.value || '',
        edadSelector: document.getElementById('edadSelector')?.value || '',

        // Añadir timestamp para ordenación
        timestamp: new Date().getTime()
    };

    // Verificar si hay datos significativos para guardar
    if (!formData.mascotaNombre && !formData.propietarioNombre) {
        console.warn('No hay datos significativos para guardar.');
        return;
    }

    // Obtener historial existente
    let historial = JSON.parse(localStorage.getItem('panelQuimicoHistorial') || '[]');

    // Añadir el nuevo análisis al principio
    historial.unshift(formData);

    // Limitar a los 10 últimos
    historial = historial.slice(0, 10);

    // Guardar en localStorage
    localStorage.setItem('panelQuimicoHistorial', JSON.stringify(historial));

    // Actualizar opciones en el selector
    const selector = document.getElementById('historialSelector');
    if (selector) {
        cargarOpcionesHistorial(selector);
    }
}

// Reemplaza la función cargarAnalisisDesdeHistorial por esta versión mejorada
function cargarAnalisisDesdeHistorial(index) {
    // Obtener historial
    const historial = JSON.parse(localStorage.getItem('panelQuimicoHistorial') || '[]');
    
    if (!historial[index]) return;
    
    const analisis = historial[index];
    
    // Cargar todos los campos básicos primero
    document.getElementById('mascotaNombre').value = analisis.mascotaNombre || '';
    document.getElementById('mascotaRaza').value = analisis.mascotaRaza || '';
    document.getElementById('mascotaEdad').value = analisis.mascotaEdad || '';
    document.getElementById('mascotaPeso').value = analisis.mascotaPeso || '';
    
    document.getElementById('propietarioNombre').value = analisis.propietarioNombre || '';
    document.getElementById('propietarioCedula').value = analisis.propietarioCedula || '';
    document.getElementById('propietarioTelefono').value = analisis.propietarioTelefono || '';
    document.getElementById('propietarioEmail').value = analisis.propietarioEmail || '';
    document.getElementById('propietarioFecha').value = analisis.propietarioFecha || '';
    document.getElementById('nombreMedico').value = analisis.nombreMedico || '';
    
    // Establecer los selectores principales PRIMERO y en orden correcto
    // 1. Especie
    if (analisis.especieSelector) {
        document.getElementById('especieSelector').value = analisis.especieSelector;
        // Actualizar manualmente el campo relacionado
        document.getElementById('especieEnPlantilla').value = analisis.mascotaEspecie || '';
    }
    
    // 2. Sexo
    if (analisis.sexoSelector) {
        document.getElementById('sexoSelector').value = analisis.sexoSelector;
        // Actualizar manualmente el campo relacionado
        document.getElementById('sexoEnPlantilla').value = analisis.mascotaSexo || '';
    }
    
    // 3. Edad
    if (analisis.edadSelector) {
        document.getElementById('edadSelector').value = analisis.edadSelector;
    }
    
    // IMPORTANTE: Actualizar los valores de referencia explícitamente
    // DESPUÉS de establecer todos los selectores
    actualizarValoresReferencia2();
    
    // Ahora cargar los valores de los análisis
    document.getElementById('Glucosa').value = analisis.Glucosa || '';
    document.getElementById('Colesterol_total').value = analisis.Colesterol_total || '';
    document.getElementById('Trigliceridos').value = analisis.Trigliceridos || '';
    
    document.getElementById('nitrogeno_ureico').value = analisis.nitrogeno_ureico || '';
    document.getElementById('creatinina').value = analisis.creatinina || '';
    document.getElementById('urea').value = analisis.urea || '';
    document.getElementById('acido_urico').value = analisis.acido_urico || '';
    document.getElementById('bun_crea').value = analisis.bun_crea || '';
    document.getElementById('fosforo').value = analisis.fosforo || '';
    document.getElementById('calcio').value = analisis.calcio || '';
    document.getElementById('magnesio').value = analisis.magnesio || '';
    
    document.getElementById('AST').value = analisis.AST || '';
    document.getElementById('ALT').value = analisis.ALT || '';
    document.getElementById('Fosfatasa_Alcalina').value = analisis.Fosfatasa_Alcalina || '';
    document.getElementById('GGT').value = analisis.GGT || '';
    document.getElementById('billirrubina_total').value = analisis.billirrubina_total || '';
    
    document.getElementById('Albumina').value = analisis.Albumina || '';
    document.getElementById('proteinas_totales').value = analisis.proteinas_totales || '';
    document.getElementById('Globulinas').value = analisis.Globulinas || '';
    document.getElementById('alb/glo').value = analisis.alb_glo || '';
    document.getElementById('lipasa').value = analisis.lipasa || '';
    
    document.getElementById('suero_hemolitico2').value = analisis.suero_hemolitico || 'No se observa';
    document.getElementById('suero_lipemico2').value = analisis.suero_lipemico || 'No se observa';
    document.getElementById('suero_icterico2').value = analisis.suero_icterico || 'No se observa';
    
    // Actualizar colores y valores calculados
    calculateValues(); // Para actualizar globulinas y alb/glo
    calculateBunCreatinine(); // Para actualizar BUN/CREA
    
    // Actualizar colores para todos los campos
    const parametros = [
        { campo: 'Glucosa', ref: 'refglucosa' },
        { campo: 'Colesterol_total', ref: 'refcolesterolT' },
        { campo: 'Trigliceridos', ref: 'refTrigliceridos' },
        { campo: 'nitrogeno_ureico', ref: 'refnitrogeno_ureico' },
        { campo: 'urea', ref: 'refurea' },
        { campo: 'creatinina', ref: 'refcreatinina' },
        { campo: 'bun_crea', ref: 'refbun_crea' },
        { campo: 'acido_urico', ref: 'refacido_urico' },
        { campo: 'fosforo', ref: 'reffosforo' },
        { campo: 'calcio', ref: 'refcalcio' },
        { campo: 'magnesio', ref: 'refmagnesio' },
        { campo: 'AST', ref: 'refAST' },
        { campo: 'ALT', ref: 'refALT' },
        { campo: 'Fosfatasa_Alcalina', ref: 'refFosfatasa_Alcalina' },
        { campo: 'GGT', ref: 'refGGT' },
        { campo: 'billirrubina_total', ref: 'refbillirrubina' },
        { campo: 'Albumina', ref: 'refalbumina' },
        { campo: 'lipasa', ref: 'reflipasa' },
        { campo: 'proteinas_totales', ref: 'refproteinas_totales' },
        { campo: 'Globulinas', ref: 'refglobulinas' },
        { campo: 'alb/glo', ref: 'refalb_glo' }
    ];
    
    parametros.forEach(param => {
        actualizarColor(param.campo, param.ref, {type: 'blur'});
    });
    
    // Mostrar mensaje de éxito
    alert(`Datos de ${analisis.mascotaNombre} cargados correctamente`);
}


        document.addEventListener('DOMContentLoaded', () => {
            const templates = document.querySelectorAll('.container');
            const templateSelector = document.getElementById('templateSelector');
        
            if (templateSelector) {
                templateSelector.addEventListener('change', () => {
                    templates.forEach(template => template.style.display = 'none');
                    const selectedTemplate = document.getElementById(templateSelector.value);
                    if (selectedTemplate) selectedTemplate.style.display = 'block';
                });
            }
        });
        
        function printTemplate() {
            const templateSelector = document.getElementById('templateSelector');
            const selectedTemplate = document.getElementById(templateSelector.value);
        
            if (!selectedTemplate) {
                alert('Selecciona una plantilla antes de imprimir.');
                return;
            }
        
            // Crear un contenedor temporal para la impresión
            const printContainer = document.createElement('div');
            printContainer.id = 'printContainer';
            printContainer.style.display = 'none';
            document.body.appendChild(printContainer);
        
            // Clonar la plantilla seleccionada y agregarla al contenedor de impresión
            const clone = selectedTemplate.cloneNode(true);
            printContainer.appendChild(clone);
        
            // Ocultar todas las plantillas excepto la seleccionada
            const templates = document.querySelectorAll('.container');
            templates.forEach(template => {
                if (template !== selectedTemplate) {
                    template.style.display = 'none';
                }
            });
        
            // Mostrar el contenedor de impresión y ocultar el resto del contenido
            printContainer.style.display = 'block';
            document.querySelector('.controls').style.display = 'none';
        
            // Imprimir el contenido del contenedor de impresión
            window.print();
        
            // Restaurar la visibilidad de todas las plantillas y controles
            printContainer.style.display = 'none';
            document.querySelector('.controls').style.display = 'block';
            templates.forEach(template => {
                template.style.display = 'none';
            });
            selectedTemplate.style.display = 'block';
        
            // Eliminar el contenedor de impresión
            document.body.removeChild(printContainer);
        }
        </script>
    <script>
   document.addEventListener('DOMContentLoaded', () => {
        const templates = document.querySelectorAll('.container');
        const templateSelector = document.getElementById('templateSelector');
    
        if (templateSelector) {
            templateSelector.addEventListener('change', () => {
                templates.forEach(template => template.style.display = 'none');
                const selectedTemplate = document.getElementById(templateSelector.value);
                if (selectedTemplate) selectedTemplate.style.display = 'block';
            });
        }
    });
    async function generatePDF() {
    // Mostrar el indicador de carga
    const loadingIndicator = document.getElementById('loadingPdf');
    const pdfButton = document.getElementById('pdfButton');
    
    loadingIndicator.style.display = 'flex';
    pdfButton.disabled = true;
    
    try {
        const { jsPDF } = window.jspdf;
        const selectedTemplate = document.getElementById('template1');

        if (!selectedTemplate) {
            alert('No se encontró la plantilla.');
            return;
        }

        // Obtener el nombre de la mascota y el primer apellido del propietario
        const mascotaNombre = document.getElementById('mascotaNombre').value || 'Sin_nombre';
        const propietarioNombre = document.getElementById('propietarioNombre').value || 'Sin_apellido';
        
        // Extraer el primer apellido (segundo elemento después de dividir por espacios)
        const nombreArray = propietarioNombre.split(' ');
        // Si hay al menos dos palabras, tomar la segunda como primer apellido
        // Si no, usar el valor completo o el default
        const propietarioApellido = nombreArray.length > 1 ? nombreArray[1] : nombreArray[0];

        // Espera a que todas las imágenes dentro del elemento se carguen
        const images = selectedTemplate.getElementsByTagName('img');
        const loadImages = Array.from(images).map(img => {
            return new Promise((resolve, reject) => {
                if (img.complete) {
                    resolve();
                } else {
                    img.onload = resolve;
                    img.onerror = reject;
                }
            });
        });

        await Promise.all(loadImages);

        // Genera el canvas
        const canvas = await html2canvas(selectedTemplate, {
            scale: 2,
            useCORS: true,
            logging: false,
            allowTaint: true,
            backgroundColor: '#ffffff'
        });

        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 140; 
        const pageHeight = 297;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        // Calcular la posición para centrar la imagen con márgenes
        const x = (pdf.internal.pageSize.getWidth() - imgWidth) / 2;
        const y = 5;

        // Agrega la imagen de la plantilla escalada y centrada
        pdf.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight);

        // Genera el nombre del archivo según la plantilla actual y datos
        // Verificar si viene de analitos_laboratorio
        const urlParams = new URLSearchParams(window.location.search);
        const isAnalitosLaboratorio = urlParams.get('template') === 'analitos_laboratorio';
        const fileName = isAnalitosLaboratorio 
            ? `Analitos Laboratorio ${mascotaNombre} ${propietarioApellido}.pdf`
            : `Perfil Quimico General ${mascotaNombre} ${propietarioApellido}.pdf`;
        
        // Generar el blob del PDF
        const pdfBlob = pdf.output('blob');
        
        // Intentar usar la API File System Access para guardar el archivo
        if ('showSaveFilePicker' in window) {
            try {
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [{
                        description: 'Archivo PDF',
                        accept: { 'application/pdf': ['.pdf'] }
                    }]
                });
                
                const writable = await fileHandle.createWritable();
                await writable.write(pdfBlob);
                await writable.close();
                
                console.log('Archivo guardado con éxito usando File System Access API');
            } catch (err) {
                // Si el usuario cancela el guardado o hay un error
                if (err.name !== 'AbortError') {
                    console.error('Error al usar File System Access API:', err);
                    // Caer en el método tradicional
                    pdf.save(fileName);
                }
            }
        } else {
            // Navegador no soporta File System Access API, usar método tradicional
            pdf.save(fileName);
        }
        
    } catch (error) {
        console.error('Error al generar el PDF:', error);
        alert('Ocurrió un error al generar el PDF: ' + error.message);
    } finally {
        // Ocultar el indicador de carga y habilitar el botón nuevamente
        loadingIndicator.style.display = 'none';
        pdfButton.disabled = false;
    }
}

// Función para eliminar el campo LIPASA
function deleteLipasaField() {
    const lipasaRow = document.getElementById('lipasaRow');
    if (lipasaRow) {
        if (confirm('¿Estás seguro de que quieres eliminar el campo LIPASA?')) {
            lipasaRow.remove();
            // También limpiar el valor del input si existe
            const lipasaInput = document.getElementById('lipasa');
            if (lipasaInput) {
                lipasaInput.value = '';
            }
        }
    } else {
        alert('El campo LIPASA ya ha sido eliminado');
    }
}
</script>
    </script>
        <script type="module" src="numeros.js"></script>
    </body>
    </html>
