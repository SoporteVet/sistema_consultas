<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hisopado de Oído</title>
    <link rel="stylesheet" href="index_lab.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="text/javascript">window.jsPDF = window.jspdf.jsPDF;</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=ABeeZee:ital@0;1&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=League+Spartan:wght@100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
    <style>
        /* Oculta elementos durante la generación de PDF */
        .pdf-hide { display: none !important; }
    </style>
    <script>
        // Autollenado desde parámetros URL
        document.addEventListener('DOMContentLoaded', function(){
            try {
                const params = new URLSearchParams(window.location.search);
                const setVal = (id, val) => { const el = document.getElementById(id); if (el && val!=null && val!=='') el.value = val; };
                setVal('mascotaNombre', params.get('mascotaNombre'));
                setVal('propietarioNombre', params.get('propietarioNombre'));
                setVal('propietarioCedula', params.get('propietarioCedula'));
                setVal('propietarioTelefono', params.get('propietarioTelefono'));
                setVal('propietarioEmail', params.get('propietarioEmail'));
                setVal('nombreMedico', params.get('nombreMedico'));
                setVal('mascotaRaza', params.get('mascotaRaza'));
                setVal('mascotaEdad', params.get('mascotaEdad'));
                setVal('mascotaPeso', params.get('mascotaPeso'));
                // Especie/Sexo
                const especie = params.get('especie');
                const sexo = params.get('mascotaSexo');
                const especieSelector = document.getElementById('especieSelector');
                const sexoSelector = document.getElementById('sexoSelector');
                if (especieSelector && especie) { especieSelector.value = capitalize(especie); actualizarEspecieEnPlantilla(); }
                if (sexoSelector && sexo) { sexoSelector.value = capitalize(sexo); actualizarSexoEnPlantilla(); }
                
                // Verificar el mensaje del médico después del autollenado
                const medico = params.get('nombreMedico');
                if (medico) {
                    setTimeout(() => {
                        verificarMedico();
                    }, 100);
                }
            } catch(e){ console.warn('Autollenado hisopado oído falló:', e); }
            function capitalize(s){ if(!s) return s; return s.charAt(0).toUpperCase()+s.slice(1).toLowerCase(); }
        });
    </script>
</head>
<body>
    <div class="controls">
        <label for="sexoSelector">Selecciona el sexo:</label>
        <select id="sexoSelector" onchange="actualizarSexoEnPlantilla()">
            <option value="Seleccionar" selected>-- Seleccionar --</option>
            <option value="Macho">Macho</option>
            <option value="Hembra">Hembra</option>
        </select>
        <label for="especieSelector">Selecciona la especie:</label>
        <select id="especieSelector" onchange="actualizarEspecieEnPlantilla()">
            <option value="Seleccionar" selected>-- Seleccionar --</option>
            <option value="Canino">Canino</option>
            <option value="Felino">Felino</option>
            <option value="Lagomorfo">Lagomorfo</option>
            <option value="Cuilo">Cuilo</option>
        </select>
    </div>

    <div class="container" style="display: block;">
        <div class="header">
            <img src="empresa.jpg" alt="Logo de la Empresa" class="small-image">
            <h1>Laboratorio Clínico Veterinario</h1>
        </div>
        <h3 class="subheader">HISOPADO DE OÍDO</h3>
            <table>
                <thead>
                    <tr>
                        <th colspan="2">DATOS DE LA MASCOTA</th>
                        <th colspan="2">DATOS DEL PROPIETARIO</th>
                    </tr>
                </thead>
                <tbody>
                <tr>
                    <td>Nombre</td>
                    <td><input type="text" id="mascotaNombre" onkeydown="moverFocoConFlechas(event, 'propietarioNombre', 'propietarioNombre', 'mascotaNombre', 'mascotaRaza')"></td>
                    <td>Nombre</td>
                    <td><input type="text" id="propietarioNombre" onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaNombre', 'mascotaNombre', 'propietarioCedula')"></td>
                </tr>
                <tr>
                    <td>Raza</td>
                    <td><input type="text" id="mascotaRaza" list="razas" onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaNombre', 'mascotaNombre', 'mascotaSexo')"></td>
                    <datalist id="razas"></datalist>
                    <td>Cédula</td>
                    <td><input type="text" id="propietarioCedula" onkeydown="moverFocoConFlechas(event, 'propietarioTelefono', 'mascotaRaza', 'propietarioNombre', 'propietarioTelefono')"></td>
                </tr>
                <tr>
                    <td>Sexo</td>
                    <td><input type="text" id="sexoEnPlantilla"></td>
                    <td>Teléfono</td>
                    <td><input type="text" id="propietarioTelefono" onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaSexo', 'propietarioCedula', 'propietarioEmail')"></td>
                </tr>
                <tr>
                    <td>Especie</td>
                    <td><input type="text" id="especieEnPlantilla"></td>
                    <td>Email</td>
                    <td><input type="text" id="propietarioEmail" onkeydown="moverFocoConFlechas(event, 'mascotaEspecie', 'mascotaEspecie', 'propietarioTelefono', 'nombreMedico')"></td>
                </tr>
                <tr>
                    <td>Edad</td>
                    <td><input type="text" id="mascotaEdad" list="edades" onkeydown="moverFocoConFlechas(event, 'nombreMedico', 'mascotaEspecie', 'mascotaEspecie', 'mascotaPeso')"></td>
                    <datalist id="edades">
                        <option value="1 mes"><option value="2 meses"><option value="3 meses"><option value="4 meses">
                        <option value="5 meses"><option value="6 meses"><option value="7 meses"><option value="8 meses"><option value="9 meses">
                        <option value="10 meses"><option value="11 meses"><option value="12 meses">
                        <option value="1 año"><option value="2 años"><option value="3 años"><option value="4 años">
                        <option value="5 años"><option value="6 años"><option value="7 años"><option value="8 años"><option value="9 años">
                        <option value="10 años"><option value="11 años"><option value="12 años"><option value="13 años"></option><option value="14 años"></option>
                        <option value="15 años"><option value="16 años"><option value="17 años"><option value="18 años"></option>
                        <option value="19 años"><option value="20 años"></option>    
                    </datalist>
                    <td>Médico</td>
                    <td>
                        <input type="text" id="nombreMedico" list="medicos" 
                            onkeydown="moverFocoConFlechas(event, 'propietarioFecha', 'mascotaEdad', 'propietarioEmail', 'propietarioFecha')" 
                            oninput="verificarMedico()">
                    </td>
                    <datalist id="medicos">
                        <option value="N.A">
                        <option value="Dr. Randall Azofeifa">
                        <option value="Dr. Luis Coto">
                        <option value="Dra. Daniela Sancho">
                        <option value="Dra. Sofia Carrillo">
                        <option value="Dra. Franciny Nuñez">
                        <option value="Dra. Maria Chacón">
                        <option value="Dra. Alejandra León">
                        <option value="Dra. Karla Quesada">
                        <option value="Dra. Kharen Moreno">
                        <option value="Dra. Karina Madrigal">
                        <option value="Dra. Natalia Alvarado">
                    </datalist>
                </tr>
                <tr>
                    <td>Peso</td>
                    <td><input type="text" id="mascotaPeso" list="pesos" onkeydown="moverFocoConFlechas(event, 'propietarioFecha', 'mascotaEdad', 'mascotaEdad', 'mascotaPeso')"></td>
                    <datalist id="pesos">
                        <option value="N.A">N.A</option><option value="0,1 kg">0,1 kg</option><option value="0,2 kg">0,2 kg</option><option value="0,3 kg">0,3 kg</option><option value="0,4 kg">0,4 kg</option>
                        <option value="0,5 kg">0,5 kg</option><option value="0,6 kg">0,6 kg</option><option value="0,7 kg">0,7 kg</option><option value="0,8 kg">0,8 kg</option><option value="0,9 kg">0,9 kg</option>
                        <option value="1,0 kg">1,0 kg</option><option value="1,1 kg">1,1 kg</option><option value="1,2 kg">1,2 kg</option><option value="1,3 kg">1,3 kg</option><option value="1,4 kg">1,4 kg</option>
                        <option value="1,5 kg">1,5 kg</option><option value="1,6 kg">1,6 kg</option><option value="1,7 kg">1,7 kg</option><option value="1,8 kg">1,8 kg</option><option value="1,9 kg">1,9 kg</option>
                        <option value="2,0 kg">2,0 kg</option><option value="2,1 kg">2,1 kg</option><option value="2,2 kg">2,2 kg</option><option value="2,3 kg">2,3 kg</option><option value="2,4 kg">2,4 kg</option>
                        <option value="2,5 kg">2,5 kg</option><option value="2,6 kg">2,6 kg</option><option value="2,7 kg">2,7 kg</option><option value="2,8 kg">2,8 kg</option><option value="2,9 kg">2,9 kg</option>
                        <option value="3,0 kg">3,0 kg</option><option value="3,1 kg">3,1 kg</option><option value="3,2 kg">3,2 kg</option><option value="3,3 kg">3,3 kg</option><option value="3,4 kg">3,4 kg</option>
                        <option value="3,5 kg">3,5 kg</option><option value="3,6 kg">3,6 kg</option><option value="3,7 kg">3,7 kg</option><option value="3,8 kg">3,8 kg</option><option value="3,9 kg">3,9 kg</option>
                        <option value="4,0 kg">4,0 kg</option><option value="4,1 kg">4,1 kg</option><option value="4,2 kg">4,2 kg</option><option value="4,3 kg">4,3 kg</option><option value="4,4 kg">4,4 kg</option>
                        <option value="4,5 kg">4,5 kg</option><option value="4,6 kg">4,6 kg</option><option value="4,7 kg">4,7 kg</option><option value="4,8 kg">4,8 kg</option><option value="4,9 kg">4,9 kg</option>
                        <option value="5,0 kg">5,0 kg</option><option value="5,1 kg">5,1 kg</option><option value="5,2 kg">5,2 kg</option><option value="5,3 kg">5,3 kg</option><option value="5,4 kg">5,4 kg</option>
                        <option value="5,5 kg">5,5 kg</option><option value="5,6 kg">5,6 kg</option><option value="5,7 kg">5,7 kg</option><option value="5,8 kg">5,8 kg</option><option value="5,9 kg">5,9 kg</option>
                        <option value="6,0 kg">6,0 kg</option><option value="6,1 kg">6,1 kg</option><option value="6,2 kg">6,2 kg</option><option value="6,3 kg">6,3 kg</option><option value="6,4 kg">6,4 kg</option>
                        <option value="6,5 kg">6,5 kg</option><option value="6,6 kg">6,6 kg</option><option value="6,7 kg">6,7 kg</option><option value="6,8 kg">6,8 kg</option><option value="6,9 kg">6,9 kg</option>
                        <option value="7,0 kg">7,0 kg</option><option value="7,1 kg">7,1 kg</option><option value="7,2 kg">7,2 kg</option><option value="7,3 kg">7,3 kg</option><option value="7,4 kg">7,4 kg</option>
                        <option value="7,5 kg">7,5 kg</option><option value="7,6 kg">7,6 kg</option><option value="7,7 kg">7,7 kg</option><option value="7,8 kg">7,8 kg</option><option value="7,9 kg">7,9 kg</option>
                        <option value="8,0 kg">8,0 kg</option><option value="8,1 kg">8,1 kg</option><option value="8,2 kg">8,2 kg</option><option value="8,3 kg">8,3 kg</option><option value="8,4 kg">8,4 kg</option>
                        <option value="8,5 kg">8,5 kg</option><option value="8,6 kg">8,6 kg</option><option value="8,7 kg">8,7 kg</option><option value="8,8 kg">8,8 kg</option><option value="8,9 kg">8,9 kg</option>
                        <option value="9,0 kg">9,0 kg</option><option value="9,1 kg">9,1 kg</option><option value="9,2 kg">9,2 kg</option><option value="9,3 kg">9,3 kg</option><option value="9,4 kg">9,4 kg</option>
                        <option value="9,5 kg">9,5 kg</option><option value="9,6 kg">9,6 kg</option><option value="9,7 kg">9,7 kg</option><option value="9,8 kg">9,8 kg</option><option value="9,9 kg">9,9 kg</option>
                        <option value="10,0 kg">10,0 kg</option><option value="10,1 kg">10,1 kg</option><option value="10,2 kg">10,2 kg</option><option value="10,3 kg">10,3 kg</option><option value="10,4 kg">10,4 kg</option>
                        <option value="10,5 kg">10,5 kg</option><option value="10,6 kg">10,6 kg</option><option value="10,7 kg">10,7 kg</option><option value="10,8 kg">10,8 kg</option><option value="10,9 kg">10,9 kg</option>
                        <option value="11,0 kg">11,0 kg</option><option value="11,1 kg">11,1 kg</option><option value="11,2 kg">11,2 kg</option><option value="11,3 kg">11,3 kg</option><option value="11,4 kg">11,4 kg</option>
                        <option value="11,5 kg">11,5 kg</option><option value="11,6 kg">11,6 kg</option><option value="11,7 kg">11,7 kg</option><option value="11,8 kg">11,8 kg</option><option value="11,9 kg">11,9 kg</option>
                        <option value="12,0 kg">12,0 kg</option>
                    </datalist>
                    <td>Fecha</td>
                    <td><input type="date" id="propietarioFecha" class="date-input" onkeydown="moverFocoConFlechas(event, 'nombreMedico', 'mascotaPeso', 'nombreMedico', 'propietarioFecha')"></td>
                </tr>
            </tbody>
        </table>

        <table>
            <thead>
                <tr><th colspan="2">HISOPADO DE OÍDO</th></tr>
            </thead>
            <tbody>
                <tr>
                    <td style="width: 30%;">TINCIÓN GRAM:</td>
                    <td>
                        <input type="text" id="tincionGram" list="gramOptions">
                        <datalist id="gramOptions">
                            <option value="Bacterias Gram Positivas">
                            <option value="Bacterias Gram Negativas">
                        </datalist>
                    </td>
                </tr>
                <tr>
                    <td rowspan="2">TINCIÓN DIFF QUIK:</td>
                    <td>
                        <input type="text" id="diffQuik1" value="Se observan estructuras levaduriformes compatibles con Malassezia spp">
                    </td>
                </tr>
                <tr>
                    <td>
                        <input type="text" id="diffQuik2" value="Se observan células epiteliales en escasa cantidad">
                    </td>
                </tr>
                <tr>
                    <td>ACEITE INMERSIÓN:</td>
                    <td>
                        <input type="text" id="aceiteInmersion" value="No se observan ácaros">
                    </td>
                </tr>
                <tr>
                    <td>KOH:</td>
                    <td>
                        <input type="text" id="koh" value="No se observan estructuras compatibles con dermátofitos">
                    </td>
                </tr>
            </tbody>
        </table>

        <div class="footer">
            <p id="mensajeMedico" style="display: none;">El personal médico cuenta con un plazo de 24 a 48 horas para interpretar el reporte de los resultados.</p>
            <p>Facebook: Veterinaria San Martin de Porres | Teléfono: 4000 - 1365 | Ext: 106</p>
            <p>WhatsApp: 8839 - 2214 | San Rafael Abajo de Desamparados, 50 metros Norte del Mall Zona Centro</p>
            <p>Correo: laboratorio@vetsanmartin.com</p>
        </div>
    </div>

    <div class="controls">
        <button id="pdfButton" onclick="generatePDF()">Generar PDF</button>
        <button id="menuButton" onclick="window.location.href='index.html'">Volver al Menú</button>
        <div id="loadingPdf" class="loading-indicator" style="display:none;">
            <div class="spinner"></div>
            <span>Generando PDF...</span>
        </div>
    </div>

    <script>
        // Funciones para actualizar sexo y especie
        function actualizarSexoEnPlantilla() {
            const sexo = document.getElementById('sexoSelector').value;
            const sexoCapitalizado = sexo.charAt(0).toUpperCase() + sexo.slice(1);
            document.getElementById('sexoEnPlantilla').value = sexoCapitalizado;
        }

        function actualizarEspecieEnPlantilla() {
            const especie = document.getElementById('especieSelector').value;
            document.getElementById('especieEnPlantilla').value = especie;
            actualizarRazasPorEspecie();
        }

        function verificarMedico() {
            const medico = document.getElementById('nombreMedico').value;
            const mensaje = document.getElementById('mensajeMedico');
            
            // Verificar si el médico es N.A en cualquier variante o está vacío
            const isNA = !medico || 
                       medico.trim() === '' || 
                       medico.toUpperCase() === 'N.A' || 
                       medico.toUpperCase() === 'NA' || 
                       medico.toUpperCase() === 'N.A.';
            
            if (isNA) {
                mensaje.style.display = 'none';
            } else {
                mensaje.style.display = 'block';
            }
        }

        // Navegación con teclas
        function moverFocoConFlechas(event, derechaId, izquierdaId, arribaId, abajoId) {
            switch (event.key) {
                case 'ArrowRight':
                    event.preventDefault();
                    document.getElementById(derechaId).focus();
                    break;
                case 'ArrowLeft':
                    event.preventDefault();
                    document.getElementById(izquierdaId).focus();
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    document.getElementById(arribaId).focus();
                    break;
                case 'Enter':
                case 'ArrowDown':
                    event.preventDefault();
                    document.getElementById(abajoId).focus();
                    break;
            }
        }

        // Listas de razas
        const razasCaninas = [
            "Ainu", "Airedale terrier", "Akita", "Akita Inu", "Alaskan Malamute",
            "American Black and Tan Coonhound", "American Bull Terrier", "American Pit Bull Terrier",
            "American Staffordshire terrier", "American Water Spaniel", "Apso Tibetano", "Barzoi", 
            "Basenji", "Basset Hound", "Beagle", "Bichon Frise", "Bloodhound", "Bobtail", 
            "Border Collie", "Boston Terrier", "Bouvier des Flandres", "Boxer", "Bull terrier", 
            "Bull Terrier Miniatura", "Bulldog Americano", "Bulldog Francés", "Bulldog Inglés", 
            "Bullmastiff", "Cavalier King Charles Spaniel", "Chihuahua", "Chow Chow", 
            "Cocker Spaniel Americano", "Cocker Spaniel Inglés", "Collie", "Collie Escocés", 
            "Dachshund", "Dálmata", "Doberman", "Doberman Pincher", "Dogo Alemán", 
            "Dogo Argentino", "Dogo de Burdeos", "French Poodle", "Galgo Español", 
            "Galgo Inglés-español", "Golden Retriever", "Gran Danés", "Greyhound", 
            "Husky Siberiano", "Jack Russell Terrier", "Labrador Retriever", "Maltés", 
            "Pastor Alemán", "Pequinés", "Pomerania", "Pug", "Rottweiler", "Samoyedo", 
            "San Bernardo", "Schnauzer", "Shih Tzu", "SRD", "Yorkshire Terrier", "Weimaraner", "Fila Brasileiro",
        ];

        const razasFelinas = [
            "Abisinio", "American Bobtail", "Angora Turco", "Azul Ruso", "Balinés", 
            "Bengalí", "Bobtail japonés", "Bombay", "British Shorthair", "Burmés", 
            "Carey", "Común Europeo", "Exótico", "Himalayo", "Javanés", 
            "Oriental", "Persa", "Sagrado de Birmania", "Siamés", "Siberiano", 
            "Silvestre", "SRD"
        ];

        function actualizarRazasPorEspecie() {
            const especie = document.getElementById('especieSelector').value;
            let datalistRazas = document.getElementById('razas');
            if (!datalistRazas) {
                datalistRazas = document.createElement('datalist');
                datalistRazas.id = 'razas';
                document.body.appendChild(datalistRazas);
            } else {
                datalistRazas.innerHTML = '';
            }
            const campoRaza = document.getElementById('mascotaRaza');
            if (campoRaza.value && campoRaza.value !== "SRD") {
                campoRaza.value = '';
            }
            if (especie === "Canino") {
                razasCaninas.forEach(raza => {
                    const option = document.createElement('option');
                    option.value = raza;
                    datalistRazas.appendChild(option);
                });
            } else if (especie === "Felino") {
                razasFelinas.forEach(raza => {
                    const option = document.createElement('option');
                    option.value = raza;
                    datalistRazas.appendChild(option);
                });
            } else if (especie === "Lagomorfo" || especie === "Cuilo") {
                const option = document.createElement('option');
                option.value = "SRD";
                datalistRazas.appendChild(option);
            }
        }

        // Inicializar al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            const especieSelector = document.getElementById('especieSelector');
            if (especieSelector) {
                actualizarRazasPorEspecie();
                especieSelector.addEventListener('change', actualizarRazasPorEspecie);
            }
            const campoRaza = document.getElementById('mascotaRaza');
            if (campoRaza && campoRaza.getAttribute('list') !== 'razas') {
                campoRaza.setAttribute('list', 'razas');
            }
        });

        // Generar PDF
        async function generatePDF() {
            const loadingIndicator = document.getElementById('loadingPdf');
            const pdfButton = document.getElementById('pdfButton');
            const menuButton = document.getElementById('menuButton');
            
            loadingIndicator.style.display = 'flex';
            pdfButton.disabled = true;
            menuButton.disabled = true;
            
            try {
                const { jsPDF } = window.jspdf;
                const container = document.querySelector('.container');
                const images = container.getElementsByTagName('img');
                const loadImages = Array.from(images).map(img => {
                    return new Promise((resolve, reject) => {
                        if (img.complete) resolve();
                        else { img.onload = resolve; img.onerror = reject; }
                    });
                });
                await Promise.all(loadImages);
                
                const canvas = await html2canvas(container, { 
                    scale: 3, 
                    useCORS: true, 
                    backgroundColor: '#ffffff' 
                });
                
                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 180;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const marginLeft = (210 - imgWidth) / 2;
                
                pdf.addImage(imgData, 'JPEG', marginLeft, 10, imgWidth, imgHeight);
                
                const petName = document.getElementById('mascotaNombre')?.value.trim() || '';
                const ownerFull = document.getElementById('propietarioNombre')?.value.trim() || '';
                const ownerParts = ownerFull.split(/\s+/);
                const firstSurname = ownerParts.length > 1 ? ownerParts[1] : ownerParts[0] || '';
                const fileName = `Hisopado de Oído ${petName} ${firstSurname}.pdf`;
                
                pdf.save(fileName);
            } catch (error) {
                console.error('Error al generar PDF:', error);
                alert('Ocurrió un error al generar el PDF: ' + error.message);
            } finally {
                loadingIndicator.style.display = 'none';
                pdfButton.disabled = false;
                menuButton.disabled = false;
            }
        }
    </script>
</body>
</html>
