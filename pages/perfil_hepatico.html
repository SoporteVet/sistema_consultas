<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil Hepático</title>
    <link rel="stylesheet" href="index_lab.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=ABeeZee:ital@0;1&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=League+Spartan:wght@100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">

    <style>
        /* Estilos para el panel de eliminación de parámetros */
        .parameter-selector-panel {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .parameter-selector-panel h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }

        .selector-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .parameter-dropdown {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .remove-param-btn {
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .remove-param-btn:hover {
            background: #c82333;
        }

        .remove-param-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        /* Estilos para campos calculados automáticamente */
        input[readonly] {
            background-color: #f8f9fa !important;
            color: #495057 !important;
            cursor: not-allowed;
            border: 1px solid #ced4da;
        }

        input[readonly]:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* Indicador visual para campos calculados */
        .campo-calculado::after {
            content: " (Calculado)";
            font-size: 0.8em;
            color: #6c757d;
            font-style: italic;
        }

        /* Estilos para colores de valores */
        .valor-bajo {
            position: relative;
        }

        .valor-alto {
            position: relative;
        }

        /* Asegurar que los colores se muestren correctamente en campos readonly */
        input[readonly].valor-bajo {
            color: #0096d2 !important;
        }

        input[readonly].valor-alto {
            color: red !important;
        }

        input[readonly].valor-normal {
            color: black !important;
        }

        /* Estilos para el historial */
        .historial-container {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .historial-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .historial-container select {
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        /* Estilos para el indicador de carga */
        .loading-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
            margin: 10px 0;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
<script>
// Autollenado Perfil Hepático desde parámetros URL
document.addEventListener('DOMContentLoaded', function(){
  try {
    const p = new URLSearchParams(location.search);
    const setVal = (id, v) => { const el = document.getElementById(id); if (el && v!=null && v!=='') el.value = v; };
    setVal('mascotaNombre', p.get('mascotaNombre'));
    setVal('propietarioNombre', p.get('propietarioNombre'));
    setVal('propietarioCedula', p.get('propietarioCedula'));
    setVal('propietarioTelefono', p.get('propietarioTelefono'));
    setVal('propietarioEmail', p.get('propietarioEmail'));
    setVal('nombreMedico', p.get('nombreMedico'));
    setVal('mascotaRaza', p.get('mascotaRaza'));
    setVal('mascotaEdad', p.get('mascotaEdad'));
    setVal('mascotaPeso', p.get('mascotaPeso'));
    
    // Verificar el mensaje del médico después del autollenado
    const medico = p.get('nombreMedico');
    if (medico) {
      setTimeout(() => {
        verificarMedico();
      }, 100);
    }
    
    const especie = p.get('especie');
    const sexo = p.get('mascotaSexo');
    if (especie) {
      const especieSelector = document.getElementById('especieSelector');
      if (especieSelector) {
        especieSelector.value = capitalize(especie);
        const evt = new Event('change'); especieSelector.dispatchEvent(evt);
      }
    }
    if (sexo) {
      const sexoSelector = document.getElementById('sexoSelector');
      if (sexoSelector) {
        sexoSelector.value = capitalize(sexo);
        const evt = new Event('change'); sexoSelector.dispatchEvent(evt);
      }
    }
  } catch(e) { console.warn('Autollenado perfil hepático falló:', e); }
  function capitalize(s){ if(!s) return s; return s.charAt(0).toUpperCase()+s.slice(1).toLowerCase(); }
});
</script>

<div class="controls">
    <label for="sexoSelector">Selecciona el sexo:</label>
    <select id="sexoSelector" onchange="actualizarSexoEnPlantilla(),actualizarValoresReferencia()">
        <option value="Seleccionar" selected>-- Seleccionar --</option>
        <option value="Macho">Macho</option>
        <option value="Hembra">Hembra</option>
    </select>
    <label for="especieSelector">Selecciona la especie:</label>
    <select id="especieSelector" onchange="actualizarEspecieEnPlantilla(),actualizarValoresReferencia()">
        <option value="Seleccionar" selected>-- Seleccionar --</option>
        <option value="Canino">Canino</option>
        <option value="Felino">Felino</option>
        <option value="Lagomorfo">Lagomorfo</option>
        <option value="Cuilo">Cuilo</option>
    </select>
    <label for="edadSelector">Selecciona el rango de edad:</label>
    <select id="edadSelector" onchange="actualizarValoresReferencia()">
        <option value="Seleccionar" selected>-- Seleccionar --</option>
        <option value="De 1 año a 12 años">De 1 año a 12 años</option>
        <option value="De 6 meses a 1 año">De 6 meses a 1 año</option>
        <option value="De mes y medio a 5 meses">De mes y medio a 5 meses</option>
        <option value="Menor de mes y medio">Menor de mes y medio</option>
        <option value="Todas las edades">Todas las edades</option>
    </select>
</div>

<!-- Panel para eliminar parámetros -->
<div class="parameter-selector-panel">
    <h3>Eliminar parámetros</h3>
    <div class="selector-container">
        <select id="parameterSelector" class="parameter-dropdown">
            <option value="" selected disabled>-- Seleccionar parámetro --</option>
        </select>
        <button onclick="eliminarParametroSeleccionado()" class="remove-param-btn">Eliminar</button>
    </div>
</div>

<div class="container" id="template1" style="display: block;">
    <div class="header">
        <img src="empresa.jpg" alt="Logo de la Empresa" class="small-image">
        <h1>Laboratorio Clínico Veterinario</h1>
    </div>
    <h3 class="subheader">PERFIL HEPÁTICO COMPLETO</h3>
        <table>
            <thead>
                <tr>
                    <th colspan="2">DATOS DE LA MASCOTA</th>
                    <th colspan="2">DATOS DEL PROPIETARIO</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Nombre</td>
                    <td><input type="text" id="mascotaNombre" onkeydown="moverFocoConFlechas(event, 'propietarioNombre', 'propietarioNombre', 'mascotaNombre', 'mascotaRaza')"></td>
                    <td>Nombre</td>
                    <td><input type="text" id="propietarioNombre"  onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaNombre', 'mascotaNombre', 'propietarioCedula')"></td>
                </tr>
                <tr>
                    <td>Raza</td>
                    <td><input type="text" id="mascotaRaza" list="razas"  onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaNombre', 'mascotaNombre', 'mascotaSexo')"></td>
                    <datalist id="razas"></datalist>
                    
                    <td>Cédula</td>
                    <td><input type="text" id="propietarioCedula"  onkeydown="moverFocoConFlechas(event, 'propietarioTelefono', 'mascotaRaza', 'propietarioNombre', 'propietarioTelefono')"></td>
                </tr>
                <tr>
                    <td>Sexo</td>
                    <td><input type="text" id="sexoEnPlantilla"></td>
                    <td>Teléfono</td>
                    <td><input type="text" id="propietarioTelefono" onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaSexo', 'propietarioCedula', 'propietarioEmail')"></td>
                </tr>
                <tr>
                    <td>Especie</td>
                    <td><input type="text" id="especieEnPlantilla"></td>
                    <td>Email</td>
                    <td><input type="text" id="propietarioEmail"  onkeydown="moverFocoConFlechas(event, 'mascotaEspecie', 'mascotaEspecie', 'propietarioTelefono', 'nombreMedico')"></td>
                </tr>
                <tr>
                    <td>Edad</td>
                    <td><input type="text" id="mascotaEdad" list="edades"  onkeydown="moverFocoConFlechas(event, 'nombreMedico', 'mascotaEspecie', 'mascotaEspecie', 'mascotaPeso')"></td>
                    <datalist id="edades">
                        <option value="1 mes"><option value="2 meses"><option value="3 meses"><option value="4 meses">
                        <option value="5 meses"><option value="6 meses"><option value="7 meses"><option value="8 meses"><option value="9 meses">
                        <option value="10 meses"><option value="11 meses"><option value="12 meses">
                        <option value="1 año"><option value="2 años"><option value="3 años"><option value="4 años">
                        <option value="5 años"><option value="6 años"><option value="7 años"><option value="8 años"><option value="9 años">
                        <option value="10 años"><option value="11 años"><option value="12 años"><option value="13 años"></option><option value="14 años"></option>
                        <option value="15 años"><option value="16 años"><option value="17 años"><option value="18 años"></option>
                        <option value="19 años"><option value="20 años"></option>    
                    </datalist>
                    <td>Médico</td>
                    <td>
                        <input type="text" id="nombreMedico" list="medicos" 
                            onkeydown="moverFocoConFlechas(event, 'propietarioFecha', 'mascotaEdad', 'propietarioEmail', 'propietarioFecha')" 
                            oninput="verificarMedico()">
                    </td>
                    <datalist id="medicos">
                        <option value="N.A">
                        <option value="Dr. Randall Azofeifa">
                        <option value="Dr. Luis Coto">
                        <option value="Dr. Gustavo Gónzalez">
                        <option value="Dra. Daniela Sancho">
                        <option value="Dra. Sofia Carrillo">
                        <option value="Dra. Franciny Nuñez">
                        <option value="Dra. Lourdes Chacón">
                        <option value="Dra. Alejandra León">
                        <option value="Dra. Karla Quesada">
                        <option value="Dra. Kharen Moreno">
                        <option value="Dra. Karina Madrigal">
                        <option value="Dra. Natalia Alvarado">
                    </datalist>
                </tr>
                <script>    
                    function actualizarSexoEnPlantilla() {
                        const sexo = document.getElementById('sexoSelector').value;
                        document.getElementById('sexoEnPlantilla').value = sexo.charAt(0).toUpperCase() + sexo.slice(1);
                    }
                    function actualizarEspecieEnPlantilla() {
                        const especie = document.getElementById('especieSelector').value;
                        document.getElementById('especieEnPlantilla').value = especie;
                    }
                    function verificarMedico() {
                        const medico = document.getElementById('nombreMedico').value;
                        const mensaje = document.getElementById('mensajeMedico');
                        if (medico === 'N.A' || medico === 'NA' || medico === '' || medico === 'N.A.' || medico.toLowerCase() === 'na') {
                            mensaje.style.display = 'none';
                        } else {
                            mensaje.style.display = 'block';
                        }
                    }
                </script>
                <tr>
                    <td>Peso</td>
                    <td><input type="text" id="mascotaPeso" list="pesos" onkeydown="moverFocoConFlechas(event, 'propietarioFecha', 'mascotaEdad', 'mascotaEdad', 'mascotaPeso')"></td>

    <datalist id="pesos">
        <option value="N.A">N.A</option><option value="0,1 kg">0,1 kg</option><option value="0,2 kg">0,2 kg</option><option value="0,3 kg">0,3 kg</option><option value="0,4 kg">0,4 kg</option>
        <option value="0,5 kg">0,5 kg</option><option value="0,6 kg">0,6 kg</option><option value="0,7 kg">0,7 kg</option><option value="0,8 kg">0,8 kg</option><option value="0,9 kg">0,9 kg</option>
        <option value="1,0 kg">1,0 kg</option><option value="1,1 kg">1,1 kg</option><option value="1,2 kg">1,2 kg</option><option value="1,3 kg">1,3 kg</option><option value="1,4 kg">1,4 kg</option>
        <option value="1,5 kg">1,5 kg</option><option value="1,6 kg">1,6 kg</option><option value="1,7 kg">1,7 kg</option><option value="1,8 kg">1,8 kg</option><option value="1,9 kg">1,9 kg</option>
        <option value="2,0 kg">2,0 kg</option><option value="2,1 kg">2,1 kg</option><option value="2,2 kg">2,2 kg</option><option value="2,3 kg">2,3 kg</option><option value="2,4 kg">2,4 kg</option>
        <option value="2,5 kg">2,5 kg</option><option value="2,6 kg">2,6 kg</option><option value="2,7 kg">2,7 kg</option><option value="2,8 kg">2,8 kg</option><option value="2,9 kg">2,9 kg</option>
        <option value="3,0 kg">3,0 kg</option><option value="3,1 kg">3,1 kg</option><option value="3,2 kg">3,2 kg</option><option value="3,3 kg">3,3 kg</option><option value="3,4 kg">3,4 kg</option>
        <option value="3,5 kg">3,5 kg</option><option value="3,6 kg">3,6 kg</option><option value="3,7 kg">3,7 kg</option><option value="3,8 kg">3,8 kg</option><option value="3,9 kg">3,9 kg</option>
        <option value="4,0 kg">4,0 kg</option><option value="4,1 kg">4,1 kg</option><option value="4,2 kg">4,2 kg</option><option value="4,3 kg">4,3 kg</option><option value="4,4 kg">4,4 kg</option>
        <option value="4,5 kg">4,5 kg</option><option value="4,6 kg">4,6 kg</option><option value="4,7 kg">4,7 kg</option><option value="4,8 kg">4,8 kg</option><option value="4,9 kg">4,9 kg</option>
        <option value="5,0 kg">5,0 kg</option><option value="5,1 kg">5,1 kg</option><option value="5,2 kg">5,2 kg</option><option value="5,3 kg">5,3 kg</option><option value="5,4 kg">5,4 kg</option>
        <option value="5,5 kg">5,5 kg</option><option value="5,6 kg">5,6 kg</option><option value="5,7 kg">5,7 kg</option><option value="5,8 kg">5,8 kg</option><option value="5,9 kg">5,9 kg</option>
        <option value="6,0 kg">6,0 kg</option><option value="6,1 kg">6,1 kg</option><option value="6,2 kg">6,2 kg</option><option value="6,3 kg">6,3 kg</option><option value="6,4 kg">6,4 kg</option>
        <option value="6,5 kg">6,5 kg</option><option value="6,6 kg">6,6 kg</option><option value="6,7 kg">6,7 kg</option><option value="6,8 kg">6,8 kg</option><option value="6,9 kg">6,9 kg</option>
        <option value="7,0 kg">7,0 kg</option><option value="7,1 kg">7,1 kg</option><option value="7,2 kg">7,2 kg</option><option value="7,3 kg">7,3 kg</option><option value="7,4 kg">7,4 kg</option>
        <option value="7,5 kg">7,5 kg</option><option value="7,6 kg">7,6 kg</option><option value="7,7 kg">7,7 kg</option><option value="7,8 kg">7,8 kg</option><option value="7,9 kg">7,9 kg</option>
        <option value="8,0 kg">8,0 kg</option><option value="8,1 kg">8,1 kg</option><option value="8,2 kg">8,2 kg</option><option value="8,3 kg">8,3 kg</option><option value="8,4 kg">8,4 kg</option>
        <option value="8,5 kg">8,5 kg</option><option value="8,6 kg">8,6 kg</option><option value="8,7 kg">8,7 kg</option><option value="8,8 kg">8,8 kg</option><option value="8,9 kg">8,9 kg</option>
        <option value="9,0 kg">9,0 kg</option><option value="9,1 kg">9,1 kg</option><option value="9,2 kg">9,2 kg</option><option value="9,3 kg">9,3 kg</option><option value="9,4 kg">9,4 kg</option>
        <option value="9,5 kg">9,5 kg</option><option value="9,6 kg">9,6 kg</option><option value="9,7 kg">9,7 kg</option><option value="9,8 kg">9,8 kg</option><option value="9,9 kg">9,9 kg</option>
        <option value="10,0 kg">10,0 kg</option><option value="10,1 kg">10,1 kg</option><option value="10,2 kg">10,2 kg</option><option value="10,3 kg">10,3 kg</option><option value="10,4 kg">10,4 kg</option>
        <option value="10,5 kg">10,5 kg</option><option value="10,6 kg">10,6 kg</option><option value="10,7 kg">10,7 kg</option><option value="10,8 kg">10,8 kg</option><option value="10,9 kg">10,9 kg</option>
        <option value="11,0 kg">11,0 kg</option><option value="11,1 kg">11,1 kg</option><option value="11,2 kg">11,2 kg</option><option value="11,3 kg">11,3 kg</option><option value="11,4 kg">11,4 kg</option>
        <option value="11,5 kg">11,5 kg</option><option value="11,6 kg">11,6 kg</option><option value="11,7 kg">11,7 kg</option><option value="11,8 kg">11,8 kg</option><option value="11,9 kg">11,9 kg</option>
        <option value="12,0 kg">12,0 kg</option>
        
    </datalist>
        <td>Fecha</td>
        <td><input type="date" id="propietarioFecha" class="date-input" onkeydown="moverFocoConFlechas(event, 'nombreMedico', 'mascotaPeso', 'nombreMedico', 'propietarioFecha')"></td>
                </tr>
                
                <script>
              function formatearFecha(input) {
            const fecha = new Date(input.value);
            const dia = String(fecha.getDate()).padStart(2, '0');
            const mes = String(fecha.getMonth() + 1).padStart(2, '0');
            const año = fecha.getFullYear();
            input.value = `${dia}-${mes}-${año}`;
        }
   
                function moverFocoConFlechas(event, derechaId, izquierdaId, arribaId, abajoId) {
                    switch (event.key) {
                        case 'ArrowRight':
                            event.preventDefault();
                            document.getElementById(derechaId).focus();
                            break;
                        case 'ArrowLeft':
                            event.preventDefault();
                            document.getElementById(izquierdaId).focus();
                            break;
                        case 'ArrowUp':
                            event.preventDefault();
                            document.getElementById(arribaId).focus();
                            break;
                        case 'Enter':
                        case 'ArrowDown':
                            event.preventDefault();
                            document.getElementById(abajoId).focus();
                            break;
                    }
                }
                const razasCaninas = [
    "Ainu", "Airedale terrier", "Akita", "Akita Inu", "Alaskan Malamute",
    "American Black and Tan Coonhound", "American Bull Terrier", "American Pit Bull Terrier",
    "American Staffordshire terrier", "American Water Spaniel", "Apso Tibetano", "Barzoi", 
    "Basenji", "Basset Hound", "Beagle", "Bichon Frise", "Bloodhound", "Bobtail", 
    "Border Collie", "Boston Terrier", "Bouvier des Flandres", "Boxer", "Bull terrier", 
    "Bull Terrier Miniatura", "Bulldog Americano", "Bulldog Francés", "Bulldog Inglés", 
    "Bullmastiff", "Cavalier King Charles Spaniel", "Chihuahua", "Chow Chow", 
    "Cocker Spaniel Americano", "Cocker Spaniel Inglés", "Collie", "Collie Escocés", 
    "Dachshund", "Dálmata", "Doberman", "Doberman Pincher", "Dogo Alemán", 
    "Dogo Argentino", "Dogo de Burdeos", "French Poodle", "Galgo Español", 
    "Galgo Inglés-español", "Golden Retriever", "Gran Danés", "Greyhound", 
    "Husky Siberiano", "Jack Russell Terrier", "Labrador Retriever", "Maltés", 
    "Pastor Alemán", "Pequinés", "Pomerania", "Pug", "Rottweiler", "Samoyedo", 
    "San Bernardo", "Schnauzer", "Shih Tzu", "SRD", "Yorkshire Terrier", "Weimaraner", "Fila Brasileiro",
];

const razasFelinas = [
    "Abisinio", "American Bobtail", "Angora Turco", "Azul Ruso", "Balinés", 
    "Bengalí", "Bobtail japonés", "Bombay", "British Shorthair", "Burmés", 
    "Carey", "Común Europeo", "Exótico", "Himalayo", "Javanés", 
    "Oriental", "Persa", "Sagrado de Birmania", "Siamés", "Siberiano", 
    "Silvestre", "SRD"
];

// Función para actualizar el datalist de razas según la especie seleccionada
function actualizarRazasPorEspecie() {
    const especie = document.getElementById('especieSelector').value;
    // Crear el datalist si no existe
    let datalistRazas = document.getElementById('razas');
    if (!datalistRazas) {
        datalistRazas = document.createElement('datalist');
        datalistRazas.id = 'razas';
        document.body.appendChild(datalistRazas);
    } else {
        // Limpiar la lista actual
        datalistRazas.innerHTML = '';
    }
    
    const campoRaza = document.getElementById('mascotaRaza');
    
    // Restablecer el campo de raza si se cambia la especie
    if (campoRaza.value && campoRaza.value !== "SRD") {
        campoRaza.value = '';
    }
    
    // Agregar las razas según la especie seleccionada
    if (especie === "Canino") {
        razasCaninas.forEach(raza => {
            const option = document.createElement('option');
            option.value = raza;
            datalistRazas.appendChild(option);
        });
    } else if (especie === "Felino") {
        razasFelinas.forEach(raza => {
            const option = document.createElement('option');
            option.value = raza;
            datalistRazas.appendChild(option);
        });
    } else if (especie === "Lagomorfo" || especie === "Cuilo") {
        // Para otras especies, agregar solo opciones genéricas
        const option = document.createElement('option');
        option.value = "SRD";
        datalistRazas.appendChild(option);
    }
}

// Modificar la función existente
function actualizarEspecieEnPlantilla() {
    const especie = document.getElementById('especieSelector').value;
    document.getElementById('especieEnPlantilla').value = especie;
    
    // Actualizar las razas disponibles según la especie
    actualizarRazasPorEspecie();
}

// Ejecutar al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    // Asegurarse de que existe el selector de especies
    const especieSelector = document.getElementById('especieSelector');
    if (especieSelector) {
        // Si ya hay una especie seleccionada al cargar
        if (especieSelector.value !== "Seleccionar") {
            actualizarRazasPorEspecie();
        }
        
        // Agregar un listener adicional para garantizar que se actualicen las razas
        especieSelector.addEventListener('change', actualizarRazasPorEspecie);
    }
    
    // Crear datalist si no existe
    if (!document.getElementById('razas')) {
        const datalist = document.createElement('datalist');
        datalist.id = 'razas';
        document.body.appendChild(datalist);
    }
});
                </script>
            </tbody>
        </table>

        <h3 class="titulos">FUNCIONAMIENTO HEPÁTICO</h3>
        <table>
            <thead>
                <tr>
                    <th>PARÁMETRO</th>
                    <th>RESULTADO</th>
                    <th>VALOR DE REFERENCIA</th>
                    <th>UNIDADES</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>GLUCOSA</td>
                    <td><input type="text" id="glucosa" oninput="actualizarColor('glucosa', 'refGlucosa')" onblur="formatearDecimal('glucosa')" onkeydown="moverFoco(event, 'colesterol')"></td>
                    <td id="refGlucosa">77-126</td>
                    <td>mg/dl</td>
                </tr>
                <tr>
                    <td>COLESTEROL TOTAL</td>
                    <td><input type="text" id="colesterol" oninput="actualizarColor('colesterol', 'refColesterol')" onblur="formatearDecimal('colesterol')" onkeydown="moverFoco(event, 'trigliceridos')"></td>
                    <td id="refColesterol">129-331</td>
                    <td>mg/dl</td>
                </tr>
                <tr>
                    <td>TRIGLICÉRIDOS</td>
                    <td><input type="text" id="trigliceridos" oninput="actualizarColor('trigliceridos', 'refTrigliceridos')" onblur="formatearDecimal('trigliceridos')" onkeydown="moverFoco(event, 'urea')"></td>
                    <td id="refTrigliceridos">36-135</td>
                    <td>mg/dl</td>
                </tr>
                <tr>
                    <td>UREA</td>
                    <td><input type="text" id="urea" oninput="actualizarColor('urea', 'refUrea')" onblur="formatearDecimal('urea')" onkeydown="moverFoco(event, 'fosforo')"></td>
                    <td id="refUrea">20-50</td>
                    <td>mg/dl</td>
                </tr>
                <tr>
                    <td>FOSFORO</td>
                    <td><input type="text" id="fosforo" oninput="actualizarColor('fosforo', 'refFosforo')" onblur="formatearDecimal('fosforo')" onkeydown="moverFoco(event, 'bilirrubina_total')"></td>
                    <td id="refFosforo">3,3-6,4</td>
                    <td>mg/dl</td>
                </tr>
                <tr>
                    <td>BILIRRUBINA TOTAL</td>
                    <td><input type="text" id="bilirrubina_total" oninput="actualizarColor('bilirrubina_total', 'refBilirrubinaTotal')" onblur="formatearDecimal('bilirrubina_total')" onkeydown="moverFoco(event, 'bilirrubina_directa')"></td>
                    <td id="refBilirrubinaTotal">0,2-0,8</td>
                    <td>mg/dl</td>
                </tr>
                <tr>
                    <td>BILIRRUBINA DIRECTA</td>
                    <td><input type="text" id="bilirrubina_directa" oninput="actualizarColor('bilirrubina_directa', 'refBilirrubinaDirecta')" onblur="formatearDecimal('bilirrubina_directa')" onkeydown="moverFoco(event, 'bilirrubina_indirecta')"></td>
                    <td id="refBilirrubinaDirecta">0,0-14,0</td>
                    <td>mg/dl</td>
                </tr>
                <tr>
                    <td>BILIRRUBINA INDIRECTA</td>
                    <td><input type="text" id="bilirrubina_indirecta" oninput="actualizarColor('bilirrubina_indirecta', 'refBilirrubinaIndirecta')" onblur="formatearDecimal('bilirrubina_indirecta')" onkeydown="moverFoco(event, 'fosfatasa_alcalina')"></td>
                    <td id="refBilirrubinaIndirecta">0,07-0,60</td>
                    <td>mg/dl</td>
                </tr>
                <tr>
                    <td>FOSFATASA ALCALINA</td>
                    <td><input type="text" id="fosfatasa_alcalina" oninput="actualizarColor('fosfatasa_alcalina', 'refFosfatasaAlcalina')" onblur="formatearDecimal('fosfatasa_alcalina')" onkeydown="moverFoco(event, 'ggt')"></td>
                    <td id="refFosfatasaAlcalina">20-70</td>
                    <td>U/L</td>
                </tr>
                <tr>
                    <td>GGT</td>
                    <td><input type="text" id="ggt" oninput="actualizarColor('ggt', 'refGGT')" onblur="formatearDecimal('ggt')" onkeydown="moverFoco(event, 'ast')"></td>
                    <td id="refGGT">1-11,5</td>
                    <td>U/L</td>
                </tr>
                <tr>
                    <td>AST</td>
                    <td><input type="text" id="ast" oninput="actualizarColor('ast', 'refAST')" onblur="formatearDecimal('ast')" onkeydown="moverFoco(event, 'alt')"></td>
                    <td id="refAST">14-42</td>
                    <td>U/L</td>
                </tr>
                <tr>
                    <td>ALT</td>
                    <td><input type="text" id="alt" oninput="actualizarColor('alt', 'refALT')" onblur="formatearDecimal('alt')" onkeydown="moverFoco(event, 'albumina')"></td>
                    <td id="refALT">15-52</td>
                    <td>U/L</td>
                </tr>
            </tbody>
        </table>

        <h3 class="titulos">QUÍMICA SANGUÍNEA</h3>
        <table>
            <thead>
                <tr>
                    <th>PARÁMETRO</th>
                    <th>RESULTADO</th>
                    <th>VALOR DE REFERENCIA</th>
                    <th>UNIDADES</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>ALBUMINA</td>
                    <td><input type="text" id="albumina" oninput="calcularRelacionAG()" onblur="formatearDecimal('albumina')" onkeydown="moverFoco(event, 'proteinas_totales')"></td>
                    <td id="refAlbumina">2,6-3,6</td>
                    <td>g/dl</td>
                </tr>
                <tr>
                    <td>PROTEÍNAS TOTALES</td>
                    <td><input type="text" id="proteinas_totales" oninput="calcularRelacionAG()" onblur="formatearDecimal('proteinas_totales')" onkeydown="moverFoco(event, 'globulinas_totales')"></td>
                    <td id="refProteinasTotales">5,4-7,2</td>
                    <td>g/dl</td>
                </tr>
                <tr>
                    <td>GLOBULINAS TOTALES</td>
                    <td><input type="text" id="globulinas_totales" oninput="calcularRelacionAG()" onblur="formatearDecimal('globulinas_totales')" onkeydown="moverFoco(event, 'relacion_ag')"></td>
                    <td id="refGlobulinasTotales">3,0-4,7</td>
                    <td>g/dl</td>
                </tr>
                <tr>
                    <td>RELACIÓN ALBUMINA/GLOBULINA</td>
                    <td><input type="text" id="relacion_ag" oninput="calcularRelacionAG()" onblur="formatearDecimal('relacion_ag')" onkeydown="moverFoco(event, 'glucosa')"></td>
                    <td id="refRelacionAG">0,6 - 1,1</td>
                    <td></td>
                </tr>
            </tbody>
        </table>

        <h3 class="titulos" id="interferenceIndicesSection">ÍNDICES DE INTERFERENCIA</h3>
        <table>
            <tbody>
                <tr>
                    <td><strong>Suero Hemolítico</strong></td>
                    <td>
                        <input type="text" id="suero_hemolitico" list="interferencias" value="No se observa" onkeydown="moverFoco(event, 'suero_lipemico')">
                        <datalist id="interferencias">
                            <option value="No se observa">
                            <option value="Ligero">
                            <option value="Moderado">
                            <option value="Intenso">
                        </datalist>
                    </td>
                </tr>
                <tr>
                    <td><strong>Suero Lipémico</strong></td>
                    <td>
                        <input type="text" id="suero_lipemico" list="interferencias" value="No se observa" onkeydown="moverFoco(event, 'suero_icterico')">
                    </td>
                </tr>
                <tr>
                    <td><strong>Suero Ictérico</strong></td>
                    <td>
                        <input type="text" id="suero_icterico" list="interferencias" value="No se observa" onkeydown="moverFoco(event, 'glucosa')">
                    </td>
                </tr>
            </tbody>
        </table>

        <script>
            // Valores de referencia para perfil hepático
            const valoresReferenciaHepatico = {
                Canino: {
                    Macho: {
                        "De 1 año a 12 años": {
                            Glucosa: "77-126",
                            ColesterolTotal: "129-331",
                            Trigliceridos: "36-135",
                            Urea: "20-50",
                            Fosforo: "3,3-6,4",
                            BilirrubinaTotal: "0,2-0,8",
                            BilirrubinaDirecta: "0,0-14,0",
                            BilirrubinaIndirecta: "0,07-0,60",
                            FosfatasaAlcalina: "20-70",
                            GGT: "1-11,5",
                            AST: "14-42",
                            ALT: "15-52",
                            Albumina: "2,6-3,6",
                            ProteinasTotales: "5,4-7,2",
                            GlobulinasTotales: "3,0-4,7",
                            RelacionAG: "0,6-1,1"
                        },
                        "De 6 meses a 1 año": {
                            Glucosa: "77-126",
                            ColesterolTotal: "129-331",
                            Trigliceridos: "36-135",
                            Urea: "20-50",
                            Fosforo: "3,3-6,4",
                            BilirrubinaTotal: "0,2-0,8",
                            BilirrubinaDirecta: "0,0-14,0",
                            BilirrubinaIndirecta: "0,07-0,60",
                            FosfatasaAlcalina: "20-70",
                            GGT: "1-11,5",
                            AST: "14-42",
                            ALT: "15-52",
                            Albumina: "2,6-3,6",
                            ProteinasTotales: "5,4-7,2",
                            GlobulinasTotales: "3,0-4,7",
                            RelacionAG: "0,6-1,1"
                        },
                        "De mes y medio a 5 meses": {
                            Glucosa: "77-126",
                            ColesterolTotal: "129-331",
                            Trigliceridos: "36-135",
                            Urea: "20-50",
                            Fosforo: "3,3-6,4",
                            BilirrubinaTotal: "0,2-0,8",
                            BilirrubinaDirecta: "0,0-14,0",
                            BilirrubinaIndirecta: "0,07-0,60",
                            FosfatasaAlcalina: "20-70",
                            GGT: "1-11,5",
                            AST: "14-42",
                            ALT: "15-52",
                            Albumina: "2,6-3,6",
                            ProteinasTotales: "5,4-7,2",
                            GlobulinasTotales: "3,0-4,7",
                            RelacionAG: "0,6-1,1"
                        },
                        "Menor de mes y medio": {
                            Glucosa: "77-126",
                            ColesterolTotal: "129-331",
                            Trigliceridos: "36-135",
                            Urea: "20-50",
                            Fosforo: "3,3-6,4",
                            BilirrubinaTotal: "0,2-0,8",
                            BilirrubinaDirecta: "0,0-14,0",
                            BilirrubinaIndirecta: "0,07-0,60",
                            FosfatasaAlcalina: "20-70",
                            GGT: "1-11,5",
                            AST: "14-42",
                            ALT: "15-52",
                            Albumina: "2,6-3,6",
                            ProteinasTotales: "5,4-7,2",
                            GlobulinasTotales: "3,0-4,7",
                            RelacionAG: "0,6-1,1"
                        }
                    },
                    Hembra: {
                        "De 1 año a 12 años": {
                            Glucosa: "77-126",
                            ColesterolTotal: "129-331",
                            Trigliceridos: "36-135",
                            Urea: "20-50",
                            Fosforo: "3,3-6,4",
                            BilirrubinaTotal: "0,2-0,8",
                            BilirrubinaDirecta: "0,0-14,0",
                            BilirrubinaIndirecta: "0,07-0,60",
                            FosfatasaAlcalina: "20-70",
                            GGT: "1-11,5",
                            AST: "14-42",
                            ALT: "15-52",
                            Albumina: "2,6-3,6",
                            ProteinasTotales: "5,4-7,2",
                            GlobulinasTotales: "3,0-4,7",
                            RelacionAG: "0,6-1,1"
                        },
                        "De 6 meses a 1 año": {
                            Glucosa: "77-126",
                            ColesterolTotal: "129-331",
                            Trigliceridos: "36-135",
                            Urea: "20-50",
                            Fosforo: "3,3-6,4",
                            BilirrubinaTotal: "0,2-0,8",
                            BilirrubinaDirecta: "0,0-14,0",
                            BilirrubinaIndirecta: "0,07-0,60",
                            FosfatasaAlcalina: "20-70",
                            GGT: "1-11,5",
                            AST: "14-42",
                            ALT: "15-52",
                            Albumina: "2,6-3,6",
                            ProteinasTotales: "5,4-7,2",
                            GlobulinasTotales: "3,0-4,7",
                            RelacionAG: "0,6-1,1"
                        },
                        "De mes y medio a 5 meses": {
                            Glucosa: "77-126",
                            ColesterolTotal: "129-331",
                            Trigliceridos: "36-135",
                            Urea: "20-50",
                            Fosforo: "3,3-6,4",
                            BilirrubinaTotal: "0,2-0,8",
                            BilirrubinaDirecta: "0,0-14,0",
                            BilirrubinaIndirecta: "0,07-0,60",
                            FosfatasaAlcalina: "20-70",
                            GGT: "1-11,5",
                            AST: "14-42",
                            ALT: "15-52",
                            Albumina: "2,6-3,6",
                            ProteinasTotales: "5,4-7,2",
                            GlobulinasTotales: "3,0-4,7",
                            RelacionAG: "0,6-1,1"
                        },
                        "Menor de mes y medio": {
                            Glucosa: "77-126",
                            ColesterolTotal: "129-331",
                            Trigliceridos: "36-135",
                            Urea: "20-50",
                            Fosforo: "3,3-6,4",
                            BilirrubinaTotal: "0,2-0,8",
                            BilirrubinaDirecta: "0,0-14,0",
                            BilirrubinaIndirecta: "0,07-0,60",
                            FosfatasaAlcalina: "20-70",
                            GGT: "1-11,5",
                            AST: "14-42",
                            ALT: "15-52",
                            Albumina: "2,6-3,6",
                            ProteinasTotales: "5,4-7,2",
                            GlobulinasTotales: "3,0-4,7",
                            RelacionAG: "0,6-1,1"
                        }
                    }
                },
                Felino: {
                    Macho: {
                        "De 1 año a 12 años": {
                            Glucosa: "70-130",
                            ColesterolTotal: "95-130",
                            Trigliceridos: "25-100",
                            Urea: "20-50",
                            Fosforo: "3,5-6,0",
                            BilirrubinaTotal: "0,1-0,4",
                            BilirrubinaDirecta: "0,0-0,1",
                            BilirrubinaIndirecta: "0,1-0,3",
                            FosfatasaAlcalina: "10-50",
                            GGT: "0-5",
                            AST: "15-45",
                            ALT: "20-60",
                            Albumina: "2,5-3,8",
                            ProteinasTotales: "5,7-8,9",
                            GlobulinasTotales: "3,0-5,5",
                            RelacionAG: "0,5-1,0"
                        },
                        "De 6 meses a 1 año": {
                            Glucosa: "70-130",
                            ColesterolTotal: "95-130",
                            Trigliceridos: "25-100",
                            Urea: "20-50",
                            Fosforo: "3,5-6,0",
                            BilirrubinaTotal: "0,1-0,4",
                            BilirrubinaDirecta: "0,0-0,1",
                            BilirrubinaIndirecta: "0,1-0,3",
                            FosfatasaAlcalina: "10-50",
                            GGT: "0-5",
                            AST: "15-45",
                            ALT: "20-60",
                            Albumina: "2,5-3,8",
                            ProteinasTotales: "5,7-8,9",
                            GlobulinasTotales: "3,0-5,5",
                            RelacionAG: "0,5-1,0"
                        },
                        "De mes y medio a 5 meses": {
                            Glucosa: "70-130",
                            ColesterolTotal: "95-130",
                            Trigliceridos: "25-100",
                            Urea: "20-50",
                            Fosforo: "3,5-6,0",
                            BilirrubinaTotal: "0,1-0,4",
                            BilirrubinaDirecta: "0,0-0,1",
                            BilirrubinaIndirecta: "0,1-0,3",
                            FosfatasaAlcalina: "10-50",
                            GGT: "0-5",
                            AST: "15-45",
                            ALT: "20-60",
                            Albumina: "2,5-3,8",
                            ProteinasTotales: "5,7-8,9",
                            GlobulinasTotales: "3,0-5,5",
                            RelacionAG: "0,5-1,0"
                        },
                        "Menor de mes y medio": {
                            Glucosa: "70-130",
                            ColesterolTotal: "95-130",
                            Trigliceridos: "25-100",
                            Urea: "20-50",
                            Fosforo: "3,5-6,0",
                            BilirrubinaTotal: "0,1-0,4",
                            BilirrubinaDirecta: "0,0-0,1",
                            BilirrubinaIndirecta: "0,1-0,3",
                            FosfatasaAlcalina: "10-50",
                            GGT: "0-5",
                            AST: "15-45",
                            ALT: "20-60",
                            Albumina: "2,5-3,8",
                            ProteinasTotales: "5,7-8,9",
                            GlobulinasTotales: "3,0-5,5",
                            RelacionAG: "0,5-1,0"
                        }
                    },
                    Hembra: {
                        "De 1 año a 12 años": {
                            Glucosa: "70-130",
                            ColesterolTotal: "95-130",
                            Trigliceridos: "25-100",
                            Urea: "20-50",
                            Fosforo: "3,5-6,0",
                            BilirrubinaTotal: "0,1-0,4",
                            BilirrubinaDirecta: "0,0-0,1",
                            BilirrubinaIndirecta: "0,1-0,3",
                            FosfatasaAlcalina: "10-50",
                            GGT: "0-5",
                            AST: "15-45",
                            ALT: "20-60",
                            Albumina: "2,5-3,8",
                            ProteinasTotales: "5,7-8,9",
                            GlobulinasTotales: "3,0-5,5",
                            RelacionAG: "0,5-1,0"
                        },
                        "De 6 meses a 1 año": {
                            Glucosa: "70-130",
                            ColesterolTotal: "95-130",
                            Trigliceridos: "25-100",
                            Urea: "20-50",
                            Fosforo: "3,5-6,0",
                            BilirrubinaTotal: "0,1-0,4",
                            BilirrubinaDirecta: "0,0-0,1",
                            BilirrubinaIndirecta: "0,1-0,3",
                            FosfatasaAlcalina: "10-50",
                            GGT: "0-5",
                            AST: "15-45",
                            ALT: "20-60",
                            Albumina: "2,5-3,8",
                            ProteinasTotales: "5,7-8,9",
                            GlobulinasTotales: "3,0-5,5",
                            RelacionAG: "0,5-1,0"
                        },
                        "De mes y medio a 5 meses": {
                            Glucosa: "70-130",
                            ColesterolTotal: "95-130",
                            Trigliceridos: "25-100",
                            Urea: "20-50",
                            Fosforo: "3,5-6,0",
                            BilirrubinaTotal: "0,1-0,4",
                            BilirrubinaDirecta: "0,0-0,1",
                            BilirrubinaIndirecta: "0,1-0,3",
                            FosfatasaAlcalina: "10-50",
                            GGT: "0-5",
                            AST: "15-45",
                            ALT: "20-60",
                            Albumina: "2,5-3,8",
                            ProteinasTotales: "5,7-8,9",
                            GlobulinasTotales: "3,0-5,5",
                            RelacionAG: "0,5-1,0"
                        },
                        "Menor de mes y medio": {
                            Glucosa: "70-130",
                            ColesterolTotal: "95-130",
                            Trigliceridos: "25-100",
                            Urea: "20-50",
                            Fosforo: "3,5-6,0",
                            BilirrubinaTotal: "0,1-0,4",
                            BilirrubinaDirecta: "0,0-0,1",
                            BilirrubinaIndirecta: "0,1-0,3",
                            FosfatasaAlcalina: "10-50",
                            GGT: "0-5",
                            AST: "15-45",
                            ALT: "20-60",
                            Albumina: "2,5-3,8",
                            ProteinasTotales: "5,7-8,9",
                            GlobulinasTotales: "3,0-5,5",
                            RelacionAG: "0,5-1,0"
                        }
                    }
                }
            };

            function actualizarValoresReferencia() {
                const especie = document.getElementById('especieSelector').value;
                const sexo = document.getElementById('sexoSelector').value;
                const edad = document.getElementById('edadSelector').value;

                if (especie !== "Seleccionar" && sexo !== "Seleccionar" && edad !== "Seleccionar") {
                    const refValores = valoresReferenciaHepatico[especie][sexo][edad];
                    
                    if (refValores) {
                        // Actualizar todos los valores de referencia 
                        document.getElementById('refGlucosa').innerText = refValores.Glucosa || '';
                        document.getElementById('refColesterol').innerText = refValores.ColesterolTotal || '';
                        document.getElementById('refTrigliceridos').innerText = refValores.Trigliceridos || '';
                        document.getElementById('refUrea').innerText = refValores.Urea || '';
                        document.getElementById('refFosforo').innerText = refValores.Fosforo || '';
                        document.getElementById('refBilirrubinaTotal').innerText = refValores.BilirrubinaTotal || '';
                        document.getElementById('refBilirrubinaDirecta').innerText = refValores.BilirrubinaDirecta || '';
                        document.getElementById('refBilirrubinaIndirecta').innerText = refValores.BilirrubinaIndirecta || '';
                        document.getElementById('refFosfatasaAlcalina').innerText = refValores.FosfatasaAlcalina || '';
                        document.getElementById('refGGT').innerText = refValores.GGT || '';
                        document.getElementById('refAST').innerText = refValores.AST || '';
                        document.getElementById('refALT').innerText = refValores.ALT || '';
                        document.getElementById('refAlbumina').innerText = refValores.Albumina || '';
                        document.getElementById('refProteinasTotales').innerText = refValores.ProteinasTotales || '';
                        document.getElementById('refGlobulinasTotales').innerText = refValores.GlobulinasTotales || '';
                        document.getElementById('refRelacionAG').innerText = refValores.RelacionAG || '';
                        
                        // Actualizar colores de campos que ya tienen valores
                        const campos = ['glucosa', 'colesterol', 'trigliceridos', 'urea', 'fosforo', 'bilirrubina_total', 
                                      'bilirrubina_directa', 'bilirrubina_indirecta', 'fosfatasa_alcalina', 'ggt', 'ast', 'alt',
                                      'albumina', 'proteinas_totales', 'globulinas_totales', 'relacion_ag'];
                        
                        campos.forEach(campo => {
                            if (document.getElementById(campo).value) {
                                actualizarColor(campo, 'ref' + campo.charAt(0).toUpperCase() + campo.slice(1).replace('_', ''));
                            }
                        });
                    }
                }
            }

            function actualizarColor(inputId, refId) {
                const inputElement = document.getElementById(inputId);
                const refElement = document.getElementById(refId);
                
                if (!inputElement || !refElement) return;
                
                // Limpiar clases anteriores del input
                inputElement.classList.remove('valor-bajo', 'valor-alto', 'valor-normal');
                
                // Obtener el valor actual sin ninguna flecha
                const valorTexto = inputElement.value.trim().replace(/[↑↓]\s*$/, '').replace(',', '.');
                
                // Si no hay valor, no agregar ninguna clase y salir
                if (!valorTexto) {
                    inputElement.style.color = 'black';
                    inputElement.style.fontWeight = 'normal';
                    return;
                }
                
                const valor = parseFloat(valorTexto);
                
                // Si no es un número, salir
                if (isNaN(valor)) return;
                
                // Establecer negrita siempre
                inputElement.style.fontWeight = 'bold';
                
                // Obtener rango de referencia
                const rangoTexto = refElement.textContent;
                const coincidencia = rangoTexto.match(/([\d,.]+)\s*-\s*([\d,.]+)/);
                
                if (coincidencia) {
                    const min = parseFloat(coincidencia[1].replace(',', '.'));
                    const max = parseFloat(coincidencia[2].replace(',', '.'));
                    
                    if (valor < min) {
                        inputElement.style.color = '#0096d2'; // Azul
                        inputElement.classList.add('valor-bajo');
                    } else if (valor > max) {
                        inputElement.style.color = 'red';
                        inputElement.classList.add('valor-alto');
                    } else {
                        inputElement.style.color = 'black';
                        inputElement.classList.add('valor-normal');
                    }
                }
            }

            // Función para calcular Relación A/G cuando se cambian albumina, proteínas o globulinas
            function calcularRelacionAG() {
                const albumina = parseFloat(document.getElementById('albumina').value.replace(',', '.')) || 0;
                const proteinasTotales = parseFloat(document.getElementById('proteinas_totales').value.replace(',', '.')) || 0;
                const globulinas = parseFloat(document.getElementById('globulinas_totales').value.replace(',', '.')) || 0;
                
                const relacionInput = document.getElementById('relacion_ag');
                
                // Si tenemos albumina y globulinas, calcular relación A/G
                if (albumina > 0 && globulinas > 0) {
                    const relacion = albumina / globulinas;
                    relacionInput.value = relacion.toFixed(1).replace('.', ',');
                    
                    // Actualizar color de relación
                    setTimeout(() => {
                        actualizarColor('relacion_ag', 'refRelacionAG');
                    }, 10);
                } else {
                    relacionInput.value = '';
                }
                
                // Actualizar colores de todos los campos
                setTimeout(() => {
                    actualizarColor('albumina', 'refAlbumina');
                    actualizarColor('proteinas_totales', 'refProteinasTotales');
                    actualizarColor('globulinas_totales', 'refGlobulinasTotales');
                }, 10);
            }

            // Variable para controlar si realmente debemos formatear
            let formatTimeout = null;
            let currentFocusedInput = null;

            function formatearDecimal(id) {
                // Cancelar cualquier timeout pendiente
                if (formatTimeout) {
                    clearTimeout(formatTimeout);
                }
                
                // Esperar un momento antes de formatear
                formatTimeout = setTimeout(() => {
                    var input = document.getElementById(id);
                    if (!input || input.value === '') return;
                    
                    // Solo formatear si el input NO tiene el foco actualmente
                    if (document.activeElement !== input) {
                        var valor = parseFloat(input.value.replace(',', '.')) || 0;
                        input.value = valor.toFixed(1).replace('.', ',');
                    }
                }, 150); // Pequeño delay para evitar formateo mientras se escribe
            }

            function moverFoco(event, siguienteId) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    document.getElementById(siguienteId).focus();
                }
            }
        </script>
</div>

<div class="controls">
    <button id="pdfButton" onclick="generatePDF()">Generar PDF</button>
    <button id="menuButton" onclick="window.location.href='index.html'">Volver al Menú</button>
    <div id="loadingPdf" class="loading-indicator">
        <div class="spinner"></div>
        <span>Generando PDF...</span>
    </div>
</div>

<script>
// Configurar el historial de análisis
document.addEventListener('DOMContentLoaded', function() {
    setupHistorial();
    
    // Añadir evento para guardar los datos al generar el PDF
    const pdfButton = document.getElementById('pdfButton');
    if (pdfButton) {
        const originalHandler = pdfButton.onclick;
        pdfButton.onclick = async function() {
            guardarAnalisisActual();
            if (originalHandler) {
                return originalHandler.apply(this, arguments);
            }
        };
    }
});

// Función para configurar el selector de historial
function setupHistorial() {
    const controlsDiv = document.querySelector('.controls');
    
    if (controlsDiv) {
        const historialContainer = document.createElement('div');
        historialContainer.className = 'historial-container';
        
        const label = document.createElement('label');
        label.htmlFor = 'historialSelector';
        label.textContent = 'Historial de análisis:';
        
        const select = document.createElement('select');
        select.id = 'historialSelector';
        
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '-- Seleccionar análisis anterior --';
        defaultOption.selected = true;
        select.appendChild(defaultOption);
        
        cargarOpcionesHistorial(select);
        
        select.addEventListener('change', function() {
            if (this.value) {
                cargarAnalisisDesdeHistorial(this.value);
            }
        });
        
        historialContainer.appendChild(label);
        historialContainer.appendChild(select);
        
        controlsDiv.appendChild(historialContainer);
    }
}

// Función para cargar las opciones del historial
function cargarOpcionesHistorial(selectElement) {
    while (selectElement.options.length > 1) {
        selectElement.remove(1);
    }
    
    const historial = JSON.parse(localStorage.getItem('perfilHepaticoHistorial') || '[]');
    
    historial.forEach((analisis, index) => {
        const option = document.createElement('option');
        option.value = index;
        
        const fecha = new Date(analisis.timestamp);
        const fechaStr = fecha.toLocaleDateString();
        const horaStr = fecha.toLocaleTimeString();
        
        option.textContent = `${analisis.mascotaNombre} - ${analisis.propietarioNombre} (${fechaStr} ${horaStr})`;
        
        selectElement.appendChild(option);
    });
}

// Función para guardar el análisis actual
function guardarAnalisisActual() {
    const getValueSafe = (id) => {
        const element = document.getElementById(id);
        return element ? element.value : '';
    };

    const formData = {
        mascotaNombre: getValueSafe('mascotaNombre'),
        mascotaRaza: getValueSafe('mascotaRaza'),
        mascotaEspecie: getValueSafe('especieEnPlantilla'),
        mascotaSexo: getValueSafe('sexoEnPlantilla'),
        mascotaEdad: getValueSafe('mascotaEdad'),
        mascotaPeso: getValueSafe('mascotaPeso'),
        
        propietarioNombre: getValueSafe('propietarioNombre'),
        propietarioCedula: getValueSafe('propietarioCedula'),
        propietarioTelefono: getValueSafe('propietarioTelefono'),
        propietarioEmail: getValueSafe('propietarioEmail'),
        propietarioFecha: getValueSafe('propietarioFecha'),
        nombreMedico: getValueSafe('nombreMedico'),
        
        glucosa: getValueSafe('glucosa'),
        colesterol: getValueSafe('colesterol'),
        trigliceridos: getValueSafe('trigliceridos'),
        urea: getValueSafe('urea'),
        fosforo: getValueSafe('fosforo'),
        bilirrubina_total: getValueSafe('bilirrubina_total'),
        bilirrubina_directa: getValueSafe('bilirrubina_directa'),
        bilirrubina_indirecta: getValueSafe('bilirrubina_indirecta'),
        fosfatasa_alcalina: getValueSafe('fosfatasa_alcalina'),
        ggt: getValueSafe('ggt'),
        ast: getValueSafe('ast'),
        alt: getValueSafe('alt'),
        
        albumina: getValueSafe('albumina'),
        proteinas_totales: getValueSafe('proteinas_totales'),
        globulinas_totales: getValueSafe('globulinas_totales'),
        relacion_ag: getValueSafe('relacion_ag'),
        
        suero_hemolitico: getValueSafe('suero_hemolitico'),
        suero_lipemico: getValueSafe('suero_lipemico'),
        suero_icterico: getValueSafe('suero_icterico'),
        
        especieSelector: getValueSafe('especieSelector'),
        sexoSelector: getValueSafe('sexoSelector'),
        edadSelector: getValueSafe('edadSelector'),
        
        timestamp: new Date().getTime()
    };
    
    if (!formData.mascotaNombre && !formData.propietarioNombre) return;
    
    let historial = JSON.parse(localStorage.getItem('perfilHepaticoHistorial') || '[]');
    
    historial.unshift(formData);
    historial = historial.slice(0, 10);
    
    localStorage.setItem('perfilHepaticoHistorial', JSON.stringify(historial));
    
    const selector = document.getElementById('historialSelector');
    if (selector) {
        cargarOpcionesHistorial(selector);
    }
}

// Función para cargar un análisis desde el historial
function cargarAnalisisDesdeHistorial(index) {
    const historial = JSON.parse(localStorage.getItem('perfilHepaticoHistorial') || '[]');
    
    if (!historial[index]) return;
    
    const analisis = historial[index];
    
    // Cargar todos los campos con los datos guardados
    document.getElementById('mascotaNombre').value = analisis.mascotaNombre || '';
    document.getElementById('mascotaRaza').value = analisis.mascotaRaza || '';
    document.getElementById('especieEnPlantilla').value = analisis.mascotaEspecie || '';
    document.getElementById('sexoEnPlantilla').value = analisis.mascotaSexo || '';
    document.getElementById('mascotaEdad').value = analisis.mascotaEdad || '';
    document.getElementById('mascotaPeso').value = analisis.mascotaPeso || '';
    
    document.getElementById('propietarioNombre').value = analisis.propietarioNombre || '';
    document.getElementById('propietarioCedula').value = analisis.propietarioCedula || '';
    document.getElementById('propietarioTelefono').value = analisis.propietarioTelefono || '';
    document.getElementById('propietarioEmail').value = analisis.propietarioEmail || '';
    document.getElementById('propietarioFecha').value = analisis.propietarioFecha || '';
    document.getElementById('nombreMedico').value = analisis.nombreMedico || '';
    
    // Datos del perfil hepático
    document.getElementById('glucosa').value = analisis.glucosa || '';
    document.getElementById('colesterol').value = analisis.colesterol || '';
    document.getElementById('trigliceridos').value = analisis.trigliceridos || '';
    document.getElementById('urea').value = analisis.urea || '';
    document.getElementById('fosforo').value = analisis.fosforo || '';
    document.getElementById('bilirrubina_total').value = analisis.bilirrubina_total || '';
    document.getElementById('bilirrubina_directa').value = analisis.bilirrubina_directa || '';
    document.getElementById('bilirrubina_indirecta').value = analisis.bilirrubina_indirecta || '';
    document.getElementById('fosfatasa_alcalina').value = analisis.fosfatasa_alcalina || '';
    document.getElementById('ggt').value = analisis.ggt || '';
    document.getElementById('ast').value = analisis.ast || '';
    document.getElementById('alt').value = analisis.alt || '';
    
    document.getElementById('albumina').value = analisis.albumina || '';
    document.getElementById('proteinas_totales').value = analisis.proteinas_totales || '';
    document.getElementById('globulinas_totales').value = analisis.globulinas_totales || '';
    document.getElementById('relacion_ag').value = analisis.relacion_ag || '';
    
    document.getElementById('suero_hemolitico').value = analisis.suero_hemolitico || 'No se observa';
    document.getElementById('suero_lipemico').value = analisis.suero_lipemico || 'No se observa';
    document.getElementById('suero_icterico').value = analisis.suero_icterico || 'No se observa';
    
    // Selectores principales
    if (analisis.especieSelector) {
        document.getElementById('especieSelector').value = analisis.especieSelector;
        const event = new Event('change');
        document.getElementById('especieSelector').dispatchEvent(event);
    }
    
    if (analisis.sexoSelector) {
        document.getElementById('sexoSelector').value = analisis.sexoSelector;
        const event = new Event('change');
        document.getElementById('sexoSelector').dispatchEvent(event);
    }
    
    if (analisis.edadSelector) {
        document.getElementById('edadSelector').value = analisis.edadSelector;
        const event = new Event('change');
        document.getElementById('edadSelector').dispatchEvent(event);
    }
    
    calcularRelacionAG();
    
    alert(`Datos de ${analisis.mascotaNombre} cargados correctamente`);
}

// Agregar botón para borrar historial
document.addEventListener('DOMContentLoaded', function() {
    const controlsDiv = document.querySelector('.controls');
    
    if (controlsDiv) {
        const borrarHistorialBtn = document.createElement('button');
        borrarHistorialBtn.id = 'borrarHistorialBtn';
        borrarHistorialBtn.textContent = 'Borrar Historial';
        borrarHistorialBtn.onclick = function() {
            if (confirm('¿Estás seguro de que quieres borrar todo el historial de análisis?')) {
                localStorage.removeItem('perfilHepaticoHistorial');
                cargarOpcionesHistorial(document.getElementById('historialSelector'));
                alert('Historial borrado correctamente');
            }
        };
        
        controlsDiv.appendChild(borrarHistorialBtn);
    }
});

async function generatePDF() {
    const loadingIndicator = document.getElementById('loadingPdf');
    const pdfButton = document.getElementById('pdfButton');
    
    loadingIndicator.style.display = 'flex';
    pdfButton.disabled = true;
    
    try {
        const { jsPDF } = window.jspdf;
        const selectedTemplate = document.getElementById('template1');

        if (!selectedTemplate) {
            alert('No se encontró la plantilla.');
            return;
        }

        const mascotaNombre = document.getElementById('mascotaNombre').value || 'Sin_nombre';
        const propietarioNombre = document.getElementById('propietarioNombre').value || 'Sin_apellido';
        
        const nombreArray = propietarioNombre.split(' ');
        const propietarioApellido = nombreArray.length > 1 ? nombreArray[1] : nombreArray[0];

        const images = selectedTemplate.getElementsByTagName('img');
        const loadImages = Array.from(images).map(img => {
            return new Promise((resolve, reject) => {
                if (img.complete) {
                    resolve();
                } else {
                    img.onload = resolve;
                    img.onerror = reject;
                }
            });
        });

        await Promise.all(loadImages);

        const canvas = await html2canvas(selectedTemplate, {
            scale: 2,
            useCORS: true,
            logging: false,
            allowTaint: true,
            backgroundColor: '#ffffff'
        });

        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 150; 
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        const x = (pdf.internal.pageSize.getWidth() - imgWidth) / 2;
        const y = 5;

        pdf.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight);

        const fileName = `Perfil_Hepatico_${mascotaNombre}_${propietarioApellido}.pdf`;
        
        const pdfBlob = pdf.output('blob');
        
        if ('showSaveFilePicker' in window) {
            try {
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [{
                        description: 'Archivo PDF',
                        accept: { 'application/pdf': ['.pdf'] }
                    }]
                });
                
                const writable = await fileHandle.createWritable();
                await writable.write(pdfBlob);
                await writable.close();
                
                console.log('Archivo guardado con éxito usando File System Access API');
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Error al usar File System Access API:', err);
                    pdf.save(fileName);
                }
            }
        } else {
            pdf.save(fileName);
        }
    } catch (error) {
        console.error('Error al generar el PDF:', error);
        alert('Ocurrió un error al generar el PDF: ' + error.message);
    } finally {
        loadingIndicator.style.display = 'none';
        pdfButton.disabled = false;
    }
}

// Funciones para eliminar parámetros
document.addEventListener('DOMContentLoaded', function() {
    cargarListaDeParametrosHepatico();
});

function cargarListaDeParametrosHepatico() {
    const selector = document.getElementById('parameterSelector');
    if (!selector) {
        console.error("No se encontró el selector de parámetros");
        return;
    }
    
    selector.innerHTML = '<option value="" selected disabled>-- Seleccionar parámetro --</option>';
    
    const parametrosEspecificos = [
        "GLUCOSA", "COLESTEROL TOTAL", "TRIGLICÉRIDOS", "UREA", "FOSFORO",
        "BILIRRUBINA TOTAL", "BILIRRUBINA DIRECTA", "BILIRRUBINA INDIRECTA",
        "FOSFATASA ALCALINA", "GGT", "AST", "ALT",
        "ALBUMINA", "PROTEÍNAS TOTALES", "GLOBULINAS TOTALES", "RELACIÓN ALBUMINA/GLOBULINA",
        "Suero Hemolítico", "Suero Lipémico", "Suero Ictérico"
    ];
    
    const tablas = document.querySelectorAll('#template1 table');
    
    tablas.forEach((tabla, tablaIndex) => {
        const filas = tabla.querySelectorAll('tbody tr');
        
        filas.forEach((fila, filaIndex) => {
            if (!fila.cells || fila.cells.length === 0) return;
            
            const paramName = fila.cells[0]?.textContent.trim();
            
            if (parametrosEspecificos.includes(paramName)) {
                const filaId = `fila-hepatico-${tablaIndex}-${filaIndex}`;
                fila.id = filaId;
                
                const option = document.createElement('option');
                option.value = filaId;
                option.textContent = paramName;
                selector.appendChild(option);
            }
        });
    });
}

function eliminarParametroSeleccionado() {
    const selector = document.getElementById('parameterSelector');
    const filaId = selector.value;
    
    if (!filaId) {
        alert('Por favor, selecciona un parámetro para eliminar.');
        return;
    }
    
    const fila = document.getElementById(filaId);
    if (fila) {
        fila.remove();
        cargarListaDeParametrosHepatico();
    }
}

</script>

<div class="footer">
    <p id="mensajeMedico" style="display: none;">El personal médico cuenta con un plazo de 24 a 48 horas para interpretar el reporte de los resultados.</p>
    <p>Facebook: Veterinaria San Martin de Porres | Teléfono: 4000 - 1365 | Ext: 106</p>
    <p>WhatsApp: 8839 - 2214 | San Rafael Abajo de Desamparados, 50 metros Norte del Mall Zona Centro</p>
    <p>Correo: laboratorio@vetsanmartin.com</p>
</div>

</body>
</html>
