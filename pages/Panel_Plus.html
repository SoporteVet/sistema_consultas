<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Plantillas</title>
    <link rel="stylesheet" href="index_lab.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=ABeeZee:ital@0;1&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=League+Spartan:wght@100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
</head>
<body>
<script>
// Autollenado Panel Plus
document.addEventListener('DOMContentLoaded', function(){
  try {
    const p = new URLSearchParams(location.search);
    const setVal = (id, v) => { const el = document.getElementById(id); if (el && v) el.value = v; };
    setVal('mascotaNombre', p.get('mascotaNombre'));
    setVal('propietarioNombre', p.get('propietarioNombre'));
    setVal('propietarioCedula', p.get('propietarioCedula'));
    setVal('propietarioTelefono', p.get('propietarioTelefono'));
    setVal('propietarioEmail', p.get('propietarioEmail'));
    setVal('nombreMedico', p.get('nombreMedico'));
    setVal('mascotaRaza', p.get('mascotaRaza'));
    setVal('mascotaEdad', p.get('mascotaEdad'));
    setVal('mascotaPeso', p.get('mascotaPeso'));
    
    // Verificar el mensaje del médico después del autollenado
    const medico = p.get('nombreMedico');
    if (medico) {
      setTimeout(() => {
        verificarMedico();
      }, 100);
    }
  } catch(e){}
});
</script>
    <body>
        <div class="controls">
            <label for="sexoSelector">Selecciona el sexo:</label>
            <select id="sexoSelector" onchange="actualizarSexoEnPlantilla(),actualizarValoresReferencia2()">
                <option value="Seleccionar" selected>-- Seleccionar --</option>
                <option value="Macho">Macho</option>
                <option value="Hembra">Hembra</option>
            </select>
            <label for="especieSelector">Selecciona la especie:</label>
            <select id="especieSelector" onchange="actualizarEspecieEnPlantilla(),actualizarValoresReferencia2()">
                <option value="Seleccionar" selected>-- Seleccionar --</option>
                <option value="Canino">Canino</option>
                <option value="Felino">Felino</option>
                <option value="Lagomorfo">Lagomorfo</option>
                <option value="Cuilo">Cuilo</option>
            </select>
            <label for="edadSelector">Selecciona el rango de edad:</label>
            <select id="edadSelector" onchange="actualizarValoresReferencia2()">
                <option value="Seleccionar" selected>-- Seleccionar --</option>
                <option value="De 1 año a 12 años">De 1 año a 12 años</option>
                <option value="De 6 meses a 1 año">De 6 meses a 1 año</option>
                <option value="De 3 meses a 6 meses">De 3 meses a 6 meses</option>
                <option value="De mes y medio a 3 meses">De mes y medio a 3 meses</option>
                <option value="Todas las edades">Todas las edades</option>
            </select>
        </div>
        <div class="container" id="template1" style="display: block;">
        <div class="header">
            <img src="empresa.jpg" alt="Logo de la Empresa" class="small-image">
            <h1>Laboratorio Clínico Veterinario</h1>
        </div>
        <h3 class="subheader">PANEL PLUS</h3>
            <table>
                <thead>
                    <tr>
                        <th colspan="2">DATOS DE LA MASCOTA</th>
                        <th colspan="2">DATOS DEL PROPIETARIO</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Nombre</td>
                        <td><input type="text" id="mascotaNombre" onkeydown="moverFocoConFlechas(event, 'propietarioNombre', 'propietarioNombre', 'mascotaNombre', 'mascotaRaza')"></td>
                        <td>Nombre</td>
                        <td><input type="text" id="propietarioNombre"  onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaNombre', 'mascotaNombre', 'propietarioCedula')"></td>
                    </tr>
                    <tr>
                        <td>Raza</td>
                        <td><input type="text" id="mascotaRaza" list="razas"  onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaNombre', 'mascotaNombre', 'mascotaSexo')"></td>
                        <datalist id="razas">

                        </datalist>
                        <td>Cédula</td>
                        <td><input type="text" id="propietarioCedula"  onkeydown="moverFocoConFlechas(event, 'propietarioTelefono', 'mascotaRaza', 'propietarioNombre', 'propietarioTelefono')"></td>
                    </tr>
                    <tr>
                        <td>Sexo</td>
                        <td><input type="text" id="sexoEnPlantilla"></td>
                        <td>Teléfono</td>
                        <td><input type="text" id="propietarioTelefono" onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaSexo', 'propietarioCedula', 'propietarioEmail')"></td>
                    </tr>
                    <tr>
                        <td>Especie</td>
                        <td><input type="text" id="especieEnPlantilla"></td>
                        <td>Email</td>
                        <td><input type="text" id="propietarioEmail"  onkeydown="moverFocoConFlechas(event, 'mascotaEspecie', 'mascotaEspecie', 'propietarioTelefono', 'nombreMedico')"></td>
                    </tr>
                    <tr>
                        <td>Edad</td>
                        <td><input type="text" id="mascotaEdad" list="edades"  onkeydown="moverFocoConFlechas(event, 'nombreMedico', 'mascotaEspecie', 'mascotaEspecie', 'mascotaPeso')"></td>
    
                        <datalist id="edades">
                        <option value="1 mes"><option value="2 meses"><option value="3 meses"><option value="4 meses">
                        <option value="5 meses"><option value="6 meses"><option value="7 meses"><option value="8 meses"><option value="9 meses">
                        <option value="10 meses"><option value="11 meses"><option value="12 meses">
                        <option value="1 año"><option value="2 años"><option value="3 años"><option value="4 años">
                        <option value="5 años"><option value="6 años"><option value="7 años"><option value="8 años"><option value="9 años">
                        <option value="10 años"><option value="11 años"><option value="12 años"><option value="13 años"></option><option value="14 años"></option>
                        <option value="15 años"><option value="16 años"><option value="17 años"><option value="18 años"></option>
                        <option value="19 años"><option value="20 años"></option>    
                    </datalist>
                        <td>Médico</td>
                        <td>
                            <input type="text" id="nombreMedico" list="medicos" 
                                onkeydown="moverFocoConFlechas(event, 'propietarioFecha', 'mascotaEdad', 'propietarioEmail', 'propietarioFecha')" 
                                oninput="verificarMedico()">
                        </td>
                        <datalist id="medicos">
                            <option value="N.A">
                            <option value="Dr. Randall Azofeifa">
                            <option value="Dr. Luis Coto">
                            <option value="Dra. Daniela Sancho">
                            <option value="Dra. Sofia Carrillo">
                            <option value="Dra. Franciny Nuñez">
                            <option value="Dra. Lourdes Chacón">
                            <option value="Dra. Alejandra León">
                            <option value="Dra. Karla Quesada">
                            <option value="Dra. Kharen Moreno">
                            <option value="Dra. Karina Madrigal">
                            <option value="Dra. Natalia Alvarado">
                        </datalist>
                    </tr>
                    <tr>
                        <script>    
                            function actualizarSexoEnPlantilla() {
                                const sexo = document.getElementById('sexoSelector').value;
                                document.getElementById('sexoEnPlantilla').value = sexo.charAt(0).toUpperCase() + sexo.slice(1);
                            }
                            function actualizarEspecieEnPlantilla() {
                                const especie = document.getElementById('especieSelector').value;
                                document.getElementById('especieEnPlantilla').value = especie;
                            }
                            function verificarMedico() {
                                const medico = document.getElementById('nombreMedico').value;
                                const mensaje = document.getElementById('mensajeMedico');
                                if (medico === 'N.A' || medico === 'NA' || medico === '' || medico === 'N.A.' || medico.toLowerCase() === 'na') {
                                    mensaje.style.display = 'none';
                                } else {
                                    mensaje.style.display = 'block';
                                }
                            }
                            
                            </script>
                    </tr>
                    <tr>
                        <td>Peso</td>
    <td><input type="text" id="mascotaPeso" list="pesos" onkeydown="moverFocoConFlechas(event, 'propietarioFecha', 'mascotaEdad', 'mascotaEdad', 'mascotaPeso')"></td>
    
        <datalist id="pesos">
            <option value="N.A">N.A</option><option value="0,1 kg">0,1 kg</option><option value="0,2 kg">0,2 kg</option><option value="0,3 kg">0,3 kg</option><option value="0,4 kg">0,4 kg</option>
            <option value="0,5 kg">0,5 kg</option><option value="0,6 kg">0,6 kg</option><option value="0,7 kg">0,7 kg</option><option value="0,8 kg">0,8 kg</option><option value="0,9 kg">0,9 kg</option>
            <option value="1,0 kg">1,0 kg</option><option value="1,1 kg">1,1 kg</option><option value="1,2 kg">1,2 kg</option><option value="1,3 kg">1,3 kg</option><option value="1,4 kg">1,4 kg</option>
            <option value="1,5 kg">1,5 kg</option><option value="1,6 kg">1,6 kg</option><option value="1,7 kg">1,7 kg</option><option value="1,8 kg">1,8 kg</option><option value="1,9 kg">1,9 kg</option>
            <option value="2,0 kg">2,0 kg</option><option value="2,1 kg">2,1 kg</option><option value="2,2 kg">2,2 kg</option><option value="2,3 kg">2,3 kg</option><option value="2,4 kg">2,4 kg</option>
            <option value="2,5 kg">2,5 kg</option><option value="2,6 kg">2,6 kg</option><option value="2,7 kg">2,7 kg</option><option value="2,8 kg">2,8 kg</option><option value="2,9 kg">2,9 kg</option>
            <option value="3,0 kg">3,0 kg</option><option value="3,1 kg">3,1 kg</option><option value="3,2 kg">3,2 kg</option><option value="3,3 kg">3,3 kg</option><option value="3,4 kg">3,4 kg</option>
            <option value="3,5 kg">3,5 kg</option><option value="3,6 kg">3,6 kg</option><option value="3,7 kg">3,7 kg</option><option value="3,8 kg">3,8 kg</option><option value="3,9 kg">3,9 kg</option>
            <option value="4,0 kg">4,0 kg</option><option value="4,1 kg">4,1 kg</option><option value="4,2 kg">4,2 kg</option><option value="4,3 kg">4,3 kg</option><option value="4,4 kg">4,4 kg</option>
            <option value="4,5 kg">4,5 kg</option><option value="4,6 kg">4,6 kg</option><option value="4,7 kg">4,7 kg</option><option value="4,8 kg">4,8 kg</option><option value="4,9 kg">4,9 kg</option>
            <option value="5,0 kg">5,0 kg</option><option value="5,1 kg">5,1 kg</option><option value="5,2 kg">5,2 kg</option><option value="5,3 kg">5,3 kg</option><option value="5,4 kg">5,4 kg</option>
            <option value="5,5 kg">5,5 kg</option><option value="5,6 kg">5,6 kg</option><option value="5,7 kg">5,7 kg</option><option value="5,8 kg">5,8 kg</option><option value="5,9 kg">5,9 kg</option>
            <option value="6,0 kg">6,0 kg</option><option value="6,1 kg">6,1 kg</option><option value="6,2 kg">6,2 kg</option><option value="6,3 kg">6,3 kg</option><option value="6,4 kg">6,4 kg</option>
            <option value="6,5 kg">6,5 kg</option><option value="6,6 kg">6,6 kg</option><option value="6,7 kg">6,7 kg</option><option value="6,8 kg">6,8 kg</option><option value="6,9 kg">6,9 kg</option>
            <option value="7,0 kg">7,0 kg</option><option value="7,1 kg">7,1 kg</option><option value="7,2 kg">7,2 kg</option><option value="7,3 kg">7,3 kg</option><option value="7,4 kg">7,4 kg</option>
            <option value="7,5 kg">7,5 kg</option><option value="7,6 kg">7,6 kg</option><option value="7,7 kg">7,7 kg</option><option value="7,8 kg">7,8 kg</option><option value="7,9 kg">7,9 kg</option>
            <option value="8,0 kg">8,0 kg</option><option value="8,1 kg">8,1 kg</option><option value="8,2 kg">8,2 kg</option><option value="8,3 kg">8,3 kg</option><option value="8,4 kg">8,4 kg</option>
            <option value="8,5 kg">8,5 kg</option><option value="8,6 kg">8,6 kg</option><option value="8,7 kg">8,7 kg</option><option value="8,8 kg">8,8 kg</option><option value="8,9 kg">8,9 kg</option>
            <option value="9,0 kg">9,0 kg</option><option value="9,1 kg">9,1 kg</option><option value="9,2 kg">9,2 kg</option><option value="9,3 kg">9,3 kg</option><option value="9,4 kg">9,4 kg</option>
            <option value="9,5 kg">9,5 kg</option><option value="9,6 kg">9,6 kg</option><option value="9,7 kg">9,7 kg</option><option value="9,8 kg">9,8 kg</option><option value="9,9 kg">9,9 kg</option>
            <option value="10,0 kg">10,0 kg</option><option value="10,1 kg">10,1 kg</option><option value="10,2 kg">10,2 kg</option><option value="10,3 kg">10,3 kg</option><option value="10,4 kg">10,4 kg</option>
            <option value="10,5 kg">10,5 kg</option><option value="10,6 kg">10,6 kg</option><option value="10,7 kg">10,7 kg</option><option value="10,8 kg">10,8 kg</option><option value="10,9 kg">10,9 kg</option>
            <option value="11,0 kg">11,0 kg</option><option value="11,1 kg">11,1 kg</option><option value="11,2 kg">11,2 kg</option><option value="11,3 kg">11,3 kg</option><option value="11,4 kg">11,4 kg</option>
            <option value="11,5 kg">11,5 kg</option><option value="11,6 kg">11,6 kg</option><option value="11,7 kg">11,7 kg</option><option value="11,8 kg">11,8 kg</option><option value="11,9 kg">11,9 kg</option>
            <option value="12,0 kg">12,0 kg</option>
            
        </datalist>
            <td>Fecha</td>
            <td><input type="date" id="propietarioFecha" class="date-input" onkeydown="moverFocoConFlechas(event, 'nombreMedico', 'mascotaPeso', 'nombreMedico', 'propietarioFecha')"></td>
                    </tr>
                    
                    <script>
                  function formatearFecha(input) {
                const fecha = new Date(input.value);
                const dia = String(fecha.getDate()).padStart(2, '0');
                const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                const año = fecha.getFullYear();
                input.value = `${dia}-${mes}-${año}`;
            }
       
            function moverFocoConFlechas(event, derechaId, izquierdaId, arribaId, abajoId) {
                    switch (event.key) {
                        case 'ArrowRight':
                            event.preventDefault();
                            document.getElementById(derechaId).focus();
                            break;
                        case 'ArrowLeft':
                            event.preventDefault();
                            document.getElementById(izquierdaId).focus();
                            break;
                        case 'ArrowUp':
                            event.preventDefault();
                            document.getElementById(arribaId).focus();
                            break;
                        case 'Enter':
                        case 'ArrowDown':
                            event.preventDefault();
                            document.getElementById(abajoId).focus();
                            break;
                    }
                }
                const razasCaninas = [
    "Ainu", "Airedale terrier", "Akita", "Akita Inu", "Alaskan Malamute",
    "American Black and Tan Coonhound", "American Bull Terrier", "American Pit Bull Terrier",
    "American Staffordshire terrier", "American Water Spaniel", "Apso Tibetano", "Barzoi", 
    "Basenji", "Basset Hound", "Beagle", "Bichon Frise", "Bloodhound", "Bobtail", 
    "Border Collie", "Boston Terrier", "Bouvier des Flandres", "Boxer", "Bull terrier", 
    "Bull Terrier Miniatura", "Bulldog Americano", "Bulldog Francés", "Bulldog Inglés", 
    "Bullmastiff", "Cavalier King Charles Spaniel", "Chihuahua", "Chow Chow", 
    "Cocker Spaniel Americano", "Cocker Spaniel Inglés", "Collie", "Collie Escocés", 
    "Dachshund", "Dálmata", "Doberman", "Doberman Pincher", "Dogo Alemán", 
    "Dogo Argentino", "Dogo de Burdeos", "French Poodle", "Galgo Español", 
    "Galgo Inglés-español", "Golden Retriever", "Gran Danés", "Greyhound", 
    "Husky Siberiano", "Jack Russell Terrier", "Labrador Retriever", "Maltés", 
    "Pastor Alemán", "Pequinés", "Pomerania", "Pug", "Rottweiler", "Samoyedo", 
    "San Bernardo", "Schnauzer Gigante", "Schnauzer Mediano", "Schnauzer Miniatura", 
    "Shih Tzu", "SRD", "Yorkshire Terrier", "Weimaraner", "Fila Brasileiro",
];

const razasFelinas = [
    "Abisinio", "American Bobtail", "Angora Turco", "Azul Ruso", "Balinés", 
    "Bengalí", "Bobtail japonés", "Bombay", "British Shorthair", "Burmés", 
    "Carey", "Común Europeo", "Exótico", "Himalayo", "Javanés", 
    "Oriental", "Persa", "Sagrado de Birmania", "Siamés", "Siberiano", 
    "Silvestre", "SRD"
];
// Reemplazar la función de reemplazo de punto por coma
function reemplazarPuntoPorComa() {
    // Obtener todos los campos numéricos
    const camposNumericos = [
        'Glucosa', 'Colesterol_total', 'amilasa', 'CK', 
        'nitrogeno_ureico', 'creatinina', 'bun_crea', 'fosforo', 'calcio',
        'ALT', 'Fosfatasa_Alcalina', 'billirrubina_total', 'Albumina',
        'proteinas_totales', 'Globulinas', 'alb/glo'
    ];
    
    // Aplicar la funcionalidad a cada campo
    camposNumericos.forEach(id => {
        const campo = document.getElementById(id);
        if (campo) {
            // Usar keydown en lugar de input
            campo.addEventListener('keydown', function(event) {
                // Solo actuar cuando se presiona la tecla punto
                if (event.key === '.') {
                    event.preventDefault(); // Prevenir la acción por defecto
                    
                    // Obtener la posición actual del cursor
                    const cursorPos = this.selectionStart;
                    
                    // Obtener el valor actual e insertar una coma en lugar del punto
                    const valorActual = this.value;
                    const nuevoValor = valorActual.slice(0, cursorPos) + ',' + valorActual.slice(cursorPos);
                    
                    // Establecer el nuevo valor
                    this.value = nuevoValor;
                    
                    // Restaurar la posición del cursor justo después de la coma
                    setTimeout(() => {
                        this.setSelectionRange(cursorPos + 1, cursorPos + 1);
                    }, 0);
                }
            });
            
            // Mover las actualizaciones de color y cálculos al evento blur
            campo.addEventListener('blur', function() {
                actualizarColor(id, 'ref' + id.toLowerCase());
                if (id === 'Albumina' || id === 'proteinas_totales') {
                    calculateValues();
                }
            });
            
            // Eliminar cualquier evento input que pueda interferir
            const oldInputListeners = campo._inputListeners || [];
            oldInputListeners.forEach(listener => {
                campo.removeEventListener('input', listener);
            });
        }
    });
}

// Ejecutar cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    reemplazarPuntoPorComa();
});
// Función para actualizar el datalist de razas según la especie seleccionada
function actualizarRazasPorEspecie() {
    const especie = document.getElementById('especieSelector').value;
    // Crear el datalist si no existe
    let datalistRazas = document.getElementById('razas');
    if (!datalistRazas) {
        datalistRazas = document.createElement('datalist');
        datalistRazas.id = 'razas';
        document.body.appendChild(datalistRazas);
    } else {
        // Limpiar la lista actual
        datalistRazas.innerHTML = '';
    }
    
    const campoRaza = document.getElementById('mascotaRaza');
    
    // Restablecer el campo de raza si se cambia la especie
    if (campoRaza.value && campoRaza.value !== "SRD") {
        campoRaza.value = '';
    }
    
    // Agregar las razas según la especie seleccionada
    if (especie === "Canino") {
        razasCaninas.forEach(raza => {
            const option = document.createElement('option');
            option.value = raza;
            datalistRazas.appendChild(option);
        });
    } else if (especie === "Felino") {
        razasFelinas.forEach(raza => {
            const option = document.createElement('option');
            option.value = raza;
            datalistRazas.appendChild(option);
        });
    } else if (especie === "Lagomorfo" || especie === "Cuilo") {
        // Para otras especies, agregar solo opciones genéricas
        const option = document.createElement('option');
        option.value = "SRD";
        datalistRazas.appendChild(option);
    }
}

// Modificar la función existente
function actualizarEspecieEnPlantilla() {
    const especie = document.getElementById('especieSelector').value;
    document.getElementById('especieEnPlantilla').value = especie;
    
    // Actualizar las razas disponibles según la especie
    actualizarRazasPorEspecie();
}

// Ejecutar al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    // Asegurarse de que existe el selector de especies
    const especieSelector = document.getElementById('especieSelector');
    if (especieSelector) {
        // Si ya hay una especie seleccionada al cargar
        if (especieSelector.value !== "Seleccionar") {
            actualizarRazasPorEspecie();
        }
        
        // Agregar un listener adicional para garantizar que se actualicen las razas
        especieSelector.addEventListener('change', actualizarRazasPorEspecie);
    }
    
    // Crear datalist si no existe
    if (!document.getElementById('razas')) {
        const datalist = document.createElement('datalist');
        datalist.id = 'razas';
        document.body.appendChild(datalist);
    }
});

            
                    </script>
                </tbody>
            </table>
    
        <h3 class="titulos">DEPARTAMENTO DE QUIMICA CLINICA</h3>
        <table>
            <thead>
                <tr>
                    <th>PARÁMETRO</th>
                    <th>RESULTADO</th>
                    <th>VALOR DE REFERENCIA</th>
                    <th>UNIDADES</th>
                </tr>
            </thead>
            <tbody>
                <script>
            const valoresReferencia2 = {
                    Canino: {
                        Macho: {
                            "De 1 año a 12 años": {
                                Glucosa: "77 - 126",
                                Colesterol_total: "129 - 331",		
                                Amilasa: "400 - 2500",
                                Nitrógeno_Ureico:	"7 - 23",
                                Creatinina: "0,6 - 1,2",
                                Urea: "20 - 50",
                                Relación_BUN_Crea:	" 4,2 - 32,8 ",
                                Calcio: "9,0 - 11,4",
                                Fosforo: "3,3 - 6,4",
                                Sodio: "139 - 164",
                                Potasio: "4,4 - 6,1",
                                Cloro: "105 - 125",
                                Na_K: "27 - 38",
                                ALT: "15 - 52",
                                Fosfatasa_Alcalina: "20 - 70",
                                Bilirrubina_Total: "0,2- 0,8",
                                Albumina: "2,6 - 3,6",
                                Proteínas_Totales: "5,4 - 7,2",
                                Globulinas_Totales: "3,0 - 4,7",
                                Relación_Albumina_Globulina: "0,6 - 1,1 ",
                            },
                        "De 6 meses a 1 año": {
                                Glucosa: "76 - 129",
                                Colesterol_total: "129 - 271",		
                                Amilasa: "363 - 916",
                                Nitrógeno_Ureico:	"7,3 - 23,5",
                                Urea: "20 - 50",
                                Creatinina: "0,7 - 1,4",
                                Relación_BUN_Crea:	" 4,2 - 32,8 ",
                                Calcio: "9,2 - 13,0",
                                Fosforo: "4,8 - 9,0",
                                Sodio: "137 - 163",
                                Potasio: "4,2 - 5,7",
                                Cloro: "105 - 125",
                                Na_K: "27 - 38",
                                ALT: "19 - 47",
                                Fosfatasa_Alcalina: "32 - 97",
                                Bilirrubina_Total: "0,2- 0,9",
                                Albumina: "2,7 - 3,5",
                                Proteínas_Totales: "5,1 - 7,3",
                                Globulinas_Totales: "3,0 - 4,7",
                                Relación_Albumina_Globulina: "0,6 - 1,1 ",
                            },
                            "De 3 meses a 6 meses": {
                                Glucosa: "89 - 133",
                                Colesterol_Total: "115 - 255",
                                Amilasa: "262 - 621",
                                Nitrógeno_Ureico: "7 - 19",
                                Creatinina: "0,3 - 0,9",
                                Urea: "20 - 50",
                                Relación_BUN_Crea: "4,2 - 32,8",
                                Fosforo: "7,2 - 10,1",
                                Calcio: "9,8 - 12,4",
                                Sodio: "144 - 160",
                                Potasio: "4,8 - 6,2",
                                Cloro: "105 - 125",
                                Na_K: "27 - 38",
                                ALT: "13 - 30",
                                Fosfatasa_Alcalina: "85 - 199",
                                Bilirrubina_Total: "0,2 - 0,9",
                                Albumina: "2,4 - 3,1",
                                Proteínas_Totales: "4,6 - 5,6",
                                Globulinas_Totales: "3,0 - 4,7",
                                Relación_Albumina_Globulina: "0,6 - 1,1"
                            },
                            "De mes y medio a 3 meses": {
                                Glucosa: "97 - 150",
                                Colesterol_Total: "113 - 332",
                                Amilasa: "262 - 621",
                                Nitrógeno_Ureico: "5,9 - 15,2",
                                Urea: "20 - 50",
                                Creatinina: "0,3 - 0,7",
                                Relación_BUN_Crea: "4,2 - 32,8",
                                Fosforo: "7,5 - 10,1",
                                Calcio: "9,8 - 12,4",
                                Sodio: "142 - 157",
                                Potasio: "4,8 - 5,8",
                                Cloro: "105 - 125",
                                Na_K: "27 - 38",
                                ALT: "10,0 - 28,0",
                                Fosfatasa_Alcalina: "78 - 293",
                                Bilirrubina_Total: "0,1 - 0,6",
                                Albumina: "2,3 - 2,6",
                                Proteínas_Totales: "4,0 - 5,2",
                                Globulinas_Totales: "3,0 - 4,1",
                                Relación_Albumina_Globulina: "0,6 - 1,1"
                            },
                        },
                        Hembra: {
                            "De 1 año a 12 años": {
                                Glucosa: "77 - 126",
                                Colesterol_total: "129 - 331",		
                                Amilasa: "400 - 2500",
                                Nitrógeno_Ureico:	"7 - 23",
                                Creatinina: "0,6 - 1,2",
                                Urea: '20 - 50',
                                Relación_BUN_Crea:	" 4,2 - 32,8 ",
                                Calcio: "9,0 - 11,4",
                                Fosforo: "3,3 - 6,4",
                                Sodio: "139 - 164",
                                Potasio: "4,4 - 6,1",
                                Cloro: "105 - 125",
                                Na_K: "27 - 38",
                                ALT: "15 - 52",
                                Fosfatasa_Alcalina: "20 - 70",
                                Bilirrubina_Total: "0,2- 0,8",
                                Albumina: "2,6 - 3,6",
                                Proteínas_Totales: "5,4 - 7,2",
                                Globulinas_Totales: "3,0 - 4,7",
                                Relación_Albumina_Globulina: "0,6 - 1,1 ",
                            },
                            "De 6 meses a 1 año": {
                                Glucosa: "29 - 127",
                                Colesterol_Total: "127 - 247",
                                Amilasa: "255 - 832",
                                Nitrógeno_Ureico: "10 - 27",
                                Urea: '20 - 50',
                                Creatinina: "0.7 - 1.4",
                                Relación_BUN_Crea: "4,2 - 32,8",
                                Fosforo: "4,4 - 9,2",
                                Calcio: "9,4 - 11,7",
                                Sodio: "139 - 163",
                                Potasio: "4,3 - 5,5",
                                Cloro: "105 - 125",
                                Na_K: "27 - 38",
                                ALT: "16 - 49",
                                Fosfatasa_Alcalina: "29 - 97",
                                Bilirrubina_Total: "0,2 - 1,1",
                                Albumina: "2,7 - 3,6",
                                Proteínas_Totales: "5,1 - 6,9",
                                Globulinas_Totales: "3,0 - 4,7",
                                Relación_Albumina_Globulina: "0,6 - 1,1",
                            },
                            "De 3 meses a 6 meses": {
                                Glucosa: "82 - 130",
                                Colesterol_Total: "105 - 241",
                                Amilasa: "281 - 636",
                                Nitrógeno_Ureico: "7 - 19",
                                Urea: "20 - 50",
                                Creatinina: "0,4 - 0,9",
                                Relación_BUN_Crea: "4,2 - 32,8",
                                Fosforo: "7,5 - 10,0",
                                Calcio: "10,1 - 12,3",
                                Sodio: "138 - 156",
                                Potasio: "4,3 - 5,9",
                                Cloro: "105 - 125",
                                Na_K: "27 - 38",
                                ALT: "9 - 27",
                                Fosfatasa_Alcalina: "77 - 180",
                                Bilirrubina_Total: "0,2 - 0,9",
                                Albumina: "2,4 - 3,1",
                                Proteínas_Totales: "4,6 - 5,8",
                                Globulinas_Totales: "3,0 - 4,7",
                                Relación_Albumina_Globulina: "0,6 - 1,1"
                            },
                        },
                        "De mes y medio a 3 meses": {
                                Glucosa: "108 - 151",
                                Colesterol_Total: "110 - 273",
                                Amilasa: "281 - 636",
                                Nitrógeno_Ureico: "6,2 - 15,2",
                                Urea: "20 - 50",
                                Creatinina: "0,8 - 1,3",
                                Relación_BUN_Crea: "4,2 - 32,8",
                                Fosforo: "7,5 - 10,7",
                                Calcio: "9,9 - 12,0",
                                Sodio: "144 - 159",
                                Potasio: "4,7 - 6,0",
                                Cloro: "105 - 125",
                                Na_K: "27 - 38",
                                ALT: "9 - 30",
                                Fosfatasa_Alcalina: "85 - 273",
                                Bilirrubina_Total: "0,1 - 0,6",
                                Albumina: "2,2 - 2,9",
                                Proteínas_Totales: "4,0 - 5,1",
                                Globulinas_Totales: "3,0 - 4,7",
                                Relación_Albumina_Globulina: "0,6 - 1,1"
                            },
                    },
                    Felino: {
                        Macho: {
                            "De 1 año a 12 años": {
                                Glucosa: "65 - 111",
                                Colesterol_Total: "76 - 146",
                                Amilasa: "400 - 2500",
                                Nitrógeno_Ureico: "20 - 42",
                                Urea: "30 - 60",
                                Creatinina: "0,5 - 1,8",
                                Relación_BUN_Crea: "4,2 - 32,8",
                                Fosforo: "4,1 - 6,4",
                                Calcio: "8,3 - 10,4",
                                Sodio: "149 - 163",
                                Potasio: "4,1 - 5,4",
                                Cloro: "114 - 125",
                                Na_K: "32 - 41",
                                ALT: "20 - 67",
                                Fosfatasa_Alcalina: "13 - 47",
                                Bilirrubina_Total: "0,2 - 0,7",
                                Albumina: "2,8 - 3,7",
                                Proteínas_Totales: "5,8 - 7,6",
                                Globulinas_Totales: "2,6 - 4,5",
                                Relación_Albumina_Globulina: "0,5 - 1,3",     
                            },
                            "De 6 meses a 1 año": {
                                Glucosa: "67 - 101",
                                Colesterol_Total: "68 - 128",
                                Amilasa: "403 - 752",
                                Nitrógeno_Ureico: "14 - 36",
                                Urea: "30 - 60",
                                Creatinina: "0,4 - 1,2",
                                Relación_BUN_Crea: "4,2 - 32,8",
                                Fosforo: "6,2 - 9,1",
                                Calcio: "8,9 - 10,1",
                                Sodio: "152 - 162",
                                Potasio: "4,1 - 5,7",
                                Cloro: "114 - 126",
                                ALT: "19 - 72",
                                Fosfatasa_Alcalina: "21 - 95",
                                Bilirrubina_Total: "0,2 - 0,8",
                                Albumina: "2,4 - 3,6",
                                Proteínas_Totales: "5,3 - 6,9",
                                Globulinas_Totales: "2,6 - 4,5",
                                Relación_Albumina_Globulina: "0,5 - 1,3"
                            },
                            "De 3 meses a 6 meses": {
                                Glucosa: "61 - 102",
                                Colesterol_Total: "66 - 132",
                                Amilasa: "403 - 752",
                                Nitrógeno_Ureico: "19 - 34",
                                Urea: "30 - 60",
                                Creatinina: "0,4 - 0,9",
                                Relación_BUN_Crea: "4,2 - 32,8",
                                Fosforo: "7,1 - 9,5",
                                Calcio: "9,1 - 10,9",
                                Sodio: "143 - 159",
                                Potasio: "4,4 - 5,9",
                                Cloro: "114 - 125",
                                ALT: "18 - 55",
                                Fosfatasa_Alcalina: "43 - 124",
                                Bilirrubina_Total: "0,2 - 0,8",
                                Albumina: "2,7 - 3,6",
                                Proteínas_Totales: "5,4 - 6,6",
                                Globulinas_Totales: "2,6 - 4,5",
                                Relación_Albumina_Globulina: "0,5 - 1,3"
                            },
                        },
                        Hembra: {
                            "De 1 año a 12 años": {
                                Glucosa: "65 - 112",
                                Colesterol_Total: "51 - 112",
                                Amilasa: "400 - 2500",
                                Nitrógeno_Ureico: "19 - 30",
                                Creatinina: "0,6 - 1,7",
                                Urea: "30 - 60",
                                Relación_BUN_Crea: "4,2 - 32,8",
                                Fosforo: "3,2 - 6,6",
                                Calcio: "7,8 - 9,2",
                                Sodio: "147 - 163",
                                Potasio: "4,0 - 5,0",
                                Cloro: "114 - 125",
                                Na_K: "32 - 41",
                                ALT: "22 - 79",
                                Fosfatasa_Alcalina: "12 - 55",
                                Bilirrubina_Total: "0,3 - 1,1",
                                Albumina: "2,4 - 3,0",
                                Proteínas_Totales: "5,6 - 7,7",
                                Globulinas_Totales: "2,6 - 4,5",
                                Relación_Albumina_Globulina: "0,5 - 1,3"
                            },
                            "De 6 meses a 1 año": {
                                Glucosa: "67 - 102",
                                Colesterol_Total: "56 - 114",
                                Amilasa: "352 - 833",
                                Nitrógeno_Ureico: "19 - 37",
                                Creatinina: "0,3 - 1,2",
                                Urea: "30 - 60",
                                Relación_BUN_Crea: "4,2 - 32,8",
                                Fosforo: "4,9 - 8,3",
                                Calcio: "8,5 - 10,3",
                                Sodio: "147 - 163",
                                Potasio: "4,1 - 5,6",
                                Cloro: "114 - 125",
                                Na_K: "32 - 41",
                                ALT: "25 - 77",
                                Fosfatasa_Alcalina: "22 - 100",
                                Bilirrubina_Total: "0,2 - 0,9",
                                Albumina: "2,5 - 3,6",
                                Proteínas_Totales: "5,4 - 7,2",
                                Globulinas_Totales: "2,6 - 4,5",
                                Relación_Albumina_Globulina: "0,5 - 1,3"
                        },
                        "De 3 meses a 6 meses": {
                            Glucosa: "59 - 99",
                            Colesterol_Total: "63 - 113",
                            Amilasa: "464 - 988",
                            Nitrógeno_Ureico: "19 - 33",
                            Urea: "30 - 60",
                            Creatinina: "0,4 - 0,9",
                            Relación_BUN_Crea: "4,2 - 32,8",
                            Fosforo: "6,9 - 9,5",
                            Calcio: "8,9 - 10,9",
                            Sodio: "144 - 162",
                            Potasio: "4,1 - 5,5",
                            Cloro: "114 - 126",
                            Na_K: "32 - 41",
                            ALT: "19 - 58",
                            Fosfatasa_Alcalina: "39 - 114",
                            Bilirrubina_Total: "0,1 - 0,6",
                            Albumina: "2,5 - 3,5",
                            Proteínas_Totales: "5,4 - 6,8",
                            Globulinas_Totales: "2,6 - 4,5",
                            Relación_Albumina_Globulina: "0,5 - 1,3"
                            },
                        }
                    },
                    Lagomorfo: {
                        Macho: {
                            "Todas las edades": {
                                Glucosa: "60,0 - 125,0",
                                Colesterol_Total: "20,0 - 43,0",
                                Amilasa: "",
                                Nitrógeno_Ureico: "9,0 - 32,0",
                                Creatinina: "0,6 - 2,2",
                                Relación_BUN_Crea: "",
                                Fosforo: "",
                                Calcio: "7,8 - 10,5",
                                ALT: "10,0 - 25,0",
                                Fosfatasa_Alcalina: "",
                                Bilirrubina_Total: "0,3 - 0,9",
                                Albumina: "2,1 - 3,9",
                                Proteínas_Totales: "4,6 - 6,2",
                                Globulinas_Totales: "1,7 - 2,6",
                                Relación_Albumina_Globulina: "",
                            },
                        },
                        Hembra: {
                            "Todas las edades": {
                                Glucosa: "77 - 126",
                                Colesterol_total: "129 - 331",		
                                Amilasa: "400 - 2500",
                                Nitrógeno_Ureico:	"7 - 23",
                                Creatinina: "0,6 - 1,2",
                                Relación_BUN_Crea:	" 4,2 - 32,8 ",
                                Calcio: "9,0 - 11,4",
                                Fosforo: "14,2 - 18,9",
                                ALT: "3,3 - 6,4",
                                Fosfatasa_Alcalina: "15 - 52",
                                Bilirrubina_Total: "0,2- 0,8",
                                Albumina: "2,6 - 3,6",
                                Proteínas_Totales: "2,6 - 3,6",
                                Globulinas_Totales: "3,0 - 4,7",
                                Relación_Albumina_Globulina: "0,6 - 1,1 ",
                            },
                            },
                        },
                    Cuilo: {
                        Macho: {
                            "Todas las edades": {
                                Glucosa: "60 - 125",
                                Colesterol_Total: "20 - 43",
                                Amilasa: "",
                                Nitrógeno_Ureico: "9,0 - 32,0",
                                Creatinina: "0,6 - 2,2",
                                Relación_BUN_Crea: "",
                                Fosforo: "0 - 5,3",
                                Calcio: "7,8 - 10,5",
                                ALT: "10,0 - 25,0",
                                Fosfatasa_Alcalina: "",
                                Bilirrubina_Total: "0,3 - 0,9",
                                Albumina: "2,1 - 3,9",
                                Proteínas_Totales: "4,6 - 6,2",
                                Globulinas_Totales: "1,7 - 2,6",
                                Relación_Albumina_Globulina: ""
                            },
                        },
                        Hembra: {
                            "Todas las edades": {
                                Glucosa: "60 - 125",
                                Colesterol_Total: "20 - 43",
                                Amilasa: "",
                                Nitrógeno_Ureico: "9,0 - 32,0",
                                Creatinina: "0,6 - 2,2",
                                Relación_BUN_Crea: "",
                                Fosforo: "0 - 5,3",
                                Calcio: "7,8 - 10,5",
                                ALT: "10,0 - 25,0",
                                Fosfatasa_Alcalina: "",
                                Bilirrubina_Total: "0,3 - 0,9",
                                Albumina: "2,1 - 3,9",
                                Proteínas_Totales: "4,6 - 6,2",
                                Globulinas_Totales: "1,7 - 2,6",
                                Relación_Albumina_Globulina: ""
                            },
                            },
                        },
                    };
    </script>
                    <script>
   function actualizarValoresReferencia2() {
    const especie = document.getElementById('especieSelector').value;
    const sexo = document.getElementById('sexoSelector').value;
    const edad = document.getElementById('edadSelector').value;

    if (especie !== "Seleccionar" && sexo !== "Seleccionar" && edad !== "Seleccionar") {
        const refValores = valoresReferencia2[especie][sexo][edad];
        document.getElementById('refglucosa').innerText = refValores.Glucosa || '';
        document.getElementById('refcolesterolT').innerText = refValores.Colesterol_total || refValores.Colesterol_Total || '';
        document.getElementById('refamilasa').innerText = refValores.Amilasa || '';
        document.getElementById('refurea').innerText = refValores.Urea || '';
        document.getElementById('refnitrogeno_ureico').innerText = refValores.Nitrógeno_Ureico || '';
        document.getElementById('refcreatinina').innerText = refValores.Creatinina || '';
        document.getElementById('refbun_crea').innerText = refValores.Relación_BUN_Crea || '';
        document.getElementById('reffosforo').innerText = refValores.Fosforo || '';
        document.getElementById('refcalcio').innerText = refValores.Calcio || '';
        document.getElementById('refsodio').innerText = refValores.Sodio || '';
        document.getElementById('refpotasio').innerText = refValores.Potasio|| '';
        document.getElementById('refcloro').innerText = refValores.Cloro || '';
        document.getElementById('refNa_K').innerText = refValores.Na_K || '';
        document.getElementById('refALT').innerText = refValores.ALT || '';
        document.getElementById('refFosfatasa_Alcalina').innerText = refValores.Fosfatasa_Alcalina || '';
        document.getElementById('refbillirrubina').innerText = refValores.Bilirrubina_Total || '';
        document.getElementById('refalbumina').innerText = refValores.Albumina || '';
        document.getElementById('refproteinas_totales').innerText = refValores.Proteínas_Totales || '';
        document.getElementById('refglobulinas').innerText = refValores.Globulinas_Totales || '';
        document.getElementById('refalb_glo').innerText = refValores.Relación_Albumina_Globulina || '';
    } else {
        document.getElementById('refglucosa').innerText = "";
        document.getElementById('refcolesterolT').innerText = "";
        document.getElementById('refamilasa').innerText = "";
        document.getElementById('refurea').innerText = "";
        document.getElementById('refnitrogeno_ureico').innerText = "";
        document.getElementById('refcreatinina').innerText = "";
        document.getElementById('refbun_crea').innerText = "";
        document.getElementById('reffosforo').innerText = "";
        document.getElementById('refcalcio').innerText = "";
        document.getElementById('refpotasio').innerText = "";
        document.getElementById('refcloro').innerText = "";
        document.getElementById('refNa_K').innerText = "";
        document.getElementById('refALT').innerText = "";
        document.getElementById('refFosfatasa_Alcalina').innerText = "";
        document.getElementById('refbillirrubina').innerText = "";
        document.getElementById('refalbumina').innerText = "";
        document.getElementById('refproteinas_totales').innerText = "";
        document.getElementById('refglobulinas').innerText = "";
        document.getElementById('refalb_glo').innerText = "";
    }
}
// Reemplazar la función actualizarColor con esta versión simplificada
// Reemplazar la función actualizarColor existente con esta versión mejorada
function actualizarColor(inputId, refId) {
    const inputElement = document.getElementById(inputId);
    const refElement = document.getElementById(refId);
    
    if (!inputElement || !refElement || !refElement.textContent) {
        console.log(`No se encontró: ${inputId} o ${refId}`);
        return;
    }
    
    // Obtener el valor del input y convertirlo a número
    let valorTexto = inputElement.value.trim();
    
    // Eliminar cualquier flecha existente
    valorTexto = valorTexto.replace(/\s*[↑↓]$/, '');
    
    if (!valorTexto) {
        inputElement.style.color = 'black';
        return;
    }
    
    const valor = parseFloat(valorTexto.replace(',', '.'));
    if (isNaN(valor)) return;
    
    // Extraer el rango de referencia
    const rangoTexto = refElement.textContent;
    const coincidencia = rangoTexto.match(/([\d,.]+)\s*-\s*([\d,.]+)/);
    
    if (coincidencia) {
        const min = parseFloat(coincidencia[1].replace(',', '.'));
        const max = parseFloat(coincidencia[2].replace(',', '.'));
        
        // Aplicar color según el valor
        if (valor < min) {
            inputElement.style.color = '#0096d2'; // Azul/celeste para valores bajos
            
            // Solo agregar flecha si es evento blur o enter, no durante la escritura
            if (event && (event.type === 'blur' || (event.type === 'keydown' && event.key === 'Enter'))) {
                inputElement.value = valorTexto + ' ↓';
            }
        } else if (valor > max) {
            inputElement.style.color = 'red'; // Rojo para valores altos
            
            if (event && (event.type === 'blur' || (event.type === 'keydown' && event.key === 'Enter'))) {
                inputElement.value = valorTexto + ' ↑';
            }
        } else {
            inputElement.style.color = 'black'; // Negro para valores normales
            inputElement.value = valorTexto; // Sin flechas
        }
    }
}

// Modificar los listeners para pasar el evento a la función actualizarColor
document.addEventListener('DOMContentLoaded', function() {
    const parametros = [
        { campo: 'Glucosa', ref: 'refglucosa' },
        { campo: 'Colesterol_total', ref: 'refcolesterolT' },
        { campo: 'amilasa', ref: 'refamilasa' },
        { campo: 'urea', ref: 'refurea' },
        { campo: 'nitrogeno_ureico', ref: 'refnitrogeno_ureico' },
        { campo: 'creatinina', ref: 'refcreatinina' },
        { campo: 'bun_crea', ref: 'refbun_crea' },
        { campo: 'fosforo', ref: 'reffosforo' },
        { campo: 'calcio', ref: 'refcalcio' },
        { campo: 'sodio', ref: 'refsodio' },
        { campo: 'potasio', ref: 'refpotasio' },
        { campo: 'cloro', ref: 'refcloro' },
        { campo: 'Na_K', ref: 'refNa_K' },
        { campo: 'ALT', ref: 'refALT' },
        { campo: 'Fosfatasa_Alcalina', ref: 'refFosfatasa_Alcalina' },
        { campo: 'billirrubina_total', ref: 'refbillirrubina' },
        { campo: 'Albumina', ref: 'refalbumina' },
        { campo: 'proteinas_totales', ref: 'refproteinas_totales' },
        { campo: 'Globulinas', ref: 'refglobulinas' },
        { campo: 'alb/glo', ref: 'refalb_glo' }
    ];
    
    parametros.forEach(param => {
        const input = document.getElementById(param.campo);
        if (input) {
            // No actualizar el color durante la escritura, solo al perder el foco
            input.removeEventListener('input', function() {
                actualizarColor(param.campo, param.ref);
            });
            
            // Actualizar solo al perder el foco o presionar Enter
            input.addEventListener('blur', function(event) {
                actualizarColor(param.campo, param.ref, event);
            });
            
            input.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    actualizarColor(param.campo, param.ref, event);
                }
            });
        }
    });
});

    </script>
            </script>
            <tr>
                <td>GLUCOSA</td>
                <td>
                    <input type="text" id="Glucosa" list="rangoglucosa" onkeydown="moverFoco(event, 'Glucosa')">
                    <datalist id="rangoglucosa"></datalist>
                </td>
                <td id="refglucosa">77 - 126</td>
                <td>mg/dl</td>
                </script>
                </tr>
                <tr>
                    <td>COLESTEROL TOTAL</td>
                    <td>
                        <input type="text" id="Colesterol_total" list="rangocolesterolT" onkeydown="moverFoco(event, 'Colesterol_total')">  
                 <datalist id="rangocolesterolT"></datalist>
                    </td>
                <td id="refcolesterolT">129 - 331</td>
                <td>mg/dl</td>  
                </tr>
                <tr>
                    <td>AMILASA</td>
                    <td>
                        <input type="text" id="amilasa" list="rangoamilasa" onblur="formatearDecimal('amilasa')" onkeydown="moverFoco(event, 'amilasa')">
                        <datalist id="rangoamilasa"></datalist>
                    </td>
                    <td id="refamilasa">400 - 2500</td>
                    <td>U/L</td>
                </tr>
            </tbody>
        </table>
    
        <h3 class="titulos">FUNCIONAMIENTO RENAL</h3>
        <table>
            <thead>
                <tr>
                    <th>PARÁMETRO</th>
                    <th>RESULTADO</th>
                    <th>VALOR DE REFERENCIA</th>
                    <th>UNIDADES</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>NITROGENO UREICO</td>
                    <td>
                        <input type="text" id="nitrogeno_ureico" list="rangonitrogeno_ureico" onblur="formatearDecimal('nitrogeno_ureico')" onkeydown="moverFoco(event, 'nitrogeno_ureico')">
                        <datalist id="rangonitrogeno_ureico"></datalist>
                    </td>
                    <td id="refnitrogeno_ureico">7 - 23</td>
                    <td>mg/dl</td>
                </tr>
                <tr>
                    <td>CREATININA</td>
                    <td>
                        <input type="text" id="creatinina" list="rangocreatinina" onblur="formatearDecimal('creatinina')" onkeydown="moverFoco(event, 'creatinina')">
                        <datalist id="rangocreatinina"></datalist>
                    </td>
                    <td id="refcreatinina">0,6 - 1,2</td>
                    <td>mg/dl</td>
                </tr>
                <tr>
                    <td>UREA</td>
                    <td>
                        <input type="text" id="urea" list="rangourea" onkeydown="moverFoco(event, 'Urea')">
                        <datalist id="rangourea"></datalist>
                    </td>
                    <td id="refurea">20 - 50</td>
                    <td>mg/dl</td>
                    </tr>
                <tr>
                    <td>RELACIÓN BUN/CREA</td>
                    <td>
                    <input type="text" id="bun_crea" list="rangobun_crea" readonly style="background-color: #f0f0f0;" onkeydown="moverFoco(event, 'fosforo')">                        <datalist id="rangobun_crea"></datalist>
                    </td>
                    <td id="refbun_crea"> 4,2 - 32,8 </td>
                    <td>mg/dl</td>
                </tr>
                <tr>
                    <td>FOSFORO</td>
                    <td>
                        <input type="text" id="fosforo" list="rangofosforo" onblur="formatearDecimal('fosforo')" onkeydown="moverFoco(event, 'fosforo')">
                        <datalist id="rangofosforo"></datalist>
                    </td>
                    <td id="reffosforo">3,3 - 6,4</td>
                    <td>mg/dl</td>
                </tr>
                <tr>
                    <td>CALCIO</td>
                    <td>
                        <input type="text" id="calcio" list="rangocalcio" onblur="formatearDecimal('calcio')" onkeydown="moverFoco(event, 'calcio')">
                        <datalist id="rangocalcio"></datalist>
                    </td>
                    <td id="refcalcio">9,0 - 11,4</td>
                    <td>mg/dl</td>
                </tr>
                <tr>
                    <td>SODIO</td>
                    <td>
                        <input type="text" id="sodio" list="rangosodio" onblur="formatearDecimal('sodio')" onkeydown="moverFoco(event, 'sodios')">
                        <datalist id="rangosodio"></datalist>
                    </td>
                    <td id="refsodio">139 - 164</td>
                    <td>mmol/l</td>
                </tr>
                <tr>
                    <td>POTASIO</td>
                    <td>
                        <input type="text" id="potasio" list="rangopotasio" onblur="formatearDecimal('potasio')" onkeydown="moverFoco(event, 'potasio')">
                        <datalist id="rangopotasio"></datalist>
                    </td>
                    <td id="refpotasio">4,4 - 6,1</td>
                    <td>mmol/l</td>
                </tr>
                <tr>
                    <td>CLORO</td>
                    <td>
                        <input type="text" id="cloro" list="rangocloro" onblur="formatearDecimal('cloro')" onkeydown="moverFoco(event, 'cloro')">
                        <datalist id="rangocloro"></datalist>
                    </td>
                    <td id="refcloro">105 - 125</td>
                    <td>mmol/l</td>
                </tr>
                <tr>
                    <td>NA+/K+</td>
                    <td>
                        <input type="text" id="Na_K" list="rangoNa_K" onblur="formatearDecimal('Na_K')" onkeydown="moverFoco(event, 'Na_K')">
                        <datalist id="rangoNa_K"></datalist>
                    </td>
                    <td id="refNa_K">27 - 38</td>
                    <td></td>
                </tr>
            </tbody>
        </table>
    
        <h3 class="titulos">FUNCIONAMIENTO HÉPATICO</h3>
        <table>
            <thead>
                <tr>
                    <th>PARÁMETRO</th>
                    <th>RESULTADO</th>
                    <th>VALOR DE REFERENCIA</th>
                    <th>UNIDADES</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>ALT</td>
                    <td>
                        <input type="text" id="ALT" list="rangoALT" onblur="formatearDecimal('ALT')" onkeydown="moverFoco(event, 'ALT')">
                        <datalist id="rangoALT"></datalist>
                    </td>
                    <td id="refALT">15 - 52</td>
                    <td>U/L</td>
                </tr>
                <tr>
                    <td>FOSFATASA ALCALINA</td>
                    <td>
                        <input type="text" id="Fosfatasa_Alcalina" list="rangoFosfatasa_Alcalina" onblur="formatearDecimal('Fosfatasa_Alcalina')" onkeydown="moverFoco(event, 'Fosfatasa_Alcalina')">
                        <datalist id="rangoFosfatasa_Alcalina"></datalist>
                    </td>
                    <td id="refFosfatasa_Alcalina">20 - 70</td>
                    <td>U/L</td>
                </tr>
                <tr>
                    <td>BILLIRRUBINA TOTAL</td>
                    <td>
                        <input type="text" id="billirrubina_total" list="rangobillirrubina" onblur="formatearDecimal('billirrubina_total')" onkeydown="moverFoco(event, 'billirrubina_total')">
                        <datalist id="rangobillirrubina"></datalist>
                    </td>
                    <td id="refbillirrubina"> 0,2 - 0,8 </td>
                    <td>mg/dl</td>
                </tr>
            </tbody>
        </table>
    
        <h3 class="titulos">FUNCIONAMIENTO SANGUINEO</h3>
        <table>
            <thead>
                <tr>
                    <th>PARÁMETRO</th>
                    <th>RESULTADO</th>
                    <th>VALOR DE REFERENCIA</th>
                    <th>UNIDADES</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>ALBUMINA</td>
                    <td>
                        <input type="text" id="Albumina" list="rangoalbumina" onblur="formatearDecimal('Albumina')" onkeydown="moverFoco(event, 'Albumina')">
                        <datalist id="rangoalbumina"></datalist>
                    </td>
                    <td id="refalbumina">2,6 - 3,6</td>
                    <td>g/dl</td>
                    <script type="module">
                        import {  recuentoalbumina  } from './numeros.js';
            document.getElementById('Albumina').addEventListener('input', calculateValues);
            document.getElementById('proteinas_totales').addEventListener('input', calculateValues);
                    </script>
                </tr>
                    <td>PROTEINAS TOTALES</td>
                    <td>
                        <input type="text" id="proteinas_totales" list="rangoproteinas" onblur="formatearDecimal('proteinas_totales')" onkeydown="moverFoco(event, 'proteinas_totales')">
                        <datalist id="rangoproteinas"></datalist>
                    </td>
                    <td id="refproteinas_totales">5,4 - 7,2</td>
                    <td>g/dl</td>
                </tr>
                <tr>
                    <td>GLOBULINAS TOTALES</td>
                    <td>
                        <input type="text" id="Globulinas" list="rangoglubolinas" onblur="formatearDecimal('Globulinas')" onkeydown="moverFoco(event, 'Globulinas')">
                        <datalist id="rangoglobulinas"></datalist>
                    </td>
                    <td id="refglobulinas">3,0 - 4,7</td>
                    <td>g/dl</td>
                </tr>
                <tr>
                    <td>RELACIÓN ALBUMINA/GLOBULINAS</td>
                    <td>
                        <input type="text" id="alb/glo" list="rangoalb/glo" onblur="formatearDecimal('alb/glo')" onkeydown="moverFoco(event, 'alb/glo')">
                        <datalist id="rangoalb/glo"></datalist>
                    </td>
                    <td id="refalb_glo">0,6 - 1,1</td>
                    <td>mg/dl</td>
                </tr>
                <script>
function calculateValues() {
    const albumina = parseFloat(document.getElementById('Albumina').value.replace(',', '.')) || 0;
    const proteinasTotales = parseFloat(document.getElementById('proteinas_totales').value.replace(',', '.')) || 0;
    
    const globulinasTotales = proteinasTotales - albumina;
    
    let relacionAlbGlo = 0;
    if (globulinasTotales > 0) {
        relacionAlbGlo = albumina / globulinasTotales;
    }
    
    document.getElementById('Globulinas').value = globulinasTotales.toFixed(1).replace('.', ',');
    document.getElementById('alb/glo').value = relacionAlbGlo.toFixed(1).replace('.', ',');
    
    actualizarColor('Globulinas', 'refglobulinas');
    actualizarColor('alb/glo', 'refalb_glo'); // Corregido: usar el ID exacto que aparece en el HTML
}




            </script>
            </tbody>
        </table>
    
        <h3 class="titulos">INDICES DE INTERFERENCIA</h3>
        <table>
            <tbody>
                <tr>
                    <td>SUERO HEMOLITICO</td>
                    <td>
                        <input type="text" id="suero_hemolitico2" list="opcionesInterferencia" style="width:140px;">
                    </td>
                </tr>
                <tr>
                    <td>SUERO LIPEMICO</td>
                    <td>
                        <input type="text" id="suero_lipemico2" list="opcionesInterferencia" style="width:140px;">
                    </td>
                </tr>
                <tr>
                    <td>SUERO ICTERICO</td>
                    <td>
                        <input type="text" id="suero_icterico2" list="opcionesInterferencia" style="width:140px;">
                    </td>
                </tr>
            </tbody>
        </table>
        <datalist id="opcionesInterferencia">
    <option value="No se observa">
    <option value="Se observa">
</datalist>
<div class="footer">
            <p id="mensajeMedico" style="display: none;">El personal médico cuenta con un plazo de 24 a 48 horas para interpretar el reporte de los resultados.</p>
            <p>Facebook: Veterinaria San Martin de Porres | Teléfono: 4000 - 1365 | Ext: 106</p>
            <p>WhatsApp: 8839 - 2214 | San Rafael Abajo de Desamparados, 50 metros Norte del Mall Zona Centro</p>
            <p>Correo: laboratorio@vetsanmartin.com</p>
        </div>
    </div>
    <div class="controls">
        <button id="pdfButton" onclick="generatePDF()">Generar PDF</button>
        <button id="menuButton" onclick="window.location.href='index.html'">Volver al Menú</button>
        <div id="loadingPdf" class="loading-indicator">
            <div class="spinner"></div>
            <span>Generando PDF...</span>
        </div>
    </div>
    <div class="parameter-selector-panel">
        <h3>Eliminar parámetros</h3>
        <div class="selector-container">
            <select id="parameterSelector" class="parameter-dropdown">
                <option value="" selected disabled>-- Seleccionar parámetro --</option>
            </select>
            <button onclick="eliminarParametroSeleccionado()" class="remove-param-btn">Eliminar</button>
        </div>
    </div>

    <script>
    
        // Implementación de historial para Panel_Plus.html
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar el historial de análisis
            setupHistorial();
            
            // Añadir evento para guardar los datos al generar el PDF
            const pdfButton = document.getElementById('pdfButton');
            if (pdfButton) {
                const originalHandler = pdfButton.onclick;
                pdfButton.onclick = async function() {
                    // Guardar los datos antes de generar el PDF
                    guardarAnalisisActual();
                    
                    // Llamar al manejador original
                    if (originalHandler) {
                        return originalHandler.apply(this, arguments);
                    }
                };
            }
        });
        
        // Función para configurar el selector de historial
        function setupHistorial() {
            // Crear el selector de historial
            const controlsDiv = document.querySelector('.controls');
            
            if (controlsDiv) {
                // Crear el contenedor para el historial
                const historialContainer = document.createElement('div');
                historialContainer.className = 'historial-container';
                historialContainer.style.marginTop = '10px';
                
                // Crear etiqueta
                const label = document.createElement('label');
                label.htmlFor = 'historialSelector';
                label.textContent = 'Historial de análisis:';
                label.style.marginRight = '10px';
                
                // Crear selector
                const select = document.createElement('select');
                select.id = 'historialSelector';
                select.style.padding = '5px';
                select.style.marginRight = '10px';
                
                // Opción por defecto
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- Seleccionar análisis anterior --';
                defaultOption.selected = true;
                select.appendChild(defaultOption);
                
                // Cargar opciones del historial
                cargarOpcionesHistorial(select);
                
                // Evento de cambio
                select.addEventListener('change', function() {
                    if (this.value) {
                        cargarAnalisisDesdeHistorial(this.value);
                    }
                });
                
                // Agregar botón para borrar historial
                const borrarHistorialBtn = document.createElement('button');
                borrarHistorialBtn.textContent = 'Borrar Historial';
                borrarHistorialBtn.style.marginLeft = '10px';
                borrarHistorialBtn.onclick = function() {
                    if (confirm('¿Estás seguro de que quieres borrar todo el historial de análisis?')) {
                        localStorage.removeItem('panelPlusHistorial');
                        cargarOpcionesHistorial(select);
                        alert('Historial borrado correctamente');
                    }
                };
                
                // Agregar elementos al DOM
                historialContainer.appendChild(label);
                historialContainer.appendChild(select);
                historialContainer.appendChild(borrarHistorialBtn);
                
                // Agregar después de los selectores existentes
                controlsDiv.appendChild(historialContainer);
            }
        }
        
        // Función para cargar las opciones del historial
        function cargarOpcionesHistorial(selectElement) {
            // Limpiar opciones existentes excepto la primera
            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }
            
            // Obtener historial del localStorage
            const historial = JSON.parse(localStorage.getItem('panelPlusHistorial') || '[]');
            
            // Agregar cada análisis como opción
            historial.forEach((analisis, index) => {
                const option = document.createElement('option');
                option.value = index;
                
                // Crear descripción con nombre, fecha y hora
                const fecha = new Date(analisis.timestamp);
                const fechaStr = fecha.toLocaleDateString();
                const horaStr = fecha.toLocaleTimeString();
                
                option.textContent = `${analisis.mascotaNombre} - ${analisis.propietarioNombre} (${fechaStr} ${horaStr})`;
                
                selectElement.appendChild(option);
            });
        }
        
        // Función para guardar el análisis actual
        function guardarAnalisisActual() {
            // Recopilación de todos los datos del formulario
            const formData = {
                // Datos de la mascota y propietario
                mascotaNombre: document.getElementById('mascotaNombre')?.value || '',
                mascotaRaza: document.getElementById('mascotaRaza')?.value || '',
                mascotaEspecie: document.getElementById('especieEnPlantilla')?.value || '',
                mascotaSexo: document.getElementById('sexoEnPlantilla')?.value || '',
                mascotaEdad: document.getElementById('mascotaEdad')?.value || '',
                mascotaPeso: document.getElementById('mascotaPeso')?.value || '',

                propietarioNombre: document.getElementById('propietarioNombre')?.value || '',
                propietarioCedula: document.getElementById('propietarioCedula')?.value || '',
                propietarioTelefono: document.getElementById('propietarioTelefono')?.value || '',
                propietarioEmail: document.getElementById('propietarioEmail')?.value || '',
                propietarioFecha: document.getElementById('propietarioFecha')?.value || '',
                nombreMedico: document.getElementById('nombreMedico')?.value || '',

                // Datos de química clínica
                Glucosa: document.getElementById('Glucosa')?.value || '',
                Colesterol_total: document.getElementById('Colesterol_total')?.value || '',
                Trigliceridos: document.getElementById('Trigliceridos')?.value || '',

                // Datos adicionales
                ALT: document.getElementById('ALT')?.value || '',
                AST: document.getElementById('AST')?.value || '',
                Fosfatasa_Alcalina: document.getElementById('Fosfatasa_Alcalina')?.value || '',

                // Índices de interferencia
                suero_hemolitico: document.getElementById('suero_hemolitico2')?.value || 'No se observa',
                suero_lipemico: document.getElementById('suero_lipemico2')?.value || 'No se observa',
                suero_icterico: document.getElementById('suero_icterico2')?.value || 'No se observa',

                // Selectores principales
                especieSelector: document.getElementById('especieSelector')?.value || '',
                sexoSelector: document.getElementById('sexoSelector')?.value || '',
                edadSelector: document.getElementById('edadSelector')?.value || '',

                // Añadir timestamp para ordenación
                timestamp: new Date().getTime()
            };

            // Verificar si hay datos significativos para guardar
            if (!formData.mascotaNombre && !formData.propietarioNombre) {
                console.warn('No hay datos significativos para guardar.');
                return;
            }

            // Obtener historial existente
            let historial = JSON.parse(localStorage.getItem('panelPlusHistorial') || '[]');

            // Añadir el nuevo análisis al principio
            historial.unshift(formData);

            // Limitar a los 10 últimos
            historial = historial.slice(0, 10);

            // Guardar en localStorage
            localStorage.setItem('panelPlusHistorial', JSON.stringify(historial));

            // Actualizar opciones en el selector
            const selector = document.getElementById('historialSelector');
            if (selector) {
                cargarOpcionesHistorial(selector);
            }
        }
        
        // Función para cargar un análisis desde el historial
        function cargarAnalisisDesdeHistorial(index) {
            // Obtener historial
            const historial = JSON.parse(localStorage.getItem('panelPlusHistorial') || '[]');
            
            if (!historial[index]) return;
            
            const analisis = historial[index];
            
            // Cargar todos los campos con los datos guardados
            // Datos de la mascota y propietario
            document.getElementById('mascotaNombre').value = analisis.mascotaNombre || '';
            document.getElementById('mascotaRaza').value = analisis.mascotaRaza || '';
            document.getElementById('especieEnPlantilla').value = analisis.mascotaEspecie || '';
            document.getElementById('sexoEnPlantilla').value = analisis.mascotaSexo || '';
            document.getElementById('mascotaEdad').value = analisis.mascotaEdad || '';
            document.getElementById('mascotaPeso').value = analisis.mascotaPeso || '';
            
            document.getElementById('propietarioNombre').value = analisis.propietarioNombre || '';
            document.getElementById('propietarioCedula').value = analisis.propietarioCedula || '';
            document.getElementById('propietarioTelefono').value = analisis.propietarioTelefono || '';
            document.getElementById('propietarioEmail').value = analisis.propietarioEmail || '';
            document.getElementById('propietarioFecha').value = analisis.propietarioFecha || '';
            document.getElementById('nombreMedico').value = analisis.nombreMedico || '';
            
            // Datos de química clínica
            document.getElementById('Glucosa').value = analisis.Glucosa || '';
            document.getElementById('Colesterol_total').value = analisis.Colesterol_total || '';
            document.getElementById('amilasa').value = analisis.amilasa || '';
            
            // Datos de funcionamiento renal
            document.getElementById('nitrogeno_ureico').value = analisis.nitrogeno_ureico || '';
            document.getElementById('creatinina').value = analisis.creatinina || '';
            document.getElementById('urea').value = analisis.urea || '';
            document.getElementById('bun_crea').value = analisis.bun_crea || '';
            document.getElementById('fosforo').value = analisis.fosforo || '';
            document.getElementById('calcio').value = analisis.calcio || '';
            document.getElementById('sodio').value = analisis.sodio || '';
            document.getElementById('potasio').value = analisis.potasio || '';
            document.getElementById('cloro').value = analisis.cloro || '';
            document.getElementById('Na_K').value = analisis.Na_K || '';
            
            // Datos de funcionamiento hepático
            document.getElementById('ALT').value = analisis.ALT || '';
            document.getElementById('Fosfatasa_Alcalina').value = analisis.Fosfatasa_Alcalina || '';
            document.getElementById('billirrubina_total').value = analisis.billirrubina_total || '';
            
            // Datos de funcionamiento sanguíneo
            document.getElementById('Albumina').value = analisis.Albumina || '';
            document.getElementById('proteinas_totales').value = analisis.proteinas_totales || '';
            document.getElementById('Globulinas').value = analisis.Globulinas || '';
            document.getElementById('alb/glo').value = analisis.alb_glo || '';
            
            // Índices de interferencia
            document.getElementById('suero_hemolitico2').value = analisis.suero_hemolitico || 'No se observa';
            document.getElementById('suero_lipemico2').value = analisis.suero_lipemico || 'No se observa';
            document.getElementById('suero_icterico2').value = analisis.suero_icterico || 'No se observa';
            
            // Selectores principales
            if (analisis.especieSelector) {
                document.getElementById('especieSelector').value = analisis.especieSelector;
                // Disparar el evento change manualmente
                const event = new Event('change');
                document.getElementById('especieSelector').dispatchEvent(event);
            }
            
            if (analisis.sexoSelector) {
                document.getElementById('sexoSelector').value = analisis.sexoSelector;
                const event = new Event('change');
                document.getElementById('sexoSelector').dispatchEvent(event);
            }
            
            if (analisis.edadSelector) {
                document.getElementById('edadSelector').value = analisis.edadSelector;
                const event = new Event('change');
                document.getElementById('edadSelector').dispatchEvent(event);
            }
            
            // Actualizar colores y valores calculados
            calculateValues(); // Para actualizar globulinas y alb/glo
            
            // Actualizar colores para todos los campos
            const parametros = [
                { campo: 'Glucosa', ref: 'refglucosa' },
                { campo: 'Colesterol_total', ref: 'refcolesterolT' },
                { campo: 'amilasa', ref: 'refamilasa' },
                { campo: 'urea', ref: 'refurea' },
                { campo: 'nitrogeno_ureico', ref: 'refnitrogeno_ureico' },
                { campo: 'creatinina', ref: 'refcreatinina' },
                { campo: 'bun_crea', ref: 'refbun_crea' },
                { campo: 'fosforo', ref: 'reffosforo' },
                { campo: 'calcio', ref: 'refcalcio' },
                { campo: 'sodio', ref: 'refsodio' },
                { campo: 'potasio', ref: 'refpotasio' },
                { campo: 'cloro', ref: 'refcloro' },
                { campo: 'Na_K', ref: 'refNa_K' },
                { campo: 'ALT', ref: 'refALT' },
                { campo: 'Fosfatasa_Alcalina', ref: 'refFosfatasa_Alcalina' },
                { campo: 'billirrubina_total', ref: 'refbillirrubina' },
                { campo: 'Albumina', ref: 'refalbumina' },
                { campo: 'proteinas_totales', ref: 'refproteinas_totales' },
                { campo: 'Globulinas', ref: 'refglobulinas' },
                { campo: 'alb/glo', ref: 'refalb_glo' }
            ];
            
            parametros.forEach(param => {
                actualizarColor(param.campo, param.ref, {type: 'blur'});
            });
            
            // Mostrar mensaje de éxito
            alert(`Datos de ${analisis.mascotaNombre} cargados correctamente`);
        }

function moverFoco(event, siguienteId) {
    if (event.key === 'Enter') {
        event.preventDefault();
        
        // Lista completa de campos en orden de navegación
        const camposParametros = [
            'Glucosa', 
            'Colesterol_total', 
            'amilasa',
            'nitrogeno_ureico',  
            'creatinina', 
            'urea', 
            'bun_crea', 
            'fosforo', 
            'calcio', 
            'sodio', 
            'potasio', 
            'cloro', 
            'Na_K', 
            'ALT', 
            'Fosfatasa_Alcalina', 
            'billirrubina_total', 
            'Albumina', 
            'proteinas_totales', 
            'Globulinas', 
            'alb/glo'
        ];
        
        // Encontrar el índice del campo actual
        const indiceActual = camposParametros.indexOf(event.target.id);
        
        if (indiceActual !== -1 && indiceActual < camposParametros.length - 1) {
            // Mover al siguiente campo en la secuencia
            const siguienteId = camposParametros[indiceActual + 1];
            document.getElementById(siguienteId).focus();
        } else {
            // Si no está en la lista o es el último, usar el siguienteId proporcionado
            document.getElementById(siguienteId).focus();
}
    } else if (event.key === 'ArrowUp') {
        event.preventDefault();
        
        // Los mismos campos para navegación hacia arriba
        const camposParametros = [
            'Glucosa', 
            'Colesterol_total', 
            'amilasa',
            'nitrogeno_ureico',  
            'creatinina', 
            'urea', 
            'bun_crea', 
            'fosforo', 
            'calcio', 
            'sodio', 
            'potasio', 
            'cloro', 
            'Na_K', 
            'ALT', 
            'Fosfatasa_Alcalina', 
            'billirrubina_total', 
            'Albumina', 
            'proteinas_totales', 
            'Globulinas', 
            'alb/glo'
        ];
        // Encontrar el índice del campo actual
        const indiceActual = camposParametros.indexOf(event.target.id);
        
        if (indiceActual > 0) {
            // Mover al campo anterior
            const anteriorId = camposParametros[indiceActual - 1];
            document.getElementById(anteriorId).focus();
        }
    }
}
document.addEventListener('DOMContentLoaded', () => {
    cargarListaDeParametros();
    console.log("Cargando lista de parámetros..."); // Para debugear
});
// Función mejorada de redondeo que maneja correctamente los IDs de referencia
function redondearAEntero(id) {
    const input = document.getElementById(id);
    if (!input || input.value === '') return;
    
    // Eliminar flechas y obtener valor numérico
    const valorTexto = input.value.replace(/\s*[↑↓]$/, '').replace(',', '.');
    const valor = parseFloat(valorTexto);
    
    if (isNaN(valor)) return;
    
    // Si tiene decimales, redondear a entero
    if (!Number.isInteger(valor)) {
        input.value = Math.round(valor);
    }
    
    // Usar IDs de referencia específicos para cada campo
    let refId;
    switch(id) {
        case 'Colesterol_total':
            refId = 'refcolesterolT';
            break;
        case 'CK':
            refId = 'refCK';
            break;
        case 'Glucosa':
            refId = 'refglucosa';
            break;
        case 'amilasa':
            refId = 'refamilasa';
            break;
        case 'ALT':
            refId = 'refALT';
            break;
        case 'Fosfatasa_Alcalina':
            refId = 'refFosfatasa_Alcalina';
            break;
        case 'urea':
            refId = 'refurea';
            break;
        case 'nitrogeno_ureico':
            refId = 'refnitrogeno_ureico';
            break;
        case 'sodio':
            refId = 'refsodio';
            break;
        case 'cloro':
            refId = 'refcloro';
            break;
        case 'Na_K':
            refId = 'refNa_K';
            break;
        default:
            refId = 'ref' + id.toLowerCase();
    }
    
    // Aplicar color y flechas después del redondeo
    const evento = new Event('blur');
    actualizarColor(id, refId, evento);
}

// Asignar esta función a los campos que necesitan redondeo
document.addEventListener('DOMContentLoaded', function() {
    // Campos que deben redondearse a enteros
    const camposEnteros = ['Glucosa', 'Colesterol_total', 'amilasa', 'CK', 'ALT', 'Fosfatasa_Alcalina', 'urea', 'nitrogeno_ureico', 'sodio', 'cloro', 'Na_K'];
    
    camposEnteros.forEach(id => {
        const campo = document.getElementById(id);
        if (campo) {
            // Remover listeners existentes para evitar conflictos
            const nuevoInput = campo.cloneNode(true);
            campo.parentNode.replaceChild(nuevoInput, campo);
            
            // Agregar el nuevo listener
            nuevoInput.addEventListener('blur', function() {
                redondearAEntero(id);
            });
            
            // Mantener navegación con teclas
            if (campo.hasAttribute('onkeydown')) {
                const keydownValue = campo.getAttribute('onkeydown');
                nuevoInput.setAttribute('onkeydown', keydownValue);
            }
        }
    });
});
// Función para redondear a un decimal (para fósforo y calcio)
function redondearAUnDecimal(id) {
    const input = document.getElementById(id);
    if (!input || input.value === '') return;
    
    // Eliminar flechas y obtener valor numérico
    const valorTexto = input.value.replace(/\s*[↑↓]$/, '').replace(',', '.');
    const valor = parseFloat(valorTexto);
    
    if (isNaN(valor)) return;
    
    // Redondear a un decimal
    const valorRedondeado = Math.round(valor * 10) / 10;
    
    // Convertir a formato con coma decimal (español)
    input.value = valorRedondeado.toFixed(1).replace('.', ',');
    
    // Aplicar color y flechas después del redondeo
    const evento = new Event('blur');
    actualizarColor(id, 'ref' + id.toLowerCase(), evento);
}

// Asignar esta función a los campos fósforo y calcio
document.addEventListener('DOMContentLoaded', function() {
    // Campos que deben redondearse a un decimal
    const camposUnDecimal = ['fosforo', 'calcio', 'creatinina'];
    
    camposUnDecimal.forEach(id => {
        const campo = document.getElementById(id);
        if (campo) {
            // Remover listeners existentes para evitar conflictos
            const nuevoInput = campo.cloneNode(true);
            campo.parentNode.replaceChild(nuevoInput, campo);
            
            // Agregar el nuevo listener
            nuevoInput.addEventListener('blur', function() {
                redondearAUnDecimal(id);
            });
            
            // Mantener navegación con teclas
            if (campo.hasAttribute('onkeydown')) {
                const keydownValue = campo.getAttribute('onkeydown');
                nuevoInput.setAttribute('onkeydown', keydownValue);
            }
        }
    });
});
function cargarListaDeParametros() {
    const selector = document.getElementById('parameterSelector');
    if (!selector) {
        console.error("No se encontró el selector de parámetros");
        return;
    }
    
    selector.innerHTML = '<option value="" selected disabled>-- Seleccionar parámetro --</option>';
    
    // Lista de parámetros específicos que queremos mostrar
    const parametrosEspecificos = [
        "GLUCOSA", "COLESTEROL TOTAL", "AMILASA", "UREA",
        "NITROGENO UREICO", "CREATININA", "BUN_CREA", "FOSFORO", "CALCIO", "SODIO", "POTASIO", "CLORO", "NA+/K+",
        "ALT", "FOSFATASA ALCALINA", "BILLIRRUBINA TOTAL",
        "ALBUMINA", "PROTEINAS TOTALES", "GLOBULINAS TOTALES", "RELACIÓN ALBUMINA/GLOBULINAS"
    ];
    
    const tablas = document.querySelectorAll('#template1 table');
    console.log(`Encontradas ${tablas.length} tablas`); // Para debugear
    
    tablas.forEach((tabla, tablaIndex) => {
        const filas = tabla.querySelectorAll('tbody tr');
        console.log(`Tabla ${tablaIndex}: ${filas.length} filas`); // Para debugear
        
        filas.forEach((fila, filaIndex) => {
            if (!fila.cells || fila.cells.length === 0) return;
            
            // Obtener el nombre del parámetro (primera celda)
            const paramName = fila.cells[0]?.textContent.trim();
            console.log(`Fila ${filaIndex}: "${paramName}"`); // Para debugear
            
            // Solo agregar los parámetros específicos que queremos
            if (parametrosEspecificos.includes(paramName)) {
                // Crear un ID único para la fila
                const filaId = `fila-${tablaIndex}-${filaIndex}`;
                fila.id = filaId;
                
                // Añadir opción al selector
                const option = document.createElement('option');
                option.value = filaId;
                option.textContent = paramName;
                selector.appendChild(option);
            }
        });
    });
    
    console.log(`Total de opciones cargadas: ${selector.options.length - 1}`); // Para debugear
}

function eliminarParametroSeleccionado() {
    const selector = document.getElementById('parameterSelector');
    const filaId = selector.value;
    
    if (!filaId) {
        alert('Por favor, selecciona un parámetro para eliminar.');
        return;
    }
    
    const fila = document.getElementById(filaId);
    if (fila) {
        fila.remove();
        
        // Actualizar el selector después de eliminar
        cargarListaDeParametros();
    }
}
    function actualizarSexoEnPlantilla() {
        const sexo = document.getElementById('sexoSelector').value;
        document.getElementById('sexoEnPlantilla').value = sexo.charAt(0).toUpperCase() + sexo.slice(1);
    }
    function actualizarEspecieEnPlantilla() {
        const especie = document.getElementById('especieSelector').value;
        document.getElementById('especieEnPlantilla').value = especie;
    }
    function verificarMedico2() {
        const medico = document.getElementById('nombreMedico').value;
        const mensaje = document.getElementById('mensajeMedico');
        if (medico === 'N.A' || medico === '') {
            mensaje.style.display = 'none';
        } else {
            mensaje.style.display = 'block';
        }
    }
    
    </script>
    <script>
        
       document.addEventListener('DOMContentLoaded', () => {
        const templates = document.querySelectorAll('.container');
        const templateSelector = document.getElementById('templateSelector');
    
        templateSelector.addEventListener('change', () => {
            templates.forEach(template => template.style.display = 'none');
            const selectedTemplate = document.getElementById(templateSelector.value);
            if (selectedTemplate) selectedTemplate.style.display = 'block';
        });
    });
    async function generatePDF() {
    // Mostrar el indicador de carga
    const loadingIndicator = document.getElementById('loadingPdf');
    const pdfButton = document.getElementById('pdfButton');
    
    loadingIndicator.style.display = 'flex';
    pdfButton.disabled = true;
    
    try {
        console.log("Iniciando generación de PDF...");
        
        // Verificar que las bibliotecas estén cargadas
        if (!window.jspdf || !window.html2canvas) {
            throw new Error("Las bibliotecas necesarias no están cargadas correctamente");
        }
        
        const { jsPDF } = window.jspdf;
        console.log("jsPDF cargado correctamente");
        
        const selectedTemplate = document.getElementById('template1');
        if (!selectedTemplate) {
            throw new Error('No se encontró la plantilla');
        }
        
        // Obtener datos para el nombre del archivo
        const mascotaNombre = document.getElementById('mascotaNombre').value || 'Sin_nombre';
        const propietarioNombre = document.getElementById('propietarioNombre').value || 'Sin_apellido';
        const nombreArray = propietarioNombre.split(' ');
        const propietarioApellido = nombreArray.length > 1 ? nombreArray[1] : nombreArray[0];
        
        console.log("Esperando carga de imágenes...");
        // Esperar a que todas las imágenes se carguen
        const images = selectedTemplate.getElementsByTagName('img');
        const loadImages = Array.from(images).map(img => {
            return new Promise((resolve, reject) => {
                if (img.complete) {
                    resolve();
                } else {
                    img.onload = resolve;
                    img.onerror = reject;
                }
            });
        });
        
        await Promise.all(loadImages);
        console.log("Imágenes cargadas, generando canvas...");
        
        // Generar canvas con opciones óptimas
        const canvas = await html2canvas(selectedTemplate, {
            scale: 2,
            useCORS: true,
            logging: false,
            allowTaint: true,
            backgroundColor: '#ffffff'
        });

        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 140; 
        const pageHeight = 297;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        // Calcular la posición para centrar la imagen con márgenes
        const x = (pdf.internal.pageSize.getWidth() - imgWidth) / 2;
        const y = 5;

        // Agrega la imagen de la plantilla escalada y centrada
        pdf.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight);
        
        console.log("Canvas generado, creando PDF...");
        
        // Nombre del archivo
        const fileName = `Panel Plus ${mascotaNombre} ${propietarioApellido}.pdf`;
        console.log("Guardando como:", fileName);
        
        // Método simplificado - usar el método tradicional que funciona en todos los navegadores
        pdf.save(fileName);
        console.log("PDF guardado exitosamente");
        
    } catch (error) {
        console.error('Error detallado al generar el PDF:', error);
        alert('Error al generar el PDF: ' + error.message);
    } finally {
        // Ocultar indicador y habilitar botón
        loadingIndicator.style.display = 'none';
        pdfButton.disabled = false;
    }
}

// Agregar la función formatearDecimal si aún no existe
function formatearDecimal(id) {
    const input = document.getElementById(id);
    if (!input || input.value === '') return;
    
    // Eliminar flechas y obtener valor numérico
    const valorTexto = input.value.replace(/\s*[↑↓]$/, '').replace(',', '.');
    const valor = parseFloat(valorTexto);
    
    if (isNaN(valor)) return;
    
    // Determinar el número de decimales según el campo
    let decimales = 1; // Por defecto, un decimal
    
    // Algunos campos podrían requerir diferente cantidad de decimales
    if (['billirrubina_total', 'creatinina', 'Albumina'].includes(id)) {
        decimales = 1; // 1 decimal para estos campos
    } else if (['fosforo', 'calcio', 'potasio'].includes(id)) {
        decimales = 1; // 1 decimal para estos campos
    } else if (['ALT', 'Fosfatasa_Alcalina', 'amilasa', 'nitrogeno_ureico', 'urea'].includes(id)) {
        decimales = 0; // Sin decimales para estos campos (enteros)
    }
    
    // Formatear con el número adecuado de decimales y usar coma como separador
    input.value = valor.toFixed(decimales).replace('.', ',');
    
    // Actualizar color basado en referencia
    // Determinar qué ID de referencia usar
    let refId;
    switch(id) {
        case 'Colesterol_total':
            refId = 'refcolesterolT';
            break;
        case 'billirrubina_total':
            refId = 'refbillirrubina';
            break;
        case 'Fosfatasa_Alcalina':
            refId = 'refFosfatasa_Alcalina';
            break;
        case 'alb/glo':
            refId = 'refalb_glo';
            break;
        case 'Na_K':
            refId = 'refNa_K';
            break;
        default:
            refId = 'ref' + id.toLowerCase();
    }
    
    actualizarColor(id, refId);
    
    // Si es uno de los campos que afecta al cálculo BUN/CREA, recalcular
    if (id === 'nitrogeno_ureico' || id === 'creatinina') {
        calculateBunCreatinine();
    }
}

// Reemplazar la función calculateBunCreatinine por esta versión mejorada
function calculateBunCreatinine() {
    const nitroInput = document.getElementById('nitrogeno_ureico');
    const creaInput = document.getElementById('creatinina');
    const bunCreaInput = document.getElementById('bun_crea');
    const refElement = document.getElementById('refbun_crea');

    // Verificar que los elementos existan
    if (!nitroInput || !creaInput || !bunCreaInput || !refElement) {
        console.error("Elementos necesarios para el cálculo BUN/CREA no encontrados");
        return;
    }

    // Obtener y limpiar los valores
    let nitroValue = nitroInput.value.trim().replace(/\s*[↑↓]$/, '').replace(',', '.');
    let creaValue = creaInput.value.trim().replace(/\s*[↑↓]$/, '').replace(',', '.');

    const nitroNum = parseFloat(nitroValue);
    const creaNum = parseFloat(creaValue);

    // Si no hay números válidos o creatinina es cero/negativa
    if (isNaN(nitroNum) || isNaN(creaNum) || creaNum <= 0) {
        bunCreaInput.value = "";
        return;
    }

    // Calcular la relación
    const ratio = nitroNum / creaNum;
    
    // Obtener rango de referencia
    const rangoTexto = refElement.textContent.trim();
    const match = rangoTexto.match(/([\d,.]+)\s*-\s*([\d,.]+)/);
    
    if (match) {
        const min = parseFloat(match[1].replace(',', '.'));
        const max = parseFloat(match[2].replace(',', '.'));
        
        // Formatear con un decimal y coma
        let ratioFormatted = ratio.toFixed(1).replace('.', ',');
        
        // Aplicar estilo y añadir flecha según el valor
        if (ratio < min) {
            bunCreaInput.style.color = '#0096d2'; // Azul para valores bajos
            ratioFormatted += ' ↓';
        } else if (ratio > max) {
            bunCreaInput.style.color = 'red'; // Rojo para valores altos
            ratioFormatted += ' ↑';
        } else {
            bunCreaInput.style.color = 'black'; // Negro para valores normales
        }
        
        // Mostrar el resultado
        bunCreaInput.value = ratioFormatted;
    } else {
        // Si no se pudo determinar el rango, mostrar sin indicadores
        bunCreaInput.value = ratio.toFixed(1).replace('.', ',');
        bunCreaInput.style.color = 'black';
    }
}

// Configurar los listeners para el cálculo automático de BUN/CREA
document.addEventListener('DOMContentLoaded', function() {
    // ...existing code...
    
    // Configurar event listeners para BUN/CREA
    const nitro = document.getElementById('nitrogeno_ureico');
    const crea = document.getElementById('creatinina');
    
    if (nitro) {
        nitro.addEventListener('input', calculateBunCreatinine);
        nitro.addEventListener('blur', function() {
            if (typeof formatearDecimal === 'function') {
                formatearDecimal('nitrogeno_ureico');
            }
            calculateBunCreatinine();
        });
    }
    
    if (crea) {
        crea.addEventListener('input', calculateBunCreatinine);
        crea.addEventListener('blur', function() {
            if (typeof formatearDecimal === 'function') {
                formatearDecimal('creatinina');
            }
            calculateBunCreatinine();
        });
    }
    
    // Ejecutar cálculo inicial después de cargar la página
    setTimeout(calculateBunCreatinine, 500);
});

// Modificar la función cargarAnalisisDesdeHistorial para recalcular BUN/CREA
function cargarAnalisisDesdeHistorial(index) {
    // ...existing code...
    
    // Recalcular BUN/CREA en lugar de usar el valor guardado
    setTimeout(function() {
        calculateBunCreatinine();
        if (typeof calculateValues === 'function') {
            calculateValues(); // Para calcular globulinas y alb/glo
        }
    }, 200);
}

    </script>
    </body>
    </html>
