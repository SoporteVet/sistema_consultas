<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electrolitos - Laboratorio Veterinario</title>
    <link rel="stylesheet" href="index_lab.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=ABeeZee:ital@0;1&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=League+Spartan:wght@100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">

    <style>
        /* Estilos para el panel de eliminación de parámetros */
        .parameter-selector-panel {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .parameter-selector-panel h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }

        .selector-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .parameter-dropdown {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .remove-param-btn {
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .remove-param-btn:hover {
            background: #c82333;
        }

        .remove-param-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        /* Estilos para colores de valores */
        .valor-bajo {
            color: #0096d2 !important;
            font-weight: bold;
        }

        .valor-alto {
            color: red !important;
            font-weight: bold;
        }

        .valor-normal {
            color: black !important;
            font-weight: bold;
        }
    </style>
</head>

<body>
<script>
// Autollenado desde parámetros URL
document.addEventListener('DOMContentLoaded', function(){
  try {
    const p = new URLSearchParams(location.search);
    const setVal = (id, v) => { const el = document.getElementById(id); if (el && v!=null && v!=='') el.value = v; };
    setVal('mascotaNombre', p.get('mascotaNombre'));
    setVal('propietarioNombre', p.get('propietarioNombre'));
    setVal('propietarioCedula', p.get('propietarioCedula'));
    setVal('propietarioTelefono', p.get('propietarioTelefono'));
    setVal('propietarioEmail', p.get('propietarioEmail'));
    setVal('nombreMedico', p.get('nombreMedico'));
    setVal('mascotaRaza', p.get('mascotaRaza'));
    setVal('mascotaEdad', p.get('mascotaEdad'));
    setVal('mascotaPeso', p.get('mascotaPeso'));
    
    // Verificar el mensaje del médico después del autollenado
    const medico = p.get('nombreMedico');
    if (medico) {
      setTimeout(() => {
        verificarMedico();
      }, 100);
    }
    
    const especie = p.get('especie');
    const sexo = p.get('mascotaSexo');
    if (especie) {
      const especieSelector = document.getElementById('especieSelector');
      if (especieSelector) {
        especieSelector.value = capitalize(especie);
        const evt = new Event('change'); especieSelector.dispatchEvent(evt);
      }
    }
    if (sexo) {
      const sexoSelector = document.getElementById('sexoSelector');
      if (sexoSelector) {
        sexoSelector.value = capitalize(sexo);
        const evt = new Event('change'); sexoSelector.dispatchEvent(evt);
      }
    }
  } catch(e) { console.warn('Autollenado electrolitos falló:', e); }
  function capitalize(s){ if(!s) return s; return s.charAt(0).toUpperCase()+s.slice(1).toLowerCase(); }
});
</script>

    <div class="controls">
        <label for="sexoSelector">Selecciona el sexo:</label>
        <select id="sexoSelector" onchange="actualizarSexoEnPlantilla(),actualizarValoresReferencia()">
            <option value="Seleccionar" selected>-- Seleccionar --</option>
            <option value="Macho">Macho</option>
            <option value="Hembra">Hembra</option>
        </select>
        <label for="especieSelector">Selecciona la especie:</label>
        <select id="especieSelector" onchange="actualizarEspecieEnPlantilla(),actualizarValoresReferencia()">
            <option value="Seleccionar" selected>-- Seleccionar --</option>
            <option value="Canino">Canino</option>
            <option value="Felino">Felino</option>
            <option value="Lagomorfo">Lagomorfo</option>
            <option value="Cuilo">Cuilo</option>
        </select>
        <label for="edadSelector">Selecciona el rango de edad:</label>
        <select id="edadSelector" onchange="actualizarValoresReferencia()">
            <option value="Seleccionar" selected>-- Seleccionar --</option>
            <option value="De 1 año a 12 años">De 1 año a 20 años</option>
            <option value="De 6 meses a 1 año">De 6 meses a 1 año</option>
            <option value="De mes y medio a 5 meses">De mes y medio a 5 meses</option>
            <option value="Menor de mes y medio">Menor de mes y medio</option>
            <option value="Todas las edades">Todas las edades</option>
        </select>
    </div>

    <!-- Panel para eliminar parámetros -->
    <div class="parameter-selector-panel">
        <h3>Eliminar parámetros</h3>
        <div class="selector-container">
            <select id="parameterSelector" class="parameter-dropdown">
                <option value="" selected disabled>-- Seleccionar parámetro --</option>
            </select>
            <button onclick="eliminarParametroSeleccionado()" class="remove-param-btn">Eliminar</button>
        </div>
    </div>

<div class="container" id="template1" style="display: block;">
    <div class="header">
        <img src="empresa.jpg" alt="Logo de la Empresa" class="small-image">
        <h1>Laboratorio Clínico Veterinario</h1>
    </div>
    <h3 class="subheader">ELECTROLITOS</h3>
        <table>
            <thead>
                <tr>
                    <th colspan="2">DATOS DE LA MASCOTA</th>
                    <th colspan="2">DATOS DEL PROPIETARIO</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Nombre</td>
                    <td><input type="text" id="mascotaNombre" onkeydown="moverFocoConFlechas(event, 'propietarioNombre', 'propietarioNombre', 'mascotaNombre', 'mascotaRaza')"></td>
                    <td>Nombre</td>
                    <td><input type="text" id="propietarioNombre" onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaNombre', 'mascotaNombre', 'propietarioCedula')"></td>
                </tr>
                <tr>
                    <td>Raza</td>
                    <td><input type="text" id="mascotaRaza" list="razas" onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaNombre', 'mascotaNombre', 'mascotaSexo')"></td>
                    <datalist id="razas"></datalist>
                    <td>Cédula</td>
                    <td><input type="text" id="propietarioCedula" onkeydown="moverFocoConFlechas(event, 'propietarioTelefono', 'mascotaRaza', 'propietarioNombre', 'propietarioTelefono')"></td>
                </tr>
                <tr>
                    <td>Sexo</td>
                    <td><input type="text" id="sexoEnPlantilla"></td>
                    <td>Teléfono</td>
                    <td><input type="text" id="propietarioTelefono" onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaSexo', 'propietarioCedula', 'propietarioEmail')"></td>
                </tr>
                <tr>
                    <td>Especie</td>
                    <td><input type="text" id="especieEnPlantilla"></td>
                    <td>Email</td>
                    <td><input type="text" id="propietarioEmail" onkeydown="moverFocoConFlechas(event, 'mascotaEspecie', 'mascotaEspecie', 'propietarioTelefono', 'nombreMedico')"></td>
                </tr>
                <tr>
                    <td>Edad</td>
                    <td><input type="text" id="mascotaEdad" list="edades" onkeydown="moverFocoConFlechas(event, 'nombreMedico', 'mascotaEspecie', 'mascotaEspecie', 'mascotaPeso')"></td>
                    <datalist id="edades">
                        <option value="1 mes"><option value="2 meses"><option value="3 meses"><option value="4 meses">
                        <option value="5 meses"><option value="6 meses"><option value="7 meses"><option value="8 meses"><option value="9 meses">
                        <option value="10 meses"><option value="11 meses"><option value="12 meses">
                        <option value="1 año"><option value="2 años"><option value="3 años"><option value="4 años">
                        <option value="5 años"><option value="6 años"><option value="7 años"><option value="8 años"><option value="9 años">
                        <option value="10 años"><option value="11 años"><option value="12 años"><option value="13 años"><option value="14 años">
                        <option value="15 años"><option value="16 años"><option value="17 años"><option value="18 años">
                        <option value="19 años"><option value="20 años">    
                    </datalist>
                    <td>Médico</td>
                    <td>
                        <input type="text" id="nombreMedico" list="medicos" 
                            onkeydown="moverFocoConFlechas(event, 'propietarioFecha', 'mascotaEdad', 'propietarioEmail', 'propietarioFecha')" 
                            oninput="verificarMedico()">
                    </td>
                    <datalist id="medicos">
                        <option value="N.A">
                        <option value="Dr. Randall Azofeifa">
                        <option value="Dr. Luis Coto">
                        <option value="Dr. Gustavo Gónzalez">
                        <option value="Dra. Daniela Sancho">
                        <option value="Dra. Sofia Carrillo">
                        <option value="Dra. Franciny Nuñez">
                        <option value="Dra. Lourdes Chacón">
                        <option value="Dra. Alejandra León">
                        <option value="Dra. Karla Quesada">
                        <option value="Dra. Kharen Moreno">
                        <option value="Dra. Karina Madrigal">
                        <option value="Dra. Natalia Alvarado">
                    </datalist>
                </tr>
                <tr>
                    <script>    
                        function actualizarSexoEnPlantilla() {
                            const sexo = document.getElementById('sexoSelector').value;
                            document.getElementById('sexoEnPlantilla').value = sexo.charAt(0).toUpperCase() + sexo.slice(1);
                        }
                        function actualizarEspecieEnPlantilla() {
                            const especie = document.getElementById('especieSelector').value;
                            document.getElementById('especieEnPlantilla').value = especie;
                            actualizarRazasPorEspecie();
                        }
                        function verificarMedico() {
                            const medico = document.getElementById('nombreMedico').value;
                            const mensaje = document.getElementById('mensajeMedico');
                            if (medico === 'N.A' || medico === 'NA' || medico === '' || medico === 'N.A.' || medico.toLowerCase() === 'na') {
                                mensaje.style.display = 'none';
                            } else {
                                mensaje.style.display = 'block';
                            }
                        }
                    </script>
                </tr>
                <tr>
                    <td>Peso</td>
                    <td><input type="text" id="mascotaPeso" list="pesos" onkeydown="moverFocoConFlechas(event, 'propietarioFecha', 'mascotaEdad', 'mascotaEdad', 'mascotaPeso')"></td>
                    <datalist id="pesos">
                        <option value="N.A">N.A</option><option value="0,1 kg">0,1 kg</option><option value="0,2 kg">0,2 kg</option><option value="0,3 kg">0,3 kg</option><option value="0,4 kg">0,4 kg</option>
                        <option value="0,5 kg">0,5 kg</option><option value="0,6 kg">0,6 kg</option><option value="0,7 kg">0,7 kg</option><option value="0,8 kg">0,8 kg</option><option value="0,9 kg">0,9 kg</option>
                        <option value="1,0 kg">1,0 kg</option><option value="1,5 kg">1,5 kg</option><option value="2,0 kg">2,0 kg</option><option value="2,5 kg">2,5 kg</option>
                        <option value="3,0 kg">3,0 kg</option><option value="3,5 kg">3,5 kg</option><option value="4,0 kg">4,0 kg</option><option value="4,5 kg">4,5 kg</option>
                        <option value="5,0 kg">5,0 kg</option><option value="5,5 kg">5,5 kg</option><option value="6,0 kg">6,0 kg</option><option value="6,5 kg">6,5 kg</option>
                        <option value="7,0 kg">7,0 kg</option><option value="7,5 kg">7,5 kg</option><option value="8,0 kg">8,0 kg</option><option value="8,5 kg">8,5 kg</option>
                        <option value="9,0 kg">9,0 kg</option><option value="9,5 kg">9,5 kg</option><option value="10,0 kg">10,0 kg</option><option value="10,5 kg">10,5 kg</option>
                        <option value="11,0 kg">11,0 kg</option><option value="11,5 kg">11,5 kg</option><option value="12,0 kg">12,0 kg</option>
                    </datalist>
                    <td>Fecha</td>
                    <td><input type="date" id="propietarioFecha" class="date-input" onkeydown="moverFocoConFlechas(event, 'nombreMedico', 'mascotaPeso', 'nombreMedico', 'propietarioFecha')"></td>
                </tr>
                
                <script>
                function moverFocoConFlechas(event, derechaId, izquierdaId, arribaId, abajoId) {
                    switch (event.key) {
                        case 'ArrowRight':
                            event.preventDefault();
                            document.getElementById(derechaId).focus();
                            break;
                        case 'ArrowLeft':
                            event.preventDefault();
                            document.getElementById(izquierdaId).focus();
                            break;
                        case 'ArrowUp':
                            event.preventDefault();
                            document.getElementById(arribaId).focus();
                            break;
                        case 'Enter':
                        case 'ArrowDown':
                            event.preventDefault();
                            document.getElementById(abajoId).focus();
                            break;
                    }
                }

                const razasCaninas = [
                    "Ainu", "Airedale terrier", "Akita", "Akita Inu", "Alaskan Malamute",
                    "American Black and Tan Coonhound", "American Bull Terrier", "American Pit Bull Terrier",
                    "American Staffordshire terrier", "American Water Spaniel", "Apso Tibetano", "Barzoi", 
                    "Basenji", "Basset Hound", "Beagle", "Bichon Frise", "Bloodhound", "Bobtail", 
                    "Border Collie", "Boston Terrier", "Bouvier des Flandres", "Boxer", "Bull terrier", 
                    "Bull Terrier Miniatura", "Bulldog Americano", "Bulldog Francés", "Bulldog Inglés", 
                    "Bullmastiff", "Cavalier King Charles Spaniel", "Chihuahua", "Chow Chow", 
                    "Cocker Spaniel Americano", "Cocker Spaniel Inglés", "Collie", "Collie Escocés", 
                    "Dachshund", "Dálmata", "Doberman", "Doberman Pincher", "Dogo Alemán", 
                    "Dogo Argentino", "Dogo de Burdeos", "French Poodle", "Galgo Español", 
                    "Galgo Inglés-español", "Golden Retriever", "Gran Danés", "Greyhound", 
                    "Husky Siberiano", "Jack Russell Terrier", "Labrador Retriever", "Maltés", 
                    "Pastor Alemán", "Pequinés", "Pomerania", "Pug", "Rottweiler", "Samoyedo", 
                    "San Bernardo", "Schnauzer", "Shih Tzu", "SRD", "Yorkshire Terrier", "Weimaraner", "Fila Brasileiro"
                ];

                const razasFelinas = [
                    "Abisinio", "American Bobtail", "Angora Turco", "Azul Ruso", "Balinés", 
                    "Bengalí", "Bobtail japonés", "Bombay", "British Shorthair", "Burmés", 
                    "Carey", "Común Europeo", "Exótico", "Himalayo", "Javanés", 
                    "Oriental", "Persa", "Sagrado de Birmania", "Siamés", "Siberiano", 
                    "Silvestre", "SRD"
                ];

                function actualizarRazasPorEspecie() {
                    const especie = document.getElementById('especieSelector').value;
                    let datalistRazas = document.getElementById('razas');
                    if (!datalistRazas) {
                        datalistRazas = document.createElement('datalist');
                        datalistRazas.id = 'razas';
                        document.body.appendChild(datalistRazas);
                    } else {
                        datalistRazas.innerHTML = '';
                    }
                    
                    const campoRaza = document.getElementById('mascotaRaza');
                    
                    if (campoRaza.value && campoRaza.value !== "SRD") {
                        campoRaza.value = '';
                    }
                    
                    if (especie === "Canino") {
                        razasCaninas.forEach(raza => {
                            const option = document.createElement('option');
                            option.value = raza;
                            datalistRazas.appendChild(option);
                        });
                    } else if (especie === "Felino") {
                        razasFelinas.forEach(raza => {
                            const option = document.createElement('option');
                            option.value = raza;
                            datalistRazas.appendChild(option);
                        });
                    } else if (especie === "Lagomorfo" || especie === "Cuilo") {
                        const option = document.createElement('option');
                        option.value = "SRD";
                        datalistRazas.appendChild(option);
                    }
                }

                document.addEventListener('DOMContentLoaded', function() {
                    const especieSelector = document.getElementById('especieSelector');
                    if (especieSelector) {
                        if (especieSelector.value !== "Seleccionar") {
                            actualizarRazasPorEspecie();
                        }
                        especieSelector.addEventListener('change', actualizarRazasPorEspecie);
                    }
                    
                    if (!document.getElementById('razas')) {
                        const datalist = document.createElement('datalist');
                        datalist.id = 'razas';
                        document.body.appendChild(datalist);
                    }
                });
                </script>
            </tbody>
        </table>

        <h3 class="titulos">ELECTROLITOS</h3>
        <table>
            <thead>
                <tr>
                    <th>PARÁMETRO</th>
                    <th>RESULTADO</th>
                    <th>VALOR DE REFERENCIA</th>
                    <th>UNIDADES</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>FÓSFORO (P)</td>
                    <td><input type="text" id="fosforo" oninput="actualizarColor('fosforo', 'refFosforo')" onblur="formatearDecimal('fosforo')" onkeydown="moverFoco(event, 'calcio')"></td>
                    <td id="refFosforo">2,5 - 6,8</td>
                    <td>mg/dL</td>
                </tr>
                <tr>
                    <td>CALCIO (Ca)</td>
                    <td><input type="text" id="calcio" oninput="actualizarColor('calcio', 'refCalcio')" onblur="formatearDecimal('calcio')" onkeydown="moverFoco(event, 'magnesio')"></td>
                    <td id="refCalcio">9,0 - 11,3</td>
                    <td>mg/dL</td>
                </tr>
                <tr>
                    <td>MAGNESIO (Mg)</td>
                    <td><input type="text" id="magnesio" oninput="actualizarColor('magnesio', 'refMagnesio')" onblur="formatearDecimal('magnesio')" onkeydown="moverFoco(event, 'sodio')"></td>
                    <td id="refMagnesio">1,8 - 2,4</td>
                    <td>mg/dL</td>
                </tr>
                <tr>
                    <td>SODIO (Na)</td>
                    <td><input type="text" id="sodio" oninput="actualizarColor('sodio', 'refSodio');calcularNaK()" onblur="formatearDecimal('sodio')" onkeydown="moverFoco(event, 'potasio')"></td>
                    <td id="refSodio">144 - 160</td>
                    <td>mmol/L</td>
                </tr>
                <tr>
                    <td>POTASIO (K)</td>
                    <td><input type="text" id="potasio" oninput="actualizarColor('potasio', 'refPotasio');calcularNaK()" onblur="formatearDecimal('potasio')" onkeydown="moverFoco(event, 'cloro')"></td>
                    <td id="refPotasio">3,5 - 5,8</td>
                    <td>mmol/L</td>
                </tr>
                <tr>
                    <td>CLORO (Cl)</td>
                    <td><input type="text" id="cloro" oninput="actualizarColor('cloro', 'refCloro')" onblur="formatearDecimal('cloro')" onkeydown="moverFoco(event, 'dioxido')"></td>
                    <td id="refCloro">109 - 122</td>
                    <td>mmol/L</td>
                </tr>
                <tr>
                    <td>Dióxido de Carbono</td>
                    <td><input type="text" id="dioxido" oninput="actualizarColor('dioxido', 'refDioxido')" onblur="formatearDecimal('dioxido')" onkeydown="moverFoco(event, 'na_k')"></td>
                    <td id="refDioxido">17 - 24</td>
                    <td>mmol/L</td>
                </tr>
                <tr>
                    <td>NA+/K+</td>
                    <td><input type="text" id="na_k" oninput="actualizarColor('na_k', 'refNaK')" onblur="formatearDecimal('na_k')" title="Se calcula automáticamente: Na / K"></td>
                    <td id="refNaK">27 - 38</td>
                    <td></td>
                </tr>
            </tbody>
        </table>

        <script>
            const valoresReferencia = {
                Canino: {
                    Macho: {
                        "De 1 año a 20 años": {
                            Fosforo: "3,3 - 5,7",
                            Calcio: "9,1 - 10,8",
                            Magnesio: "1,8 - 3,0",
                            Sodio: "140 - 161",
                            Potasio: "4,4 - 5,7",
                            Cloro: "105 - 125",
                            Dioxido: "12 - 28",
                            NaK: "27 - 38"
                        },
                        "De 6 meses a 1 año": {
                            Fosforo: "4,8 - 9,0",
                            Calcio: "9,2 - 13,0",
                            Magnesio: "1,8 - 3,0",
                            Sodio: "137 - 163",
                            Potasio: "4,2 - 5,7",
                            Cloro: "105 - 125",
                            Dioxido: "12 - 28",
                            NaK: "27 - 38"
                        },
                        "De mes y medio a 5 meses": {
                            Fosforo: "7,2 - 10,1",
                            Calcio: "9,8 - 12,4",
                            Magnesio: "1,8 - 3,0",
                            Sodio: "144 - 160",
                            Potasio: "4,8 - 6,2",
                            Cloro: "105 - 125",
                            Dioxido: "12 - 28",
                            NaK: "27 - 38"
                        },
                        "Menor de mes y medio": {
                            Fosforo: "7,5 - 10,1",
                            Calcio: "9,8 - 12,4",
                            Magnesio: "1,6 - 2,6",
                            Sodio: "142 - 157",
                            Potasio: "4,8 - 5,8",
                            Cloro: "105 - 125",
                            Dioxido: "12 - 28",
                            NaK: "27 - 38"
                        }
                    },
                    Hembra: {
                        "De 1 año a 20 años": {
                            Fosforo: "3,3 - 6,4",
                            Calcio: "9,0 - 11,4",
                            Magnesio: "1,8 - 3,0",
                            Sodio: "139 - 164",
                            Potasio: "4,4 - 6,1",
                            Cloro: "105 - 125",
                            Dioxido: "12 - 28",
                            NaK: "27 - 38"
                        },
                        "De 6 meses a 1 año": {
                            Fosforo: "4,9 - 8,3",
                            Calcio: "8,5 - 10,3",
                            Magnesio: "1,9 - 2,28",
                            Sodio: "147 - 163",
                            Potasio: "4,1 - 5,6",
                            Cloro: "114 - 126",
                            Dioxido: "20 - 25",
                            NaK: "32 - 41"
                        },
                        "De mes y medio a 5 meses": {
                            Fosforo: "7,5 - 10,0",
                            Calcio: "10,1 - 12,3",
                            Magnesio: "1,8 - 3,0",
                            Sodio: "138 - 156",
                            Potasio: "4,3 - 5,9",
                            Cloro: "105 - 125",
                            Dioxido: "12 - 28",
                            NaK: "27 - 38"
                        },
                        "Menor de mes y medio": {
                            Fosforo: "7,5 - 10,7",
                            Calcio: "9,9 - 12,0",
                            Magnesio: "1,8 - 3,0",
                            Sodio: "144 - 159",
                            Potasio: "4,7 - 6,0",
                            Cloro: "105 - 125",
                            Dioxido: "12 - 28",
                            NaK: "27 - 38"
                        }
                    }
                },
                Felino: {
                    Macho: {
                        "De 1 año a 20 años": {
                            Fosforo: "4,1 - 6,4",
                            Calcio: "8,3 - 10,4",
                            Magnesio: "1,9 - 2,28",
                            Sodio: "149 - 163",
                            Potasio: "4,1 - 5,4",
                            Cloro: "114 - 126",
                            Dioxido: "20 - 25",
                            NaK: "32 - 41"
                        },
                        "De 6 meses a 1 año": {
                            Fosforo: "6,2 - 9,1",
                            Calcio: "8,9 - 10,1",
                            Magnesio: "1,9 - 2,28",
                            Sodio: "152 - 162",
                            Potasio: "4,1 - 5,7",
                            Cloro: "114 - 126",
                            Dioxido: "20 - 25",
                            NaK: "32 - 41"
                        },
                        "De mes y medio a 5 meses": {
                            Fosforo: "7,1 - 9,5",
                            Calcio: "9,1 - 10,9",
                            Magnesio: "1,9 - 2,28",
                            Sodio: "143 - 159",
                            Potasio: "4,4 - 5,9",
                            Cloro: "114 - 126",
                            Dioxido: "20 - 25",
                            NaK: "32 - 41"
                        }
                    },
                    Hembra: {
                        "De 1 año a 20 años": {
                            Fosforo: "3,2 - 6,6",
                            Calcio: "7,8 - 9,2",
                            Magnesio: "1,9 - 2,28",
                            Sodio: "147 - 163",
                            Potasio: "4,0 - 5,0",
                            Cloro: "114 - 126",
                            Dioxido: "20 - 25",
                            NaK: "32 - 41"
                        },
                        "De 6 meses a 1 año": {
                            Fosforo: "4,9 - 8,3",
                            Calcio: "8,5 - 10,3",
                            Magnesio: "1,9 - 2,28",
                            Sodio: "147 - 163",
                            Potasio: "4,1 - 5,6",
                            Cloro: "114 - 126",
                            Dioxido: "20 - 25",
                            NaK: "32 - 41"
                        },
                        "De mes y medio a 5 meses": {
                            Fosforo: "6,9 - 9,5",
                            Calcio: "8,9 - 10,9",
                            Magnesio: "1,9 - 2,28",
                            Sodio: "144 - 162",
                            Potasio: "4,1 - 5,5",
                            Cloro: "114 - 126",
                            Dioxido: "20 - 25",
                            NaK: "32 - 41"
                        }
                    }
                },
                Lagomorfo: {
                    Macho: {
                        "Todas las edades": {
                            Fosforo: "4,5 - 6,8",
                            Calcio: "7,8 - 10,5",
                            Magnesio: "1,8 - 2,4",
                            Sodio: "144 - 160",
                            Potasio: "3,5 - 5,8",
                            Cloro: "105 - 125",
                            Dioxido: "17 - 24",
                            NaK: "25 - 35"
                        }
                    },
                    Hembra: {
                        "Todas las edades": {
                            Fosforo: "4,5 - 6,8",
                            Calcio: "7,8 - 10,5",
                            Magnesio: "1,8 - 2,4",
                            Sodio: "144 - 160",
                            Potasio: "3,5 - 5,8",
                            Cloro: "105 - 125",
                            Dioxido: "17 - 24",
                            NaK: "25 - 35"
                        }
                    }
                },
                Cuilo: {
                    Macho: {
                        "Todas las edades": {
                            Fosforo: "4,5 - 6,8",
                            Calcio: "7,8 - 10,5",
                            Magnesio: "1,8 - 2,4",
                            Sodio: "144 - 160",
                            Potasio: "3,5 - 5,8",
                            Cloro: "105 - 125",
                            Dioxido: "17 - 24",
                            NaK: "25 - 35"
                        }
                    },
                    Hembra: {
                        "Todas las edades": {
                            Fosforo: "4,5 - 6,8",
                            Calcio: "7,8 - 10,5",
                            Magnesio: "1,8 - 2,4",
                            Sodio: "144 - 160",
                            Potasio: "3,5 - 5,8",
                            Cloro: "105 - 125",
                            Dioxido: "17 - 24",
                            NaK: "25 - 35"
                        }
                    }
                }
            };

            function actualizarValoresReferencia() {
                const especie = document.getElementById('especieSelector').value;
                const sexo = document.getElementById('sexoSelector').value;
                const edad = document.getElementById('edadSelector').value;

                if (especie !== "Seleccionar" && sexo !== "Seleccionar" && edad !== "Seleccionar") {
                    const refValores = valoresReferencia[especie][sexo][edad];
                    
                    document.getElementById('refSodio').innerText = refValores.Sodio || '';
                    document.getElementById('refPotasio').innerText = refValores.Potasio || '';
                    document.getElementById('refCloro').innerText = refValores.Cloro || '';
                    document.getElementById('refCalcio').innerText = refValores.Calcio || '';
                    document.getElementById('refFosforo').innerText = refValores.Fosforo || '';
                    document.getElementById('refMagnesio').innerText = refValores.Magnesio || '';
                    document.getElementById('refDioxido').innerText = refValores.Dioxido || '';
                    document.getElementById('refNaK').innerText = refValores.NaK || '';
                    
                    // Actualizar colores si hay valores
                    if (document.getElementById('sodio').value) actualizarColor('sodio', 'refSodio');
                    if (document.getElementById('potasio').value) actualizarColor('potasio', 'refPotasio');
                    if (document.getElementById('cloro').value) actualizarColor('cloro', 'refCloro');
                    if (document.getElementById('calcio').value) actualizarColor('calcio', 'refCalcio');
                    if (document.getElementById('fosforo').value) actualizarColor('fosforo', 'refFosforo');
                    if (document.getElementById('magnesio').value) actualizarColor('magnesio', 'refMagnesio');
                    if (document.getElementById('dioxido').value) actualizarColor('dioxido', 'refDioxido');
                }
            }

            function actualizarColor(inputId, refId) {
                const inputElement = document.getElementById(inputId);
                const refElement = document.getElementById(refId);
                
                if (!inputElement || !refElement) return;
                
                // Limpiar clases anteriores
                inputElement.classList.remove('valor-bajo', 'valor-alto', 'valor-normal');
                
                // Obtener el valor actual
                const valorTexto = inputElement.value.trim().replace(',', '.');
                
                if (!valorTexto) {
                    inputElement.style.color = 'black';
                    inputElement.style.fontWeight = 'normal';
                    return;
                }
                
                const valor = parseFloat(valorTexto);
                
                if (isNaN(valor)) return;
                
                inputElement.style.fontWeight = 'bold';
                
                // Obtener rango de referencia
                const rangoTexto = refElement.textContent;
                const coincidencia = rangoTexto.match(/([\d,.]+)\s*-\s*([\d,.]+)/);
                
                if (coincidencia) {
                    const min = parseFloat(coincidencia[1].replace(',', '.'));
                    const max = parseFloat(coincidencia[2].replace(',', '.'));
                    
                    if (valor < min) {
                        inputElement.classList.add('valor-bajo');
                    } else if (valor > max) {
                        inputElement.classList.add('valor-alto');
                    } else {
                        inputElement.classList.add('valor-normal');
                    }
                }
            }

            function formatearDecimal(id) {
                var input = document.getElementById(id);
                if (input.value === '') return;
                var valor = parseFloat(input.value.replace(',', '.')) || 0;
                input.value = valor.toFixed(1).replace('.', ',');
            }

            function moverFoco(event, siguienteId) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    document.getElementById(siguienteId).focus();
                }
            }
            function calcularNaK() {
                const naEl = document.getElementById('sodio');
                const kEl = document.getElementById('potasio');
                const ratioEl = document.getElementById('na_k');
                if (!naEl || !kEl || !ratioEl) return;
                
                // Solo calcular automáticamente si el campo está vacío
                const na = parseFloat((naEl.value || '').replace(',', '.'));
                const k = parseFloat((kEl.value || '').replace(',', '.'));
                if (!isNaN(na) && !isNaN(k) && k > 0) {
                    const r = na / k;
                    const nuevoValor = r.toFixed(1).replace('.', ',');
                    
                    // Solo actualizar si el campo está vacío (para permitir edición manual)
                    if (!ratioEl.value || ratioEl.value === '') {
                        ratioEl.value = nuevoValor;
                    }
                    actualizarColor('na_k', 'refNaK');
                }
            }
        </script>

        <h3 class="titulos">ÍNDICES DE INTERFERENCIA</h3>
        <table>
            <tbody>
                <tr>
                    <td>SUERO HEMOLÍTICO:</td>
                    <td>
                        <input type="text" id="suero_hemolitico" list="opcionesInterferencia" style="width:140px;" value="No se observa">
                    </td>
                </tr>
                <tr>
                    <td>SUERO LIPÉMICO:</td>
                    <td>
                        <input type="text" id="suero_lipemico" list="opcionesInterferencia" style="width:140px;" value="No se observa">
                    </td>
                </tr>
                <tr>
                    <td>SUERO ICTÉRICO:</td>
                    <td>
                        <input type="text" id="suero_icterico" list="opcionesInterferencia" style="width:140px;" value="No se observa">
                    </td>
                </tr>
            </tbody>
        </table>
        
        <datalist id="opcionesInterferencia">
            <option value="No se observa">
            <option value="Se observa">
        </datalist>

  <div class="footer">
    <p id="mensajeMedico" style="display: none;">El personal médico cuenta con un plazo de 24 a 48 horas para interpretar el reporte de los resultados.</p>
    <p>Facebook: Veterinaria San Martin de Porres | Teléfono: 4000 - 1365 | Ext: 106</p>
    <p>WhatsApp: 8839 - 2214 | San Rafael Abajo de Desamparados, 50 metros Norte del Mall Zona Centro</p>
    <p>Correo: laboratorio@vetsanmartin.com</p>
</div>
</div>

<div class="controls">
    <button id="pdfButton" onclick="generatePDF()">Generar PDF</button>
    <button id="menuButton" onclick="window.location.href='index.html'">Volver al Menú</button>
    <div id="loadingPdf" class="loading-indicator">
        <div class="spinner"></div>
        <span>Generando PDF...</span>
    </div>
</div>

<script>
// Configuración del historial
document.addEventListener('DOMContentLoaded', function() {
    setupHistorial();
    
    const pdfButton = document.getElementById('pdfButton');
    if (pdfButton) {
        const originalHandler = pdfButton.onclick;
        pdfButton.onclick = async function() {
            guardarAnalisisActual();
            if (originalHandler) {
                return originalHandler.apply(this, arguments);
            }
        };
    }
});

function setupHistorial() {
    const controlsDiv = document.querySelector('.controls');
    
    if (controlsDiv) {
        const historialContainer = document.createElement('div');
        historialContainer.className = 'historial-container';
        
        const label = document.createElement('label');
        label.htmlFor = 'historialSelector';
        label.textContent = 'Historial de análisis:';
        
        const select = document.createElement('select');
        select.id = 'historialSelector';
        
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '-- Seleccionar análisis anterior --';
        defaultOption.selected = true;
        select.appendChild(defaultOption);
        
        cargarOpcionesHistorial(select);
        
        select.addEventListener('change', function() {
            if (this.value) {
                cargarAnalisisDesdeHistorial(this.value);
            }
        });
        
        historialContainer.appendChild(label);
        historialContainer.appendChild(select);
        controlsDiv.appendChild(historialContainer);
    }
}

function cargarOpcionesHistorial(selectElement) {
    while (selectElement.options.length > 1) {
        selectElement.remove(1);
    }
    
    const historial = JSON.parse(localStorage.getItem('electrolitosHistorial') || '[]');
    
    historial.forEach((analisis, index) => {
        const option = document.createElement('option');
        option.value = index;
        
        const fecha = new Date(analisis.timestamp);
        const fechaStr = fecha.toLocaleDateString();
        const horaStr = fecha.toLocaleTimeString();
        
        option.textContent = `${analisis.mascotaNombre} - ${analisis.propietarioNombre} (${fechaStr} ${horaStr})`;
        
        selectElement.appendChild(option);
    });
}

function guardarAnalisisActual() {
    const getValueSafe = (id) => {
        const element = document.getElementById(id);
        return element ? element.value : '';
    };

    const formData = {
        mascotaNombre: getValueSafe('mascotaNombre'),
        mascotaRaza: getValueSafe('mascotaRaza'),
        mascotaEspecie: getValueSafe('especieEnPlantilla'),
        mascotaSexo: getValueSafe('sexoEnPlantilla'),
        mascotaEdad: getValueSafe('mascotaEdad'),
        mascotaPeso: getValueSafe('mascotaPeso'),
        
        propietarioNombre: getValueSafe('propietarioNombre'),
        propietarioCedula: getValueSafe('propietarioCedula'),
        propietarioTelefono: getValueSafe('propietarioTelefono'),
        propietarioEmail: getValueSafe('propietarioEmail'),
        propietarioFecha: getValueSafe('propietarioFecha'),
        nombreMedico: getValueSafe('nombreMedico'),
        
        sodio: getValueSafe('sodio'),
        potasio: getValueSafe('potasio'),
        cloro: getValueSafe('cloro'),
        calcio: getValueSafe('calcio'),
        fosforo: getValueSafe('fosforo'),
        magnesio: getValueSafe('magnesio'),
        dioxido: getValueSafe('dioxido'),
        na_k: getValueSafe('na_k'),
        suero_hemolitico: getValueSafe('suero_hemolitico'),
        suero_lipemico: getValueSafe('suero_lipemico'),
        suero_icterico: getValueSafe('suero_icterico'),
        
        especieSelector: getValueSafe('especieSelector'),
        sexoSelector: getValueSafe('sexoSelector'),
        edadSelector: getValueSafe('edadSelector'),
        
        timestamp: new Date().getTime()
    };
    
    if (!formData.mascotaNombre && !formData.propietarioNombre) return;
    
    let historial = JSON.parse(localStorage.getItem('electrolitosHistorial') || '[]');
    historial.unshift(formData);
    historial = historial.slice(0, 10);
    
    localStorage.setItem('electrolitosHistorial', JSON.stringify(historial));
    
    const selector = document.getElementById('historialSelector');
    if (selector) {
        cargarOpcionesHistorial(selector);
    }
}

function cargarAnalisisDesdeHistorial(index) {
    const historial = JSON.parse(localStorage.getItem('electrolitosHistorial') || '[]');
    
    if (!historial[index]) return;
    
    const analisis = historial[index];
    
    document.getElementById('mascotaNombre').value = analisis.mascotaNombre || '';
    document.getElementById('mascotaRaza').value = analisis.mascotaRaza || '';
    document.getElementById('especieEnPlantilla').value = analisis.mascotaEspecie || '';
    document.getElementById('sexoEnPlantilla').value = analisis.mascotaSexo || '';
    document.getElementById('mascotaEdad').value = analisis.mascotaEdad || '';
    document.getElementById('mascotaPeso').value = analisis.mascotaPeso || '';
    
    document.getElementById('propietarioNombre').value = analisis.propietarioNombre || '';
    document.getElementById('propietarioCedula').value = analisis.propietarioCedula || '';
    document.getElementById('propietarioTelefono').value = analisis.propietarioTelefono || '';
    document.getElementById('propietarioEmail').value = analisis.propietarioEmail || '';
    document.getElementById('propietarioFecha').value = analisis.propietarioFecha || '';
    document.getElementById('nombreMedico').value = analisis.nombreMedico || '';
    
    document.getElementById('sodio').value = analisis.sodio || '';
    document.getElementById('potasio').value = analisis.potasio || '';
    document.getElementById('cloro').value = analisis.cloro || '';
    document.getElementById('calcio').value = analisis.calcio || '';
    document.getElementById('fosforo').value = analisis.fosforo || '';
    document.getElementById('magnesio').value = analisis.magnesio || '';
    document.getElementById('dioxido').value = analisis.dioxido || '';
    document.getElementById('na_k').value = analisis.na_k || '';
    document.getElementById('suero_hemolitico').value = analisis.suero_hemolitico || 'No se observa';
    document.getElementById('suero_lipemico').value = analisis.suero_lipemico || 'No se observa';
    document.getElementById('suero_icterico').value = analisis.suero_icterico || 'No se observa';
    
    if (analisis.especieSelector) {
        document.getElementById('especieSelector').value = analisis.especieSelector;
        const event = new Event('change');
        document.getElementById('especieSelector').dispatchEvent(event);
    }
    
    if (analisis.sexoSelector) {
        document.getElementById('sexoSelector').value = analisis.sexoSelector;
        const event = new Event('change');
        document.getElementById('sexoSelector').dispatchEvent(event);
    }
    
    if (analisis.edadSelector) {
        document.getElementById('edadSelector').value = analisis.edadSelector;
        const event = new Event('change');
        document.getElementById('edadSelector').dispatchEvent(event);
    }
    
    alert(`Datos de ${analisis.mascotaNombre} cargados correctamente`);
}

document.addEventListener('DOMContentLoaded', function() {
    const controlsDiv = document.querySelector('.controls');
    
    if (controlsDiv) {
        const borrarHistorialBtn = document.createElement('button');
        borrarHistorialBtn.id = 'borrarHistorialBtn';
        borrarHistorialBtn.textContent = 'Borrar Historial';
        borrarHistorialBtn.onclick = function() {
            if (confirm('¿Estás seguro de que quieres borrar todo el historial de análisis?')) {
                localStorage.removeItem('electrolitosHistorial');
                cargarOpcionesHistorial(document.getElementById('historialSelector'));
                alert('Historial borrado correctamente');
            }
        };
        
        controlsDiv.appendChild(borrarHistorialBtn);
    }
});

async function generatePDF() {
    const loadingIndicator = document.getElementById('loadingPdf');
    const pdfButton = document.getElementById('pdfButton');
    
    loadingIndicator.style.display = 'flex';
    pdfButton.disabled = true;
    
    try {
        const { jsPDF } = window.jspdf;
        const selectedTemplate = document.getElementById('template1');

        if (!selectedTemplate) {
            alert('No se encontró la plantilla.');
            return;
        }

        const mascotaNombre = document.getElementById('mascotaNombre').value || 'Sin_nombre';
        const propietarioNombre = document.getElementById('propietarioNombre').value || 'Sin_apellido';
        
        const nombreArray = propietarioNombre.split(' ');
        const propietarioApellido = nombreArray.length > 1 ? nombreArray[1] : nombreArray[0];

        const images = selectedTemplate.getElementsByTagName('img');
        const loadImages = Array.from(images).map(img => {
            return new Promise((resolve, reject) => {
                if (img.complete) {
                    resolve();
                } else {
                    img.onload = resolve;
                    img.onerror = reject;
                }
            });
        });

        await Promise.all(loadImages);

        const canvas = await html2canvas(selectedTemplate, {
            scale: 2,
            useCORS: true,
            logging: false,
            allowTaint: true,
            backgroundColor: '#ffffff'
        });

        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 150; 
        const pageHeight = 297;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        const x = (pdf.internal.pageSize.getWidth() - imgWidth) / 2;
        const y = 5;

        pdf.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight);

        const fileName = `Electrolitos ${mascotaNombre} ${propietarioApellido}.pdf`;
        
        const pdfBlob = pdf.output('blob');
        
        if ('showSaveFilePicker' in window) {
            try {
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [{
                        description: 'Archivo PDF',
                        accept: { 'application/pdf': ['.pdf'] }
                    }]
                });
                
                const writable = await fileHandle.createWritable();
                await writable.write(pdfBlob);
                await writable.close();
                
                console.log('Archivo guardado con éxito usando File System Access API');
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Error al usar File System Access API:', err);
                    pdf.save(fileName);
                }
            }
        } else {
            pdf.save(fileName);
        }
    } catch (error) {
        console.error('Error al generar el PDF:', error);
        alert('Ocurrió un error al generar el PDF: ' + error.message);
    } finally {
        loadingIndicator.style.display = 'none';
        pdfButton.disabled = false;
    }
}

// Funciones para eliminar parámetros
document.addEventListener('DOMContentLoaded', function() {
    cargarListaDeParametrosElectrolitos();
});

function cargarListaDeParametrosElectrolitos() {
    const selector = document.getElementById('parameterSelector');
    if (!selector) {
        console.error("No se encontró el selector de parámetros");
        return;
    }
    
    selector.innerHTML = '<option value="" selected disabled>-- Seleccionar parámetro --</option>';
    
    const parametrosEspecificos = [
        "FÓSFORO (P)", "CALCIO TOTAL (Ca)", "MAGNESIO (Mg)", "SODIO (Na)",
        "POTASIO (K)", "CLORO (Cl)", "Dióxido de Carbono", "NA+/K+",
        "SUERO HEMOLÍTICO", "SUERO LIPÉMICO", "SUERO ICTÉRICO"
    ];
    
    const tablas = document.querySelectorAll('#template1 table');
    
    tablas.forEach((tabla, tablaIndex) => {
        const filas = tabla.querySelectorAll('tbody tr');
        
        filas.forEach((fila, filaIndex) => {
            if (!fila.cells || fila.cells.length === 0) return;
            
            const paramName = fila.cells[0]?.textContent.trim();
            
            if (parametrosEspecificos.includes(paramName)) {
                const filaId = `fila-electrolitos-${tablaIndex}-${filaIndex}`;
                fila.id = filaId;
                
                const option = document.createElement('option');
                option.value = filaId;
                option.textContent = paramName;
                selector.appendChild(option);
            }
        });
    });
}

function eliminarParametroSeleccionado() {
    const selector = document.getElementById('parameterSelector');
    const filaId = selector.value;
    
    if (!filaId) {
        alert('Por favor, selecciona un parámetro para eliminar.');
        return;
    }
    
    const fila = document.getElementById(filaId);
    if (fila) {
        fila.remove();
        cargarListaDeParametrosElectrolitos();
    }
}
</script>
</body>
</html>

