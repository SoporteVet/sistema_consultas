<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Plantillas</title>
    <link rel="stylesheet" href="index_lab.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=ABeeZee:ital@0;1&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=League+Spartan:wght@100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">

    <style>
        /* Estilos para el panel de eliminación de parámetros */
        .parameter-selector-panel {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .parameter-selector-panel h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }

        .selector-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .parameter-dropdown {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .remove-param-btn {
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .remove-param-btn:hover {
            background: #c82333;
        }

        .remove-param-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        /* Estilos para campos calculados automáticamente */
        input[readonly] {
            background-color: #f8f9fa !important;
            color: #495057 !important;
            cursor: not-allowed;
            border: 1px solid #ced4da;
        }

        input[readonly]:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* Indicador visual para campos calculados */
        .campo-calculado::after {
            content: " (Calculado)";
            font-size: 0.8em;
            color: #6c757d;
            font-style: italic;
        }

        /* Estilos para colores de valores */
        .valor-bajo {
            position: relative;
        }

        .valor-alto {
            position: relative;
        }

        /* Asegurar que los colores se muestren correctamente en campos readonly */
        input[readonly].valor-bajo {
            color: #0096d2 !important;
        }

        input[readonly].valor-alto {
            color: red !important;
        }

        input[readonly].valor-normal {
            color: black !important;
        }
    </style>
</head>


<body>
<script>
// Autollenado Hemograma desde parámetros URL
document.addEventListener('DOMContentLoaded', function(){
  try {
    const p = new URLSearchParams(location.search);
    const setVal = (id, v) => { const el = document.getElementById(id); if (el && v!=null && v!=='') el.value = v; };
    setVal('mascotaNombre', p.get('mascotaNombre'));
    setVal('propietarioNombre', p.get('propietarioNombre'));
    setVal('propietarioCedula', p.get('propietarioCedula'));
    setVal('propietarioTelefono', p.get('propietarioTelefono'));
    setVal('propietarioEmail', p.get('propietarioEmail'));
    setVal('nombreMedico', p.get('nombreMedico'));
    setVal('mascotaRaza', p.get('mascotaRaza'));
    setVal('mascotaEdad', p.get('mascotaEdad'));
    setVal('mascotaPeso', p.get('mascotaPeso'));
    
    // Verificar el mensaje del médico después del autollenado
    const medico = p.get('nombreMedico');
    if (medico) {
      setTimeout(() => {
        verificarMedico();
      }, 100);
    }
    
    const especie = p.get('especie');
    const sexo = p.get('mascotaSexo');
    if (especie) {
      const especieSelector = document.getElementById('especieSelector');
      if (especieSelector) {
        especieSelector.value = capitalize(especie);
        const evt = new Event('change'); especieSelector.dispatchEvent(evt);
      }
    }
    if (sexo) {
      const sexoSelector = document.getElementById('sexoSelector');
      if (sexoSelector) {
        sexoSelector.value = capitalize(sexo);
        const evt = new Event('change'); sexoSelector.dispatchEvent(evt);
      }
    }
  } catch(e) { console.warn('Autollenado hemograma falló:', e); }
  function capitalize(s){ if(!s) return s; return s.charAt(0).toUpperCase()+s.slice(1).toLowerCase(); }
});
</script>
    <div class="controls">
        <label for="sexoSelector">Selecciona el sexo:</label>
        <select id="sexoSelector" onchange="actualizarSexoEnPlantilla(),actualizarValoresReferencia()">
            <option value="Seleccionar" selected>-- Seleccionar --</option>
            <option value="Macho">Macho</option>
            <option value="Hembra">Hembra</option>
        </select>
        <label for="especieSelector">Selecciona la especie:</label>
        <select id="especieSelector" onchange="actualizarEspecieEnPlantilla(),actualizarValoresReferencia()">
            <option value="Seleccionar" selected>-- Seleccionar --</option>
            <option value="Canino">Canino</option>
            <option value="Felino">Felino</option>
            <option value="Lagomorfo">Lagomorfo</option>
            <option value="Cuilo">Cuilo</option>
        </select>
        <label for="edadSelector">Selecciona el rango de edad:</label>
        <select id="edadSelector" onchange="actualizarValoresReferencia()">
            <option value="Seleccionar" selected>-- Seleccionar --</option>
            <option value="De 1 año a 12 años">De 1 año a 12 años</option>
            <option value="De 6 meses a 1 año">De 6 meses a 1 año</option>
            <option value="De mes y medio a 5 meses">De mes y medio a 5 meses</option>
            <option value="Menor de mes y medio">Menor de mes y medio</option>
            <option value="Todas las edades">Todas las edades</option>
        </select>
    </div>

    <!-- Panel para eliminar parámetros -->
    <div class="parameter-selector-panel">
        <h3>Eliminar parámetros</h3>
        <div class="selector-container">
            <select id="parameterSelector" class="parameter-dropdown">
                <option value="" selected disabled>-- Seleccionar parámetro --</option>
            </select>
            <button onclick="eliminarParametroSeleccionado()" class="remove-param-btn">Eliminar</button>
        </div>
    </div>

<div class="container" id="template1" style="display: block;">
    <div class="header">
        <img src="empresa.jpg" alt="Logo de la Empresa" class="small-image">
        <h1>Laboratorio Clínico Veterinario</h1>
    </div>
    <h3 class="subheader">HEMOGRAMA</h3>
        <table>
            <thead>
                <tr>
                    <th colspan="2">DATOS DE LA MASCOTA</th>
                    <th colspan="2">DATOS DEL PROPIETARIO</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Nombre</td>
                    <td><input type="text" id="mascotaNombre" onkeydown="moverFocoConFlechas(event, 'propietarioNombre', 'propietarioNombre', 'mascotaNombre', 'mascotaRaza')"></td>
                    <td>Nombre</td>
                    <td><input type="text" id="propietarioNombre"  onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaNombre', 'mascotaNombre', 'propietarioCedula')"></td>
                </tr>
                <tr>
                    <td>Raza</td>
                    <td><input type="text" id="mascotaRaza" list="razas"  onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaNombre', 'mascotaNombre', 'mascotaSexo')"></td>
                    <datalist id="razas">

                    </datalist>
                    
                    <td>Cédula</td>
                    <td><input type="text" id="propietarioCedula"  onkeydown="moverFocoConFlechas(event, 'propietarioTelefono', 'mascotaRaza', 'propietarioNombre', 'propietarioTelefono')"></td>
                </tr>
                <tr>
                    <td>Sexo</td>
                    <td><input type="text" id="sexoEnPlantilla"></td>
                    <td>Teléfono</td>
                    <td><input type="text" id="propietarioTelefono" onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaSexo', 'propietarioCedula', 'propietarioEmail')"></td>
                </tr>
                <tr>
                    <td>Especie</td>
                    <td><input type="text" id="especieEnPlantilla"></td>
                    <td>Email</td>
                    <td><input type="text" id="propietarioEmail"  onkeydown="moverFocoConFlechas(event, 'mascotaEspecie', 'mascotaEspecie', 'propietarioTelefono', 'nombreMedico')"></td>
                </tr>
                <tr>
                    <td>Edad</td>
                    <td><input type="text" id="mascotaEdad" list="edades"  onkeydown="moverFocoConFlechas(event, 'nombreMedico', 'mascotaEspecie', 'mascotaEspecie', 'mascotaPeso')"></td>
                    <datalist id="edades">
                        <option value="1 mes"><option value="2 meses"><option value="3 meses"><option value="4 meses">
                        <option value="5 meses"><option value="6 meses"><option value="7 meses"><option value="8 meses"><option value="9 meses">
                        <option value="10 meses"><option value="11 meses"><option value="12 meses">
                        <option value="1 año"><option value="2 años"><option value="3 años"><option value="4 años">
                        <option value="5 años"><option value="6 años"><option value="7 años"><option value="8 años"><option value="9 años">
                        <option value="10 años"><option value="11 años"><option value="12 años"><option value="13 años"></option><option value="14 años"></option>
                        <option value="15 años"><option value="16 años"><option value="17 años"><option value="18 años"></option>
                        <option value="19 años"><option value="20 años"></option>    
                    </datalist>
                    </datalist>
                    <td>Médico</td>
                    <td>
                        <input type="text" id="nombreMedico" list="medicos" 
                            onkeydown="moverFocoConFlechas(event, 'propietarioFecha', 'mascotaEdad', 'propietarioEmail', 'propietarioFecha')" 
                            oninput="verificarMedico()">
                    </td>
                    <datalist id="medicos">
                        <option value="N.A">
                        <option value="Dr. Randall Azofeifa">
                        <option value="Dr. Luis Coto">
                        <option value="Dr. Gustavo Gónzalez">
                        <option value="Dra. Daniela Sancho">
                        <option value="Dra. Sofia Carrillo">
                        <option value="Dra. Franciny Nuñez">
                        <option value="Dra. Lourdes Chacón">
                        <option value="Dra. Alejandra León">
                        <option value="Dra. Karla Quesada">
                        <option value="Dra. Kharen Moreno">
                        <option value="Dra. Karina Madrigal">
                        <option value="Dra. Natalia Alvarado">
                    </datalist>
                </tr>
                <tr>
                    <script>    
                        function actualizarSexoEnPlantilla() {
                            const sexo = document.getElementById('sexoSelector').value;
                            document.getElementById('sexoEnPlantilla').value = sexo.charAt(0).toUpperCase() + sexo.slice(1);
                        }
                        function actualizarEspecieEnPlantilla() {
                            const especie = document.getElementById('especieSelector').value;
                            document.getElementById('especieEnPlantilla').value = especie;
                        }
                        function verificarMedico() {
                            const medico = document.getElementById('nombreMedico').value;
                            const mensaje = document.getElementById('mensajeMedico');
                            if (medico === 'N.A' || medico === 'NA' || medico === '' || medico === 'N.A.' || medico.toLowerCase() === 'na') {
                                mensaje.style.display = 'none';
                            } else {
                                mensaje.style.display = 'block';
                            }
                        }


                        </script>
                </tr>
                <tr>
                    <td>Peso</td>
<td><input type="text" id="mascotaPeso" list="pesos" onkeydown="moverFocoConFlechas(event, 'propietarioFecha', 'mascotaEdad', 'mascotaEdad', 'mascotaPeso')"></td>

    <datalist id="pesos">
        <option value="N.A">N.A</option><option value="0,1 kg">0,1 kg</option><option value="0,2 kg">0,2 kg</option><option value="0,3 kg">0,3 kg</option><option value="0,4 kg">0,4 kg</option>
        <option value="0,5 kg">0,5 kg</option><option value="0,6 kg">0,6 kg</option><option value="0,7 kg">0,7 kg</option><option value="0,8 kg">0,8 kg</option><option value="0,9 kg">0,9 kg</option>
        <option value="1,0 kg">1,0 kg</option><option value="1,1 kg">1,1 kg</option><option value="1,2 kg">1,2 kg</option><option value="1,3 kg">1,3 kg</option><option value="1,4 kg">1,4 kg</option>
        <option value="1,5 kg">1,5 kg</option><option value="1,6 kg">1,6 kg</option><option value="1,7 kg">1,7 kg</option><option value="1,8 kg">1,8 kg</option><option value="1,9 kg">1,9 kg</option>
        <option value="2,0 kg">2,0 kg</option><option value="2,1 kg">2,1 kg</option><option value="2,2 kg">2,2 kg</option><option value="2,3 kg">2,3 kg</option><option value="2,4 kg">2,4 kg</option>
        <option value="2,5 kg">2,5 kg</option><option value="2,6 kg">2,6 kg</option><option value="2,7 kg">2,7 kg</option><option value="2,8 kg">2,8 kg</option><option value="2,9 kg">2,9 kg</option>
        <option value="3,0 kg">3,0 kg</option><option value="3,1 kg">3,1 kg</option><option value="3,2 kg">3,2 kg</option><option value="3,3 kg">3,3 kg</option><option value="3,4 kg">3,4 kg</option>
        <option value="3,5 kg">3,5 kg</option><option value="3,6 kg">3,6 kg</option><option value="3,7 kg">3,7 kg</option><option value="3,8 kg">3,8 kg</option><option value="3,9 kg">3,9 kg</option>
        <option value="4,0 kg">4,0 kg</option><option value="4,1 kg">4,1 kg</option><option value="4,2 kg">4,2 kg</option><option value="4,3 kg">4,3 kg</option><option value="4,4 kg">4,4 kg</option>
        <option value="4,5 kg">4,5 kg</option><option value="4,6 kg">4,6 kg</option><option value="4,7 kg">4,7 kg</option><option value="4,8 kg">4,8 kg</option><option value="4,9 kg">4,9 kg</option>
        <option value="5,0 kg">5,0 kg</option><option value="5,1 kg">5,1 kg</option><option value="5,2 kg">5,2 kg</option><option value="5,3 kg">5,3 kg</option><option value="5,4 kg">5,4 kg</option>
        <option value="5,5 kg">5,5 kg</option><option value="5,6 kg">5,6 kg</option><option value="5,7 kg">5,7 kg</option><option value="5,8 kg">5,8 kg</option><option value="5,9 kg">5,9 kg</option>
        <option value="6,0 kg">6,0 kg</option><option value="6,1 kg">6,1 kg</option><option value="6,2 kg">6,2 kg</option><option value="6,3 kg">6,3 kg</option><option value="6,4 kg">6,4 kg</option>
        <option value="6,5 kg">6,5 kg</option><option value="6,6 kg">6,6 kg</option><option value="6,7 kg">6,7 kg</option><option value="6,8 kg">6,8 kg</option><option value="6,9 kg">6,9 kg</option>
        <option value="7,0 kg">7,0 kg</option><option value="7,1 kg">7,1 kg</option><option value="7,2 kg">7,2 kg</option><option value="7,3 kg">7,3 kg</option><option value="7,4 kg">7,4 kg</option>
        <option value="7,5 kg">7,5 kg</option><option value="7,6 kg">7,6 kg</option><option value="7,7 kg">7,7 kg</option><option value="7,8 kg">7,8 kg</option><option value="7,9 kg">7,9 kg</option>
        <option value="8,0 kg">8,0 kg</option><option value="8,1 kg">8,1 kg</option><option value="8,2 kg">8,2 kg</option><option value="8,3 kg">8,3 kg</option><option value="8,4 kg">8,4 kg</option>
        <option value="8,5 kg">8,5 kg</option><option value="8,6 kg">8,6 kg</option><option value="8,7 kg">8,7 kg</option><option value="8,8 kg">8,8 kg</option><option value="8,9 kg">8,9 kg</option>
        <option value="9,0 kg">9,0 kg</option><option value="9,1 kg">9,1 kg</option><option value="9,2 kg">9,2 kg</option><option value="9,3 kg">9,3 kg</option><option value="9,4 kg">9,4 kg</option>
        <option value="9,5 kg">9,5 kg</option><option value="9,6 kg">9,6 kg</option><option value="9,7 kg">9,7 kg</option><option value="9,8 kg">9,8 kg</option><option value="9,9 kg">9,9 kg</option>
        <option value="10,0 kg">10,0 kg</option><option value="10,1 kg">10,1 kg</option><option value="10,2 kg">10,2 kg</option><option value="10,3 kg">10,3 kg</option><option value="10,4 kg">10,4 kg</option>
        <option value="10,5 kg">10,5 kg</option><option value="10,6 kg">10,6 kg</option><option value="10,7 kg">10,7 kg</option><option value="10,8 kg">10,8 kg</option><option value="10,9 kg">10,9 kg</option>
        <option value="11,0 kg">11,0 kg</option><option value="11,1 kg">11,1 kg</option><option value="11,2 kg">11,2 kg</option><option value="11,3 kg">11,3 kg</option><option value="11,4 kg">11,4 kg</option>
        <option value="11,5 kg">11,5 kg</option><option value="11,6 kg">11,6 kg</option><option value="11,7 kg">11,7 kg</option><option value="11,8 kg">11,8 kg</option><option value="11,9 kg">11,9 kg</option>
        <option value="12,0 kg">12,0 kg</option>
        
    </datalist>
        <td>Fecha</td>
        <td><input type="date" id="propietarioFecha" class="date-input" onkeydown="moverFocoConFlechas(event, 'nombreMedico', 'mascotaPeso', 'nombreMedico', 'propietarioFecha')"></td>
                </tr>
                
                <script>
              function formatearFecha(input) {
            const fecha = new Date(input.value);
            const dia = String(fecha.getDate()).padStart(2, '0');
            const mes = String(fecha.getMonth() + 1).padStart(2, '0');
            const año = fecha.getFullYear();
            input.value = `${dia}-${mes}-${año}`;
        }
   
                function moverFocoConFlechas(event, derechaId, izquierdaId, arribaId, abajoId) {
                    switch (event.key) {
                        case 'ArrowRight':
                            event.preventDefault();
                            document.getElementById(derechaId).focus();
                            break;
                        case 'ArrowLeft':
                            event.preventDefault();
                            document.getElementById(izquierdaId).focus();
                            break;
                        case 'ArrowUp':
                            event.preventDefault();
                            document.getElementById(arribaId).focus();
                            break;
                        case 'Enter':
                        case 'ArrowDown':
                            event.preventDefault();
                            document.getElementById(abajoId).focus();
                            break;
                    }
                }
                const razasCaninas = [
    "Ainu", "Airedale terrier", "Akita", "Akita Inu", "Alaskan Malamute",
    "American Black and Tan Coonhound", "American Bull Terrier", "American Pit Bull Terrier",
    "American Staffordshire terrier", "American Water Spaniel", "Apso Tibetano", "Barzoi", 
    "Basenji", "Basset Hound", "Beagle", "Bichon Frise", "Bloodhound", "Bobtail", 
    "Border Collie", "Boston Terrier", "Bouvier des Flandres", "Boxer", "Bull terrier", 
    "Bull Terrier Miniatura", "Bulldog Americano", "Bulldog Francés", "Bulldog Inglés", 
    "Bullmastiff", "Cavalier King Charles Spaniel", "Chihuahua", "Chow Chow", 
    "Cocker Spaniel Americano", "Cocker Spaniel Inglés", "Collie", "Collie Escocés", 
    "Dachshund", "Dálmata", "Doberman", "Doberman Pincher", "Dogo Alemán", 
    "Dogo Argentino", "Dogo de Burdeos", "French Poodle", "Galgo Español", 
    "Galgo Inglés-español", "Golden Retriever", "Gran Danés", "Greyhound", 
    "Husky Siberiano", "Jack Russell Terrier", "Labrador Retriever", "Maltés", 
    "Pastor Alemán", "Pequinés", "Pomerania", "Pug", "Rottweiler", "Samoyedo", 
    "San Bernardo", "Schnauzer", "Shih Tzu", "SRD", "Yorkshire Terrier", "Weimaraner", "Fila Brasileiro",
];

const razasFelinas = [
    "Abisinio", "American Bobtail", "Angora Turco", "Azul Ruso", "Balinés", 
    "Bengalí", "Bobtail japonés", "Bombay", "British Shorthair", "Burmés", 
    "Carey", "Común Europeo", "Exótico", "Himalayo", "Javanés", 
    "Oriental", "Persa", "Sagrado de Birmania", "Siamés", "Siberiano", 
    "Silvestre", "SRD"
];

// Función para actualizar el datalist de razas según la especie seleccionada
function actualizarRazasPorEspecie() {
    const especie = document.getElementById('especieSelector').value;
    // Crear el datalist si no existe
    let datalistRazas = document.getElementById('razas');
    if (!datalistRazas) {
        datalistRazas = document.createElement('datalist');
        datalistRazas.id = 'razas';
        document.body.appendChild(datalistRazas);
    } else {
        // Limpiar la lista actual
        datalistRazas.innerHTML = '';
    }
    
    const campoRaza = document.getElementById('mascotaRaza');
    
    // Restablecer el campo de raza si se cambia la especie
    if (campoRaza.value && campoRaza.value !== "SRD") {
        campoRaza.value = '';
    }
    
    // Agregar las razas según la especie seleccionada
    if (especie === "Canino") {
        razasCaninas.forEach(raza => {
            const option = document.createElement('option');
            option.value = raza;
            datalistRazas.appendChild(option);
        });
    } else if (especie === "Felino") {
        razasFelinas.forEach(raza => {
            const option = document.createElement('option');
            option.value = raza;
            datalistRazas.appendChild(option);
        });
    } else if (especie === "Lagomorfo" || especie === "Cuilo") {
        // Para otras especies, agregar solo opciones genéricas
        const option = document.createElement('option');
        option.value = "SRD";
        datalistRazas.appendChild(option);
    }
}

// Modificar la función existente
function actualizarEspecieEnPlantilla() {
    const especie = document.getElementById('especieSelector').value;
    document.getElementById('especieEnPlantilla').value = especie;
    
    // Actualizar las razas disponibles según la especie
    actualizarRazasPorEspecie();
}

// Ejecutar al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    // Asegurarse de que existe el selector de especies
    const especieSelector = document.getElementById('especieSelector');
    if (especieSelector) {
        // Si ya hay una especie seleccionada al cargar
        if (especieSelector.value !== "Seleccionar") {
            actualizarRazasPorEspecie();
        }
        
        // Agregar un listener adicional para garantizar que se actualicen las razas
        especieSelector.addEventListener('change', actualizarRazasPorEspecie);
    }
    
    // Crear datalist si no existe
    if (!document.getElementById('razas')) {
        const datalist = document.createElement('datalist');
        datalist.id = 'razas';
        document.body.appendChild(datalist);
    }
});
                </script>
            </tbody>
        </table>

        <h3 class="titulos">FÓRMULA BLANCA</h3>
        <table>
            <thead>
                <tr>
                    <th>PARÁMETRO</th>
                    <th>RESULTADO</th>
                    <th>VALOR DE REFERENCIA</th>
                    <th>UNIDADES</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>RECUENTO LEUCOCITOS</td>
                    <td>
                        <input type="text" id="leucocitos" list="rangoLeucocitos" oninput="calcularTodos()" onblur="formatearDecimal('leucocitos')" onkeydown="moverFoco(event, 'linfocitos')">
                        <datalist id="rangoLeucocitos"></datalist>
                    </td>
                    <td id="refLeucocitos">6,8 - 13,9</td>
                    <td>x 10³/µl</td>
                </tr>
                <script type="module">
                 import { recuentoLeucocitos } from './numeros.js';

                    document.addEventListener('DOMContentLoaded', () => {
                        const datalist = document.getElementById('rangoLeucocitos');
                        recuentoLeucocitos.forEach(valor => {
                            const option = document.createElement('option');
                            option.value = parseFloat(valor.replace(',', '.')).toFixed(1).replace('.', ',');
                            datalist.appendChild(option);
                        });
                    });
                    </script>
                <td>LINFOCITOS #</td>
                <td><input type="text" id="linfocitos" list="rangoLinfocitos" oninput="calcularTodos()" onblur="formatearDecimal('linfocitos')" onkeydown="moverFoco(event, 'monocitos')"></td>
                <td id="reflinfocitos">1,1 - 3,3</td>
                <td>x 10³/µl</td>
            </tr>
                <tr>
                    <td>MONOCITOS #</td>
                    <td><input type="text" id="monocitos" list="rangoMonocitos" oninput="calcularTodos()" onblur="formatearDecimal('monocitos')" onkeydown="moverFoco(event, 'eosinofilos')"></td>
                    <td id="refMonocitos">0,0 - 1,8</td>
                    <td>x 10³/µl</td>
                </tr>
                <tr>
                    <td>NEUTROFILOS #</td>
                    <td><input type="text" id="neutrofilos" list="rangoNeutrofilos" class="campo-calculado" style="background-color: #f0f0f0;" onblur="formatearDecimal('neutrofilos')" onkeydown="moverFoco(event, 'eosinofilos')" title="Se calcula automáticamente: Leucocitos - Linfocitos - Monocitos - Eosinófilos"></td>
                    <td id="refneutrofilos">4,1 - 10,3</td>
                    <td>x 10³/µl</td>
                </tr>
                <tr>
                    <td>EOSINOFILOS #</td>
                    <td><input type="text" id="eosinofilos" list="rangoEosinofilos" class="campo-calculado" style="background-color: #f0f0f0;" onblur="formatearDecimal('eosinofilos')" onkeydown="moverFoco(event, 'basofilos')" title="Se calcula automáticamente: (Eosinófilos % × Leucocitos) ÷ 100"></td>
                    <td id="refeosinofilos">0,0 - 1,7</td>
                    <td>x 10³/µl</td>
                </tr>
                <tr>
                    <td>BASOFILOS #</td>
                    <td><input type="text" id="basofilos" list="rangoBasofilos" oninput="calcularTodos()"  onblur="formatearDecimales('basofilos', 2)"  onkeydown="moverFoco(event, 'linfocitos_porcentaje')"></td>
                    <td id="refbasofilos">0,00 - 0,12</td>
                    <td>x 10³/µl</td>
                </tr>
                <tr>
                    <td>LINFOCITOS %</td>
                    <td><input type="text" id="linfocitos_porcentaje" list="rangoLinfocitosPorcentaje" oninput="calcularTodos()" onblur="formatearDecimal('linfocitos_porcentaje')" onkeydown="moverFoco(event, 'monocitos_porcentaje')"></td>
                    <td id="reflinfocitos2">12,0 - 30,0</td>
                    <td>%</td>
                </tr>
                <tr>
                    <td>MONOCITOS %</td>
                    <td><input type="text" id="monocitos_porcentaje" list= "rangoMonocitosPorcentaje" oninput="calcularTodos()" onblur="formatearDecimal('monocitos_porcentaje')" onkeydown="moverFoco(event, 'neutrofilos_porcentaje')"></td>
                    <td id="refmonocitos">2,0 - 9,0</td>
                    <td>%</td>
                </tr>
                <tr>
                    <td>NEUTROFILOS %</td>
                    <td><input type="text" id="neutrofilos_porcentaje" list="rangoNeutrofilosPorcentaje" class="campo-calculado" style="background-color: #f0f0f0;" onblur="formatearDecimal('neutrofilos_porcentaje')" onkeydown="moverFoco(event, 'eosinofilos_porcentaje')" title="Se calcula automáticamente: 100 - Linfocitos % - Monocitos % - Eosinófilos %"></td>
                    <td id="refNeutrofilosPorcentaje">43,0 - 81,0</td>
                    <td>%</td>
                </tr>
                <tr>
                    <td>EOSINOFILOS %</td>
                    <td><input type="text" id="eosinofilos_porcentaje" oninput="calcularTodos()" onblur="formatearDecimal('eosinofilos_porcentaje')" onkeydown="moverFoco(event, 'leucocitos')"></td>
                    <td id="refEosinofilosPorcentaje">0,5 - 10,0</td>
                    <td>%</td>
                </tr>
                <tr>
                    <td>BASOFILOS %</td>
                    <td><input type="text" id="basofilos_porcentaje" list="rangoBasofilosPorcentaje" oninput="calcularTodos()" onblur="formatearDecimal('basofilos_porcentaje')" onkeydown="moverFoco(event, 'leucocitos')"></td>
                    <td id="refBasofilosPorcentaje">0,0 - 1,3</td>
                    <td>%</td>
                </tr>
                
                <script>
                        const valoresReferencia = {
                Canino: {
                    Macho: {
                        "De 1 año a 12 años": {
                            Recuentoleucocitos: "6,8 - 13,9",
                            Linfocitos_numero: "1,1 - 3,3",		
                            Monocitos_numero:	"0,0 - 1,8",
                            Neutrofilos_numero: "4,1 - 10,3",
                            Eosinofilos_numero:	"0,0 - 1,7",
                            Basofilos_numero: "0,00 - 0,12",
                            Linfocitos_porcentaje: "12,0 - 30,0",
                            Monocitos_porcentaje:	"2,0 - 9,0",
                            Neutrofilos_porcentaje: "43,0 - 81,0",
                            Eosinofilos_porcentaje: "0,5 - 10,0",
                            Basofilos_porcentaje: "0,0 - 1,3",
                            Recuentoeritrocitos: "5,87 - 7,59",
                            Hemoglobina: "14,5 - 19,2",
                            Hematocrito: "39,0 - 50,3",
                            vcm: "66,0 - 79,0",
                            hcm: "20,0 - 25,0",
                            chcm: "30,0 - 38,0",
                            rdw: "11,0 - 15,5",
                            Recuentoplaquetario: "117 - 460",
                            mpv: "7,0 - 12,9",
                        },
                    "De 6 meses a 1 año": {
                            Recuentoleucocitos: "8,3 - 18,6",
                            Linfocitos_numero: "1,9 - 5,2",		
                            Monocitos_numero:	"0,0 - 3,3",
                            Neutrofilos_numero: "5,0 - 13,4",
                            Eosinofilos_numero:	"0,0 - 1,8",
                            Basofilos_numero: "0,00 - 0,12",
                            Linfocitos_porcentaje: "12,0 - 30,0",
                            Monocitos_porcentaje:	"2,0 - 9,0",
                            Neutrofilos_porcentaje: "43,0 - 81,0",
                            Eosinofilos_porcentaje: "0,5 - 10,0",
                            Basofilos_porcentaje: "0,0 - 1,3",
                            Recuentoeritrocitos: "5,74 - 7,14",
                            Hemoglobina: "14,0 - 18,0",
                            Hematocrito: "39,0 - 50,3",
                            vcm: "65,0 - 74,0",
                            hcm: "20,0 - 25,0",
                            chcm: "30,0 - 38,0",
                            rdw: "11,0 - 15,5",
                            Recuentoplaquetario: "117 - 460",
                            mpv: "7,0 - 12,9",
                        },
                        "De mes y medio a 5 meses": {
                            Recuentoleucocitos: "7,7 - 16,3",
                            Linfocitos_numero: "2,0 - 5,7",
                            Monocitos_numero: "0,0 - 4,4",
                            Neutrofilos_numero: "4,5 - 11,2",
                            Eosinofilos_numero: "0,0 - 1,0",
                            Basofilos_numero: "0,00 - 0,12",
                            Linfocitos_porcentaje: "12,0 - 30,0",
                            Monocitos_porcentaje: "2,0 - 9,0",
                            Neutrofilos_porcentaje: "43,0 - 81,0",
                            Eosinofilos_porcentaje: "0,5 - 10,0",
                            Basofilos_porcentaje: "0,0 - 1,3",
                            Recuentoeritrocitos: "4,71 - 6,03",
                            Hemoglobina: "11,1 - 14,9",
                            Hematocrito: "30,9 - 42,0",
                            vcm: "63,0 - 74,0",
                            hcm: "20,0 - 25,0",
                            chcm: "30,0 - 38,0",
                            rdw: "11,0 - 15,5",
                            Recuentoplaquetario: "117 - 460",
                            mpv: "7,0 - 12,9",
                        },
                        "Menor de mes y medio": {
                            Recuentoleucocitos: "7,2 - 17,6",
                            Linfocitos_numero: "1,6 - 6,5",
                            Monocitos_numero: "0,0 - 3,6",
                            Neutrofilos_numero: "4,7 - 12,5",
                            Eosinofilos_numero: "0,1 - 0,6",
                            Basofilos_numero: "0,00 - 0,12",
                            Linfocitos_porcentaje: "12,0 - 30,0",
                            Monocitos_porcentaje: "2,0 - 9,0",
                            Neutrofilos_porcentaje: "43,0 - 81,0",
                            Eosinofilos_porcentaje: "0,5 - 10,0",
                            Basofilos_porcentaje: "0,0 - 1,3",
                            Recuentoeritrocitos: "3,33 - 4,49",
                            Hemoglobina: "7,4 - 10,2",
                            Hematocrito: "22,2 - 32,6",
                            vcm: "60,0 - 76,0",
                            hcm: "20,0 - 25,0",
                            chcm: "30,0 - 38,0",
                            rdw: "11,0 - 15,5",
                            Recuentoplaquetario: "117 - 460",
                            mpv: "7,0 - 12,9",
                        },
                    },
                    Hembra: {
                        "De 1 año a 12 años": {
                            Recuentoleucocitos: "6,8 - 13,9",
                            Linfocitos_numero: "1,1 - 3,3",		
                            Monocitos_numero:	"0,0 - 1,8",
                            Neutrofilos_numero: "4,1 - 10,3",
                            Eosinofilos_numero:	"0,0 - 1,7",
                            Basofilos_numero: "0,00 - 0,12",
                            Linfocitos_porcentaje: "12,0 - 30,0",
                            Monocitos_porcentaje:	"2,0 - 9,0",
                            Neutrofilos_porcentaje: "43,0 - 81,0",
                            Eosinofilos_porcentaje: "0,5 - 10,0",
                            Basofilos_porcentaje: "0,0 - 1,3",
                            Recuentoeritrocitos: "5,61 - 7,46",
                            Hemoglobina: "14,2 - 18,9",
                            Hematocrito: "40,4 - 55,3",
                            vcm: "65,0 - 80,0",
                            hcm: "20,0 - 25,0",
                            chcm: "30,0 - 38,0",
                            rdw: "11,0 - 15,5",
                            Recuentoplaquetario: "117 - 460",
                            mpv: "7,0 - 12,9",
                        },
                        "De 6 meses a 1 año": {
                            Recuentoleucocitos: "7,5 - 15,0",
                            Linfocitos_numero: "1,6 - 5,3",		
                            Monocitos_numero:	"0,0 - 3,0",
                            Neutrofilos_numero: "4,1 - 10,4",
                            Eosinofilos_numero:	"0,0 - 1,8",
                            Basofilos_numero: "0,00 - 0,12",
                            Linfocitos_porcentaje: "12,0 - 30,0",
                            Monocitos_porcentaje:	"2,0 - 9,0",
                            Neutrofilos_porcentaje: "43,0 - 81,0",
                            Eosinofilos_porcentaje: "0,5 - 10,0",
                            Basofilos_porcentaje: "0,0 - 1,3",
                            Recuentoeritrocitos: "5,67 - 7,23",
                            Hemoglobina: "14,8 - 18,3",
                            Hematocrito: "39,5 - 52,0",
                            vcm: "65,0 - 76,0",
                            hcm: "20,0 - 25,0",
                            chcm: "30,0 - 38,0",
                            rdw: "11,0 - 15,5",
                            Recuentoplaquetario: "117 - 460",
                            mpv: "7,0 - 12,9",
                        },
                        "De mes y medio a 5 meses": {
                            Recuentoleucocitos: "7,3 - 18,7",
                            Linfocitos_numero: "2,0 - 5,9",
                            Monocitos_numero: "0,0 - 4,4",
                            Neutrofilos_numero: "4,3 - 12,4",
                            Eosinofilos_numero: "0,0 - 0,9",
                            Basofilos_numero: "0,00 - 0,12",
                            Linfocitos_porcentaje: "12,0 - 30,0",
                            Monocitos_porcentaje: "2,0 - 9,0",
                            Neutrofilos_porcentaje: "43,0 - 81,0",
                            Eosinofilos_porcentaje: "0,5 - 10,0",
                            Basofilos_porcentaje: "0,0 - 1,3",
                            Recuentoeritrocitos: "4,72 - 6,32",
                            Hemoglobina: "11,0 - 15,0",
                            Hematocrito: "31,1 - 42,7",
                            vcm: "63,0 - 74,0",
                            hcm: "20,0 - 25,0",
                            chcm: "30,0 - 38,0",
                            rdw: "11,0 - 15,5",
                            Recuentoplaquetario: "117 - 460",
                            mpv: "7,0 - 12,9",
                        },
                        "Menor de mes y medio": {
                            Recuentoleucocitos: "7,9 - 17,3",
                            Linfocitos_numero: "1,7 - 6,4",
                            Monocitos_numero: "0,0 - 3,3",
                            Neutrofilos_numero: "4,7 - 13,5",
                            Eosinofilos_numero: "0,1 - 0,6",
                            Basofilos_numero: "0,00 - 0,12",
                            Linfocitos_porcentaje: "12,0 - 30,0",
                            Monocitos_porcentaje: "2,0 - 9,0",
                            Neutrofilos_porcentaje: "43,0 - 81,0",
                            Eosinofilos_porcentaje: "0,5 - 10,0",
                            Basofilos_porcentaje: "0,0 - 1,3",
                            Recuentoeritrocitos: "3,40 - 4,56",
                            Hemoglobina: "7,7 - 10,3",
                            Hematocrito: "23,2 - 33,9",
                            vcm: "61,0 - 76,0",
                            hcm: "20,0 - 25,0",
                            chcm: "30,0 - 38,0",
                            rdw: "11,0 - 15,5",
                            Recuentoplaquetario: "117 - 460",
                            mpv: "7,0 - 12,9",
                        },
                    }
                },
                Felino: {
                    Macho: {
                        "De 1 año a 12 años": {
                            Recuentoleucocitos: "6,4 - 19,0",
                            Linfocitos_numero: "1,5 - 4,9",
                            Monocitos_numero: "0,0 - 2,08",
                            Neutrofilos_numero: "3,6 - 13,4",
                            Eosinofilos_numero: "0,2 - 1,2",
                            Basofilos_numero: "0,00 - 0,15",
                            Linfocitos_porcentaje: "12,0 - 45,0",
                            Monocitos_porcentaje: "2,0 - 9,0",
                            Neutrofilos_porcentaje: "30,0 - 80,0",
                            Eosinofilos_porcentaje: "0,5 - 11,0",
                            Basofilos_porcentaje: "0,0 - 1,5",
                            Recuentoeritrocitos: "5,71 - 9,67",
                            Hemoglobina: "8,7 - 14,4",
                            Hematocrito: "26,2 - 46,3",
                            vcm: "43,0 - 53,0",
                            hcm: "13,0 - 21,0",
                            chcm: "30,0 - 38,0",
                            rdw: "14,0 - 18,0",
                            Recuentoplaquetario: "100 - 514",
                            mpv: "5,0 - 11,8",
                        },
                        "De 6 meses a 1 año": {
                            Recuentoleucocitos: "8,7 - 29,0",
                            Linfocitos_numero: "1,8 - 6,9",
                            Monocitos_numero: "0,0 - 4,48",
                            Neutrofilos_numero: "5,5 - 22,5",
                            Eosinofilos_numero: "0,2 - 1,8",
                            Basofilos_numero: "0,00 - 0,15",
                            Linfocitos_porcentaje: "12,0 - 45,0",
                            Monocitos_porcentaje: "2,0 - 9,0",
                            Neutrofilos_porcentaje: "30,0 - 80,0",
                            Eosinofilos_porcentaje: "0,5 - 11,0",
                            Basofilos_porcentaje: "0,0 - 1,5",
                            Recuentoeritrocitos: "6,00 - 8,90",
                            Hemoglobina: "9,2 - 13,2",
                            Hematocrito: "28,5 - 42,8",
                            vcm: "43,0 - 51,0",
                            hcm: "13,0 - 21,0",
                            chcm: "30,0 - 38,0",
                            rdw: "14,0 - 18,0",
                            Recuentoplaquetario: "100 - 514",
                            mpv: "5,0 - 11,8",
                        },
                        "De mes y medio a 5 meses": {
                            Recuentoleucocitos: "9,9 - 24,4",
                            Linfocitos_numero: "0,9 - 6,0",
                            Monocitos_numero: "0,0 - 2,9",
                            Neutrofilos_numero: "6,3 - 19,8",
                            Eosinofilos_numero: "0,3 - 1,7",
                            Basofilos_numero: "0,00 - 0,15",
                            Linfocitos_porcentaje: "12,0 - 45,0",
                            Monocitos_porcentaje: "2,0 - 9,0",
                            Neutrofilos_porcentaje: "30,0 - 80,0",
                            Eosinofilos_porcentaje: "0,5 - 11,0",
                            Basofilos_porcentaje: "0,0 - 1,5",
                            Recuentoeritrocitos: "5,64 - 8,11",
                            Hemoglobina: "8,4 - 12,8",
                            Hematocrito: "26,9 - 40,2",
                            vcm: "42,0 - 54,0",
                            hcm: "13,0 - 21,0",
                            chcm: "30,0 - 38,0",
                            rdw: "14,0 - 18,0",
                            Recuentoplaquetario: "100 - 514",
                            mpv: "5,0 - 11,8",
                            },
                    },
                    Hembra: {
                        "De 1 año a 12 años": {
                            Recuentoleucocitos: "6,7 - 16,9",
                            Linfocitos_numero: "1,0 - 4,6",
                            Monocitos_numero: "0,0 - 3,29",
                            Neutrofilos_numero: "3,8 - 12,2",
                            Eosinofilos_numero: "0,2 - 1,4",
                            Basofilos_numero: "0,00 - 0,15",
                            Linfocitos_porcentaje: "12,0 - 45,0",
                            Monocitos_porcentaje: "2,0 - 9,0",
                            Neutrofilos_porcentaje: "30,0 - 80,0",
                            Eosinofilos_porcentaje: "0,5 - 11,0",
                            Basofilos_porcentaje: "0,0 - 1,5",
                            Recuentoeritrocitos: "5,54 - 8,75",
                            Hemoglobina: "9,0 - 13,5",
                            Hematocrito: "26,9 - 42,5",
                            vcm: "42,0 - 52,0",
                            hcm: "13,0 - 21,0",
                            chcm: "30,0 - 38,0",
                            rdw: "14,0 - 18,0",
                            Recuentoplaquetario: "100 - 514",
                            mpv: "5,0 - 11,8",
                        },
                        "De 6 meses a 1 año": {
                            Recuentoleucocitos: "8,2 - 25,9",
                            Linfocitos_numero: "1,6 - 5,6",
                            Monocitos_numero: "0,0 - 3,13",
                            Neutrofilos_numero: "5,1 - 19,9",
                            Eosinofilos_numero: "0,2 - 1,9",
                            Basofilos_numero: "0,00 - 0,15",
                            Linfocitos_porcentaje: "12,0 - 45,0",
                            Monocitos_porcentaje: "2,0 - 9,0",
                            Neutrofilos_porcentaje: "30,0 - 80,0",
                            Eosinofilos_porcentaje: "0,5 - 11,0",
                            Basofilos_porcentaje: "0,0 - 1,5",
                            Recuentoeritrocitos: "6,28 - 8,97",
                            Hemoglobina: "9,2 - 13,8",
                            Hematocrito: "30,2 - 45,0",
                            vcm: "42,0 - 52,0",
                            hcm: "13,0 - 21,0",
                            chcm: "30,0 - 38,0",
                            rdw: "14,0 - 18,0",
                            Recuentoplaquetario: "100 - 514",
                            mpv: "5,0 - 11,8",
                    },
                        "De mes y medio a 5 meses": {
                            Recuentoleucocitos: "8,7 - 28,2",
                            Linfocitos_numero: "0,9 - 6,1",
                            Monocitos_numero: "0,0 - 2,86",
                            Neutrofilos_numero: "5,9 - 22,5",
                            Eosinofilos_numero: "0,3 - 1,7",
                            Basofilos_numero: "0,00 - 0,15",
                            Linfocitos_porcentaje: "12,0 - 45,0",
                            Monocitos_porcentaje: "2,0 - 9,0",
                            Neutrofilos_porcentaje: "30,0 - 80,0",
                            Eosinofilos_porcentaje: "0,5 - 11,0",
                            Basofilos_porcentaje: "0,0 - 1,5",
                            Recuentoeritrocitos: "5,71 - 8,27",
                            Hemoglobina: "8,6 - 12,9",
                            Hematocrito: "27,4 - 39,3",
                            vcm: "42,0 - 54,0",
                            hcm: "13,0 - 21,0",
                            chcm: "30,0 - 38,0",
                            rdw: "14,0 - 18,0",
                            Recuentoplaquetario: "100 - 514",
                            mpv: "5,0 - 11,8",
                            },
                    }
                },
                Lagomorfo: {
                    Macho: {
                        "Todas las edades": {
                            Recuentoleucocitos: "5,0 - 12,0",
                            Linfocitos_numero: "3,2 - 9,0",
                            Monocitos_numero: "0,1 - 0,6",
                            Neutrofilos_numero: "2,9 - 11,0",
                            Eosinofilos_numero: "25,0 - 60,0",
                            Basofilos_numero: "0,00 - 0,76",
                            Linfocitos_porcentaje: "2,0 - 10,0",
                            Neutrofilos_porcentaje: "35,0 - 55,0",
                            Eosinofilos_porcentaje: "0,0 - 5,0",
                            Basofilos_porcentaje: "0,0 - 8,0",
                            Recuentoeritrocitos: "0,0 - 5,0",
                            Hemoglobina: "4,0 - 8,0",
                            Hematocrito: "8,0 - 17,5",
                            vcm: "30,0 - 50,0",
                            hcm: "58,0 - 75,0",
                            chcm: "17,5 - 23,5",
                            rdw: "29,0 - 37,0",
                            Recuentoplaquetario: "290 - 650",
                            mpv: "3,8 - 6,8",
                        },
                    },
                    Hembra: {
                        "Todas las edades": {
                            Recuentoleucocitos: "5,0 - 12,0",
                            Linfocitos_numero: "3,2 - 9,0",
                            Monocitos_numero: "0,1 - 0,6",
                            Neutrofilos_numero: "2,9 - 11,0",
                            Eosinofilos_numero: "25,0 - 60,0",
                            Basofilos_numero: "0,00 - 0,76",
                            Linfocitos_porcentaje: "2,0 - 10,0",
                            Neutrofilos_porcentaje: "35,0 - 55,0",
                            Eosinofilos_porcentaje: "0,0 - 5,0",
                            Basofilos_porcentaje: "0,0 - 8,0",
                            Recuentoeritrocitos: "0,0 - 5,0",
                            Hemoglobina: "4,0 - 8,0",
                            Hematocrito: "8,0 - 17,5",
                            vcm: "30,0 - 50,0",
                            hcm: "58,0 - 75,0",
                            chcm: "17,5 - 23,5",
                            rdw: "29,0 - 37,0",
                            Recuentoplaquetario: "290 - 650",
                            mpv: "3,8 - 6,8",
                        },
                        },
                    },
                Cuilo: {
                    Macho: {
                        "Todas las edades": {
                            Recuentoleucocitos: "7,0 - 14,0",
                            Linfocitos_numero: "7,0 - 14,0",
                            Monocitos_numero: "0,14 - 2,8",
                            Neutrofilos_numero: "1,4 - 8,4",
                            Eosinofilos_numero: "0,0 - 0,7",
                            Linfocitos_porcentaje: "30,0 - 80,0",
                            Monocitos_porcentaje: "2,0 - 20,0",
                            Neutrofilos_porcentaje: "20,0 - 60,0",
                            Eosinofilos_porcentaje: "0,0 - 5,0",
                            Recuentoeritrocitos: "4,0 - 7,0",
                            Hemoglobina: "35,0 - 45,0",
                            Hematocrito: "35,0 - 45,0",
                            vcm: "56,8 - 66,5",
                            hcm: "20,1 - 25,1",
                            chcm: "32,0 - 37,0",
                            rdw: "13,0 - 18,5",
                            Recuentoplaquetario: "100 - 712",
                            mpv: "3,8 - 6,8",
                        },
                    },
                    Hembra: {
                        "Todas las edades": {
                            Recuentoleucocitos: "7,0 - 14,0",
                            Linfocitos_numero: "7,0 - 14,0",
                            Monocitos_numero: "0,14 - 2,8",
                            Neutrofilos_numero: "1,4 - 8,4",
                            Eosinofilos_numero: "0,0 - 0,7",
                            Linfocitos_porcentaje: "30,0 - 80,0",
                            Monocitos_porcentaje: "2,0 - 20,0",
                            Neutrofilos_porcentaje: "20,0 - 60,0",
                            Eosinofilos_porcentaje: "0,0 - 5,0",
                            Recuentoeritrocitos: "4,0 - 7,0",
                            Hemoglobina: "35,0 - 45,0",
                            Hematocrito: "35,0 - 45,0",
                            vcm: "56,8 - 66,5",
                            hcm: "20,1 - 25,1",
                            chcm: "32,0 - 37,0",
                            rdw: "13,0 - 18,5",
                            Recuentoplaquetario: "100 - 712",
                            mpv: "3,8 - 6,8",
                        },
                        },
                    },
                };
                function actualizarValoresReferencia() {
    const especie = document.getElementById('especieSelector').value;
    const sexo = document.getElementById('sexoSelector').value;
    const edad = document.getElementById('edadSelector').value;

    if (especie !== "Seleccionar" && sexo !== "Seleccionar" && edad !== "Seleccionar") {
        const refValores = valoresReferencia[especie][sexo][edad];
        
        // Actualizar todos los valores de referencia 
        document.getElementById('refLeucocitos').innerText = refValores.Recuentoleucocitos || '';
        document.getElementById('reflinfocitos').innerText = refValores.Linfocitos_numero || '';
        document.getElementById('refMonocitos').innerText = refValores.Monocitos_numero || '';
        document.getElementById('refneutrofilos').innerText = refValores.Neutrofilos_numero || '';
        document.getElementById('refeosinofilos').innerText = refValores.Eosinofilos_numero || '';
        document.getElementById('refbasofilos').innerText = refValores.Basofilos_numero || '0,0 - 0,1';
        document.getElementById('reflinfocitos2').innerText = refValores.Linfocitos_porcentaje || '';
        document.getElementById('refmonocitos').innerText = refValores.Monocitos_porcentaje || '';
        document.getElementById('refNeutrofilosPorcentaje').innerText = refValores.Neutrofilos_porcentaje || '';
        document.getElementById('refEosinofilosPorcentaje').innerText = refValores.Eosinofilos_porcentaje || '';
        document.getElementById('refBasofilosPorcentaje').innerText = refValores.Basofilos_porcentaje || '0,0 - 1,0';
        document.getElementById('referitrocitos').innerText = refValores.Recuentoeritrocitos || '';
        document.getElementById('refhemoglobina').innerText = refValores.Hemoglobina || '';
        document.getElementById('refhematocrito').innerText = refValores.Hematocrito || '';
        document.getElementById('refvcm').innerText = refValores.vcm || '';
        document.getElementById('refhcm').innerText = refValores.hcm || '';
        document.getElementById('refchcm').innerText = refValores.chcm || '';
        document.getElementById('refrdw').innerText = refValores.rdw || '';
        document.getElementById('refplaquetario').innerText = refValores.Recuentoplaquetario || '';
        document.getElementById('refmpv').innerText = refValores.mpv || '';
        
            if (document.getElementById('leucocitos').value) 
                actualizarColor('leucocitos', 'refLeucocitos');
            if (document.getElementById('linfocitos').value)
                actualizarColor('linfocitos', 'reflinfocitos');
            if (document.getElementById('monocitos').value)
                actualizarColor('monocitos', 'refMonocitos');
            if (document.getElementById('neutrofilos').value)
                actualizarColor('neutrofilos', 'refneutrofilos');
            if (document.getElementById('eosinofilos').value)
                actualizarColor('eosinofilos', 'refeosinofilos');
            if (document.getElementById('basofilos').value)
                actualizarColor('basofilos', 'refbasofilos');
            if (document.getElementById('linfocitos_porcentaje').value)
                actualizarColor('linfocitos_porcentaje', 'reflinfocitos2');
            if (document.getElementById('monocitos_porcentaje').value)
                actualizarColor('monocitos_porcentaje', 'refmonocitos');
            if (document.getElementById('neutrofilos_porcentaje').value)
                actualizarColor('neutrofilos_porcentaje', 'refNeutrofilosPorcentaje');
            if (document.getElementById('eosinofilos_porcentaje').value)
                actualizarColor('eosinofilos_porcentaje', 'refEosinofilosPorcentaje');
                if (document.getElementById('basofilos_porcentaje').value)
                actualizarColor('basofilos_porcentaje', 'refBasofilosPorcentaje');
            
            // Series roja
            if (document.getElementById('eritrocitos').value)
                actualizarColor('eritrocitos', 'referitrocitos');
            if (document.getElementById('hemoglobina').value)
                actualizarColor('hemoglobina', 'refhemoglobina');
            if (document.getElementById('hematocrito').value)
                actualizarColor('hematocrito', 'refhematocrito');
            if (document.getElementById('vcm').value)
                actualizarColor('vcm', 'refvcm');
            if (document.getElementById('hcm').value)
                actualizarColor('hcm', 'refhcm');
            if (document.getElementById('chcm').value)
                actualizarColor('chcm', 'refchcm');
            if (document.getElementById('rdw').value)
                actualizarColor('rdw', 'refrdw');
            
            // Plaquetas
            if (document.getElementById('plaquetas').value)
                actualizarColor('plaquetas', 'refplaquetario');
            if (document.getElementById('mpv').value)
                actualizarColor('mpv', 'refmpv');
        }; // Un pequeño retardo para asegurar que los valores de referencia se han actualizado
    }
function actualizarColor(inputId, refId) {
    const inputElement = document.getElementById(inputId);
    const refElement = document.getElementById(refId);
    
    if (!inputElement || !refElement) return;
    
    // Asegurarse de que el input esté dentro de un contenedor
    let container = inputElement.parentElement;
    if (!container.classList.contains('input-container')) {
        // Si el input no está en un contenedor, envolverlo en uno
        const wrapper = document.createElement('div');
        wrapper.className = 'input-container';
        inputElement.parentNode.insertBefore(wrapper, inputElement);
        wrapper.appendChild(inputElement);
        container = wrapper;
    }
    
    // Limpiar clases anteriores primero (importante!)
    container.classList.remove('valor-bajo', 'valor-alto', 'valor-normal');
    inputElement.classList.remove('valor-bajo', 'valor-alto', 'valor-normal');
    
    // Obtener el valor actual sin ninguna flecha
    const valorTexto = inputElement.value.trim().replace(/[↑↓]\s*$/, '').replace(',', '.');
    
    // Si no hay valor, no agregar ninguna clase y salir
    if (!valorTexto) {
        inputElement.style.color = 'black';
        return;
    }
    
    const valor = parseFloat(valorTexto);
    
    // Si no es un número, salir
    if (isNaN(valor)) return;
    
    // Establecer negrita siempre
    inputElement.style.fontWeight = 'bold';
    
    // Obtener rango de referencia
    const rangoTexto = refElement.textContent;
    const coincidencia = rangoTexto.match(/([\d,.]+)\s*-\s*([\d,.]+)/);
    
    if (coincidencia) {
        const min = parseFloat(coincidencia[1].replace(',', '.'));
        const max = parseFloat(coincidencia[2].replace(',', '.'));
        
        if (valor < min) {
            inputElement.style.color = '#0096d2'; // Azul
            container.classList.add('valor-bajo');
            inputElement.classList.add('valor-bajo');
        } else if (valor > max) {
            inputElement.style.color = 'red';
            container.classList.add('valor-alto');
            inputElement.classList.add('valor-alto');
        } else {
            inputElement.style.color = 'black';
            container.classList.add('valor-normal');
            inputElement.classList.add('valor-normal');
        }
    }
}
            document.getElementById('leucocitos').addEventListener('blur', () => {
                actualizarColor('leucocitos', 'refLeucocitos');
            });
            document.getElementById('linfocitos').addEventListener('blur', () => {
                actualizarColor('linfocitos', 'reflinfocitos');
            });
            document.getElementById('monocitos').addEventListener('blur', () => {
                actualizarColor('monocitos', 'refMonocitos');
            });
            document.getElementById('neutrofilos').addEventListener('blur', () => {
                actualizarColor('neutrofilos', 'refneutrofilos');
            });
            document.getElementById('eosinofilos').addEventListener('blur', () => {
                actualizarColor('eosinofilos', 'refeosinofilos');
            });
            document.getElementById('basofilos').addEventListener('blur', () => {
                actualizarColor('basofilos', 'refbasofilos');
            });
            document.getElementById('linfocitos_porcentaje').addEventListener('blur', () => {
                actualizarColor('linfocitos_porcentaje', 'reflinfocitos2');
            });
            document.getElementById('monocitos_porcentaje').addEventListener('blur', () => {
                actualizarColor('monocitos_porcentaje', 'refmonocitos');
            });
            document.getElementById('neutrofilos_porcentaje').addEventListener('blur', () => {
                actualizarColor('neutrofilos_porcentaje', 'refNeutrofilosPorcentaje');
            });
            document.getElementById('eosinofilos_porcentaje').addEventListener('blur', () => {
                actualizarColor('eosinofilos_porcentaje', 'refEosinofilosPorcentaje');
            });
            document.getElementById('basofilos_porcentaje').addEventListener('blur', () => {
                actualizarColor('basofilos_porcentaje', 'refBasofilosPorcentaje');
            });
            document.getElementById('eritrocitos').addEventListener('blur', () => {
                actualizarColor('eritrocitos', 'referitrocitos');
            });
            document.getElementById('hemoglobina').addEventListener('blur', () => {
                actualizarColor('hemoglobina', 'refhemoglobina');
            });
            document.getElementById('hematocrito').addEventListener('blur', () => {
                actualizarColor('hematocrito', 'refhematocrito');
            });
            document.getElementById('vcm').addEventListener('blur', () => {
                actualizarColor('vcm', 'refvcm');
            });
            document.getElementById('hcm').addEventListener('blur', () => {
                actualizarColor('hcm', 'refhcm');
            });
            document.getElementById('chcm').addEventListener('blur', () => {
                actualizarColor('chcm', 'refchcm');
            });
            document.getElementById('rdw').addEventListener('blur', () => {
                actualizarColor('rdw', 'refrdw');
            });
            document.getElementById('plaquetario').addEventListener('blur', () => {
                actualizarColor('plaquetario', 'refplaquetario');
            });
            document.getElementById('mpv').addEventListener('blur', () => {
                actualizarColor('mpv', 'refmpv');
            });

                
                function calcularNeutrofilos() {
                    var leucocitos = parseFloat(document.getElementById('leucocitos').value.replace(',', '.')) || 0;
                    var linfocitos = parseFloat(document.getElementById('linfocitos').value.replace(',', '.')) || 0;
                    var monocitos = parseFloat(document.getElementById('monocitos').value.replace(',', '.')) || 0;
                    var eosinofilos = parseFloat(document.getElementById('eosinofilos').value.replace(',', '.')) || 0;
                    
                    // Calcular neutrófilos # = leucocitos - linfocitos - monocitos - eosinófilos
                    var neutrofilos = leucocitos - linfocitos - monocitos - eosinofilos;
                    
                    var neutrofilosInput = document.getElementById('neutrofilos');
                    
                    // Solo mostrar el resultado si hay valores válidos
                    if (leucocitos > 0) {
                        neutrofilosInput.value = neutrofilos.toFixed(1).replace('.', ',');
                        // Actualizar color inmediatamente después de establecer el valor
                        setTimeout(() => {
                            actualizarColor('neutrofilos', 'refneutrofilos');
                        }, 10);
                    } else {
                        neutrofilosInput.value = '';
                        neutrofilosInput.style.color = 'black';
                        neutrofilosInput.classList.remove('valor-bajo', 'valor-alto', 'valor-normal');
                    }
                }
                
                function calcularEosinofilos() {
                    var leucocitos = parseFloat(document.getElementById('leucocitos').value.replace(',', '.')) || 0;
                    var eosinofilosPorcentaje = parseFloat(document.getElementById('eosinofilos_porcentaje').value.replace(',', '.')) || 0;
                    
                    // Calcular eosinófilos # = (eosinófilos % * leucocitos) / 100
                    var eosinofilos = (eosinofilosPorcentaje * leucocitos) / 100;
                    
                    var eosinofilosInput = document.getElementById('eosinofilos');
                    
                    // Solo mostrar el resultado si hay valores válidos
                    if (leucocitos > 0 && eosinofilosPorcentaje > 0) {
                        eosinofilosInput.value = eosinofilos.toFixed(1).replace('.', ',');
                        // Actualizar color inmediatamente después de establecer el valor
                        setTimeout(() => {
                            actualizarColor('eosinofilos', 'refeosinofilos');
                        }, 10);
                    } else {
                        eosinofilosInput.value = '';
                        eosinofilosInput.style.color = 'black';
                        eosinofilosInput.classList.remove('valor-bajo', 'valor-alto', 'valor-normal');
                    }
                }
                
                function calcularLinfocitosPorcentaje() {
                    var linfocitosPorcentaje = parseFloat(document.getElementById('linfocitos_porcentaje').value.replace(',', '.')) || 0;    
                }
                
                function calcularNeutrofilosPorcentaje() {
                    var linfocitosPorcentaje = parseFloat(document.getElementById('linfocitos_porcentaje').value.replace(',', '.')) || 0;
                    var monocitosPorcentaje = parseFloat(document.getElementById('monocitos_porcentaje').value.replace(',', '.')) || 0;
                    var eosinofilosPorcentaje = parseFloat(document.getElementById('eosinofilos_porcentaje').value.replace(',', '.')) || 0;
                    
                    // Calcular neutrófilos % = 100 - linfocitos % - monocitos % - eosinófilos %
                    var neutrofilosPorcentaje = 100 - linfocitosPorcentaje - monocitosPorcentaje - eosinofilosPorcentaje;
                    
                    var neutrofilosPorcentajeInput = document.getElementById('neutrofilos_porcentaje');
                    
                    // Solo mostrar el resultado si hay al menos un porcentaje válido
                    if (linfocitosPorcentaje > 0 || monocitosPorcentaje > 0 || eosinofilosPorcentaje > 0) {
                        neutrofilosPorcentajeInput.value = neutrofilosPorcentaje.toFixed(1).replace('.', ',');
                        // Actualizar color inmediatamente después de establecer el valor
                        setTimeout(() => {
                            actualizarColor('neutrofilos_porcentaje', 'refNeutrofilosPorcentaje');
                        }, 10);
                    } else {
                        neutrofilosPorcentajeInput.value = '';
                        neutrofilosPorcentajeInput.style.color = 'black';
                        neutrofilosPorcentajeInput.classList.remove('valor-bajo', 'valor-alto', 'valor-normal');
                    }
                }
                function cambiarColor(valor, id, min, max) {
                var input = document.getElementById(id);
                if (!input) return;
                
                // Asegurarse de que el input esté dentro de un contenedor
                let container = input.parentElement;
                if (!container.classList.contains('input-container')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'input-container';
                    input.parentNode.insertBefore(wrapper, input);
                    wrapper.appendChild(input);
                    container = wrapper;
                }
                
                // Siempre establecer negrita
                input.style.fontWeight = 'bold';
                
                // Limpiar clases anteriores
                container.classList.remove('valor-bajo', 'valor-alto');
                
                if (id === 'neutrofilos_porcentaje' || id === 'eosinofilos_porcentaje') {
                    input.style.color = 'black';
                    return;
                }
                
                // Solo agregar clases si hay un valor válido
                if (!isNaN(valor) && input.value.trim()) {
                    if (valor < min) {
                        input.style.color = '#0096d2'; // Azul
                        container.classList.add('valor-bajo');
                    } else if (valor > max) {
                        input.style.color = 'red';
                        container.classList.add('valor-alto');
                    } else {
                        input.style.color = 'black';
                    }
                }
            }
                function formatearDecimal(id) {
                    var input = document.getElementById(id);
                    if (input.value === '') return;
                    var valor = parseFloat(input.value.replace(',', '.')) || 0;
                    input.value = valor.toFixed(1).replace('.', ',');
                }
                
              
                </script>
            </tbody>
        </table>
        <h3 class="titulos">FÓRMULA ROJA</h3>
        <table>
            <thead>
                <tr>
                    <th>PARÁMETRO</th>
                    <th>RESULTADO</th>
                    <th>VALOR DE REFERENCIA</th>
                    <th>UNIDADES</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>RECUENTO ERITROCITOS</td>
                    <td>
                        <input type="text" id="eritrocitos" list="rangoEritrocitos" onblur="calcularEritrocitos(); formatearDecimales('eritrocitos', 2)" onkeydown="moverFoco(event, 'hemoglobina')">
                        <datalist id="rangoEritrocitos"></datalist>
                    </td>
                    <td id="referitrocitos">5,61 - 7,47</td>
                    <td>x 10⁶/µl</td>
                </tr>
             <tr>
    <td>HEMOGLOBINA</td>
    <td><input type="text" id="hemoglobina" list ="rangoHemoglobina"oninput="calcularTodosRojos()" onblur="formatearDecimal('hemoglobina', 1)" onkeydown="moverFoco(event, 'hematocrito')"></td>
    <datalist id="rangoHemoglobina"></datalist>
    <td id="refhemoglobina">14,2 - 18,9</td>
    <td>g/dl</td>
</tr>
<tr>
    <td>HEMATOCRITO</td>
    <td><input type="text" id="hematocrito" list="rangoHematocrito" oninput="calcularTodosRojos()" onblur="formatearDecimal('hematocrito', 1)" onkeydown="moverFoco(event, 'vcm')"></td>
    <datalist id="rangoHematocrito"></datalist>
    <td id="refhematocrito">40,4 - 55,3</td>
    <td>%</td>
</tr>
<tr>
    <td>VCM</td>
    <td><input type="text" id="vcm" list="rangoVcm" oninput="calcularTodosRojos()" onblur="formatearDecimal('vcm', 1)" onkeydown="moverFoco(event, 'hcm')"></td>
    <datalist id="rangoVcm"></datalist>
    <td id="refvcm">65,0 - 80,0</td>
    <td>fl</td>
</tr>
<tr>
    <td>HCM</td>
    <td><input type="text" id="hcm" list="rangoHcm" oninput="calcularTodosRojos()" onblur="formatearDecimal('hcm', 1)" onkeydown="moverFoco(event, 'chcm')"></td>
    <datalist id="rangoHcm"></datalist>
    <td id="refhcm">20,0 - 25,0</td>
    <td>pg</td>
</tr>
<tr>
    <td>CHCM</td>
    <td><input type="text" id="chcm" list= "rangoChcm" oninput="calcularTodosRojos()" onblur="formatearDecimal('chcm', 1)" onkeydown="moverFoco(event, 'rdw')"></td>
    <datalist id="rangoChcm"></datalist>
    <td id="refchcm">30,0 - 38,0</td>
    <td>g/dl</td>
</tr>
<tr>
    <td>RDW</td>
    <td><input type="text" id="rdw" list= "rangoRvw" oninput="calcularTodosRojos()" onblur="formatearDecimal('rdw', 1)" onkeydown="moverFoco(event, 'eritrocitos')"></td>
    <datalist id="rangoRvw"></datalist>
    <td id="refrdw">11,0 - 15,5</td>
    <td>%</td>
</tr>
            </tbody>
        </table>
        
        <script>
    function formatearDecimal(id, decimales = 1) {
    var input = document.getElementById(id);
    if (input.value === '') return;
    var valor = parseFloat(input.value.replace(',', '.')) || 0;
    input.value = valor.toFixed(decimales).replace('.', ',');
    }
    function formatearDecimales(id, decimales = 2) {
    var input = document.getElementById(id);
    if (input.value === '') return;
    var valor = parseFloat(input.value.replace(',', '.')) || 0;
    input.value = valor.toFixed(decimales).replace('.', ',');
    }
    
        // Función para forzar la actualización de colores de campos calculados
        function actualizarColoresCalculados() {
            setTimeout(() => {
                actualizarColor('neutrofilos', 'refneutrofilos');
                actualizarColor('eosinofilos', 'refeosinofilos');
                actualizarColor('neutrofilos_porcentaje', 'refNeutrofilosPorcentaje');
            }, 50);
        }

        // Función principal para calcular todos los valores y actualizar colores
        function calcularTodos() {
            try {
                // Obtener valores actuales
                var leucocitos = parseFloat(document.getElementById('leucocitos').value.replace(',', '.')) || 0;
                var linfocitos = parseFloat(document.getElementById('linfocitos').value.replace(',', '.')) || 0;
                var monocitos = parseFloat(document.getElementById('monocitos').value.replace(',', '.')) || 0;
                var eosinofilosPorcentaje = parseFloat(document.getElementById('eosinofilos_porcentaje').value.replace(',', '.')) || 0;
                var linfocitosPorcentaje = parseFloat(document.getElementById('linfocitos_porcentaje').value.replace(',', '.')) || 0;
                var monocitosPorcentaje = parseFloat(document.getElementById('monocitos_porcentaje').value.replace(',', '.')) || 0;
                
                // Calcular automáticamente neutrófilos # si tenemos leucocitos
                if (leucocitos > 0) {
                    calcularNeutrofilos();
                } else {
                    // Limpiar el campo si no hay leucocitos
                    document.getElementById('neutrofilos').value = '';
                    document.getElementById('neutrofilos').style.color = 'black';
                    document.getElementById('neutrofilos').classList.remove('valor-bajo', 'valor-alto', 'valor-normal');
                }
                
                // Calcular automáticamente eosinófilos # si tenemos leucocitos y eosinófilos %
                if (leucocitos > 0 && eosinofilosPorcentaje > 0) {
                    calcularEosinofilos();
                } else {
                    // Limpiar el campo si no hay valores necesarios
                    document.getElementById('eosinofilos').value = '';
                    document.getElementById('eosinofilos').style.color = 'black';
                    document.getElementById('eosinofilos').classList.remove('valor-bajo', 'valor-alto', 'valor-normal');
                }
                
                // Calcular automáticamente neutrófilos % si tenemos al menos uno de los porcentajes
                if (linfocitosPorcentaje > 0 || monocitosPorcentaje > 0 || eosinofilosPorcentaje > 0) {
                    calcularNeutrofilosPorcentaje();
                } else {
                    // Limpiar el campo si no hay porcentajes
                    document.getElementById('neutrofilos_porcentaje').value = '';
                    document.getElementById('neutrofilos_porcentaje').style.color = 'black';
                    document.getElementById('neutrofilos_porcentaje').classList.remove('valor-bajo', 'valor-alto', 'valor-normal');
                }
                
                // Lista de parámetros que pueden necesitar actualización de color
                const parametros = [
                    'leucocitos', 'linfocitos', 'monocitos', 'neutrofilos', 'eosinofilos', 'basofilos',
                    'linfocitos_porcentaje', 'monocitos_porcentaje', 'neutrofilos_porcentaje', 
                    'eosinofilos_porcentaje', 'basofilos_porcentaje'
                ];
                
                // Actualizar colores solo para elementos que existen
                parametros.forEach(param => {
                    const elemento = document.getElementById(param);
                    if (elemento) {
                        // Intentar actualizar el color si la función existe
                        const refId = 'ref' + param.replace('_', '');
                        try {
                            actualizarColor(param, refId);
                        } catch (e) {
                            // Silenciar errores de funciones no encontradas
                        }
                    }
                });
                
                // Forzar actualización de colores de campos calculados
                actualizarColoresCalculados();
                
            } catch (error) {
                // Silenciar errores para evitar interrupciones
                console.warn('Error en calcularTodos:', error);
            }
        }
    
        function calcularTodosRojos() {
            try {
                const eritrocitos = document.getElementById('eritrocitos');
                if (eritrocitos) calcularEritrocitos();
                
                const hemoglobina = document.getElementById('hemoglobina');
                if (hemoglobina) calcularHemoglobina();
                
                const hematocrito = document.getElementById('hematocrito');
                if (hematocrito) calcularHematocrito();
                
                const vcm = document.getElementById('vcm');
                if (vcm) calcularVCM();
                
                const hcm = document.getElementById('hcm');
                if (hcm) calcularHCM();
                
                const chcm = document.getElementById('chcm');
                if (chcm) calcularCHCM();
                
                const rdw = document.getElementById('rdw');
                if (rdw) calcularRDW();
            } catch (error) {
                console.warn('Error en calcularTodosRojos:', error);
            }
        }
        
        function calcularEritrocitos() {
    const elemento = document.getElementById('eritrocitos');
    if (!elemento) return;
    var eritrocitos = parseFloat(elemento.value.replace(',', '.')) || 0;
    actualizarColor('eritrocitos', 'referitrocitos');
}

function calcularHemoglobina() {
    const elemento = document.getElementById('hemoglobina');
    if (!elemento) return;
    var hemoglobina = parseFloat(elemento.value.replace(',', '.')) || 0;
    // cambiarColor(hemoglobina, 'hemoglobina', 14.2, 18.9);
    actualizarColor('hemoglobina', 'refhemoglobina');
}

function calcularHematocrito() {
    var hematocrito = parseFloat(document.getElementById('hematocrito').value.replace(',', '.')) || 0;
    // cambiarColor(hematocrito, 'hematocrito', 40.4, 55.3);
    actualizarColor('hematocrito', 'refhematocrito');
}

function calcularVCM() {
    var vcm = parseFloat(document.getElementById('vcm').value.replace(',', '.')) || 0;
    // cambiarColor(vcm, 'vcm', 65.0, 80.0);
    actualizarColor('vcm', 'refvcm');
}

function calcularHCM() {
    var hcm = parseFloat(document.getElementById('hcm').value.replace(',', '.')) || 0;
    // cambiarColor(hcm, 'hcm', 20.0, 25.0);
    actualizarColor('hcm', 'refhcm');
}

function calcularCHCM() {
    var chcm = parseFloat(document.getElementById('chcm').value.replace(',', '.')) || 0;
    // cambiarColor(chcm, 'chcm', 30.0, 38.0);
    actualizarColor('chcm', 'refchcm');
}

function calcularRDW() {
    var rdw = parseFloat(document.getElementById('rdw').value.replace(',', '.')) || 0;
    actualizarColor('rdw', 'refrdw');
}

function calcularMPV() {
    var mpv = parseFloat(document.getElementById('mpv').value.replace(',', '.')) || 0;
    actualizarColor('mpv', 'refmpv');
}

        function moverFoco(event, siguienteId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                document.getElementById(siguienteId).focus();
            }
        }
        
        document.getElementById('eritrocitos').addEventListener('blur', function() {
            formatearDecimales('eritrocitos');
            calcularTodosRojos();
        });
        document.getElementById('hemoglobina').addEventListener('blur', function() {
            formatearDecimal('hemoglobina');
            calcularTodosRojos();
        });
        document.getElementById('hematocrito').addEventListener('blur', function() {
            formatearDecimal('hematocrito');
            calcularTodosRojos();
        });
        document.getElementById('vcm').addEventListener('blur', function() {
            formatearDecimal('vcm');
            calcularTodosRojos();
        });
        document.getElementById('hcm').addEventListener('blur', function() {
            formatearDecimal('hcm');
            calcularTodosRojos();
        });
        document.getElementById('chcm').addEventListener('blur', function() {
            formatearDecimal('chcm');
            calcularTodosRojos();
        });
        document.getElementById('rdw').addEventListener('blur', function() {
            formatearDecimal('rdw');
            calcularTodosRojos();
        });
        function calcularTodosPlaquetas() {
            try {
                const plaquetas = document.getElementById('plaquetas');
                if (plaquetas) calcularPlaquetas();
                
                const mpv = document.getElementById('mpv');
                if (mpv) calcularMPV();
                
                const pdw = document.getElementById('pdw');
                if (pdw) calcularPDW();
                
                const pct = document.getElementById('pct');
                if (pct) calcularPCT();
            } catch (error) {
                console.warn('Error en calcularTodosPlaquetas:', error);
            }
        }


    </script>
    <h3 class="titulos">FÓRMULA PLAQUETARIA</h3>
   <table>
       <thead>
           <tr>
                <th>PARÁMETRO</th>
                <th>RESULTADO</th>
                <th>VALOR DE REFERENCIA</th>
                <th>UNIDADES</th>
           </tr>
       </thead>
       <tbody>
           <tr>
               <td>RECUENTO PLAQUETARIO</td>
               <td><input type="text" id="plaquetas" oninput="calcularTodosPlaquetas()" onblur="calcularTodosPlaquetas()" onkeydown="moverFoco(event, 'mpv')"></td>
               <td id="refplaquetario">117 - 460</td>
               <td>x 10³/µl</td>
           </tr>
           
           <tr>

               <td>MPV</td>
               <td><input type="text" id="mpv" list="rangoMPV" oninput="calcularTodosPlaquetas()" onblur="formatearDecimal('mpv')" onkeydown="moverFoco(event, 'pdw')"></td>
               <datalist id="rangoMPV"></datalist>
               <td id="refmpv">7,0 - 12,9</td>
               <td>fl</td>
           </tr>
           <tr>
               <td>PDW</td>
               <td><input type="text" id="pdw" oninput="calcularTodosPlaquetas()" onblur="formatearDecimal('pdw')" onkeydown="moverFoco(event, 'pct')"></td>
               <td></td>
               <td></td>
           </tr>
           <tr>
               <td>PCT</td>
               <td><input type="text" id="pct" oninput="calcularTodosPlaquetas()" onkeydown="moverFoco(event, 'plaquetas')"></td>
               <td></td>
               <td>%</td>
           </tr>
       </tbody>
   </table>
   
   <script>
   
   function calcularPlaquetas() {
    var plaquetas = parseFloat(document.getElementById('plaquetas').value.replace(',', '.')) || 0;
}
   function calcularMPV() {
       var mpv = parseFloat(document.getElementById('mpv').value.replace(',', '.')) || 0;
       cambiarColor(mpv, 'mpv', 7.0, 12.9);
   }
   
   function calcularPDW() {
       var pdw = parseFloat(document.getElementById('pdw').value.replace(',', '.')) || 0;
       pdw.style.color = 'black';
    }
   
    function calcularPCT() {
    var pctElement = document.getElementById('pct');
    var pct = parseFloat(pctElement.value.replace(',', '.')) || 0;
    
    // Aplicar el color al elemento, no al valor numérico
    pctElement.style.color = 'black';
}

// Agregar esta función para el reemplazo automático punto → coma
document.addEventListener('DOMContentLoaded', function() {
    const pctInput = document.getElementById('pct');
    if (pctInput) {
        pctInput.addEventListener('input', function(e) {
            // Reemplazar puntos por comas mientras el usuario escribe
            if (this.value.includes('.')) {
                this.value = this.value.replace('.', ',');
            }
        });
    }
});

   
   function formatearDecimal(id) {
       var input = document.getElementById(id);
       if (input.value === '') return;
       var valor = parseFloat(input.value.replace(',', '.')) || 0;
       input.value = valor.toFixed(1).replace('.', ',');
   }
   
   function moverFoco(event, siguienteId) {
       if (event.key === 'Enter') {
           event.preventDefault();
           document.getElementById(siguienteId).focus();
       }
   }
   
   document.getElementById('plaquetas').addEventListener('blur', () => {
    actualizarColor('plaquetas', 'refplaquetario');
});
   document.getElementById('mpv').addEventListener('blur', function() {
       formatearDecimal('mpv');
       calcularTodosPlaquetas();
   });
   document.getElementById('pdw').addEventListener('blur', function() {
       formatearDecimal('pdw');
       calcularTodosPlaquetas();
   });
   document.getElementById('pct').addEventListener('blur', function() {
       calcularTodosPlaquetas();
   });
   if (document.getElementById('mpv')) {
    const mpvElement = document.getElementById('mpv');
    const oldMpvListener = mpvElement.onblur;
    mpvElement.onblur = null;
    
    // Establecer un único listener
    mpvElement.addEventListener('blur', function() {
        formatearDecimal('mpv');
        actualizarColor('mpv', 'refmpv');
    });
}
   </script>
  <div class="footer">
    <p id="mensajeMedico" style="display: none;">El personal médico cuenta con un plazo de 24 a 48 horas para interpretar el reporte de los resultados.</p>
    <p>Facebook: Veterinaria San Martin de Porres | Teléfono: 4000 - 1365 | Ext: 106</p>
    <p>WhatsApp: 8839 - 2214 | San Rafael Abajo de Desamparados, 50 metros Norte del Mall Zona Centro</p>
    <p>Correo: laboratorio@vetsanmartin.com</p>
</div>
</div>
<div class="controls">
    <button id="pdfButton" onclick="generatePDF()">Generar PDF</button>
    <button id="menuButton" onclick="window.location.href='index.html'">Volver al Menú</button>
    <div id="loadingPdf" class="loading-indicator">
        <div class="spinner"></div>
        <span>Generando PDF...</span>
    </div>
</div>
  <script>
function moverFoco(event, siguienteId) {
    if (event.key === 'Enter') {
        event.preventDefault();
        
        // Lista completa de campos en orden de navegación
        const camposParametros = [
            'leucocitos', 'linfocitos', 'monocitos', 'neutrofilos', 'eosinofilos', 'basofilos',
            'linfocitos_porcentaje', 'monocitos_porcentaje', 'neutrofilos_porcentaje', 'eosinofilos_porcentaje', 'basofilos_porcentaje',
            'eritrocitos', 'hemoglobina', 'hematocrito', 'vcm', 'hcm', 'chcm', 'rdw',
            'plaquetas', 'mpv', 'pdw', 'pct'
];
        
        // Encontrar el índice del campo actual
        const indiceActual = camposParametros.indexOf(event.target.id);
        
        if (indiceActual !== -1 && indiceActual < camposParametros.length - 1) {
            // Mover al siguiente campo en la secuencia
            const siguienteId = camposParametros[indiceActual + 1];
            document.getElementById(siguienteId).focus();
        } else {
            // Si no está en la lista o es el último, usar el siguienteId proporcionado
            document.getElementById(siguienteId).focus();
}
    } else if (event.key === 'ArrowUp') {
        event.preventDefault();
        
        // Los mismos campos para navegación hacia arriba
        const camposParametros = [
        'leucocitos', 'linfocitos', 'monocitos', 'neutrofilos', 'eosinofilos', 'basofilos',
        'linfocitos_porcentaje', 'monocitos_porcentaje', 'neutrofilos_porcentaje', 'eosinofilos_porcentaje', 'basofilos_porcentaje',
        'eritrocitos', 'hemoglobina', 'hematocrito', 'vcm', 'hcm', 'chcm', 'rdw',
        'plaquetas', 'mpv', 'pdw', 'pct'
];
        
        // Encontrar el índice del campo actual
        const indiceActual = camposParametros.indexOf(event.target.id);
        
        if (indiceActual > 0) {
            // Mover al campo anterior
            const anteriorId = camposParametros[indiceActual - 1];
            document.getElementById(anteriorId).focus();
        }
    }
}
    document.addEventListener('DOMContentLoaded', () => {
        const templates = document.querySelectorAll('.container');
        const templateSelector = document.getElementById('templateSelector');
    
        templateSelector.addEventListener('change', () => {
            templates.forEach(template => template.style.display = 'none');
            const selectedTemplate = document.getElementById(templateSelector.value);
            if (selectedTemplate) selectedTemplate.style.display = 'block';
        });
    });
    
    function printTemplate() {
        const templateSelector = document.getElementById('templateSelector');
        const selectedTemplate = document.getElementById(templateSelector.value);
    
        if (!selectedTemplate) {
            alert('Selecciona una plantilla antes de imprimir.');
            return;
        }
    
        // Crear un contenedor temporal para la impresión
        const printContainer = document.createElement('div');
        printContainer.id = 'printContainer';
        printContainer.style.display = 'none';
        document.body.appendChild(printContainer);
    
        // Clonar la plantilla seleccionada y agregarla al contenedor de impresión
        const clone = selectedTemplate.cloneNode(true);
        printContainer.appendChild(clone);
    
        // Ocultar todas las plantillas excepto la seleccionada
        const templates = document.querySelectorAll('.container');
        templates.forEach(template => {
            if (template !== selectedTemplate) {
                template.style.display = 'none';
            }
        });
    
        // Mostrar el contenedor de impresión y ocultar el resto del contenido
        printContainer.style.display = 'block';
        document.querySelector('.controls').style.display = 'none';
    
        // Imprimir el contenido del contenedor de impresión
        window.print();
    
        // Restaurar la visibilidad de todas las plantillas y controles
        printContainer.style.display = 'none';
        document.querySelector('.controls').style.display = 'block';
        templates.forEach(template => {
            template.style.display = 'none';
        });
        selectedTemplate.style.display = 'block';
    
        // Eliminar el contenedor de impresión
        document.body.removeChild(printContainer);
    }
    </script>
<script>
    // Agregar al inicio del archivo después de los scripts existentes
document.addEventListener('DOMContentLoaded', function() {
    // Configurar el historial de análisis
    setupHistorial();
    
    // Añadir evento para guardar los datos al generar el PDF
    const pdfButton = document.getElementById('pdfButton');
    if (pdfButton) {
        const originalHandler = pdfButton.onclick;
        pdfButton.onclick = async function() {
            // Guardar los datos antes de generar el PDF
            guardarAnalisisActual();
            
            // Llamar al manejador original
            if (originalHandler) {
                return originalHandler.apply(this, arguments);
            }
        };
    }
});

// Función para configurar el selector de historial
function setupHistorial() {
    // Crear el selector de historial
    const controlsDiv = document.querySelector('.controls');
    
    if (controlsDiv) {
        // Crear el contenedor para el historial
        const historialContainer = document.createElement('div');
        historialContainer.className = 'historial-container';
        
        // Crear etiqueta
        const label = document.createElement('label');
        label.htmlFor = 'historialSelector';
        label.textContent = 'Historial de análisis:';
        
        // Crear selector
        const select = document.createElement('select');
        select.id = 'historialSelector';
        
        // Opción por defecto
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '-- Seleccionar análisis anterior --';
        defaultOption.selected = true;
        select.appendChild(defaultOption);
        
        // Cargar opciones del historial
        cargarOpcionesHistorial(select);
        
        // Evento de cambio
        select.addEventListener('change', function() {
            if (this.value) {
                cargarAnalisisDesdeHistorial(this.value);
            }
        });
        
        // Agregar elementos al DOM
        historialContainer.appendChild(label);
        historialContainer.appendChild(select);
        
        // Agregar después de los selectores existentes
        controlsDiv.appendChild(historialContainer);
    }
}

// Función para cargar las opciones del historial
function cargarOpcionesHistorial(selectElement) {
    // Limpiar opciones existentes excepto la primera
    while (selectElement.options.length > 1) {
        selectElement.remove(1);
    }
    
    // Obtener historial del localStorage
    const historial = JSON.parse(localStorage.getItem('hemogramaHistorial') || '[]');
    
    // Agregar cada análisis como opción
    historial.forEach((analisis, index) => {
        const option = document.createElement('option');
        option.value = index;
        
        // Crear descripción con nombre, fecha y hora
        const fecha = new Date(analisis.timestamp);
        const fechaStr = fecha.toLocaleDateString();
        const horaStr = fecha.toLocaleTimeString();
        
        option.textContent = `${analisis.mascotaNombre} - ${analisis.propietarioNombre} (${fechaStr} ${horaStr})`;
        
        selectElement.appendChild(option);
    });
}

// Función para guardar el análisis actual
function guardarAnalisisActual() {
    // Función auxiliar para obtener valores de forma segura
    const getValueSafe = (id) => {
        const element = document.getElementById(id);
        return element ? element.value : '';
    };

    // Recopilación de todos los datos del formulario
    const formData = {
        // Datos de la mascota y propietario
        mascotaNombre: getValueSafe('mascotaNombre'),
        mascotaRaza: getValueSafe('mascotaRaza'),
        mascotaEspecie: getValueSafe('especieEnPlantilla'),
        mascotaSexo: getValueSafe('sexoEnPlantilla'),
        mascotaEdad: getValueSafe('mascotaEdad'),
        mascotaPeso: getValueSafe('mascotaPeso'),
        
        propietarioNombre: getValueSafe('propietarioNombre'),
        propietarioCedula: getValueSafe('propietarioCedula'),
        propietarioTelefono: getValueSafe('propietarioTelefono'),
        propietarioEmail: getValueSafe('propietarioEmail'),
        propietarioFecha: getValueSafe('propietarioFecha'),
        nombreMedico: getValueSafe('nombreMedico'),
        
        // Datos de fórmula blanca
        leucocitos: getValueSafe('leucocitos'),
        linfocitos: getValueSafe('linfocitos'),
        monocitos: getValueSafe('monocitos'),
        neutrofilos: getValueSafe('neutrofilos'),
        eosinofilos: getValueSafe('eosinofilos'),
        linfocitos_porcentaje: getValueSafe('linfocitos_porcentaje'),
        monocitos_porcentaje: getValueSafe('monocitos_porcentaje'),
        neutrofilos_porcentaje: getValueSafe('neutrofilos_porcentaje'),
        eosinofilos_porcentaje: getValueSafe('eosinofilos_porcentaje'),
        
        // Datos de fórmula roja
        eritrocitos: getValueSafe('eritrocitos'),
        hemoglobina: getValueSafe('hemoglobina'),
        hematocrito: getValueSafe('hematocrito'),
        vcm: getValueSafe('vcm'),
        hcm: getValueSafe('hcm'),
        chcm: getValueSafe('chcm'),
        rdw: getValueSafe('rdw'),
        
        // Datos plaquetarios
        plaquetas: getValueSafe('plaquetas'),
        mpv: getValueSafe('mpv'),
        pdw: getValueSafe('pdw'),
        pct: getValueSafe('pct'),
        
        // Selectores principales
        especieSelector: getValueSafe('especieSelector'),
        sexoSelector: getValueSafe('sexoSelector'),
        edadSelector: getValueSafe('edadSelector'),
        
        // Añadir timestamp para ordenación
        timestamp: new Date().getTime()
    };
    
    // Verificar si hay datos significativos para guardar
    if (!formData.mascotaNombre && !formData.propietarioNombre) return;
    
    // Obtener historial existente
    let historial = JSON.parse(localStorage.getItem('hemogramaHistorial') || '[]');
    
    // Añadir el nuevo análisis al principio
    historial.unshift(formData);
    
    // Limitar a los 10 últimos
    historial = historial.slice(0, 10);
    
    // Guardar en localStorage
    localStorage.setItem('hemogramaHistorial', JSON.stringify(historial));
    
    // Actualizar opciones en el selector
    const selector = document.getElementById('historialSelector');
    if (selector) {
        cargarOpcionesHistorial(selector);
    }
}

// Función para cargar un análisis desde el historial
function cargarAnalisisDesdeHistorial(index) {
    // Obtener historial
    const historial = JSON.parse(localStorage.getItem('hemogramaHistorial') || '[]');
    
    if (!historial[index]) return;
    
    const analisis = historial[index];
    
    // Cargar todos los campos con los datos guardados
    // Datos de la mascota y propietario
    document.getElementById('mascotaNombre').value = analisis.mascotaNombre || '';
    document.getElementById('mascotaRaza').value = analisis.mascotaRaza || '';
    document.getElementById('especieEnPlantilla').value = analisis.mascotaEspecie || '';
    document.getElementById('sexoEnPlantilla').value = analisis.mascotaSexo || '';
    document.getElementById('mascotaEdad').value = analisis.mascotaEdad || '';
    document.getElementById('mascotaPeso').value = analisis.mascotaPeso || '';
    
    document.getElementById('propietarioNombre').value = analisis.propietarioNombre || '';
    document.getElementById('propietarioCedula').value = analisis.propietarioCedula || '';
    document.getElementById('propietarioTelefono').value = analisis.propietarioTelefono || '';
    document.getElementById('propietarioEmail').value = analisis.propietarioEmail || '';
    document.getElementById('propietarioFecha').value = analisis.propietarioFecha || '';
    document.getElementById('nombreMedico').value = analisis.nombreMedico || '';
    
    // Datos de fórmula blanca
    document.getElementById('leucocitos').value = analisis.leucocitos || '';
    document.getElementById('linfocitos').value = analisis.linfocitos || '';
    document.getElementById('monocitos').value = analisis.monocitos || '';
    document.getElementById('neutrofilos').value = analisis.neutrofilos || '';
    document.getElementById('eosinofilos').value = analisis.eosinofilos || '';
    document.getElementById('basofilos').value = analisis.basofilos || '';
    document.getElementById('linfocitos_porcentaje').value = analisis.linfocitos_porcentaje || '';
    document.getElementById('monocitos_porcentaje').value = analisis.monocitos_porcentaje || '';
    document.getElementById('neutrofilos_porcentaje').value = analisis.neutrofilos_porcentaje || '';
    document.getElementById('eosinofilos_porcentaje').value = analisis.eosinofilos_porcentaje || '';
    document.getElementById('basofilos_porcentaje').value = analisis.basofilos_porcentaje || '';
    
    // Datos de fórmula roja
    document.getElementById('eritrocitos').value = analisis.eritrocitos || '';
    document.getElementById('hemoglobina').value = analisis.hemoglobina || '';
    document.getElementById('hematocrito').value = analisis.hematocrito || '';
    document.getElementById('vcm').value = analisis.vcm || '';
    document.getElementById('hcm').value = analisis.hcm || '';
    document.getElementById('chcm').value = analisis.chcm || '';
    document.getElementById('rdw').value = analisis.rdw || '';
    
    // Datos plaquetarios
    document.getElementById('plaquetas').value = analisis.plaquetas || '';
    document.getElementById('mpv').value = analisis.mpv || '';
    document.getElementById('pdw').value = analisis.pdw || '';
    document.getElementById('pct').value = analisis.pct || '';
    
    // Selectores principales
    if (analisis.especieSelector) {
        document.getElementById('especieSelector').value = analisis.especieSelector;
        // Disparar el evento change manualmente
        const event = new Event('change');
        document.getElementById('especieSelector').dispatchEvent(event);
    }
    
    if (analisis.sexoSelector) {
        document.getElementById('sexoSelector').value = analisis.sexoSelector;
        const event = new Event('change');
        document.getElementById('sexoSelector').dispatchEvent(event);
    }
    
    if (analisis.edadSelector) {
        document.getElementById('edadSelector').value = analisis.edadSelector;
        const event = new Event('change');
        document.getElementById('edadSelector').dispatchEvent(event);
    }
    
    // Actualizar colores y valores calculados
    calcularTodos();
    calcularTodosRojos();
    calcularTodosPlaquetas();
    
    // Mostrar mensaje de éxito
    alert(`Datos de ${analisis.mascotaNombre} cargados correctamente`);
}

// Agregar botón para borrar historial
document.addEventListener('DOMContentLoaded', function() {
    const controlsDiv = document.querySelector('.controls');
    
    if (controlsDiv) {
        const borrarHistorialBtn = document.createElement('button');
        borrarHistorialBtn.id = 'borrarHistorialBtn';
        borrarHistorialBtn.textContent = 'Borrar Historial';
        borrarHistorialBtn.onclick = function() {
            if (confirm('¿Estás seguro de que quieres borrar todo el historial de análisis?')) {
                localStorage.removeItem('hemogramaHistorial');
                cargarOpcionesHistorial(document.getElementById('historialSelector'));
                alert('Historial borrado correctamente');
            }
        };
        
        controlsDiv.appendChild(borrarHistorialBtn);
    }
});
    document.addEventListener('DOMContentLoaded', () => {
        const templates = document.querySelectorAll('.container');
        const templateSelector = document.getElementById('templateSelector');
    
        templateSelector.addEventListener('change', () => {
            templates.forEach(template => template.style.display = 'none');
            const selectedTemplate = document.getElementById(templateSelector.value);
            if (selectedTemplate) selectedTemplate.style.display = 'block';
        });
    });
    async function generatePDF() {
    // Mostrar el indicador de carga
    const loadingIndicator = document.getElementById('loadingPdf');
    const pdfButton = document.getElementById('pdfButton');
    
    loadingIndicator.style.display = 'flex';
    pdfButton.disabled = true;
    
    try {
        const { jsPDF } = window.jspdf;
        const selectedTemplate = document.getElementById('template1');

        if (!selectedTemplate) {
            alert('No se encontró la plantilla.');
            return;
        }

        // Obtener el nombre de la mascota y el apellido del propietario
        const mascotaNombre = document.getElementById('mascotaNombre').value || 'Sin_nombre';
        const propietarioNombre = document.getElementById('propietarioNombre').value || 'Sin_apellido';
        const propietarioApellido = propietarioNombre.split(' ').pop(); // Obtener el último nombre como apellido

        // Espera a que todas las imágenes dentro del elemento se carguen
        const images = selectedTemplate.getElementsByTagName('img');
        const loadImages = Array.from(images).map(img => {
            return new Promise((resolve, reject) => {
                if (img.complete) {
                    resolve();
                } else {
                    img.onload = resolve;
                    img.onerror = reject;
                }
            });
        });

        await Promise.all(loadImages);

        // Genera el canvas
        const canvas = await html2canvas(selectedTemplate, {
            scale: 2,
            useCORS: true,
            logging: true,
            allowTaint: true,
            backgroundColor: '#ffffff'
        });

        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 150; 
        const pageHeight = 297;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        // Calcular la posición para centrar la imagen con márgenes
        const x = (pdf.internal.pageSize.getWidth() - imgWidth) / 2;
        const y = 5;

        // Agrega la imagen de la plantilla escalada y centrada
        pdf.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight);

        // Genera el nombre del archivo según la plantilla actual y datos
        const fileName = `Hemograma ${mascotaNombre} ${propietarioApellido}.pdf`;

        // Guarda el PDF
        pdf.save(fileName);
    } catch (error) {
        console.error('Error al generar el PDF:', error);
        alert('Ocurrió un error al generar el PDF: ' + error.message);
    } finally {
        // Ocultar el indicador de carga y habilitar el botón nuevamente
        loadingIndicator.style.display = 'none';
        pdfButton.disabled = false;
    }
}
async function generatePDF() {
    // Mostrar el indicador de carga
    const loadingIndicator = document.getElementById('loadingPdf');
    const pdfButton = document.getElementById('pdfButton');
    
    loadingIndicator.style.display = 'flex';
    pdfButton.disabled = true;
    
    try {
        const { jsPDF } = window.jspdf;
        const selectedTemplate = document.getElementById('template1');

        if (!selectedTemplate) {
            alert('No se encontró la plantilla.');
            return;
        }

        // Obtener el nombre de la mascota y el primer apellido del propietario
        const mascotaNombre = document.getElementById('mascotaNombre').value || 'Sin_nombre';
        const propietarioNombre = document.getElementById('propietarioNombre').value || 'Sin_apellido';
        
        // Extraer el primer apellido (segundo elemento después de dividir por espacios)
        const nombreArray = propietarioNombre.split(' ');
        // Si hay al menos dos palabras, tomar la segunda como primer apellido
        // Si no, usar el valor completo o el default
        const propietarioApellido = nombreArray.length > 1 ? nombreArray[1] : nombreArray[0];

        // Resto del código sin cambios...
        const images = selectedTemplate.getElementsByTagName('img');
        const loadImages = Array.from(images).map(img => {
            return new Promise((resolve, reject) => {
                if (img.complete) {
                    resolve();
                } else {
                    img.onload = resolve;
                    img.onerror = reject;
                }
            });
        });

        await Promise.all(loadImages);

        // Genera el canvas
        const canvas = await html2canvas(selectedTemplate, {
            scale: 2,
            useCORS: true,
            logging: false,
            allowTaint: true,
            backgroundColor: '#ffffff'
        });

        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 150; 
        const pageHeight = 297;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        // Calcular la posición para centrar la imagen con márgenes
        const x = (pdf.internal.pageSize.getWidth() - imgWidth) / 2;
        const y = 5;

        // Agrega la imagen de la plantilla escalada y centrada
        pdf.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight);

        // Genera el nombre del archivo según la plantilla actual y datos
        const fileName = `Hemograma ${mascotaNombre} ${propietarioApellido}.pdf`;
        
        // Generar el blob del PDF
        const pdfBlob = pdf.output('blob');
        
        // Intentar usar la API File System Access para guardar el archivo
        if ('showSaveFilePicker' in window) {
            try {
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [{
                        description: 'Archivo PDF',
                        accept: { 'application/pdf': ['.pdf'] }
                    }]
                });
                
                const writable = await fileHandle.createWritable();
                await writable.write(pdfBlob);
                await writable.close();
                
                console.log('Archivo guardado con éxito usando File System Access API');
            } catch (err) {
                // Si el usuario cancela el guardado o hay un error
                if (err.name !== 'AbortError') {
                    console.error('Error al usar File System Access API:', err);
                    // Caer en el método tradicional
                    pdf.save(fileName);
                }
            }
        } else {
            pdf.save(fileName);
        }
    } catch (error) {
        console.error('Error al generar el PDF:', error);
        alert('Ocurrió un error al generar el PDF: ' + error.message);
    } finally {
        // Ocultar el indicador de carga y habilitar el botón nuevamente
        loadingIndicator.style.display = 'none';
        pdfButton.disabled = false;
    }
}

// Funciones para eliminar parámetros
document.addEventListener('DOMContentLoaded', function() {
    // Cargar la lista de parámetros cuando se carga la página
    cargarListaDeParametrosHemograma();
});

function cargarListaDeParametrosHemograma() {
    const selector = document.getElementById('parameterSelector');
    if (!selector) {
        console.error("No se encontró el selector de parámetros");
        return;
    }
    
    selector.innerHTML = '<option value="" selected disabled>-- Seleccionar parámetro --</option>';
    
    // Lista de parámetros específicos del hemograma que queremos mostrar
    const parametrosEspecificos = [
        "RECUENTO LEUCOCITOS", "LINFOCITOS #", "MONOCITOS #", "NEUTROFILOS #", "EOSINOFILOS #", "BASOFILOS #",
        "LINFOCITOS %", "MONOCITOS %", "NEUTROFILOS %", "EOSINOFILOS %", "BASOFILOS %",
        "RECUENTO ERITROCITOS", "HEMOGLOBINA", "HEMATOCRITO", "VCM", "HCM", "CHCM", "RDW",
        "PLAQUETAS", "VPM", "PDW", "PCT"
    ];
    
    const tablas = document.querySelectorAll('#template1 table');
    console.log(`Encontradas ${tablas.length} tablas`); // Para debugear
    
    tablas.forEach((tabla, tablaIndex) => {
        const filas = tabla.querySelectorAll('tbody tr');
        console.log(`Tabla ${tablaIndex}: ${filas.length} filas`); // Para debugear
        
        filas.forEach((fila, filaIndex) => {
            if (!fila.cells || fila.cells.length === 0) return;
            
            // Obtener el nombre del parámetro (primera celda)
            const paramName = fila.cells[0]?.textContent.trim();
            console.log(`Fila ${filaIndex}: "${paramName}"`); // Para debugear
            
            // Solo agregar los parámetros específicos que queremos
            if (parametrosEspecificos.includes(paramName)) {
                // Crear un ID único para la fila
                const filaId = `fila-hemograma-${tablaIndex}-${filaIndex}`;
                fila.id = filaId;
                
                // Añadir opción al selector
                const option = document.createElement('option');
                option.value = filaId;
                option.textContent = paramName;
                selector.appendChild(option);
            }
        });
    });
    
    console.log(`Total de opciones cargadas: ${selector.options.length - 1}`); // Para debugear
}

function eliminarParametroSeleccionado() {
    const selector = document.getElementById('parameterSelector');
    const filaId = selector.value;
    
    if (!filaId) {
        alert('Por favor, selecciona un parámetro para eliminar.');
        return;
    }
    
    const fila = document.getElementById(filaId);
    if (fila) {
        fila.remove();
        
        // Actualizar el selector después de eliminar
        cargarListaDeParametrosHemograma();
    }
}

</script>
</script>
    <script type="module" src="numeros.js"></script>
</body>
</html>
